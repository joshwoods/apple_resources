# Wwdc2021 10087

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Transcript

Code

Diagnose Power and Performance regressions in your appQuickly discover how to identify priorities when viewing power and performance regressions. Learn how to track metrics that have regressed with device-and percentile-specific information, so you can focus your efforts on optimization and save valuable development time. We'll also show you how to track down common anti-patterns in your app that wear out device storage, help you customize your workflows, and add App Store Connect APIs to help you stay up to date on your app's real-world performance.ResourcesAnalyzing the performance of your shipping appApp Store Connect APIMeasuring App PerformanceMetricKitReducing terminations in your appHD VideoSD VideoRelated VideosWWDC22Track down hangs with Xcode and on-device detectionWWDC21Triage TestFlight crashes in Xcode OrganizerUltimate application performance survival guideUnderstand and eliminate hangs from your appWWDC20Diagnose performance issues with the Xcode OrganizerIdentify trends with the Power and Performance APIWhat's new in MetricKit

Quickly discover how to identify priorities when viewing power and performance regressions. Learn how to track metrics that have regressed with device-and percentile-specific information, so you can focus your efforts on optimization and save valuable development time. We'll also show you how to track down common anti-patterns in your app that wear out device storage, help you customize your workflows, and add App Store Connect APIs to help you stay up to date on your app's real-world performance.

Analyzing the performance of your shipping app

App Store Connect API

Measuring App Performance

MetricKit

Reducing terminations in your app

HD VideoSD Video

HD Video

SD Video

Track down hangs with Xcode and on-device detection

Triage TestFlight crashes in Xcode Organizer

Ultimate application performance survival guide

Understand and eliminate hangs from your app

Diagnose performance issues with the Xcode Organizer

Identify trends with the Power and Performance API

What's new in MetricKit

Search this videoâ€¦Hi, I am Sonia,a performance tools engineer.Today, my colleague Shreyas and Iwill show you how to diagnosepower and performance regressionsin your app.Every year, you work hard to releasethe best apps possible.You want to invite users to an amazing experiencein your apps, which is why optimizing for powerand performance is so important.This talk will cover key metrics that affectyour app's performance,tools to help you discover regressions,insights to help you reduce disk writes,and APIs to automate your performance workflows.To help you optimize performance,there's a comprehensive set of metrics and diagnosticsavailable to you through the Xcode Organizerand App Store Connect API, without any changes to your app.As you know, performance is not easy to optimize.With so many metrics and diagnostics available,it can be easy to get lost in a sea of information.You want to make each release better than the last,but need a quick way to summarizeyour performance priorities.The Xcode Organizer is a great toolto understand performance.It currently collects data across seven metric categories,including battery, launches, hangs, memory,disk writes, scroll hitches, and terminations.That's a lot of information to process.Let's dive into the Xcode Organizer nextand diagnose a performance regression.I'll start by viewing different metrics for my app.I can choose from seven metric categorieson the left navigation bar.Some categories, like battery and terminations,can have multiple sections, as well as subcategoriesdetailing different event types.I can optionally choose between dozensof different device types,as well as percentiles for top and typical users of my app.The center of the organizershows a chart with data for the last 16 releases.In this case, I want to investigateterminations in my app.The onscreen chart shows terminationsincreased significantly in the latest version,indicating there may be an issue with the release,specifically due to more illegal instruction exitshighlighted in blue.There's such a rich and interesting set of metricsavailable for me to understand performance in the field,but with so many device options, metric categories,and subcategories, it's not clearwhere I should start to optimize performance.That's why there's now an insights sectionin the organizer to highlightall of your performance prioritiesand streamline your workflow.The Xcode Organizer now processes metrics dataand identifies interesting trendssuch as performance regressions.Before I dive in, let's talkabout what a performance regression isand how they're detected.Regressions occur when an app performs poorlyin a power or performance area relative to recent releases.For example, when it takes longerto launch after a release.In this example, the metric is analyzedover recent releases to determineif the value is trending up.The metric is then averaged over the last few releasesand compared to the latest value.If the metric is trending up and the latest value is higherthan the average over the last few releases,it's flagged as a regression and summarizedin the insights section.In this example, the app took on average1.1 seconds to launch,then suddenly jumped to 2.5 secondsin the last release, causing it to be flaggedas a regression.Now that you know how regressions are flagged,let's go back to the organizer and dive in to a few examples.Here's a look at the regressions tab.It's a one-stop shop where you can discoveryour top performance priorities.Is your app suddenly crashing after a recent release?Is that cool new camera feature draining the device battery?You'll find the answer to these questionsand more in the insights section.All the data you need will be highlightedin this go-to section to understandperformance in the field.Here you can discover regressionsfor different metric categories and subcategoriesacross devices for typical and top percentilesgrouped together.The left-hand side will summarizewhich metric regressed, by how much,and for which percentiles,highlighting exactly what you need to focus onto create even better apps.My app has several regressionsacross terminations, memory, and disk writes.Next, I'll go through an exampleof each and how to interpret them.I'll start with termination regressions.Before I go through terminations,check out the video on "Why is my app getting killed?"for more context.Each regression will summarizeall the top issues from my latest app release.The top of the section shows illegal instructionsare causing the crashes, which can occurwhen my app accesses an invalid function pointer.Further down, there's a chart of illegal instruction exitsover the last four releases of my app.The top of the chart shows which percentilesand devices were affected.In this case, top percentile userson all iPhones are experiencing more crashesin the latest release.The average and latest number of illegal instruction exitsare to the right of the chart.In this case, my app has started crashingevery ten days in the latest version.Onscreen terminations are very disruptivebecause users will have to go back to the Home screenand relaunch the app frequently.I'll want to remove references to the invalid function pointercausing these crashes and can dig in furtherby taking a look at my crash diagnostics.Check out the "Triage TestFlight crashes with Xcode" videoto learn more about crash diagnostics.Using regressions and crash diagnostics,I now know I need to reduceonscreen terminations in the next app release.I don't want to stop at onscreen terminationsand know there's more I can do.I'll check my app's regressions to discoverother areas for improvement.Looks like there's a regression in task timeouts as well.Some metrics can regress for multiple devicesand percentiles.In this case, task timeouts have increasedacross all iPhones on both typical and top percentiles.I can scroll through each regression on the right,viewing data for recent releasesas well as the latest and average valuefor the metric.When apps are switched to the background,they have 30 seconds to execute tasksbefore the system terminates them.This means that failing to end background tasks appropriatelycan cause your app to terminate more frequently,leading to a slow launch the next timea user switches back.My app is now getting terminated every three daysin the background.While not as disruptive as an onscreen termination,background terminations can be much more common.It's essential to have a seamless launch experience,even when my app is terminated in the background.I can integrate UIKit's state restoration featuresto ensure a smooth recovery from any background exits.Lastly, coming back to my app's regressions,there's one more performance areaI need to focus on.Disk writes have increased by 28% in the last release,but it's not clear what's caused the issue.It's great I know there's a performance problem,but I'll need more insight on where to startbefore I optimize my app.Next up, Shreyas will tell youhow to discover top causes for disk write regressions.Thanks, Sonia.Hi, I'm Shreyas.I'm a storage software engineer at Apple,and I'll cover how to debug disk write regressionsand stay on top of the app's performance.But before diving into this,why are disk writes so important?Storage, very much like CPU and memory,is a limited resource.Unchecked disk writes can wear outand damage the underlying device.They're also a common cause for annoying onscreen hangsand UI hitches.If we are not careful,they can eat up the battery life quickly.These make optimizing disk writesa key component in ensuring a great user experience.With that in mind, let's learn about the resourcesavailable to diagnose high disk writes.The disk writes report pane in Xcode Organizeris a great starting point.These reports are collected from deviceswhich have consented to share app analytics,and they contain informationabout the stack trace that led to the writes.The stack trace from each report is broken downinto multiple signatures, and the writes are trackedfor a signature across all reports.In this report list, the signatures are shownsorted based on the total writes.For each of the signatures, we can find detailed stack traceshowing us the cause of the writes,and we can also find statisticsabout how many logs were received,what OS version and hardware modelbreakdown looks like, and so on.To identify the problem areas,pay close attention to your top signatures.In this case, the top signatureis responsible for 67% of the writes.We can infer from the callstacksthat this is due to an SQLite function.A lot of times, knowing this, the source of the problem,can go a long way towards solving the issue.But often, like in this case, the fix may not be obvious.The code here is critical to my new feature,I don't spot any obvious bugs,and it's not apparent what my next steps should be.Turns out, the answer is present in the stack traceif you know where to look.There are functions often deep in the stacksometimes in the libraries that you are usingthat can tell you what's wrongand, with enough research, how to fix it.But that can be very tricky.It often requires specific domain knowledgeand can be extremely time consuming.To save you all this effort, in Xcode 13,organizer has a new field called insights.Behind the scenes, a repository is maintainedwith known antipatterns that cause high disk writes.As reports are received, they're scanned for functionsthat indicate these antipatterns.When there's a match, the problem is highlighted herealong with the optimization suggestionto fix the issue.This will make it easy to reduce the app's writesand improve performancewhile saving a ton of debugging effort.For example, for our top signature,I see an optimization suggestion to add an index.There's also a link to the documentation pagethat will explain the problem in detailand give steps to debug and fix the issue.Great.Now, let's follow the advice and see if it helps.And to do that, let me fire up file activities instruments.File activities instruments is a fantastic resourceto debug all storage-related issues.It gives me detailed breakdownof all the reads and writes that the app performs.It's the perfect tool to validate my fix.Before, the instruments showed around 180 megabytesof writes to temporary files.This also introduces a 780 milliseconds of latency.And now, after the index,the writes due to the function drops to zero.This is because SQLite is more efficient now.This means we no longer have 780 millisecond latencyslowing us down. SQLite index is one example.There are a range of other optimization suggestionsto improve your app's performance,and there is constant work to expand this list,so check out the insights for your app today.Let's come back to the insights pane.We had three regressions for our app.We scrutinized each one of them, and we have discoveredthe resources available to resolve all of them.That's great.There are a ton of power and performance analyticsin Xcode Organizer, and the insights should bea go-to pane to discoveryour app's performance priorities.Make the most of it.Plan to check for regressions and insights periodically,and definitely after every release.In addition to the Xcode Organizer,there's another way for you accessall the analytics covered today,and that is App Store Connect APIs.These are great if you want to accessdata programmatically and build custom solutions.Perhaps you already have an analytics pipelinethat you have set up.Then these APIs are the perfect toolfor you to integrate all these cool analytics.Check out the video "Identify trends with Powerand Performance API" from WWDC 2020.It covers the API end points and responses in great detail.Let me give a quick overview of some of the API responses.For metrics, you can make a GET requestto the perfPowerMetrics end point.This returns a JSON response that has app's metricsand insights for your recent versions.Let's jump into the insights section.Within insights, you'll find all the regressionsidentified for your app.For each regression, you'll find metric categoryand a summary of the identified regression.This is the onscreen termination due to an illegal instructionthat we discovered earlier in Xcode Organizer.Next, you'll find the populations section.This provides a detailed, structured listof impacted percentiles and devices.You can use these to take focused actionto improve your app's performance.Similarly, for diagnostic reports,you can make a GET requestto the diagnosticSignatures end point.The responses will have a list of top signatures,and each signature will have a linkto the details associated with it.A GET request to this link will provide youwith detailed diagnostic logsand the insights associated with the signature.Use these APIs in your analytics pipelines,and when you see an insight, take action immediately.Now you know what performance regressions are,and how you can diagnose them,and where you can find actionable data to fix them.Here's what you need to do next.Go open Xcode Organizer now. Check out the regressions pane.See what your app's top performance regressions are.Find out how much your app writes.Are the top disk write callstacks what you expect?Or are there hidden bugs slowing down your app?Finally, make a plan to stay on topof your app's performance.Check Xcode Organizer periodically,and use the App Store Connect APIsin any custom analytics pipeline.Thank you for your time. Happy regression hunting.[upbeat music]

Hi, I am Sonia,a performance tools engineer.Today, my colleague Shreyas and Iwill show you how to diagnosepower and performance regressionsin your app.Every year, you work hard to releasethe best apps possible.You want to invite users to an amazing experiencein your apps, which is why optimizing for powerand performance is so important.This talk will cover key metrics that affectyour app's performance,tools to help you discover regressions,insights to help you reduce disk writes,and APIs to automate your performance workflows.To help you optimize performance,there's a comprehensive set of metrics and diagnosticsavailable to you through the Xcode Organizerand App Store Connect API, without any changes to your app.As you know, performance is not easy to optimize.With so many metrics and diagnostics available,it can be easy to get lost in a sea of information.You want to make each release better than the last,but need a quick way to summarizeyour performance priorities.The Xcode Organizer is a great toolto understand performance.It currently collects data across seven metric categories,including battery, launches, hangs, memory,disk writes, scroll hitches, and terminations.That's a lot of information to process.Let's dive into the Xcode Organizer nextand diagnose a performance regression.I'll start by viewing different metrics for my app.I can choose from seven metric categorieson the left navigation bar.Some categories, like battery and terminations,can have multiple sections, as well as subcategoriesdetailing different event types.I can optionally choose between dozensof different device types,as well as percentiles for top and typical users of my app.The center of the organizershows a chart with data for the last 16 releases.In this case, I want to investigateterminations in my app.

The onscreen chart shows terminationsincreased significantly in the latest version,indicating there may be an issue with the release,specifically due to more illegal instruction exitshighlighted in blue.There's such a rich and interesting set of metricsavailable for me to understand performance in the field,but with so many device options, metric categories,and subcategories, it's not clearwhere I should start to optimize performance.That's why there's now an insights sectionin the organizer to highlightall of your performance prioritiesand streamline your workflow.The Xcode Organizer now processes metrics dataand identifies interesting trendssuch as performance regressions.Before I dive in, let's talkabout what a performance regression isand how they're detected.Regressions occur when an app performs poorlyin a power or performance area relative to recent releases.For example, when it takes longerto launch after a release.In this example, the metric is analyzedover recent releases to determineif the value is trending up.The metric is then averaged over the last few releasesand compared to the latest value.If the metric is trending up and the latest value is higherthan the average over the last few releases,it's flagged as a regression and summarizedin the insights section.In this example, the app took on average1.1 seconds to launch,then suddenly jumped to 2.5 secondsin the last release, causing it to be flaggedas a regression.Now that you know how regressions are flagged,let's go back to the organizer and dive in to a few examples.Here's a look at the regressions tab.It's a one-stop shop where you can discoveryour top performance priorities.Is your app suddenly crashing after a recent release?Is that cool new camera feature draining the device battery?You'll find the answer to these questionsand more in the insights section.All the data you need will be highlightedin this go-to section to understandperformance in the field.Here you can discover regressionsfor different metric categories and subcategoriesacross devices for typical and top percentilesgrouped together.The left-hand side will summarizewhich metric regressed, by how much,and for which percentiles,highlighting exactly what you need to focus onto create even better apps.My app has several regressionsacross terminations, memory, and disk writes.Next, I'll go through an exampleof each and how to interpret them.I'll start with termination regressions.Before I go through terminations,check out the video on "Why is my app getting killed?"for more context.Each regression will summarizeall the top issues from my latest app release.The top of the section shows illegal instructionsare causing the crashes, which can occurwhen my app accesses an invalid function pointer.Further down, there's a chart of illegal instruction exitsover the last four releases of my app.The top of the chart shows which percentilesand devices were affected.In this case, top percentile userson all iPhones are experiencing more crashesin the latest release.The average and latest number of illegal instruction exitsare to the right of the chart.In this case, my app has started crashingevery ten days in the latest version.Onscreen terminations are very disruptivebecause users will have to go back to the Home screenand relaunch the app frequently.I'll want to remove references to the invalid function pointercausing these crashes and can dig in furtherby taking a look at my crash diagnostics.Check out the "Triage TestFlight crashes with Xcode" videoto learn more about crash diagnostics.

Using regressions and crash diagnostics,I now know I need to reduceonscreen terminations in the next app release.I don't want to stop at onscreen terminationsand know there's more I can do.I'll check my app's regressions to discoverother areas for improvement.

Looks like there's a regression in task timeouts as well.Some metrics can regress for multiple devicesand percentiles.In this case, task timeouts have increasedacross all iPhones on both typical and top percentiles.I can scroll through each regression on the right,viewing data for recent releasesas well as the latest and average valuefor the metric.When apps are switched to the background,they have 30 seconds to execute tasksbefore the system terminates them.This means that failing to end background tasks appropriatelycan cause your app to terminate more frequently,leading to a slow launch the next timea user switches back.My app is now getting terminated every three daysin the background.While not as disruptive as an onscreen termination,background terminations can be much more common.It's essential to have a seamless launch experience,even when my app is terminated in the background.I can integrate UIKit's state restoration featuresto ensure a smooth recovery from any background exits.Lastly, coming back to my app's regressions,there's one more performance areaI need to focus on.Disk writes have increased by 28% in the last release,but it's not clear what's caused the issue.It's great I know there's a performance problem,but I'll need more insight on where to startbefore I optimize my app.Next up, Shreyas will tell youhow to discover top causes for disk write regressions.

Thanks, Sonia.Hi, I'm Shreyas.I'm a storage software engineer at Apple,and I'll cover how to debug disk write regressionsand stay on top of the app's performance.But before diving into this,why are disk writes so important?Storage, very much like CPU and memory,is a limited resource.Unchecked disk writes can wear outand damage the underlying device.They're also a common cause for annoying onscreen hangsand UI hitches.If we are not careful,they can eat up the battery life quickly.These make optimizing disk writesa key component in ensuring a great user experience.With that in mind, let's learn about the resourcesavailable to diagnose high disk writes.The disk writes report pane in Xcode Organizeris a great starting point.These reports are collected from deviceswhich have consented to share app analytics,and they contain informationabout the stack trace that led to the writes.The stack trace from each report is broken downinto multiple signatures, and the writes are trackedfor a signature across all reports.In this report list, the signatures are shownsorted based on the total writes.For each of the signatures, we can find detailed stack traceshowing us the cause of the writes,and we can also find statisticsabout how many logs were received,what OS version and hardware modelbreakdown looks like, and so on.To identify the problem areas,pay close attention to your top signatures.In this case, the top signatureis responsible for 67% of the writes.We can infer from the callstacksthat this is due to an SQLite function.A lot of times, knowing this, the source of the problem,can go a long way towards solving the issue.But often, like in this case, the fix may not be obvious.The code here is critical to my new feature,I don't spot any obvious bugs,and it's not apparent what my next steps should be.Turns out, the answer is present in the stack traceif you know where to look.

There are functions often deep in the stacksometimes in the libraries that you are usingthat can tell you what's wrongand, with enough research, how to fix it.But that can be very tricky.It often requires specific domain knowledgeand can be extremely time consuming.

To save you all this effort, in Xcode 13,organizer has a new field called insights.Behind the scenes, a repository is maintainedwith known antipatterns that cause high disk writes.As reports are received, they're scanned for functionsthat indicate these antipatterns.When there's a match, the problem is highlighted herealong with the optimization suggestionto fix the issue.This will make it easy to reduce the app's writesand improve performancewhile saving a ton of debugging effort.For example, for our top signature,I see an optimization suggestion to add an index.There's also a link to the documentation pagethat will explain the problem in detailand give steps to debug and fix the issue.Great.Now, let's follow the advice and see if it helps.And to do that, let me fire up file activities instruments.File activities instruments is a fantastic resourceto debug all storage-related issues.It gives me detailed breakdownof all the reads and writes that the app performs.It's the perfect tool to validate my fix.

Before, the instruments showed around 180 megabytesof writes to temporary files.

This also introduces a 780 milliseconds of latency.

And now, after the index,the writes due to the function drops to zero.This is because SQLite is more efficient now.This means we no longer have 780 millisecond latencyslowing us down. SQLite index is one example.There are a range of other optimization suggestionsto improve your app's performance,and there is constant work to expand this list,so check out the insights for your app today.

Let's come back to the insights pane.We had three regressions for our app.We scrutinized each one of them, and we have discoveredthe resources available to resolve all of them.That's great.There are a ton of power and performance analyticsin Xcode Organizer, and the insights should bea go-to pane to discoveryour app's performance priorities.Make the most of it.Plan to check for regressions and insights periodically,and definitely after every release.

In addition to the Xcode Organizer,there's another way for you accessall the analytics covered today,and that is App Store Connect APIs.

These are great if you want to accessdata programmatically and build custom solutions.Perhaps you already have an analytics pipelinethat you have set up.Then these APIs are the perfect toolfor you to integrate all these cool analytics.Check out the video "Identify trends with Powerand Performance API" from WWDC 2020.It covers the API end points and responses in great detail.Let me give a quick overview of some of the API responses.For metrics, you can make a GET requestto the perfPowerMetrics end point.This returns a JSON response that has app's metricsand insights for your recent versions.Let's jump into the insights section.Within insights, you'll find all the regressionsidentified for your app.For each regression, you'll find metric categoryand a summary of the identified regression.

This is the onscreen termination due to an illegal instructionthat we discovered earlier in Xcode Organizer.

Next, you'll find the populations section.This provides a detailed, structured listof impacted percentiles and devices.You can use these to take focused actionto improve your app's performance.

Similarly, for diagnostic reports,you can make a GET requestto the diagnosticSignatures end point.The responses will have a list of top signatures,and each signature will have a linkto the details associated with it.

A GET request to this link will provide youwith detailed diagnostic logsand the insights associated with the signature.Use these APIs in your analytics pipelines,and when you see an insight, take action immediately.Now you know what performance regressions are,and how you can diagnose them,and where you can find actionable data to fix them.Here's what you need to do next.Go open Xcode Organizer now. Check out the regressions pane.See what your app's top performance regressions are.Find out how much your app writes.Are the top disk write callstacks what you expect?Or are there hidden bugs slowing down your app?Finally, make a plan to stay on topof your app's performance.Check Xcode Organizer periodically,and use the App Store Connect APIsin any custom analytics pipeline.Thank you for your time. Happy regression hunting.[upbeat music]

13:00 -App Store Connect API Metrics

13:01 -App Store Connect API Diagnostics

## Code Samples

```swift
GET /v1/apps/{application-id}/perfPowerMetrics
GET /v1/builds/{id}/perfPowerMetrics
```

```swift
GET /v1/builds/{id}/diagnosticSignatures
GET /v1/diagnosticSignatures/{id}/logs
```

