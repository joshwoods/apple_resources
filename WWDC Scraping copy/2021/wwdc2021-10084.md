# Wwdc2021 10084

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Transcript

Explore UWB-based car keysDiscover how to create digital car keys that support Ultra Wideband (UWB), allowing people to unlock and start their car while leaving iPhone in their bag or pocket or Apple Watch on their wrist. We'll show you how to integrate UWB, add proximity actions and distance unlock features, and help people personalize their vehicle settings by identifying which key someone uses on the driver-side door.

To get the most out of this session, we recommend watching the session “Introducing Car Keys” from WWDC20, which details the basics of pairing, key management, and server actions.ResourcesMFi ProgramHD VideoSD VideoRelated VideosWWDC20Introducing Car Keys

Discover how to create digital car keys that support Ultra Wideband (UWB), allowing people to unlock and start their car while leaving iPhone in their bag or pocket or Apple Watch on their wrist. We'll show you how to integrate UWB, add proximity actions and distance unlock features, and help people personalize their vehicle settings by identifying which key someone uses on the driver-side door.

To get the most out of this session, we recommend watching the session “Introducing Car Keys” from WWDC20, which details the basics of pairing, key management, and server actions.

MFi Program

HD VideoSD Video

HD Video

SD Video

Introducing Car Keys

Search this video…Hi, my name is Arun, and I'm a system engineerin the Wireless team.Today, I'm gonna take you on a journeyto explore UWB-based car keys.Last year, we launched car keys with the abilityto use your iPhone or Apple Watch to unlock, lock,and start your car, share your keyswith family and friends, and even manage them remotely.And you can do all of that knowing that the systemhas been designed to be secure and private.This year, we are excited to extend the capabilitiesof car keys.In this session, we will look at the new featuresand how to integrate them.If you want to learn the basics of the car keys,including provisioning, key management, and NFC,check out last year's talk, "Introducing car keys."One of the key featureswe are enabling this year is passive entry.Using UWB technology, you can now lock, unlock,and start your car while leaving iPhonein your bag or pocket, or Apple Watch on your wrist.RKE, or remote keyless entry controls,allow you to use your iPhone or Watch to lock,unlock, and perform other actionswhen you're in Bluetooth range of your car.And cars can now personalize settings by identifyingwhich digital key is entering the car through which door.There are other features that we will not be ableto cover in this session,such as pairing your device as Car Keyand Friend First Approach, but experiencesfor these features have also been upgraded.Now, let's take a look at the technologiesthat enable these features.The U1 chip with UWB technology allows carsto determine the precise location of nearby car key.UWB is also the basis of a secure-ranging protocolfor stronger protection against replay and relay attacks.The Secure Element is a protected hardware unitintegrated into Apple devices.In addition to storing car keys and authenticating credentials,we have expanded the use of Secure Elementto derive session-specific UWB ranging keys.Bluetooth LE, or BLE, is used as communication channelbetween the car and the Apple device,to exchange data during authenticationand to manage secure-ranging sessions.BLE's also used as the anchor pointto initialize a secure-ranging time grid.And finally, to ensure a common solutionwith cross-platform support, Apple,along with other industry partners,has been leading efforts to createa standard specification at the Car Connectivity Consortium.At Apple, security and privacy are part of our core values.This UWB passive entry solution was designed with both in mind.Keys are unique to each sessionand are derived upon each connection.Some of these session keys are used to encrypt messagesat the link layer, while others to ensurethat your devices can't be tracked using UWB or BLE.We use random identifiers, derived from these session keys.These identifiers are then periodically rotated.And most importantly, we strengthened the securityof UWB-based localizationby building a secure-ranging protocol.This secure-ranging protocol is a two-way ranging protocolwith a three-packet exchange.Think of it as "ping-pong-ping"where iPhone sends a poll message,and the car answers with a respond message,and iPhone sends another poll message for added accuracy.Each of these messages carry a scrambled time stamp, or STS,which is a cryptographically-generatedand time-bounded packet,meaning that even a verified packet can only be acceptedfor the time slot slot which was used to generate this STS,providing extra security against replay and relay attacks.So, how do we bring all of this together?Well, each car defines a series of virtual zones.These zones have associated features that can be triggeredwhen a device with a valid and active keyis localized entering or exiting these zones.The wider zone activates welcome features,such as turning on lights or pre-warming the cabinwhen you approach the car.The zone closest to the car typicallyunlocks the door when you approach.And the lock zone secures the cars when you walk away.So, how does a car detect you in these zones?Well, to localize the paired deviceinside these virtual zones, cars are equippedwith multiple UWB and BLE transceiversto ensure 360-degree coverage.When the user first approaches the car,your iPhone or Apple Watch is detected using BLE.Upon proximity detection, a communication channelwith the car is established.Upon connection, car authenticates the device,and a shared ranging key is derived on both sides.This operation takes place inside the Secure Element,and generates a key that is unique to each session.The derived key is used to start a secure-ranging sessionwith UWB transceivers, which allows the carto localize the device and map its trajectory.This is computed by the localization algorithmthat runs inside the car.We'll come back to it later.The car continues to map the trajectoryof the device as the user approaches the car.Based on the location and trajectory of the device,the car can decide to trigger welcome features,such as turning on lights or adjusting seats.And when the device is localized inside the unlock zone,the car can initiate unlock operationsbefore the user touches the door handle.With precise knowledge of whether the user's device isinside or outside the car, the engine only startswhen a device with a valid key is detected inside the car.And one of my favorite features,now you get to enjoy this UWB-based experienceeven when your phone is in power reserve mode.So, after a long day of hiking or backpacking, if you findthat your phone needs to be charged, there may still beenough power in the battery to get you back on the road.Now that you've seen how passive entry works,let's take a look at the remote keyless entry controls.Remote actions are usefulwhen you're farther from the car.You can use them by preheating the cabin in the winter,or find your car by honking the horn.And many actions can be triggered directlyfrom within Wallet.You can also use device to view information about the car,such as lock state, its fuel level,or battery-charging state.Remote actions are sent over Bluetooth LE.Since they are independent of UWB,they work even outside of UWB range.And finally, remote actions are standardizedat the Car Connectivity Consortium,so there's a common implementationfor all the cars and devices.For the best experience, we recommendthat automakers implement all the applicable remote actions,and not just remote lock and unlock.Let's look at how does Remote Keyless entry control works.To trigger a remote command, the device requests a challengefor the associated action, which is used as an inputto generate the device signature.The car verifies the device signature against the challenge,the associated action, and other information.If verification succeeds,the car performs the action and notifies the device.With digital car keys, cars can now automaticallypersonalize settings, like cabin temperature,seat position, seat heating, and more, by observingwhich digital key is approaching the driver's door.Today's car keys can support personalization, too,but they rely on drivers always knowingwhich key fob has which user setting.Now, with your car key on iPhone or Apple Watch,you don't have to worry about that.With precise trajectory and the knowledgeand the knowledge that the personal devicesare strongly tied to individual users,cars can personalize experienceswith greater confidence than ever before.And this works seamlessly,even when multiple users are approaching the car.To sum it up, we are excited about these new featuresand look forward to automakers launching UWB-based cars,so our users can start enjoying these featureson iPhones and Apple Watches equipped with U1 chip.Now, let's shift gears and talk about how automakerscan get on-boarded on the Apple platform,and some of the areas you will want to focus onwhen designing a car key solution.As part of this discussion, we'll cover system architecture,time synchronization, transceiver synchronization,and about building a good localization algorithm.Let's start with system architecture.Since the passive entry solution relies on reliableand accurate localization, it's essential that your systemhas good performance and low latency.As we saw earlier, each car is equippedwith multiple transceivers, and one of your first decisionswill be to select a suitable transceiver.First, you need to ensure that the transceiverscan provide sufficient link budget.Since the car key protocol is bi-directional,this means evaluating both the Tx-radiated powerand Rx sensitivity for good uplink and downlink performance.By fine-tuning the antenna directivity, you can ensurethat transceiver's antenna supports the entire fieldof view for the required coverage.Antenna diversity is critical to achieve good operating range.For example, the use of two or more antennaswith different polarization or separation can helpimprove received signal strength.Finally, you need to ensure that the 3Dtime-of-flight measurements are highly accurate.Passive entry and localization features relyon time-of-flight in their calculations.Therefore, the accuracy must be within defined bounds,regardless of the approach angle.Since even well-designed individual transceivers canresult in insufficient coverage around the car,or coverage in unwanted areas if they are poorly installed,you will need to identify the best possible positionsto place transceivers around the carto provide necessary coverage and,at the same time, you will want to limit the numberof transceivers to a minimum to keep costs down.Be sure to consider height and orientation.In general, the greater the installation height,the farther the fading point, and better the range.This obviously has to be donewithin the design constraints of the car.Similarly, poor orientation can result in gaps in coverageor coverage in unwanted areas, such as above the car.Once you have the suitable transceiversand potential positions,the next step is to verify the system RF performance.Examine the radiation patternof the transceivers installed around the carto ensure a symmetrical coverage on all sides.You also want to pay attention to the maximum rangecovered by the system.This is important for long distance features,such as welcome lights or preconditioning the cabin.And most importantly, you will want to ensurethat the system has sufficient link margin buffer,to ensure an unlock operation can take place,regardless of damping caused by the human body,channel shadowing, fading, or other variables.Another area you need to consider is system latency.When you approach the car, a complex sequenceof events begins, starting with the setup of a BLE connection,authentication, and key derivation,followed by a secure-ranging session setup,where each UWB transceiver starts scanning,so the car can determine the location of the device.All these tasks must be completedbefore the user attempts to open the door.To keep the system latency within the required bounds,you will need a high-performance crypto processorfor authentication and key management.The bus system that connects your ECUto each transceiver must be of low latency;a slow bus can really impact system op performance.Finally, you will need a flexible software architecturethat allows you to support optimization techniques,be it multi-threaded applicationsor incorporation of time synchronization.Now, let's quickly talk about time synchronization.UWB transceivers needs to be actively scanningto detect ranging packets.Without good time synchronization,long-scanning windows are neededto reliably capture incoming packets.This consumes power and processing time.By implementing a precise time synchronizationacross your system, each transceiver can knowwhen incoming packets are expectedto an accuracy of tens of microsecond.By only scanning during these time windows,not only can you conserve power, and improve performancein multi-session and congested environments,but it also helps you localize the device faster.It does that by ensuring successful rangingfrom the very first detected cycleby keeping the transceivers tightly synchronized.Another important technique is transceiver synchronization.Sometimes, some transceivers may failto connect or become out of sync.By implementing transceiver synchronization,transceivers that are successfully synchronizedwith the device can share timing informationwith other transceivers in the car,and help them quickly connect,or even compute time-of-flight, even when they have failedto finish the full-ranging cycle.Last but not least, localization algorithm.One of the most important task when designinga passive-entry solution is the developmentof a localization algorithm that can pinpoint the locationof approaching devices relative to the car.A localization algorithm is a pieceof code running on your car's ECU.It collects device's distancefrom each connected UWB transceivers and process themto locate the iPhone or Apple Watch in space.There are many ways to do this.One simple example of this is true-range multi-lateration.The localization algorithm is one of the most crucial piecesof the solution that you need to develop.So, you will need to ensure that your localization algorithmis fast and accurate, whether it wants to followthe trajectory of the user as they approach the car,or determine whether the device is inside or outside the cabin.Speed, accuracy, and precision are the keyto a good localization solution, even when you are adding supportfor a single transceiver-based unlock system.You may also need to adjust your localization algorithmfor different cabin types and physical characteristicsof the car.Now, you've seen how the car key feature works.If you're interested in development,we recommend the following workflowfor an organic progressionof software development and qualification.First, focus on UWB interoperabilityand ensure that it follows the specification.We have created a tool that helps you test this.It also lets you progressively enable cryptographic operations,so you can develop your system in a step-by-step manner.Next, integrate the BLE layer for connection managementand owner pairing.Then, focus on secure-ranging management,which is crucial for passive entry.Last but not least, support remote actionsfor control at a distance.If you're interested in learning more,we encourage you to participatein the Car Connectivity Consortium,and enroll in the MFi Program for specific detailson working with iPhone and Apple Watch.The MFi Program is where you can obtain additional documentsand tools to assist in your development.Thank you, and have a great day![music]

Hi, my name is Arun, and I'm a system engineerin the Wireless team.Today, I'm gonna take you on a journeyto explore UWB-based car keys.

Last year, we launched car keys with the abilityto use your iPhone or Apple Watch to unlock, lock,and start your car, share your keyswith family and friends, and even manage them remotely.And you can do all of that knowing that the systemhas been designed to be secure and private.This year, we are excited to extend the capabilitiesof car keys.In this session, we will look at the new featuresand how to integrate them.If you want to learn the basics of the car keys,including provisioning, key management, and NFC,check out last year's talk, "Introducing car keys."One of the key featureswe are enabling this year is passive entry.Using UWB technology, you can now lock, unlock,and start your car while leaving iPhonein your bag or pocket, or Apple Watch on your wrist.RKE, or remote keyless entry controls,allow you to use your iPhone or Watch to lock,unlock, and perform other actionswhen you're in Bluetooth range of your car.And cars can now personalize settings by identifyingwhich digital key is entering the car through which door.There are other features that we will not be ableto cover in this session,such as pairing your device as Car Keyand Friend First Approach, but experiencesfor these features have also been upgraded.Now, let's take a look at the technologiesthat enable these features.The U1 chip with UWB technology allows carsto determine the precise location of nearby car key.UWB is also the basis of a secure-ranging protocolfor stronger protection against replay and relay attacks.The Secure Element is a protected hardware unitintegrated into Apple devices.In addition to storing car keys and authenticating credentials,we have expanded the use of Secure Elementto derive session-specific UWB ranging keys.Bluetooth LE, or BLE, is used as communication channelbetween the car and the Apple device,to exchange data during authenticationand to manage secure-ranging sessions.BLE's also used as the anchor pointto initialize a secure-ranging time grid.And finally, to ensure a common solutionwith cross-platform support, Apple,along with other industry partners,has been leading efforts to createa standard specification at the Car Connectivity Consortium.At Apple, security and privacy are part of our core values.This UWB passive entry solution was designed with both in mind.Keys are unique to each sessionand are derived upon each connection.Some of these session keys are used to encrypt messagesat the link layer, while others to ensurethat your devices can't be tracked using UWB or BLE.We use random identifiers, derived from these session keys.These identifiers are then periodically rotated.And most importantly, we strengthened the securityof UWB-based localizationby building a secure-ranging protocol.This secure-ranging protocol is a two-way ranging protocolwith a three-packet exchange.Think of it as "ping-pong-ping"where iPhone sends a poll message,and the car answers with a respond message,and iPhone sends another poll message for added accuracy.Each of these messages carry a scrambled time stamp, or STS,which is a cryptographically-generatedand time-bounded packet,meaning that even a verified packet can only be acceptedfor the time slot slot which was used to generate this STS,providing extra security against replay and relay attacks.So, how do we bring all of this together?Well, each car defines a series of virtual zones.These zones have associated features that can be triggeredwhen a device with a valid and active keyis localized entering or exiting these zones.The wider zone activates welcome features,such as turning on lights or pre-warming the cabinwhen you approach the car.The zone closest to the car typicallyunlocks the door when you approach.And the lock zone secures the cars when you walk away.

So, how does a car detect you in these zones?Well, to localize the paired deviceinside these virtual zones, cars are equippedwith multiple UWB and BLE transceiversto ensure 360-degree coverage.When the user first approaches the car,your iPhone or Apple Watch is detected using BLE.Upon proximity detection, a communication channelwith the car is established.Upon connection, car authenticates the device,and a shared ranging key is derived on both sides.This operation takes place inside the Secure Element,and generates a key that is unique to each session.The derived key is used to start a secure-ranging sessionwith UWB transceivers, which allows the carto localize the device and map its trajectory.This is computed by the localization algorithmthat runs inside the car.We'll come back to it later.The car continues to map the trajectoryof the device as the user approaches the car.Based on the location and trajectory of the device,the car can decide to trigger welcome features,such as turning on lights or adjusting seats.And when the device is localized inside the unlock zone,the car can initiate unlock operationsbefore the user touches the door handle.With precise knowledge of whether the user's device isinside or outside the car, the engine only startswhen a device with a valid key is detected inside the car.And one of my favorite features,now you get to enjoy this UWB-based experienceeven when your phone is in power reserve mode.So, after a long day of hiking or backpacking, if you findthat your phone needs to be charged, there may still beenough power in the battery to get you back on the road.Now that you've seen how passive entry works,let's take a look at the remote keyless entry controls.Remote actions are usefulwhen you're farther from the car.You can use them by preheating the cabin in the winter,or find your car by honking the horn.And many actions can be triggered directlyfrom within Wallet.You can also use device to view information about the car,such as lock state, its fuel level,or battery-charging state.Remote actions are sent over Bluetooth LE.Since they are independent of UWB,they work even outside of UWB range.And finally, remote actions are standardizedat the Car Connectivity Consortium,so there's a common implementationfor all the cars and devices.For the best experience, we recommendthat automakers implement all the applicable remote actions,and not just remote lock and unlock.Let's look at how does Remote Keyless entry control works.To trigger a remote command, the device requests a challengefor the associated action, which is used as an inputto generate the device signature.The car verifies the device signature against the challenge,the associated action, and other information.If verification succeeds,the car performs the action and notifies the device.With digital car keys, cars can now automaticallypersonalize settings, like cabin temperature,seat position, seat heating, and more, by observingwhich digital key is approaching the driver's door.Today's car keys can support personalization, too,but they rely on drivers always knowingwhich key fob has which user setting.Now, with your car key on iPhone or Apple Watch,you don't have to worry about that.With precise trajectory and the knowledgeand the knowledge that the personal devicesare strongly tied to individual users,cars can personalize experienceswith greater confidence than ever before.And this works seamlessly,even when multiple users are approaching the car.To sum it up, we are excited about these new featuresand look forward to automakers launching UWB-based cars,so our users can start enjoying these featureson iPhones and Apple Watches equipped with U1 chip.Now, let's shift gears and talk about how automakerscan get on-boarded on the Apple platform,and some of the areas you will want to focus onwhen designing a car key solution.As part of this discussion, we'll cover system architecture,time synchronization, transceiver synchronization,and about building a good localization algorithm.Let's start with system architecture.Since the passive entry solution relies on reliableand accurate localization, it's essential that your systemhas good performance and low latency.As we saw earlier, each car is equippedwith multiple transceivers, and one of your first decisionswill be to select a suitable transceiver.First, you need to ensure that the transceiverscan provide sufficient link budget.Since the car key protocol is bi-directional,this means evaluating both the Tx-radiated powerand Rx sensitivity for good uplink and downlink performance.

By fine-tuning the antenna directivity, you can ensurethat transceiver's antenna supports the entire fieldof view for the required coverage.Antenna diversity is critical to achieve good operating range.For example, the use of two or more antennaswith different polarization or separation can helpimprove received signal strength.Finally, you need to ensure that the 3Dtime-of-flight measurements are highly accurate.Passive entry and localization features relyon time-of-flight in their calculations.Therefore, the accuracy must be within defined bounds,regardless of the approach angle.Since even well-designed individual transceivers canresult in insufficient coverage around the car,or coverage in unwanted areas if they are poorly installed,you will need to identify the best possible positionsto place transceivers around the carto provide necessary coverage and,at the same time, you will want to limit the numberof transceivers to a minimum to keep costs down.Be sure to consider height and orientation.In general, the greater the installation height,the farther the fading point, and better the range.This obviously has to be donewithin the design constraints of the car.Similarly, poor orientation can result in gaps in coverageor coverage in unwanted areas, such as above the car.Once you have the suitable transceiversand potential positions,the next step is to verify the system RF performance.Examine the radiation patternof the transceivers installed around the carto ensure a symmetrical coverage on all sides.You also want to pay attention to the maximum rangecovered by the system.This is important for long distance features,such as welcome lights or preconditioning the cabin.And most importantly, you will want to ensurethat the system has sufficient link margin buffer,to ensure an unlock operation can take place,regardless of damping caused by the human body,channel shadowing, fading, or other variables.Another area you need to consider is system latency.When you approach the car, a complex sequenceof events begins, starting with the setup of a BLE connection,authentication, and key derivation,followed by a secure-ranging session setup,where each UWB transceiver starts scanning,so the car can determine the location of the device.All these tasks must be completedbefore the user attempts to open the door.To keep the system latency within the required bounds,you will need a high-performance crypto processorfor authentication and key management.The bus system that connects your ECUto each transceiver must be of low latency;a slow bus can really impact system op performance.Finally, you will need a flexible software architecturethat allows you to support optimization techniques,be it multi-threaded applicationsor incorporation of time synchronization.Now, let's quickly talk about time synchronization.UWB transceivers needs to be actively scanningto detect ranging packets.Without good time synchronization,long-scanning windows are neededto reliably capture incoming packets.This consumes power and processing time.By implementing a precise time synchronizationacross your system, each transceiver can knowwhen incoming packets are expectedto an accuracy of tens of microsecond.By only scanning during these time windows,not only can you conserve power, and improve performancein multi-session and congested environments,but it also helps you localize the device faster.It does that by ensuring successful rangingfrom the very first detected cycleby keeping the transceivers tightly synchronized.Another important technique is transceiver synchronization.Sometimes, some transceivers may failto connect or become out of sync.By implementing transceiver synchronization,transceivers that are successfully synchronizedwith the device can share timing informationwith other transceivers in the car,and help them quickly connect,or even compute time-of-flight, even when they have failedto finish the full-ranging cycle.Last but not least, localization algorithm.One of the most important task when designinga passive-entry solution is the developmentof a localization algorithm that can pinpoint the locationof approaching devices relative to the car.A localization algorithm is a pieceof code running on your car's ECU.It collects device's distancefrom each connected UWB transceivers and process themto locate the iPhone or Apple Watch in space.There are many ways to do this.One simple example of this is true-range multi-lateration.The localization algorithm is one of the most crucial piecesof the solution that you need to develop.So, you will need to ensure that your localization algorithmis fast and accurate, whether it wants to followthe trajectory of the user as they approach the car,or determine whether the device is inside or outside the cabin.Speed, accuracy, and precision are the keyto a good localization solution, even when you are adding supportfor a single transceiver-based unlock system.You may also need to adjust your localization algorithmfor different cabin types and physical characteristicsof the car.Now, you've seen how the car key feature works.If you're interested in development,we recommend the following workflowfor an organic progressionof software development and qualification.First, focus on UWB interoperabilityand ensure that it follows the specification.We have created a tool that helps you test this.It also lets you progressively enable cryptographic operations,so you can develop your system in a step-by-step manner.Next, integrate the BLE layer for connection managementand owner pairing.Then, focus on secure-ranging management,which is crucial for passive entry.Last but not least, support remote actionsfor control at a distance.If you're interested in learning more,we encourage you to participatein the Car Connectivity Consortium,and enroll in the MFi Program for specific detailson working with iPhone and Apple Watch.The MFi Program is where you can obtain additional documentsand tools to assist in your development.Thank you, and have a great day![music]

## Code Samples

