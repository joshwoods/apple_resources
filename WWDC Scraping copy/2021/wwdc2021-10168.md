# Wwdc2021 10168

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Transcript

Build Mail app extensionsMeet MailKit: the best way to build amazing experiences on top of Mail. MailKit enables apps to easily and securely interact with the Mail app for macOS. We'll deep dive into the MailKit API, and show you how to create extensions for composing messages, message actions, secure email, and content blocking.ResourcesBuild Mail App ExtensionsIntroduction to WebKit Content BlockersMailKitHD VideoSD Video

Meet MailKit: the best way to build amazing experiences on top of Mail. MailKit enables apps to easily and securely interact with the Mail app for macOS. We'll deep dive into the MailKit API, and show you how to create extensions for composing messages, message actions, secure email, and content blocking.

Build Mail App Extensions

Introduction to WebKit Content Blockers

MailKit

HD VideoSD Video

HD Video

SD Video

Search this videoâ€¦Hello.Mail is a crucial application,and Mail app extensions will let you enhance itin some incredible new ways.I'm Abhilash, and along with my colleague, Seth,we are going to walk you throughhow to build great Mail app extensions.In macOS Monterey, we are shipping a new framework,MailKit, for building Mail extensions.These extensions are built on the same underlying foundationas other app extensionslike Safari app extensions and share sheet extensions.They are built with user privacy and security in mindin mind from the ground up.MailKit APIs are well documented and will be supportedacross major macOS releases.Like other app extensions, they can be in anyproperly signed Mac app,can be bundled in your existing apps,and can also be distributed in the App Store.Mail extensions are the future of extending Mail.Plug-ins will stop functioning in a future macOS release.We are introducing four new ways you can extendMail's user experience.First, compose extensions will allow new workflowswhen composing mail messages.Action extensions help people manage their inboxby providing custom rules on incoming messages.Content blocking extensions provide WebKit content blockersfor Mail messages.Finally, message security extensionscan provide further security by signing, encrypting,and decrypting messages when people send and receive mail.This provides a full suite of Mail extensionsto help compose messages,take action on incoming messages,block undesired mail contentand provide encryption and decryption.They are easy to write.They are very powerful.They are stable and will continue to workas the OS and Mail app change over time.Before we dive in to build a Mail extensionwith these capabilities,let's go through an example of one in use.Imagine I am working for a large multinational corporationwhere all my colleagues are collaboratingon multiple highly secretive projects.To help preserve secrecy of our projects,we are using a Big Secrecy Extensionthat validates recipients of a mail message.I want to send a message to my colleague Sethfor an update on our new remote office on Mars.The first thing you notice is a buttonfor the Big Secrecy Extension in the Mail compose window.This extension provides a list of projectsI'm working on, and I pick Mars Remote Office.I type in a subject and Seth's email.The extension was able to validatethat Seth is disclosed on this projectand annotates his email address with a blue checkmark.Of course, for a project of this importance, we do want to keepour manager, Mikey, informed,so I'm going to add him.Hmm, looks like Mikey is not disclosedabout our new remote office.Let me remove him and send the message.Oh, I received a reply from Seth,and it shows up in red in the message list.This is because the Big Secrecy Extensionperformed an action to color messagesregarding the Mars project as red.There is also an icon indicating that an extensionperformed an action on this message.When I go to view the message,there is an icon in the Message Viewerindicating that the message from Seth was encryptedand successfully decrypted by the Big Secrecy Extension.Now let's dive in and learn how you can leverage MailKit APIsto build powerful extensions like the Big Secrecy Extension.Let's start with compose extensions which can providenew features for users while composing messages.In macOS Monterey, there are four waysyour extension can interact with a Mail compose window.An extension can validate recipient email addressesas the user is editing them,provide a view controller with additional contextabout the message being composed,set additional headers on outgoing messages,or alert the user of errors in the message before it is sent.Let's walk through how to build a compose extension.You start by adding a new target to an existing macOS App.In Xcode 13, there is a new Mail Extension templatethat will get you started on creatinga new Mail Extension target.During setup, Xcode will allow you to choosethe type of extension you want to create.For a compose extension, you selectthe Include Compose Session Handler capability.In the Info.plist for the extension target,you must also specify an icon and a descriptive tooltipin the MEComposeSession dictionary.Mail will use the icon and tooltipto display a toolbar button in the compose window.Now let's look at the implementationfor your extension's principal class.The principal class of your extension must conformto the MEExtension protocol.MEExtension exposes optional handler methodsfor each of the four types of extensions.For a compose extension, your principal classmust implement the handler for session methodand return an instance that conformsto the MEComposeSessionHandler protocol.Methods in MEComposeSessionHandlerare called by Mail to inform the extensionabout a Compose window's life cycle.The first method that will be calledis ComposeSessionDidBegin,which happens when a new compose window is opened.There are also methods that are called based on user actionslike editing recipient email addresses or sending an email.All the methods in MEComposeSessionHandlerhave a MEComposeSession argumentwhich provides information about a compose window.Mail creates a unique MEComposeSession instancefor every Mail compose window.It has a MEMessage property that exposes various detailsof the message being edited.You can utilize this information to customizethe responses that you provide when Mail callsyour extension's MEComposeSessionHandler methods.Let's look at an example of how you can do thisto annotate recipient email addresses.Mail will call your ComposeSessionHandler'sannotateAddressesForSessionwhenever recipient addresses are edited.In this example, we are using the allRecipientAddressesproperty of MEMessage to provide an error annotationfor emails that are not matching seth@example.com.Compose extensions can also provide a view controllerthat Mail will display in the compose window.Your view controller can provide valuable context to the userby customizing the view controllerfor each compose window.Your extension's view controller must bea subclass of MEExtensionViewController.Mail will request an instance of this view controllerby calling the viewControllerForSession methodof MEComposeSessionHandler.You can learn more about these compose APIsin the MailKit documentationand get started on building new workflows.Now let's talk about Mail action extensions.Action extensions perform actions on incoming messagesto help users manage their inbox.In macOS Monterey, we are exposing three typesof actions an extension can perform on a new message.An action extension can modify read statusand flags of incoming messages,move messages to system mailboxessuch as Junk, Trash or Archive,or apply colors to messages when they are displayedin the message list.You can add support for message actionsby selecting the Include Message Action Handler capabilitywhen you are creating the Mail extension target.Similar to the compose extension,for action extensions, your principal classmust return a message action handlerby implementing a handler for message actions.In this example, the principal classis also acting as an action handlerby adopting MEMessageActionHandler.Your action extension must implementMEMessageActionHandler's decideAction for message method.DecideAction for message is calledwith a MEMessage argument.Here, we are coloring the message redby checking if the headers property contains "Mars."A few things to note about action handlers.Mail calls your handler's decideAction for messagefor every new message that it downloadsbefore it is even visible in the inbox.The first time Mail calls your extension'sdecideAction for message method,the MEMessage instance will have only a subsetof the message headers.You can provide a decision such as coloring the messagebased on the available headers.Once Mail applies the action on the message,it will be visible in the inbox.In some cases, you will need the complete body and headersof the message to return an appropriate decision.In this case, your decideAction for message methodcan return an invokeAgainWithBody decision.This will cause Mail to fetch the completemessage body and headers before invoking your handler'sdecideAction for message method again.You can now return a more accuratedecision before it is visible in the inbox.Now I am going to turn it over to Seth, who will to show youhow to build content blocking and security extensions.Thanks, Abhilash.First, I am going to walk you throughhow to add a content blocker extension.Content blockers hook into Mail's WebKit configurationfor its message view to allow extensions to blockloading content based on triggers in the message's HTML.This allows extensions to block loading contentbased on criteria of the HTML such as the URL.In this example, the extension was ableto block loading the remote imagesbased on the rules in the extension's content rule list.You can add support for content blockingby selecting Include Content Blockerwhen you are creating the Mail extension target.Next, you return a handler for the content blockerin your extension's principal class.In this example, the principal class is adoptingthe MEContentBlocker protocol so it returns self.The content rule lists are specifiedusing the same syntax as Safari content blockers.So if you already have a content rule listfor your Safari content blocker extension,you can use the same rules for a Mail app extension as well.You can get more information on how to createa content rule list by referencingthe "Introduction to Webkit Content Blockers" documentation.Once your rule list is complete, you can provide it to Mailby returning it in the contentRulesJSON method.This method expects a Data encodingof the Content Rule List JSON.And that's it for Mail content blockers.Lastly, we're going to go over Message security extensions.The Message security capability gives extensionsthe ability to encode and decode encrypted messages.They can also sign messages and provide a wayto view certificates of signed messages.You can add support for message securityby selecting Include Message Security Handlerwhen you're creating the Mail extension target.Next, you need to return a handler from your extensionthat supports the MEMessageSecurityHandlerprotocol in our extension's principal class.In this example, the extension's principal class is also adoptingthe MEMessageSecurityHandler protocol,so it returns self.Now let's take a look at how to encode messagesthat are being composed.Encoding a message is broken down into two parts.The first helps drive the UI as the message is composed.This lets the extension show if it has the abilityto sign and encrypt the current message.The next part is to actually encryptand sign the message as it is being sent.As a message is composed, Mail will send the message,including the sender and current list of recipientsto the extension.The extension can then determine if it hasthe ability to sign and encrypt the message.Based on what is returned by the extension,Mail will highlight the Lock and Certificate icons,depending on if the message can be signed and encrypted.Each time the sender or recipients change,Mail will call the getEncodingStatus methodon the extension's message security handler.The extension will verify if it can signand encrypt the message and return to Mailthe current encoding status.The example here is importing an ExampleEncoderto do the actual work of checking the encoding statusof the message.The Message Security Handlerreturns the status once available.Next, when the message is sent, Mail will takethe RFC822 message data and pass it to the extension.The extension will sign and encrypt the messageas needed, and return the signedand encrypted RFC822 data back to Mail.Mail will then send this data to the outgoing server.When the message is ready to send,Mail passes the current message using the encodeMessage methodto the extension's Message Security Handler.The extension's Message Security Handlerwill return the encoded message.Again, in this example, we're using an ExampleEncoderto do the actual work of encoding the message.The Message Security Handler returns encoded message.Message decoding works similarly but in reverse.When the message is viewed, Mail will sendthe encoded RFC822 message data to the extension.The extension will decode the message into nonencrypted,or signed, RFC822 data and return that back to Mail.Mail will then display the decoded message.When Mail is ready to decode the message,it will call into the Extension's Security Handlercalling the decodedMessage method.If the extension has the ability to decode the message,it will do so and return the decoded RFC822 message.If the extension is not needed for decoding the message,it should quickly return nil.When a message is viewed, it can be determinedif it is signed and encrypted.For signed messages, the signer certificatecan be clicked next to the signer labelto view the sender's certificate information.Mail allows extensions to provide its own view controllerto render this certificate information.As part of the decoded Mail message, the extension hasthe ability to return a set of message signers.The label provided will be shown as the signerin the message view.The extension can also populate the context propertywith any information it might needfor displaying the signing certificate.When the certificate icon is clicked,Mail requests a ViewController from the extensionand passes it the set of signers for the current message.These signers are what was returned to Mailby the extension when the message was originally decoded.The view controller must be a subclassof MEExtensionViewController.And that's it for message security extensions.Mail extensions are a powerful new wayfor you to enhance the Mail experience.We're excited to see how you leveragethese Mail capabilities to build awesome new products,and we want to hear your feedback.So send us an email or post a messageon our Developer Forums.These examples show the power of Mail app extensions.We made a compose extension that verified recipients,an action extension that colored incoming messages.We saw a content blocker blocking remote images.Last, we saw how easy it is to addcustom encryption and decryption to Mail.In this video, we covered how to build Mail app extensions.We're looking forward to see how you extend Mailto do some really cool things.So get out there and build some awesome new Mail app extensions.Thanks for watching.

Hello.Mail is a crucial application,and Mail app extensions will let you enhance itin some incredible new ways.I'm Abhilash, and along with my colleague, Seth,we are going to walk you throughhow to build great Mail app extensions.In macOS Monterey, we are shipping a new framework,MailKit, for building Mail extensions.These extensions are built on the same underlying foundationas other app extensionslike Safari app extensions and share sheet extensions.They are built with user privacy and security in mindin mind from the ground up.MailKit APIs are well documented and will be supportedacross major macOS releases.Like other app extensions, they can be in anyproperly signed Mac app,can be bundled in your existing apps,and can also be distributed in the App Store.Mail extensions are the future of extending Mail.Plug-ins will stop functioning in a future macOS release.We are introducing four new ways you can extendMail's user experience.First, compose extensions will allow new workflowswhen composing mail messages.Action extensions help people manage their inboxby providing custom rules on incoming messages.Content blocking extensions provide WebKit content blockersfor Mail messages.Finally, message security extensionscan provide further security by signing, encrypting,and decrypting messages when people send and receive mail.This provides a full suite of Mail extensionsto help compose messages,take action on incoming messages,block undesired mail contentand provide encryption and decryption.They are easy to write.They are very powerful.They are stable and will continue to workas the OS and Mail app change over time.Before we dive in to build a Mail extensionwith these capabilities,let's go through an example of one in use.Imagine I am working for a large multinational corporationwhere all my colleagues are collaboratingon multiple highly secretive projects.To help preserve secrecy of our projects,we are using a Big Secrecy Extensionthat validates recipients of a mail message.I want to send a message to my colleague Sethfor an update on our new remote office on Mars.The first thing you notice is a buttonfor the Big Secrecy Extension in the Mail compose window.This extension provides a list of projectsI'm working on, and I pick Mars Remote Office.I type in a subject and Seth's email.The extension was able to validatethat Seth is disclosed on this projectand annotates his email address with a blue checkmark.Of course, for a project of this importance, we do want to keepour manager, Mikey, informed,so I'm going to add him.Hmm, looks like Mikey is not disclosedabout our new remote office.Let me remove him and send the message.

Oh, I received a reply from Seth,and it shows up in red in the message list.This is because the Big Secrecy Extensionperformed an action to color messagesregarding the Mars project as red.There is also an icon indicating that an extensionperformed an action on this message.When I go to view the message,there is an icon in the Message Viewerindicating that the message from Seth was encryptedand successfully decrypted by the Big Secrecy Extension.

Now let's dive in and learn how you can leverage MailKit APIsto build powerful extensions like the Big Secrecy Extension.Let's start with compose extensions which can providenew features for users while composing messages.In macOS Monterey, there are four waysyour extension can interact with a Mail compose window.

An extension can validate recipient email addressesas the user is editing them,provide a view controller with additional contextabout the message being composed,set additional headers on outgoing messages,or alert the user of errors in the message before it is sent.

Let's walk through how to build a compose extension.

You start by adding a new target to an existing macOS App.In Xcode 13, there is a new Mail Extension templatethat will get you started on creatinga new Mail Extension target.During setup, Xcode will allow you to choosethe type of extension you want to create.For a compose extension, you selectthe Include Compose Session Handler capability.

In the Info.plist for the extension target,you must also specify an icon and a descriptive tooltipin the MEComposeSession dictionary.Mail will use the icon and tooltipto display a toolbar button in the compose window.Now let's look at the implementationfor your extension's principal class.The principal class of your extension must conformto the MEExtension protocol.MEExtension exposes optional handler methodsfor each of the four types of extensions.For a compose extension, your principal classmust implement the handler for session methodand return an instance that conformsto the MEComposeSessionHandler protocol.Methods in MEComposeSessionHandlerare called by Mail to inform the extensionabout a Compose window's life cycle.The first method that will be calledis ComposeSessionDidBegin,which happens when a new compose window is opened.There are also methods that are called based on user actionslike editing recipient email addresses or sending an email.

All the methods in MEComposeSessionHandlerhave a MEComposeSession argumentwhich provides information about a compose window.Mail creates a unique MEComposeSession instancefor every Mail compose window.It has a MEMessage property that exposes various detailsof the message being edited.You can utilize this information to customizethe responses that you provide when Mail callsyour extension's MEComposeSessionHandler methods.Let's look at an example of how you can do thisto annotate recipient email addresses.

Mail will call your ComposeSessionHandler'sannotateAddressesForSessionwhenever recipient addresses are edited.In this example, we are using the allRecipientAddressesproperty of MEMessage to provide an error annotationfor emails that are not matching seth@example.com.Compose extensions can also provide a view controllerthat Mail will display in the compose window.Your view controller can provide valuable context to the userby customizing the view controllerfor each compose window.Your extension's view controller must bea subclass of MEExtensionViewController.Mail will request an instance of this view controllerby calling the viewControllerForSession methodof MEComposeSessionHandler.

You can learn more about these compose APIsin the MailKit documentationand get started on building new workflows.Now let's talk about Mail action extensions.Action extensions perform actions on incoming messagesto help users manage their inbox.In macOS Monterey, we are exposing three typesof actions an extension can perform on a new message.An action extension can modify read statusand flags of incoming messages,move messages to system mailboxessuch as Junk, Trash or Archive,or apply colors to messages when they are displayedin the message list.You can add support for message actionsby selecting the Include Message Action Handler capabilitywhen you are creating the Mail extension target.Similar to the compose extension,for action extensions, your principal classmust return a message action handlerby implementing a handler for message actions.In this example, the principal classis also acting as an action handlerby adopting MEMessageActionHandler.Your action extension must implementMEMessageActionHandler's decideAction for message method.DecideAction for message is calledwith a MEMessage argument.Here, we are coloring the message redby checking if the headers property contains "Mars."A few things to note about action handlers.Mail calls your handler's decideAction for messagefor every new message that it downloadsbefore it is even visible in the inbox.The first time Mail calls your extension'sdecideAction for message method,the MEMessage instance will have only a subsetof the message headers.You can provide a decision such as coloring the messagebased on the available headers.Once Mail applies the action on the message,it will be visible in the inbox.In some cases, you will need the complete body and headersof the message to return an appropriate decision.In this case, your decideAction for message methodcan return an invokeAgainWithBody decision.This will cause Mail to fetch the completemessage body and headers before invoking your handler'sdecideAction for message method again.You can now return a more accuratedecision before it is visible in the inbox.Now I am going to turn it over to Seth, who will to show youhow to build content blocking and security extensions.Thanks, Abhilash.First, I am going to walk you throughhow to add a content blocker extension.Content blockers hook into Mail's WebKit configurationfor its message view to allow extensions to blockloading content based on triggers in the message's HTML.This allows extensions to block loading contentbased on criteria of the HTML such as the URL.In this example, the extension was ableto block loading the remote imagesbased on the rules in the extension's content rule list.You can add support for content blockingby selecting Include Content Blockerwhen you are creating the Mail extension target.Next, you return a handler for the content blockerin your extension's principal class.In this example, the principal class is adoptingthe MEContentBlocker protocol so it returns self.The content rule lists are specifiedusing the same syntax as Safari content blockers.So if you already have a content rule listfor your Safari content blocker extension,you can use the same rules for a Mail app extension as well.You can get more information on how to createa content rule list by referencingthe "Introduction to Webkit Content Blockers" documentation.Once your rule list is complete, you can provide it to Mailby returning it in the contentRulesJSON method.This method expects a Data encodingof the Content Rule List JSON.And that's it for Mail content blockers.Lastly, we're going to go over Message security extensions.The Message security capability gives extensionsthe ability to encode and decode encrypted messages.They can also sign messages and provide a wayto view certificates of signed messages.You can add support for message securityby selecting Include Message Security Handlerwhen you're creating the Mail extension target.Next, you need to return a handler from your extensionthat supports the MEMessageSecurityHandlerprotocol in our extension's principal class.In this example, the extension's principal class is also adoptingthe MEMessageSecurityHandler protocol,so it returns self.Now let's take a look at how to encode messagesthat are being composed.Encoding a message is broken down into two parts.The first helps drive the UI as the message is composed.This lets the extension show if it has the abilityto sign and encrypt the current message.The next part is to actually encryptand sign the message as it is being sent.As a message is composed, Mail will send the message,including the sender and current list of recipientsto the extension.The extension can then determine if it hasthe ability to sign and encrypt the message.Based on what is returned by the extension,Mail will highlight the Lock and Certificate icons,depending on if the message can be signed and encrypted.

Each time the sender or recipients change,Mail will call the getEncodingStatus methodon the extension's message security handler.The extension will verify if it can signand encrypt the message and return to Mailthe current encoding status.The example here is importing an ExampleEncoderto do the actual work of checking the encoding statusof the message.The Message Security Handlerreturns the status once available.Next, when the message is sent, Mail will takethe RFC822 message data and pass it to the extension.The extension will sign and encrypt the messageas needed, and return the signedand encrypted RFC822 data back to Mail.Mail will then send this data to the outgoing server.

When the message is ready to send,Mail passes the current message using the encodeMessage methodto the extension's Message Security Handler.The extension's Message Security Handlerwill return the encoded message.Again, in this example, we're using an ExampleEncoderto do the actual work of encoding the message.The Message Security Handler returns encoded message.Message decoding works similarly but in reverse.When the message is viewed, Mail will sendthe encoded RFC822 message data to the extension.The extension will decode the message into nonencrypted,or signed, RFC822 data and return that back to Mail.Mail will then display the decoded message.

When Mail is ready to decode the message,it will call into the Extension's Security Handlercalling the decodedMessage method.If the extension has the ability to decode the message,it will do so and return the decoded RFC822 message.If the extension is not needed for decoding the message,it should quickly return nil.When a message is viewed, it can be determinedif it is signed and encrypted.For signed messages, the signer certificatecan be clicked next to the signer labelto view the sender's certificate information.Mail allows extensions to provide its own view controllerto render this certificate information.As part of the decoded Mail message, the extension hasthe ability to return a set of message signers.The label provided will be shown as the signerin the message view.The extension can also populate the context propertywith any information it might needfor displaying the signing certificate.When the certificate icon is clicked,Mail requests a ViewController from the extensionand passes it the set of signers for the current message.These signers are what was returned to Mailby the extension when the message was originally decoded.The view controller must be a subclassof MEExtensionViewController.And that's it for message security extensions.Mail extensions are a powerful new wayfor you to enhance the Mail experience.We're excited to see how you leveragethese Mail capabilities to build awesome new products,and we want to hear your feedback.So send us an email or post a messageon our Developer Forums.These examples show the power of Mail app extensions.We made a compose extension that verified recipients,an action extension that colored incoming messages.We saw a content blocker blocking remote images.Last, we saw how easy it is to addcustom encryption and decryption to Mail.In this video, we covered how to build Mail app extensions.We're looking forward to see how you extend Mailto do some really cool things.So get out there and build some awesome new Mail app extensions.Thanks for watching.

## Code Samples

