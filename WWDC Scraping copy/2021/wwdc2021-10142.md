# Wwdc2021 10142

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Transcript

Code

Transition media gaplessly with HLSDiscover how you can create streaming media content that seamlessly transitions between episodes, songs, scenes, and individual resources. With gapless HLS playback, you can stitch together multiple pieces of content on the fly to create customized workouts, design interactive content, tell compelling stories, and more. We'll show you how you can provide faithful continuity for streaming music, event recordings, and pre-recorded video and provide a captivating viewing experience within your app.ResourcesHTTP Live Streaming - OverviewHD VideoSD VideoRelated VideosWWDC21Explore HLS variants in AVFoundation

Discover how you can create streaming media content that seamlessly transitions between episodes, songs, scenes, and individual resources. With gapless HLS playback, you can stitch together multiple pieces of content on the fly to create customized workouts, design interactive content, tell compelling stories, and more. We'll show you how you can provide faithful continuity for streaming music, event recordings, and pre-recorded video and provide a captivating viewing experience within your app.

HTTP Live Streaming - Overview

HD VideoSD Video

HD Video

SD Video

Explore HLS variants in AVFoundation

Search this video…♪ Bass music playing ♪♪Simon Goldrei: Hello.This session is all abouthow to transition media gaplessly with HLS.I'm Simon and I'm a member of the Streaming Media teamhere at Apple!Do you utilize AVQueuePlayer,or would like to offer your customersa seamless, Up Next-style playback of HLS itemsin your application?Do you want to present your media with the continuitythat the producer intended?Can we support our customers by providing an experienceto enjoy our media for longer?If yes, then you've tuned in to the best sessionto learn how you can now transition HLS items gaplessly.Here's our agenda.We'll survey some of the engaging media experiencesyou can deliver with this new feature,I'll detail the media authoring requirements,I'll step through some playlist exampleshighlighting best practices,and we'll end with a demo.The benefits of transitioning between HLS-backed AVPlayerItemsin an AVQueuePlayer are straightforward.Until now, the point of transitioncould be a little jarring;anything from an audible glitch to a momentary visual hiccupor even an indication of indeterminate buffering.Gapless item transitions maintain a bondthat your application provides between the customerand the content.Perhaps you recall the phrase "don't touch that dial."You can build an episodic treatmentthat seamlessly transitions from the end of one episodeinto the start of another.Gapless transitions permit the ability to replicatethe seamless track-to-track album experiencesthat we've long enjoyed.When doing this,we're delivering a more correct reproductionof what may have been live or intentionally authored.We can deliver an experience that is unbrokenand uninterrupted.We can replicate linear programming.But we can also providea dynamic and perhaps even interactive experiencethat takes the viewer from one task or sceneand directly segues into the next.Consider a transition between a set of workoutsor other instructional media.With gapless transitions we can now, programmatically,stitch scenes of an audiovisual sequencewhile maintaining accurate continuity.You can add reps......or add a cooldown, to the workout.We can achieve all of thiswhile still delivering media with all the benefitsof adaptive bitrate media streaming over HTTP.Of course, we use this, too!New features of Apple Music deliver content via HLSand achieve a gapless transition between each song.We're very excited to bring this to our customers,and we'd like to offer this to your customers, too.Let's now take detailed look at the authoring requirementsyou need to incorporate to affect the same item transitionsin your HLS content.By providing -- in your HLS manifests --variants that offer audio-format continuitybetween sequential items,you're enabling a gapless transition.Your content should provide variants that matchthe following audio media traits:the use of FairPlay Streaming, the audio codec --specified by the codecs attribute of the Stream tag --and the channel count,as specified by the Channels attribute of the Media tag.Note that if you decide to offer audio renditions,at different sample rates and bit depth,you may inhibit the gapless transition.The same advice to provide a matchand maintain continuity applies to these traits, too.Which is to say, to achieve a gapless transition,be sure to offer equivalent audio media in each variantfor consecutively enqueued items.Finally, when authoring your media,please adhere to CMAF authoring guidance.CMAF stands for "common media application format."In this MPEG specification,there is a specific recommendationto use an edit list to signal the presence of primingand remainder frames.Let's now look at a simple exampleby inspecting the master variant playlistsof two candidate items.In this HLS manifestI've offered four audiovisual variants:a pair of 720p variants and a pair of 1080p variants.Within each pair, I offer a variant encodedwith the High-Efficiency Advanced Audio Codec, HE_AAC,and another with AAC Low Complexity, or AAC_LC.In this example, consider that playback conditions supportthe selection of the 720p video paired with HE_AAC.As playback nears the end, the AVQueuePlayer will,at least initially, select the similarly encoded variantoffered in the subsequent item.This is true even if network conditionsnow support a higher-quality tier.Servicing the gapless transition is a higher prioritythan choosing a high quality when transitioning gaplessly.As playback proceeds, the adaptive bitrate heuristicsare evaluated and, if the conditions persist,the player will seamlessly switch to that higher quality.Fantastic!Now suppose we didn't offer HE_AAC in item two.In that case, the AVQueuePlayeris unable to maintain audio continuityand the gapless transition but is free to selectthe most appropriate initial variantfor the playback conditions.Let's say that we have authored our contentto support a gapless transition.In that case, we should remind ourselveshow to use an AVQueuePlayer.Here we have a short code snippet.We create two AVPlayerItems and enqueue them, in order,ahead of playback.Note that our items source from two different URLs.After creating our AVQueuePlayer,we can use the "insert after" methodto inform the queue player of the intended sequence.All that's left is to message "play".An advanced technique I'd like to share with youpermits the use of a single asset.From this asset,you can instantiate multiple AVPlayerItems.We can define different in and out pointson each distinct AVPlayerItem,prior to enqueuing in our AVQueuePlayer.Using the AVPlayerItem seekToTime method,we can define our in point.Then we can define our out point with forwardPlaybackEndTime.Here's an illustration of this concept.Item one, two, and three are all sourced from the same AVAsset,consisting of the same three scenes.They are distinct in that I have cued eachwith different in points, using seekToTime,and defined distinct out points, using forwardPlaybackEndTime.Now I can enqueue these three otherwise identical itemsinto my AVQueuePlayer, and what I achieveis a customized, dynamic sequence.Now let's see and hear gapless transitions in actionwith a demo.In this demo, we will interactively stitch togetherthree workout video streams.I've left the AVKit controls visible in eachso that you can really see these are distinct stream resources.I'll start by showing a seamless playback of all threeand then we'll edit the sequence interactively.In your software, you can imagine offering the same --or perhaps perform the reordering -- programmatically.Right! Let's do a warm-up.♪ Energetic electronic music ♪♪Ready or not? Let's do a hills run.♪ Lively hip-hop music ♪♪That's it! We're done. It's time for a cooldown.♪ Calm electronic music ♪♪I can break a sweat just watching that.I'm tempted to skip straight to the "That's it, we're done,"and skip the hills run.There's a lot of that here in San Francisco.To do this, let's edit the order of our exercise sets.I'll move the hills exercise to the top.This allows me to just do the warm-upthen immediately and gaplessly segue into the cooldown.Then I'll start by selecting the warm-up,now in the second position, as my first workout.Right! Let's do a warm-up.♪ Energetic electronic music ♪♪That's it! We're done. It's time for a cooldown.♪ Calm electronic music ♪♪Let's summarize the key pointsthat we've learned in this session.We've learned that to achieve gapless transitions using HLS,we must provide variants in each itemthat have matching audio formats.Then we saw how easy it is to instruct an AVQueuePlayerto perform the gapless transitionjust by enqueuing items in sequence.We have one related session,where we introduce new APIs for variant discovery.You may find that session useful if your software or servicecannot guarantee the items of matching audio format.I hope you've enjoyed this sessionand enjoy the rest of this WWDC 2021.Thank you.♪

♪ Bass music playing ♪♪Simon Goldrei: Hello.This session is all abouthow to transition media gaplessly with HLS.I'm Simon and I'm a member of the Streaming Media teamhere at Apple!Do you utilize AVQueuePlayer,or would like to offer your customersa seamless, Up Next-style playback of HLS itemsin your application?Do you want to present your media with the continuitythat the producer intended?Can we support our customers by providing an experienceto enjoy our media for longer?If yes, then you've tuned in to the best sessionto learn how you can now transition HLS items gaplessly.Here's our agenda.We'll survey some of the engaging media experiencesyou can deliver with this new feature,I'll detail the media authoring requirements,I'll step through some playlist exampleshighlighting best practices,and we'll end with a demo.The benefits of transitioning between HLS-backed AVPlayerItemsin an AVQueuePlayer are straightforward.Until now, the point of transitioncould be a little jarring;anything from an audible glitch to a momentary visual hiccupor even an indication of indeterminate buffering.Gapless item transitions maintain a bondthat your application provides between the customerand the content.Perhaps you recall the phrase "don't touch that dial."You can build an episodic treatmentthat seamlessly transitions from the end of one episodeinto the start of another.Gapless transitions permit the ability to replicatethe seamless track-to-track album experiencesthat we've long enjoyed.When doing this,we're delivering a more correct reproductionof what may have been live or intentionally authored.We can deliver an experience that is unbrokenand uninterrupted.We can replicate linear programming.But we can also providea dynamic and perhaps even interactive experiencethat takes the viewer from one task or sceneand directly segues into the next.Consider a transition between a set of workoutsor other instructional media.With gapless transitions we can now, programmatically,stitch scenes of an audiovisual sequencewhile maintaining accurate continuity.You can add reps......or add a cooldown, to the workout.We can achieve all of thiswhile still delivering media with all the benefitsof adaptive bitrate media streaming over HTTP.Of course, we use this, too!New features of Apple Music deliver content via HLSand achieve a gapless transition between each song.We're very excited to bring this to our customers,and we'd like to offer this to your customers, too.Let's now take detailed look at the authoring requirementsyou need to incorporate to affect the same item transitionsin your HLS content.By providing -- in your HLS manifests --variants that offer audio-format continuitybetween sequential items,you're enabling a gapless transition.Your content should provide variants that matchthe following audio media traits:the use of FairPlay Streaming, the audio codec --specified by the codecs attribute of the Stream tag --and the channel count,as specified by the Channels attribute of the Media tag.Note that if you decide to offer audio renditions,at different sample rates and bit depth,you may inhibit the gapless transition.The same advice to provide a matchand maintain continuity applies to these traits, too.Which is to say, to achieve a gapless transition,be sure to offer equivalent audio media in each variantfor consecutively enqueued items.Finally, when authoring your media,please adhere to CMAF authoring guidance.CMAF stands for "common media application format."In this MPEG specification,there is a specific recommendationto use an edit list to signal the presence of primingand remainder frames.Let's now look at a simple exampleby inspecting the master variant playlistsof two candidate items.In this HLS manifestI've offered four audiovisual variants:a pair of 720p variants and a pair of 1080p variants.Within each pair, I offer a variant encodedwith the High-Efficiency Advanced Audio Codec, HE_AAC,and another with AAC Low Complexity, or AAC_LC.In this example, consider that playback conditions supportthe selection of the 720p video paired with HE_AAC.As playback nears the end, the AVQueuePlayer will,at least initially, select the similarly encoded variantoffered in the subsequent item.This is true even if network conditionsnow support a higher-quality tier.Servicing the gapless transition is a higher prioritythan choosing a high quality when transitioning gaplessly.As playback proceeds, the adaptive bitrate heuristicsare evaluated and, if the conditions persist,the player will seamlessly switch to that higher quality.Fantastic!Now suppose we didn't offer HE_AAC in item two.In that case, the AVQueuePlayeris unable to maintain audio continuityand the gapless transition but is free to selectthe most appropriate initial variantfor the playback conditions.Let's say that we have authored our contentto support a gapless transition.In that case, we should remind ourselveshow to use an AVQueuePlayer.Here we have a short code snippet.We create two AVPlayerItems and enqueue them, in order,ahead of playback.Note that our items source from two different URLs.After creating our AVQueuePlayer,we can use the "insert after" methodto inform the queue player of the intended sequence.All that's left is to message "play".

An advanced technique I'd like to share with youpermits the use of a single asset.From this asset,you can instantiate multiple AVPlayerItems.We can define different in and out pointson each distinct AVPlayerItem,prior to enqueuing in our AVQueuePlayer.Using the AVPlayerItem seekToTime method,we can define our in point.Then we can define our out point with forwardPlaybackEndTime.Here's an illustration of this concept.Item one, two, and three are all sourced from the same AVAsset,consisting of the same three scenes.They are distinct in that I have cued eachwith different in points, using seekToTime,and defined distinct out points, using forwardPlaybackEndTime.Now I can enqueue these three otherwise identical itemsinto my AVQueuePlayer, and what I achieveis a customized, dynamic sequence.Now let's see and hear gapless transitions in actionwith a demo.In this demo, we will interactively stitch togetherthree workout video streams.I've left the AVKit controls visible in eachso that you can really see these are distinct stream resources.I'll start by showing a seamless playback of all threeand then we'll edit the sequence interactively.In your software, you can imagine offering the same --or perhaps perform the reordering -- programmatically.Right! Let's do a warm-up.♪ Energetic electronic music ♪♪Ready or not? Let's do a hills run.♪ Lively hip-hop music ♪♪That's it! We're done. It's time for a cooldown.♪ Calm electronic music ♪♪I can break a sweat just watching that.I'm tempted to skip straight to the "That's it, we're done,"and skip the hills run.There's a lot of that here in San Francisco.To do this, let's edit the order of our exercise sets.I'll move the hills exercise to the top.This allows me to just do the warm-upthen immediately and gaplessly segue into the cooldown.Then I'll start by selecting the warm-up,now in the second position, as my first workout.Right! Let's do a warm-up.♪ Energetic electronic music ♪♪That's it! We're done. It's time for a cooldown.♪ Calm electronic music ♪♪Let's summarize the key pointsthat we've learned in this session.We've learned that to achieve gapless transitions using HLS,we must provide variants in each itemthat have matching audio formats.Then we saw how easy it is to instruct an AVQueuePlayerto perform the gapless transitionjust by enqueuing items in sequence.We have one related session,where we introduce new APIs for variant discovery.You may find that session useful if your software or servicecannot guarantee the items of matching audio format.I hope you've enjoyed this sessionand enjoy the rest of this WWDC 2021.Thank you.♪

6:12 -create two items, enqueue in order and play gaplessly

## Code Samples

```swift
// create two items, enqueue in order, 


// and play gaplessly



let
 item1 
=
 
AVPlayerItem
(url: url1)

let
 item2 
=
 
AVPlayerItem
(url: url2)


let
 player 
=
 
AVQueuePlayer
()
	
player.insert(item1, after: 
nil
)
player.insert(item2, after: item1)

player.play()
```

