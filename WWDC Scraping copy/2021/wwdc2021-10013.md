# Wwdc2021 10013

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Transcript

Code

Build light and fast App ClipsApp Clips give people the power to discover and download a small part of your app at a moment's notice to complete tasks and transactions. Explore tips and best practices to help you create compact App Clips that emphasize modern features and elegant design. Learn how you can build reliable and secure App Clips to ensure that people can always access your experience when scanning a physical App Clip Code or viewing it through your website. And we'll take you through specific strategies for testing an App Clip before releasing it to the world.ResourcesReducing your app’s sizeTesting the launch experience of your App ClipHD VideoSD VideoRelated VideosWWDC22What's new in App ClipsWWDC21Explore ARKit 5What's new in App ClipsWWDC20Configure and link your App ClipsWhat's new in App Store ConnectWhat's new in Universal LinksWWDC19Optimizing Storage in Your AppWWDC18Optimizing App Assets

App Clips give people the power to discover and download a small part of your app at a moment's notice to complete tasks and transactions. Explore tips and best practices to help you create compact App Clips that emphasize modern features and elegant design. Learn how you can build reliable and secure App Clips to ensure that people can always access your experience when scanning a physical App Clip Code or viewing it through your website. And we'll take you through specific strategies for testing an App Clip before releasing it to the world.

Reducing your app’s size

Testing the launch experience of your App Clip

HD VideoSD Video

HD Video

SD Video

What's new in App Clips

Explore ARKit 5

What's new in App Clips

Configure and link your App Clips

What's new in App Store Connect

What's new in Universal Links

Optimizing Storage in Your App

Optimizing App Assets

Search this video…♪ ♪Hello and welcome.I’m Brian Goldberg, an engineer on the App Clips team.I can’t wait to show you some great tipsand techniques to build light and fast App Clips.Let’s get started.App Clips are a great way for your customersto quickly access and experience what your app has to offer.An App Clip is a small part of your appthat’s discoverable and downloadedat the moment it’s needed.App Clips are deeply integrated into the OS.They can be invoked in Safari and Messagesas well as out in the real world by scanning an App Clip Code,a QR code, or by tapping an NFC tag.App Clips are also surfaced in Maps and Siri suggestions.This session is loaded with best practicesand troubleshooting tips that will help you buildand deliver great experiences for your customers.I’ll show you a plan for getting your clip under the size limit.Maybe your App Clip isn’t being surfaced on your web pageor the App Clip card does not appear when you scan a code.Perhaps you’re looking for some tips on maintainingquality in your code base, while taking onthe added complexity that comes with adopting new features.And maybe you’re curious to know what functionalityyou can leverage that’s specific and unique to App Clips.Whether you’re building from scratchor adding a clip target to an existing app,I’ll walk you through real-world issues developers faceon a daily basis, and I’ll give youactionable next stepsfor building better clips and apps.Even when your users are in areaswith good mobile network coverage,their download speeds can vary.To ensure that App Clips can be provided on demandat a moment’s notice, the maximum sizeof an App Clip is limited.Therefore, as a developer,it’s important to optimize your content for size.It’s good to know early on and often during developmentif your clip is compact enough to be delivered on-demand.Many of you are familiar with the iterative processof profiling and optimization in software development.I’d like to show you a process where youcan use Xcode to generate a size reportand export an IPA for each device variant.Then I'll walk you through a setof basic and advanced optimizationsyou can perform to reduce the size of your App Clip.The goal is to avoid being surprisedat app submission timeif your clip is over the limit.I put together a fun example for us to look at.It’s a version of the Fruta samplethat has a number of gotchas that put it over the size limit.The gotchas are simple to illustrate some key points.Your apps are undoubtedly more complicatedand have tons more features, so please use my exampleas a starting point for further exploration.Let’s start by launching into Xcodeto go through the steps to generate the size reportand export the IPA files,and we’ll uncover these gotchasand learn how to fix them together.First select the full app scheme.Then go to the Product menu and choose Archive.This builds the project using the configurationspecified in the scheme editor.When the organizer opens, click Distribute App.Choose Development.Now select your App Clip.In the App Thinning dropdown,choose all compatible device variants.Make sure that rebuild from bitcode is checked.When the archive is done preparing, click Export.Then select a location on the file system to export to.Now open the Export folder in Finder...And then open the App Thinning Size Report.txt.There’s a section for each device variant.The second to the last line in each sectionwill tell us the uncompressed sizefor that variant.That’s what we’re interested in.Looking at the size, this tells me two things.One, I’m over the size limit.Two, I’m not seeing the effects of app thinningbecause all the device variants are around the same size.Let’s close the size report and dig a bit deeperto see why that is.Open the Apps subfolder.Rename one of the variant IPAs extension to .zip,and confirm.Double-click to uncompress.Open the Payload folderand Control-click to show the package contents.Let’s look closely.Looks like my images are individual bundle resources.Perhaps I’ll save some spaceif I put these in an asset catalog.I see a documentation zip and a README filethat don’t belong here in the installable product.There’s a framework being used by my clip.I bet that’s taking up some space too.I see some localization folders present,and I know that sometimes these filescan grow if left unchecked.The compiled executable is relatively small...but maybe there’s a way to get it even smaller.Every little bit helps.Let’s continue on and seewhat can be done to fix some of these issues.That process of generating a size reportand looking through the IPA was very helpfulbecause it identified a number of stepsI can take to reduce the App Clip size.Let’s start with some basic steps first,and then we’ll move on to more advanced techniques.We’ll double-check the build settings,we’ll go over the benefits of using asset catalogs,we’ll exclude any files from making their wayto the final product that don’t belong,and we’ll go through our codeand settings and refactor for size reduction.Keep in mind the optimizations we’ll cover applyto both your app and App Clip, so feel free to applythese tips to both types of products.Now let’s explore each topic in more detail.The compiled code portion of the App Clip packagecertainly wasn’t the largest contributor to the clip’s size.It was definitely the assets, which we’ll get to in a moment.But every little bit helps.By default, Xcode will buildusing the smallest, fastest optimization setting,but let’s double-checkto make sure that’s what’s set in my project.Make sure the full app is set as the active schemeand Option-click to display the scheme settings.Our archive build should be set to release,but it looks like I changed it at some pointand forgot to change it back.I was also experimenting a bit in build settingsand moved the release optimization leveloff of the default.Let’s change it back so that we’re usingthe best combination of small binary sizeand fast runtime execution.Most of the time, as in my case, assets like images,audio, and video take up the most space.The most important step you can taketo reduce the impact these assetshave on your App Clip size is to use asset catalogs,and this is for two reasons.One, the media you add to asset catalogsis automatically optimizedas part of the Xcode build process.And two, when customers download your app or clip,the product they download will be made small enoughto only contain assets suitable for their device.This is also known as app thinning,and we should certainly take advantage of it.In my project, I really should have putthose images in an asset catalog.We can actually do even better.I’ll create a second asset catalog,and I’ll move all the images that are sharedbetween my app and App Clip into this catalog.Let’s bring both catalogs side by side.We’ll move the icons and colors into the shared catalog.Then we’ll put the ingredientand smoothie images into the shared catalog.Since the recipe images are only needed by the full app,I’ll put those in the unshared catalogso they don’t count against the size of my App Clip.I’ll make sure to remove those images that I copiedover to the asset library.And last, I’ll use the target membership editorto exclude the unshared asset catalogfrom my App Clip.For a deep dive on the asset catalog,check out the sessions on optimizing storage in your appand optimizing app assets.Earlier, we inspected the IPA on the file system,and we saw a few things that didn’t belonglike a README file and a zipcontaining documentation.Let’s go ahead and use the target membership editorin Xcode to exclude these files from all of our build products.Ensure you’re only including codein your App Clip targetthat’s necessary for the task being performed.I find it helpful to look in the build phasesto get an overview of every source filethat is contributing to my App Clip.If I see something that looks unnecessary,I remove it from the list of sources and rebuild.The recipe and rewards functionality of Frutaare necessary for the full appbut not the App Clip, so let’s remove those files.You can even let the compiler assist.If there are build errors, either the filewas necessary, there’s more to remove,or perhaps there’s code that needsto be conditionally compiled out of the App Clip target.Over time, localized strings filescan become inflated with duplicatesand unused strings.Inspect the strings files and delete anythingthat’s not needed.Similar to what we did for asset catalogs,you can create a dedicated strings fileso that you aren’t includingyour full app’s localized stringswith your App Clip.I’ve covered some basic optimizationsyou can implement todayto get your App Clip ready for submission.Now suppose, as part of this iterative process,you measure again, you look at the size report,and you still aren’t where you need to be.That’s OK.I have several advanced optimization strategiesfor you to consider.First, evaluate your external dependenciesand take their size into consideration.Remember, App Clips are bite-sized versionsof your app, so make sure you are only linkingwhat's needed for your clip’s functionality.Remember that SmoothieAccountLogin frameworkthat was adding to my App Clip’s size?Most of the time, there’s an Apple frameworkalready integrated into the OSthat will help you accomplish your goal.Using one of these built-in frameworks is free,and it’ll make your app and App Clip lighter and faster,which means it’ll download faster, launch faster,and allow your customersto complete the task at hand faster.Use Sign in with Apple to make it easy for usersto sign in to your service with just their Apple ID.For payments, Apple Pay is fast and easy both for you,the developer, and for your customers.For communication over the network,use NSURLSession.For 3D graphics, leverage RealityKit and Metal.For more in-depth authentication flows,check out ASWebAuthenticationSession.It’s almost always the assets and not the codethat pushes the size of an App Clip over the limit.More often than not, those assets are images.In the basic steps, I moved all my images to asset catalogsto take advantage of built-in optimizationand app thinning.Sometimes that’s not enough and you need to takefurther action to reduce the size of your images.The format and options you use when saving the source imagecan often have a profound effect both on size and quality.So how do you make the best choice?Generally speaking, a PNG image will consumemore space than a JPEG image,so use PNG if you need a specific featurethat format provides like transparency...Or when JPEG's lossy compression would resultin an unacceptable loss of quality.These examples contain high-frequency features,crisp edges, and defined highlights.The lossless compression of PNGwill preserve these features much better than JPEG.And while we’re on the subject of PNG,consider PNG8 for non-photographic material.The image on the right was saved out as PNG8for a huge reduction in file size.When you export your images, do a side-by-side comparisonto make sure your optimizations hold up.A reduction in color depth can save a lot of spacebut is only appropriate for certain imagerythat won’t suffer from quantization artifacts.For photographic material, when you need to save space,use JPEG and lean a bit on lossy compression.You don’t have to acceptyour content creation tool’s defaultswhen saving your images.In my case, I reduced the file size significantlywithout a perceptible loss in quality.Let me show you a little trick that you might be able to usein your project to make sure your image qualityholds up under various optimizations.I temporarily replaced the pineapple with a mangothat was saved out as a higher compression ratio.This lets me do a quick A/B comparisonin the actual app to verifymy changes didn’t result in a loss of quality.For video, encode using the latest standards like HEVC.As a general rule, compress audio using AACor MP3 codecs, and experiment with a reduced bit rate.Quite often, super-high bit ratesaren’t necessary, and a lower bit rate clipwon’t result in a perceptible drop in quality.For certain kinds of images like interface controls,logos, and icons, representing themin SVG format can lead to significant space savings,and because it’s a vector format,it will look great rendered at any size.Speaking of the SVG format, we love it so muchwe chose it to back SF Symbols, which I highly recommend.There are over 2,000 configurable symbolsto choose from.They come in a wide range of weights and scalesthat automatically align with text labels,and dynamic type is supported out of the box.Here’s some code to get you startedusing SF symbols in your project.This code snippet shows how a similar text stylecan be applied to both a label and a symbol image.A baseline constraint keeps the label and symbolimage aligned perfectly.Instead of including several variations of an imagein your asset catalog, include one base imageand build the variations needed at runtime.Check out the Fruta sample for a fantastic exampleof how this is put into practice.Instead of using a separate imagefor each presentationof the orange ingredient-- one for this collection view,another for the full image view with vertical text and controls,and a third for the ingredient card back...This one single imageserves as the backing asset for three distinct uses.The result is a significant space savingsachieved by constructing the variations at runtime.Finally, if you’ve completed all the other stepsand still have assets that put your clipover the size limit, consider lazily loadingthose assets from a content delivery network.For example, ship good qualitybut lower resolution placeholder assetswith your App Clipand use the new Async image APIto replace these assets progressively after launch.Check out the What’s new in SwiftUI session for more.And a tip: use the network link conditionerto test your App Clip under a varietyof different bandwidth scenariosto make sure you aren’t introducingany delays for your customers in completing the task at hand.With these advanced optimizations,we’ve reached the end of the first topic.You can explore further and discover more techniquesin the developer documentation for reducing your app’s size.Say you’ve released your App Clip to productionand you don’t see it offeredas expected when you view your website in Safari.Or maybe you scanned a QR code and were directedto Safari instead of seeing the App Clip card.Generally, these issues fallinto a couple of different buckets:registration of the experienceand associated domain configuration.Let’s do a quick terminology refresher,and then I’ll go over some steps you can take to fix the issues.In App Store Connect, you have the abilityto add two types of experiences.All App Clips must have a default experience.For the default experience, you specify metadatathat populates the App Clip cardwhen invoked from your web page in Safari or when someone sendsa link to your web page in Messages.In order to take advantage of physical invocationlike QR scanning, NFC, and App Clip Codes,you need to be sure to add an advanced experience.Keep in mind, registration takes timeto propagate to devices, so changesmade in App Store Connect won’t be instantly available.For an in-depth look at registering experiences,please see the sessionsfor What’s new in App Store Connectand Configure and link Your App Clips.Prior to displaying UI that surfaces your App Clip,the OS checks to make sure that the invocation domainis verifiably associated with your App Clip.In other words, that means the URL viewed in Safarior encoded in a QR code must have a secure associationvia entitlements and an AASA filewith your app and App Clip.If this is not configured properly,your clip will not be surfaced.For more information on establishingthis secure association, please seethe What’s new in Universal Links sessionand the Configure and link your App Clips session.Let’s say you’ve configured everythingand you check Safariand you expect to see your App Clip cardpresented inline like this.But unfortunately you just see your web pageand nothing else appears.So what might be the problem,and what troubleshooting steps can you take?First, verify the syntax of your meta tagand make sure it looks similar to this template.Replace the yellow placeholderswith your full app’s App Store IDand your App Clip’s bundleID respectively.I’ll show you a technique I use to make surethe meta tag is constructed correctly.Navigate to your web page in Safariand open the web inspector.Expand the head element and look closely at the source.Then check the node attributes to ensureyour meta tag is parsed correctlyand that your App Clip bundleID is exactly the sameas what is shown in Xcode and App Store Connect.Is forwarding or redirectioninterfering with domain validation?Example.com is not consideredequal to www.example.comas far as the domain validation machinery is concerned.The important thing to remember hereis that the domain serving the content,the domain that’s at the end of the redirection chain,should be the domain that serves the AASA fileand is included in your associated domain’s entitlement.Also remember that Safari won’t display the full App Clip cardor the Smart App banner if private browsing is enabled.If you’re still stuck,verify the AASA passes validationin the ASC portal.You can use the SWCutil command line toolto retrieve an AASA filefrom your web site at the expected location.This is very similar to the operation performedby App Store Connect.You can use this to ensure there are no errorspreventing App Store Connect from retrieving the file.Check the JSON output for common mistakessuch as bundleID specified instead of applicationID.For more information, please check outthe What’s new in App Store Connect sessionas well as the What’s new in Universal Links session.Now for physical invocation like App Clip Codes,QR codes, and NFC tags, here is the expected experience.If not fully configured, your web pagewill be offered in Safari instead of your customersseeing the App Clip card in Camera.Many times the reason this occurs is becausean advanced experience has not been createdfor the URL encoded in your physical codes.Even if your QR code URL is the same as your website URLand your experience displays perfectly in Safari,it’s still necessary to create an advanced experiencein App Store Connect to power your physical codes.Remember this slide from when we were troubleshootingSafari invocation?For web traffic, all redirects are followedprior to domain validation.I’d like to make you awareof a subtle yet important differencein the way domain validation is handled for physical codes.Say you’ve been using a unique domainin your QR code URLsand have been forwarding that to your websiteto provide consistency across platforms.You’re already serving an AASA file from that domainfor customers that enter directly through the web.Now, here comes the subtle difference.For code scanning, it’s necessary to addthe exact domain to your App Clip’s entitlementsand serve an AASA file as well from this domain.The reason behind this is to give quick feedbackto the user that is scanning a physical code.And we avoid performing network requeststhat would typically result in following a redirection chain.Changes to advanced experiencesor site association take time to propagate to devices.If you’ve made sure the URL you’ve been scanninghas been added as an advanced experienceand you still don’t see the App Clip card,try clearing the experience cachein Developer settings.On to the next topic.You’ve undertaken some additional complexityin your project, and the upside is that you nowhave a more modern, platform-following experience.I’d like to show you some steps you can take to embracethe extra functionality while maintaining the levelof quality you’ve worked so hard to achieve up to this point.Let’s take a look at a diagram that showsfunctionality for a basic restaurant app.In this example, customers start by browsingthe restaurant’s menu.Next, they can customize a burgeror a cocktail and then checkout.After that, they see their order statusand options for order pickup.Now let’s say the restaurant would like to enhancethe experience by adding two features: pay at the tablewith a QR code and send the burger you customizedto a friend as a link so they can order one too.This will require some significant redesignbecause both of these features rely on launchingdirectly to the checkout step.The requested features are really great opportunitiesfor an App Clip, but shoehorning itinto the current design will createa lot of additional complexity.What steps can be taken to make the app more flexible?First, I’d like encourage you to create flattened,modular functionality where each component of your appis independent and can be directly launched into.This approach is much more suited to deep linking,which is fundamental to how App Clipsare invoked and provided state.Design the checkout module to be directly invoked by providing,say, a list of menu items, which you can encode in a URL.By representing the order as a URLembedded in a visual code, you give your customersthe ability to pay for their check at the table.Once a food item is encodable in a URL,you can use this paradigm to encourage your customersto share what they’ve ordered with their friendsso they can buy the same thing too.With very little overhead remaining,you’re able to adopt App Clipsand increase your reach by providingthis functionality on demandto customers that haven’t yet downloaded your app.I just showed some ways to think a bit differentlyabout the design of your application,to unlock extra functionalitywhile keeping the overhead to a minimum.Now let’s look at how to minimizesome of the boilerplate code that’s involvedin offering an App Clip.In your app’s code, you are likely respondingto life cycle events, typically with these methodsthat are called when your app is launchedor resumed from background.Adopting App Clips adds another set of thesesame exact life cycle methods.You might be temptedto place code in your App Clip’s life cycle methodsthat extracts the URL from the UserActivityand uses that extracted URLto derive some state and show some UI.The concept is sound, but before doing that,I suggest refactoring so that the code that handlesboth your app and App Clip launch is shared.This eliminates a whole class of bugs and headachesof trying to maintain similar functionalityin separate launch pathsbetween your App Clip and full app.Consider creating a method like respondTo that takesthe user activity as a parameter.Use this method as the main entry pointof your app and clip by directly calling itfrom all of the relevant life cycle methods.Now you’re executing codethat’s common to both your app and clip,which greatly reduces the overhead.Perhaps you respond to that user activityby extracting restaurant menu itemsfrom the URL to facilitatethe customer paying the check at the table.Since this is all code that’s shared,you can make changes onceand get the benefits in both your app and App Clip.Any discussion on adopting modern featuresin your project while maintaining qualitywould not be complete without mentioning testing.There are two techniques specific to App Clipsthat I’d like to remind you about.For iterative development, when building and runningin Xcode, set the _XCAppClipURL environment variableto an invocation URL of your choice.When you run your clip, the URL you set herewill be passed through to your clipjust as it would be on a customer’s device.To see your in-development clip surfaced by the OSsimilar to production devices, navigate to Developer settingsand create a local experience.You really need to try this out before submittingyour clip to get a better feel for how your customerswill use your App Clip on their devices.Otherwise, you’re missing outon some great opportunities to test many of the waysyour clip can be invoked, like scanning a code in Camera.It’s also a great way to try out new features in seed buildsbefore they’re available in productionlike the new App Clip card experience in Safari.I’ve just skimmed the surfaceon how awesome local experiences are for testing App Clips.For more, please see this year’s What’s new in App Clips sessionand, for a detailed description on testing App Clips,please see the developer documentationtitled Testing Your App Clip’s Launch Experience.Last, there’s some functionality that’s specific to App Clipsthat all developers should take advantage of.When App Clips were introduced,two streamlined permissions itemswere made available just for App Clips.These items are called ephemeral notificationsand location confirmation.You’re able to provide pre-authorizationfor your customers to take advantage ofright on the App Clip card.Ephemeral notifications lets you send notificationsfor 24 hours since your App Clip was last launched,and location confirmation helps you confirmthe customer is within an area you expect without asking foror needing to know their precise location.This helps prevent an accidental paymentat the wrong gas stationor ordering a smoothie from a Fruta shopin the wrong town.As a developer, you opt in to this functionalityin your Info.plist.Now your App Clips have accessto these unique permissionswithout interrupting the launch of your experiencewith alerts that ask for more than you actually need.Location confirmation is only availablefor physical invocationslike an NFC tag, an App Clip Code, or a QR code.Customers can opt out of location confirmationfor the current session or for all requests.Please be sure to handle these states appropriatelyby checking the error from confirmAcquiredand offer the customer helpful guidanceon what occurred and perhaps options to resumetheir transaction under more favorable conditions.A quick note about profiles and signing in Xcode.Most of you have enabled automatically manage signingin the Signing and Capabilities sectionof your project settings, which is fantastic.If you’re manually managing signing,make sure you obtain a recent profile.One immediate benefit is when your customersupgrade from your App Clip to your full app,their data will be migrated faster.This is one of the many benefitsto you that we’re constantly working on.Having a recent profile ensures that your appand clip have the capabilitiesnecessary to take advantage of these improvements.You’ve now learned some great techniquesto build light and fast App Clips.It’s time to wrap it all up.I’ve covered basic and advanced techniques to get your clipsmall enough to be delivered lightning-quick on demand.I showed you how to ensure your App Clip is beinginvoked where and how you expect.I showed some best practices for getting your projectready for deep linking, to adopt App Clips and universal links.And I covered functionalitythat’s unique and streamlined for App Clips.I hope you can launch Xcode todayand use some of these tipsto make your App Clip lighter and faster.Please be sure to check out my colleague Yongjun’s sessionon What’s new in App Clips this year.Thank you, and have a wonderful WWDC.[upbeat music]

♪ ♪Hello and welcome.I’m Brian Goldberg, an engineer on the App Clips team.I can’t wait to show you some great tipsand techniques to build light and fast App Clips.Let’s get started.App Clips are a great way for your customersto quickly access and experience what your app has to offer.An App Clip is a small part of your appthat’s discoverable and downloadedat the moment it’s needed.

App Clips are deeply integrated into the OS.They can be invoked in Safari and Messagesas well as out in the real world by scanning an App Clip Code,a QR code, or by tapping an NFC tag.App Clips are also surfaced in Maps and Siri suggestions.This session is loaded with best practicesand troubleshooting tips that will help you buildand deliver great experiences for your customers.I’ll show you a plan for getting your clip under the size limit.

Maybe your App Clip isn’t being surfaced on your web pageor the App Clip card does not appear when you scan a code.

Perhaps you’re looking for some tips on maintainingquality in your code base, while taking onthe added complexity that comes with adopting new features.

And maybe you’re curious to know what functionalityyou can leverage that’s specific and unique to App Clips.Whether you’re building from scratchor adding a clip target to an existing app,I’ll walk you through real-world issues developers faceon a daily basis, and I’ll give youactionable next stepsfor building better clips and apps.Even when your users are in areaswith good mobile network coverage,their download speeds can vary.

To ensure that App Clips can be provided on demandat a moment’s notice, the maximum sizeof an App Clip is limited.

Therefore, as a developer,it’s important to optimize your content for size.It’s good to know early on and often during developmentif your clip is compact enough to be delivered on-demand.

Many of you are familiar with the iterative processof profiling and optimization in software development.

I’d like to show you a process where youcan use Xcode to generate a size reportand export an IPA for each device variant.

Then I'll walk you through a setof basic and advanced optimizationsyou can perform to reduce the size of your App Clip.The goal is to avoid being surprisedat app submission timeif your clip is over the limit.I put together a fun example for us to look at.It’s a version of the Fruta samplethat has a number of gotchas that put it over the size limit.The gotchas are simple to illustrate some key points.Your apps are undoubtedly more complicatedand have tons more features, so please use my exampleas a starting point for further exploration.Let’s start by launching into Xcodeto go through the steps to generate the size reportand export the IPA files,and we’ll uncover these gotchasand learn how to fix them together.

First select the full app scheme.

Then go to the Product menu and choose Archive.

This builds the project using the configurationspecified in the scheme editor.

When the organizer opens, click Distribute App.Choose Development.

Now select your App Clip.

In the App Thinning dropdown,choose all compatible device variants.Make sure that rebuild from bitcode is checked.

When the archive is done preparing, click Export.

Then select a location on the file system to export to.

Now open the Export folder in Finder...

And then open the App Thinning Size Report.txt.

There’s a section for each device variant.

The second to the last line in each sectionwill tell us the uncompressed sizefor that variant.That’s what we’re interested in.Looking at the size, this tells me two things.One, I’m over the size limit.Two, I’m not seeing the effects of app thinningbecause all the device variants are around the same size.

Let’s close the size report and dig a bit deeperto see why that is.

Open the Apps subfolder.Rename one of the variant IPAs extension to .zip,and confirm.Double-click to uncompress.Open the Payload folderand Control-click to show the package contents.

Let’s look closely.Looks like my images are individual bundle resources.Perhaps I’ll save some spaceif I put these in an asset catalog.

I see a documentation zip and a README filethat don’t belong here in the installable product.

There’s a framework being used by my clip.I bet that’s taking up some space too.

I see some localization folders present,and I know that sometimes these filescan grow if left unchecked.

The compiled executable is relatively small...but maybe there’s a way to get it even smaller.Every little bit helps.Let’s continue on and seewhat can be done to fix some of these issues.That process of generating a size reportand looking through the IPA was very helpfulbecause it identified a number of stepsI can take to reduce the App Clip size.Let’s start with some basic steps first,and then we’ll move on to more advanced techniques.We’ll double-check the build settings,we’ll go over the benefits of using asset catalogs,we’ll exclude any files from making their wayto the final product that don’t belong,and we’ll go through our codeand settings and refactor for size reduction.Keep in mind the optimizations we’ll cover applyto both your app and App Clip, so feel free to applythese tips to both types of products.Now let’s explore each topic in more detail.The compiled code portion of the App Clip packagecertainly wasn’t the largest contributor to the clip’s size.It was definitely the assets, which we’ll get to in a moment.But every little bit helps.By default, Xcode will buildusing the smallest, fastest optimization setting,but let’s double-checkto make sure that’s what’s set in my project.Make sure the full app is set as the active schemeand Option-click to display the scheme settings.Our archive build should be set to release,but it looks like I changed it at some pointand forgot to change it back.I was also experimenting a bit in build settingsand moved the release optimization leveloff of the default.Let’s change it back so that we’re usingthe best combination of small binary sizeand fast runtime execution.Most of the time, as in my case, assets like images,audio, and video take up the most space.The most important step you can taketo reduce the impact these assetshave on your App Clip size is to use asset catalogs,and this is for two reasons.One, the media you add to asset catalogsis automatically optimizedas part of the Xcode build process.And two, when customers download your app or clip,the product they download will be made small enoughto only contain assets suitable for their device.This is also known as app thinning,and we should certainly take advantage of it.

In my project, I really should have putthose images in an asset catalog.We can actually do even better.I’ll create a second asset catalog,and I’ll move all the images that are sharedbetween my app and App Clip into this catalog.

Let’s bring both catalogs side by side.

We’ll move the icons and colors into the shared catalog.

Then we’ll put the ingredientand smoothie images into the shared catalog.

Since the recipe images are only needed by the full app,I’ll put those in the unshared catalogso they don’t count against the size of my App Clip.I’ll make sure to remove those images that I copiedover to the asset library.

And last, I’ll use the target membership editorto exclude the unshared asset catalogfrom my App Clip.For a deep dive on the asset catalog,check out the sessions on optimizing storage in your appand optimizing app assets.

Earlier, we inspected the IPA on the file system,and we saw a few things that didn’t belonglike a README file and a zipcontaining documentation.Let’s go ahead and use the target membership editorin Xcode to exclude these files from all of our build products.Ensure you’re only including codein your App Clip targetthat’s necessary for the task being performed.

I find it helpful to look in the build phasesto get an overview of every source filethat is contributing to my App Clip.If I see something that looks unnecessary,I remove it from the list of sources and rebuild.The recipe and rewards functionality of Frutaare necessary for the full appbut not the App Clip, so let’s remove those files.You can even let the compiler assist.If there are build errors, either the filewas necessary, there’s more to remove,or perhaps there’s code that needsto be conditionally compiled out of the App Clip target.Over time, localized strings filescan become inflated with duplicatesand unused strings.

Inspect the strings files and delete anythingthat’s not needed.Similar to what we did for asset catalogs,you can create a dedicated strings fileso that you aren’t includingyour full app’s localized stringswith your App Clip.

I’ve covered some basic optimizationsyou can implement todayto get your App Clip ready for submission.

Now suppose, as part of this iterative process,you measure again, you look at the size report,and you still aren’t where you need to be.That’s OK.I have several advanced optimization strategiesfor you to consider.

First, evaluate your external dependenciesand take their size into consideration.Remember, App Clips are bite-sized versionsof your app, so make sure you are only linkingwhat's needed for your clip’s functionality.Remember that SmoothieAccountLogin frameworkthat was adding to my App Clip’s size?Most of the time, there’s an Apple frameworkalready integrated into the OSthat will help you accomplish your goal.

Using one of these built-in frameworks is free,and it’ll make your app and App Clip lighter and faster,which means it’ll download faster, launch faster,and allow your customersto complete the task at hand faster.

Use Sign in with Apple to make it easy for usersto sign in to your service with just their Apple ID.For payments, Apple Pay is fast and easy both for you,the developer, and for your customers.For communication over the network,use NSURLSession.For 3D graphics, leverage RealityKit and Metal.For more in-depth authentication flows,check out ASWebAuthenticationSession.It’s almost always the assets and not the codethat pushes the size of an App Clip over the limit.More often than not, those assets are images.In the basic steps, I moved all my images to asset catalogsto take advantage of built-in optimizationand app thinning.Sometimes that’s not enough and you need to takefurther action to reduce the size of your images.The format and options you use when saving the source imagecan often have a profound effect both on size and quality.So how do you make the best choice?Generally speaking, a PNG image will consumemore space than a JPEG image,so use PNG if you need a specific featurethat format provides like transparency...

Or when JPEG's lossy compression would resultin an unacceptable loss of quality.These examples contain high-frequency features,crisp edges, and defined highlights.The lossless compression of PNGwill preserve these features much better than JPEG.

And while we’re on the subject of PNG,consider PNG8 for non-photographic material.

The image on the right was saved out as PNG8for a huge reduction in file size.When you export your images, do a side-by-side comparisonto make sure your optimizations hold up.A reduction in color depth can save a lot of spacebut is only appropriate for certain imagerythat won’t suffer from quantization artifacts.

For photographic material, when you need to save space,use JPEG and lean a bit on lossy compression.You don’t have to acceptyour content creation tool’s defaultswhen saving your images.In my case, I reduced the file size significantlywithout a perceptible loss in quality.

Let me show you a little trick that you might be able to usein your project to make sure your image qualityholds up under various optimizations.I temporarily replaced the pineapple with a mangothat was saved out as a higher compression ratio.This lets me do a quick A/B comparisonin the actual app to verifymy changes didn’t result in a loss of quality.

For video, encode using the latest standards like HEVC.

As a general rule, compress audio using AACor MP3 codecs, and experiment with a reduced bit rate.Quite often, super-high bit ratesaren’t necessary, and a lower bit rate clipwon’t result in a perceptible drop in quality.For certain kinds of images like interface controls,logos, and icons, representing themin SVG format can lead to significant space savings,and because it’s a vector format,it will look great rendered at any size.

Speaking of the SVG format, we love it so muchwe chose it to back SF Symbols, which I highly recommend.There are over 2,000 configurable symbolsto choose from.They come in a wide range of weights and scalesthat automatically align with text labels,and dynamic type is supported out of the box.

Here’s some code to get you startedusing SF symbols in your project.This code snippet shows how a similar text stylecan be applied to both a label and a symbol image.A baseline constraint keeps the label and symbolimage aligned perfectly.Instead of including several variations of an imagein your asset catalog, include one base imageand build the variations needed at runtime.Check out the Fruta sample for a fantastic exampleof how this is put into practice.Instead of using a separate imagefor each presentationof the orange ingredient-- one for this collection view,another for the full image view with vertical text and controls,and a third for the ingredient card back...

This one single imageserves as the backing asset for three distinct uses.The result is a significant space savingsachieved by constructing the variations at runtime.Finally, if you’ve completed all the other stepsand still have assets that put your clipover the size limit, consider lazily loadingthose assets from a content delivery network.

For example, ship good qualitybut lower resolution placeholder assetswith your App Clipand use the new Async image APIto replace these assets progressively after launch.

Check out the What’s new in SwiftUI session for more.And a tip: use the network link conditionerto test your App Clip under a varietyof different bandwidth scenariosto make sure you aren’t introducingany delays for your customers in completing the task at hand.With these advanced optimizations,we’ve reached the end of the first topic.You can explore further and discover more techniquesin the developer documentation for reducing your app’s size.

Say you’ve released your App Clip to productionand you don’t see it offeredas expected when you view your website in Safari.Or maybe you scanned a QR code and were directedto Safari instead of seeing the App Clip card.

Generally, these issues fallinto a couple of different buckets:registration of the experienceand associated domain configuration.Let’s do a quick terminology refresher,and then I’ll go over some steps you can take to fix the issues.In App Store Connect, you have the abilityto add two types of experiences.All App Clips must have a default experience.For the default experience, you specify metadatathat populates the App Clip cardwhen invoked from your web page in Safari or when someone sendsa link to your web page in Messages.In order to take advantage of physical invocationlike QR scanning, NFC, and App Clip Codes,you need to be sure to add an advanced experience.

Keep in mind, registration takes timeto propagate to devices, so changesmade in App Store Connect won’t be instantly available.For an in-depth look at registering experiences,please see the sessionsfor What’s new in App Store Connectand Configure and link Your App Clips.Prior to displaying UI that surfaces your App Clip,the OS checks to make sure that the invocation domainis verifiably associated with your App Clip.In other words, that means the URL viewed in Safarior encoded in a QR code must have a secure associationvia entitlements and an AASA filewith your app and App Clip.If this is not configured properly,your clip will not be surfaced.For more information on establishingthis secure association, please seethe What’s new in Universal Links sessionand the Configure and link your App Clips session.

Let’s say you’ve configured everythingand you check Safariand you expect to see your App Clip cardpresented inline like this.

But unfortunately you just see your web pageand nothing else appears.So what might be the problem,and what troubleshooting steps can you take?First, verify the syntax of your meta tagand make sure it looks similar to this template.Replace the yellow placeholderswith your full app’s App Store IDand your App Clip’s bundleID respectively.

I’ll show you a technique I use to make surethe meta tag is constructed correctly.Navigate to your web page in Safariand open the web inspector.Expand the head element and look closely at the source.Then check the node attributes to ensureyour meta tag is parsed correctlyand that your App Clip bundleID is exactly the sameas what is shown in Xcode and App Store Connect.Is forwarding or redirectioninterfering with domain validation?Example.com is not consideredequal to www.example.comas far as the domain validation machinery is concerned.The important thing to remember hereis that the domain serving the content,the domain that’s at the end of the redirection chain,should be the domain that serves the AASA fileand is included in your associated domain’s entitlement.

Also remember that Safari won’t display the full App Clip cardor the Smart App banner if private browsing is enabled.If you’re still stuck,verify the AASA passes validationin the ASC portal.

You can use the SWCutil command line toolto retrieve an AASA filefrom your web site at the expected location.This is very similar to the operation performedby App Store Connect.You can use this to ensure there are no errorspreventing App Store Connect from retrieving the file.Check the JSON output for common mistakessuch as bundleID specified instead of applicationID.

For more information, please check outthe What’s new in App Store Connect sessionas well as the What’s new in Universal Links session.Now for physical invocation like App Clip Codes,QR codes, and NFC tags, here is the expected experience.

If not fully configured, your web pagewill be offered in Safari instead of your customersseeing the App Clip card in Camera.

Many times the reason this occurs is becausean advanced experience has not been createdfor the URL encoded in your physical codes.Even if your QR code URL is the same as your website URLand your experience displays perfectly in Safari,it’s still necessary to create an advanced experiencein App Store Connect to power your physical codes.Remember this slide from when we were troubleshootingSafari invocation?For web traffic, all redirects are followedprior to domain validation.I’d like to make you awareof a subtle yet important differencein the way domain validation is handled for physical codes.Say you’ve been using a unique domainin your QR code URLsand have been forwarding that to your websiteto provide consistency across platforms.You’re already serving an AASA file from that domainfor customers that enter directly through the web.Now, here comes the subtle difference.For code scanning, it’s necessary to addthe exact domain to your App Clip’s entitlementsand serve an AASA file as well from this domain.The reason behind this is to give quick feedbackto the user that is scanning a physical code.And we avoid performing network requeststhat would typically result in following a redirection chain.Changes to advanced experiencesor site association take time to propagate to devices.

If you’ve made sure the URL you’ve been scanninghas been added as an advanced experienceand you still don’t see the App Clip card,try clearing the experience cachein Developer settings.On to the next topic.You’ve undertaken some additional complexityin your project, and the upside is that you nowhave a more modern, platform-following experience.I’d like to show you some steps you can take to embracethe extra functionality while maintaining the levelof quality you’ve worked so hard to achieve up to this point.

Let’s take a look at a diagram that showsfunctionality for a basic restaurant app.In this example, customers start by browsingthe restaurant’s menu.Next, they can customize a burgeror a cocktail and then checkout.After that, they see their order statusand options for order pickup.

Now let’s say the restaurant would like to enhancethe experience by adding two features: pay at the tablewith a QR code and send the burger you customizedto a friend as a link so they can order one too.

This will require some significant redesignbecause both of these features rely on launchingdirectly to the checkout step.The requested features are really great opportunitiesfor an App Clip, but shoehorning itinto the current design will createa lot of additional complexity.What steps can be taken to make the app more flexible?First, I’d like encourage you to create flattened,modular functionality where each component of your appis independent and can be directly launched into.This approach is much more suited to deep linking,which is fundamental to how App Clipsare invoked and provided state.Design the checkout module to be directly invoked by providing,say, a list of menu items, which you can encode in a URL.By representing the order as a URLembedded in a visual code, you give your customersthe ability to pay for their check at the table.Once a food item is encodable in a URL,you can use this paradigm to encourage your customersto share what they’ve ordered with their friendsso they can buy the same thing too.

With very little overhead remaining,you’re able to adopt App Clipsand increase your reach by providingthis functionality on demandto customers that haven’t yet downloaded your app.I just showed some ways to think a bit differentlyabout the design of your application,to unlock extra functionalitywhile keeping the overhead to a minimum.Now let’s look at how to minimizesome of the boilerplate code that’s involvedin offering an App Clip.In your app’s code, you are likely respondingto life cycle events, typically with these methodsthat are called when your app is launchedor resumed from background.

Adopting App Clips adds another set of thesesame exact life cycle methods.You might be temptedto place code in your App Clip’s life cycle methodsthat extracts the URL from the UserActivityand uses that extracted URLto derive some state and show some UI.

The concept is sound, but before doing that,I suggest refactoring so that the code that handlesboth your app and App Clip launch is shared.This eliminates a whole class of bugs and headachesof trying to maintain similar functionalityin separate launch pathsbetween your App Clip and full app.

Consider creating a method like respondTo that takesthe user activity as a parameter.Use this method as the main entry pointof your app and clip by directly calling itfrom all of the relevant life cycle methods.

Now you’re executing codethat’s common to both your app and clip,which greatly reduces the overhead.Perhaps you respond to that user activityby extracting restaurant menu itemsfrom the URL to facilitatethe customer paying the check at the table.Since this is all code that’s shared,you can make changes onceand get the benefits in both your app and App Clip.Any discussion on adopting modern featuresin your project while maintaining qualitywould not be complete without mentioning testing.There are two techniques specific to App Clipsthat I’d like to remind you about.

For iterative development, when building and runningin Xcode, set the _XCAppClipURL environment variableto an invocation URL of your choice.When you run your clip, the URL you set herewill be passed through to your clipjust as it would be on a customer’s device.

To see your in-development clip surfaced by the OSsimilar to production devices, navigate to Developer settingsand create a local experience.

You really need to try this out before submittingyour clip to get a better feel for how your customerswill use your App Clip on their devices.Otherwise, you’re missing outon some great opportunities to test many of the waysyour clip can be invoked, like scanning a code in Camera.It’s also a great way to try out new features in seed buildsbefore they’re available in productionlike the new App Clip card experience in Safari.

I’ve just skimmed the surfaceon how awesome local experiences are for testing App Clips.For more, please see this year’s What’s new in App Clips sessionand, for a detailed description on testing App Clips,please see the developer documentationtitled Testing Your App Clip’s Launch Experience.Last, there’s some functionality that’s specific to App Clipsthat all developers should take advantage of.

When App Clips were introduced,two streamlined permissions itemswere made available just for App Clips.These items are called ephemeral notificationsand location confirmation.You’re able to provide pre-authorizationfor your customers to take advantage ofright on the App Clip card.Ephemeral notifications lets you send notificationsfor 24 hours since your App Clip was last launched,and location confirmation helps you confirmthe customer is within an area you expect without asking foror needing to know their precise location.This helps prevent an accidental paymentat the wrong gas stationor ordering a smoothie from a Fruta shopin the wrong town.

As a developer, you opt in to this functionalityin your Info.plist.Now your App Clips have accessto these unique permissionswithout interrupting the launch of your experiencewith alerts that ask for more than you actually need.

Location confirmation is only availablefor physical invocationslike an NFC tag, an App Clip Code, or a QR code.Customers can opt out of location confirmationfor the current session or for all requests.

Please be sure to handle these states appropriatelyby checking the error from confirmAcquiredand offer the customer helpful guidanceon what occurred and perhaps options to resumetheir transaction under more favorable conditions.A quick note about profiles and signing in Xcode.Most of you have enabled automatically manage signingin the Signing and Capabilities sectionof your project settings, which is fantastic.

If you’re manually managing signing,make sure you obtain a recent profile.One immediate benefit is when your customersupgrade from your App Clip to your full app,their data will be migrated faster.This is one of the many benefitsto you that we’re constantly working on.Having a recent profile ensures that your appand clip have the capabilitiesnecessary to take advantage of these improvements.

You’ve now learned some great techniquesto build light and fast App Clips.It’s time to wrap it all up.I’ve covered basic and advanced techniques to get your clipsmall enough to be delivered lightning-quick on demand.I showed you how to ensure your App Clip is beinginvoked where and how you expect.I showed some best practices for getting your projectready for deep linking, to adopt App Clips and universal links.And I covered functionalitythat’s unique and streamlined for App Clips.I hope you can launch Xcode todayand use some of these tipsto make your App Clip lighter and faster.Please be sure to check out my colleague Yongjun’s sessionon What’s new in App Clips this year.Thank you, and have a wonderful WWDC.[upbeat music]

14:18 -SF Symbol and Text

18:08 -Meta Tag

27:41 -Location Confirmation

## Code Samples

```swift
label.text 
=
 
"Hello"



// TextStyle for label and image


let
 textStyle 
=
 
UIFont
.
TextStyle
.largeTitle


// Use the same TextStyle for label and image

label.font 
=
 .preferredFont(forTextStyle: textStyle)

let
 config 
=
 
UIImage
.
SymbolConfiguration
(textStyle: textStyle)

imageView.image 
=
 
UIImage
(systemName: 
"pencil.and.outline"
, withConfiguration: config)


// Align baseline of text and symbol image

imageView.firstBaselineAnchor.constraint(equalTo: label.firstBaselineAnchor).isActive 
=
 
true
```

```swift
<
meta
 
name
=
"apple-itunes-app"
 
content
=
"app-id=myAppStoreID, app-clip-bundle-id=appClipBundleID, app-clip-display=card"
>
```

```swift
if
 
let
 activationPayload 
=
 userActivity
?
.appClipActivationPayload {
  activationPayload.confirmAcquired(in: region)
  { inRegion, error 
in

    
if
 
let
 error 
=
 error 
as?
 
APActivationPayloadError
 {
      
if
 error.code 
==

      
APActivationPayloadError
.disallowed {
        
// User denied permission

        
// Or invocation was not from visual code or NFC

      } 
else
 
if
 error.code 
==

      
APActivationPayloadError
.doesNotMatch {
        
// Activation payload is not the most recent

        
// Catch in testing. Handle as above.

      }
    } 
else
 
if
 error 
==
 
nil
 {
      
// Platform was able to determine location

      
// OK to check inRegion

    }
  }
}
```

