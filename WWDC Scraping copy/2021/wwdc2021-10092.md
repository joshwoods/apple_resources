# Wwdc2021 10092

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Transcript

What's new in Wallet and Apple PayDiscover the redesigned Apple Pay for in-app and web payments and learn how you can incorporate the latest APIs into your app or website. Learn how to add features to your app like coupon codes, improved shipping information, and improvements to the payment detail display screen. And explore changes to Wallet passes, including auto-expiry and multi-pass support for the web.ResourcesApple Pay on the WebApple Pay on the Web Interactive DemoDisplaying Apple Pay Buttons Using JavaScriptDistributing and updating a passOffering Apple Pay in Your AppPassKit (Apple Pay and Wallet)WalletHD VideoSD VideoRelated VideosWWDC20What's new in Wallet and Apple Pay

Discover the redesigned Apple Pay for in-app and web payments and learn how you can incorporate the latest APIs into your app or website. Learn how to add features to your app like coupon codes, improved shipping information, and improvements to the payment detail display screen. And explore changes to Wallet passes, including auto-expiry and multi-pass support for the web.

Apple Pay on the Web

Apple Pay on the Web Interactive Demo

Displaying Apple Pay Buttons Using JavaScript

Distributing and updating a pass

Offering Apple Pay in Your App

PassKit (Apple Pay and Wallet)

Wallet

HD VideoSD Video

HD Video

SD Video

What's new in Wallet and Apple Pay

Search this video…♪ Bass music playing ♪♪Edward: Hi, and welcome to WWDC!I'm Edward, an engineer on the Wallet team,and later I'll be joined by my colleague, Russ.We're very excited to be here todayto talk to you about what's new in Wallet and Apple Pay.Today I'd like to talk about three main areas.First, I'd like to share some Wallet updatesand tell you about some exciting rolloutswe've had in the last year.Second, we have made a lot of exciting updates to Apple Pay.We've also added some new functionality,making payments even easier to use.Third, I want to go through some new API enhancementsthat we've made.So let's get started with some updates to Wallet.As you may have heard in the Keynote,we're bringing identity cards to Apple Wallet.Starting in the US, with a few select states,you can just scan your driver's licenseor state ID and capture a selfie.Your ID is protected by the Secure Element.The TSA is working to enable airport security checkpointsas the first place you can use your digital ID.For more information on this,check out the links associated with this session.Also new in iOS 15,we've added support for HomeKit-connected locks,so users can now tap to unlock a door with a home key pass.When it comes to adding passes,we know many of your users install them right from the web.In iOS 14, if you wanted to add four movie tickets,for example, you would add them individually.New this year,we've added multipass downloads from Safari.With a straightforward change, you can bundle passes together,making the experience smooth for your users.To do this, you'll need to do three things.First, zip the PkPass files together.Second, set the file extension to .pkpasses.And, finally, use the correct mime type.Now, all the passes in the bundle will be downloadedand processed by Wallet in a single download.And with all these passes, it can sometimes be troublesomefor you to keep track of them all.We also know that many people don't like to delete old passes,preferring instead to have them as keepsakes,but that can make Wallet kind of cluttered.So new in iOS 15,Wallet will now automatically hide your expired passes,keeping passes organized and easy to find.Let me show you an exampleof how you can take advantage of this.Here we see some JSON from an example pass.Wallet looks at three fields to determine if a passshould be automatically hidden.Number one, the pass has an expiration datethat is older than the current date.Two, the relevant date is older than one day.Or three, the pass has been voided.To ensure a great experience for your users,you should ensure these fields are set correctlyon your passes.Now let me tell you about some updates we've made to Apple Pay.Apple Pay continues to be the easiest wayto make payments on iPhone, iPad, Apple Watch, and Mac.It allows users to make payments in apps and on the web.Apple Pay is supported in iMessage and Business Chat,and also in App Clipsfor streamlined, in-the-moment experiences.Apple Pay usage around the world continues to grow.We've added support in Mexico, Israel,and South Africa this year, meaning Apple Payis now available in 55 countries and regions across the globe.We've added support for Express Transitin more locations.And, we've included support for combined credit and debit cardsin places such as Brazil.Now, I'd like to show you a few changesthat you can make to your apps and websitesto create a great payment experience.Last year we added support for more button typessuch as Rent with Apple Pay and Top Up with Apple Pay.Today we're introducing one more:Continue with Apple Pay.You should use this button when offering Apple Pay in a cartalongside other buttons.You can use Continue as a call to action.We're also introducing a new JavaScript implementationfor the Apple Pay button.This new button supports all current button types and styles.It's easy to implement, and can be customizedto match the design of your sites.Here is an example implementation.As you can see,the button size and style can be configured easily.Note that the styles are prefixed with "apple-pay".For more information on this,check out the documentation on the Apple Developer Portal.Next, I'd like to show you the big changes we've madeto Apple Pay for iPhone and iPad.For iOS 15, we're excited to make payments even betterwith a brand-new Apple Pay experience.We rebuilt the Apple Pay sheet from the ground up in SwiftUIwith an all-new design.It gives users an even clearer and smoother payment experiencewith a great new look.We also implemented several new featuresto improve conversion.For users new to Apple Pay,we simplified the flow to add a card and addressesfrom the payment sheet.Existing users will be able to add another cardwithout leaving the Apple Pay experience.We also redesigned the error handlingfor more clarity when a problem does occur.Once a user has finished adding a new payment method,they seamlessly resume their transaction.We also added a new summary viewwhich shows more detailed information,such as payment items, discounts, and subtotals.New for iOS 15,we also display your app's icon on the summary view.For payments on the web,we're now showing the Web Clip iconon the payment summary view.In Apple Pay, this was previously only visiblewhen using handoff from a Mac to complete a transaction.Now your website iconis viewable within the Apple Pay transactionto provide visual reassurance for the userthat payment is going to the right place.If you accept Apple Pay on the weband you haven't already set a Web Clip icon,we would strongly recommend you make your icon visible to users.To do this, you should provide a 2x and 3x iconat the sizes shown in your root document folder.Apple Pay will then automatically retrieveand display this icon with the payment request.Detailed information on implementing thisis available in the Human Interface Guidelines sectionof the Apple Developer site.While we're on the subject of icon sizes,I wanted to remind you of the new icon size requirementsfor your PKPasses.Since notifications in iOS 15 now display a bigger icon,you'll need to update your PKPass iconsto a minimum of 38x38 at 1x to ensure that your iconsare displayed without blurring.We're also pleased to introduce more flexibilityin the total line.This will enable you to add a dateif the payment occurs later;for example, if you take pre-ordersor to add the frequency for a recurring payment.Many of the new features we've just observed can be addedto your apps with only a few straightforward changes.So we'll now take a closer lookinto the API enhancements we're introducing in iOS 15.We're pleased to add support for shipping date ranges.Now you can present your users with relevant shippingor pickup times within Apple Pay.These can be used to set estimated shippingor delivery dates or time windows for in-store pickups.This extra information is displayedright on the main Apple Pay view.The new shipping date APIs have built-in supportfor calendars and time zones.This makes the handling of shipping datesor pick up times in your app straightforwardand the relevant information is displayed clearly to your users.Now I'll briefly show you how this works.We start by defining a normal shipping methodusing the same PKShippingMethod as before.Next, we choose a calendar.In this example, we use the user's current calendar.We use today as a reference and estimate the arrivalbetween three to seven days from this date.We then determine the start and end date for our date rangeusing the calendar.Finally, we convert the dates to the appropriate date componentsand then we add them to the shipping method.We use date components rather than simple datesso we can take advantage of the rich calendarand time zone support built into iOS.This enables use cases that would otherwise not be possible.For example, we can provide the correct time zonefor a pickup time regardless of the user's current time zone.This level of detail also allows us to showthe date and time information most appropriate to the user,such as displaying a specific pickup time.We've included a JavaScript equivalentfor Apple Pay on the web.You can see we specify the date component rangea little differently than we do in Swift.Your date components can be used in conjunctionwith any of our supported pickup types.For example, you could display a pickup time in your app.In addition to date ranges,you can now declare a read-only shipping address.You can use this to inform the userof a specific pickup location.To enable this, you must provide address detailsas an instance of PKContact.In this example,we have created a postal address as a CNMutablePostalAddressso we can set all the address components that we need.You can now add the shipping contactto payment request.Finally we declare the editing modeand specify the required shipping fields.The address fields included in the PKContactwill be presented to the user as read-only.In this example, we've provided a pick up postal address,which the user won't be able to edit.And here's the equivalent in JavaScriptfor Apple Pay on the web.You setup a shippingContact dictionary,set the shippingType, the shippingContactEditingMode,and the requiredShippingContactFields,and then you include the other fieldsfor a JavaScript payment request.For more information, check out the documentation availableon the Apple Pay section of the Developer Portal.Another great new feature for iOS 15is support for coupon codes.Now your users can enter promotional codesonce they've initiated a payment.This is intended so your usersdon't have to cancel their Apple Pay transactionif they forgot to apply a discount code.You might also consider implementing thisif you have an express purchase flow where users can check outfrom the product page or the shopping cart,but the coupon entry field is only presented at checkout.We've provided methods to update the payment request,so you can validate the discount codesor return error messages when required.Let's dive in and take a look at the code.You can make changes using the delegate methodwhich performs updates whenever the coupon codeis changed by the user.For example, you could use this to validate a codeand then update any payment totals.You also use the method to return customized errorsor update the payment summary items and shipping methods.Russ will show you an example of this in more detail shortly.We recommend prepopulating codes whenever possible,as well as displaying relevant error messagesfor invalid codes.I hope you've enjoyed these exciting API enhancementsfor iOS 15.Now that we have talked all about this in theory,I'm going to hand you over to Russ for a demoso you can see how to implement all these great new features.Russ Fenenga: Thanks, Edward. Hello, everyone.My name is Russ,and I'm a software engineer on the Wallet team.And I'm thrilled to be able to demonstrate to yousome of the amazing new features we have addedto the payment sheet in iOS 15and how you can integrate them into your apps.So let's get started!Here I have my ticket purchasing appfor the food festival I'm planning.My app has already implemented the existing protocol methodsfrom PKPaymentAuthorization ControllerDelegatein order to take advantage of the Apple Pay payment sheet.With iOS 15, the payment sheet will automatically be updatedto the new look without any additional work.I've decided that with the update to iOS 15I want my festival attendees to finally have the abilityto request their tickets in multiple ways.To do this, I'll need to add supportfor multiple shipping methods, so let's dive in!I'll head into our PaymentHandler classwhere I build the PKPaymentRequestto begin adding support for multiple PKShippingMethods.The first thing I'm going to add is a helper functionthat returns me an array of PKShippingMethodsrepresenting the different options available to my users.The first PKShippingMethod I createis a standard shipping method, letting the user knowthey can collect their tickets at the festival.New to iOS 15, I want to provide the useran estimated range it will take the ticketsto be shipped to them.To do this I create a Date and Calendar object,then define a shippingStart and shippingEnd datethree to five days from now.I'm then able to specify the date componentsthat I want to display to the user in the payment sheet.Then I build my PKShippingMethodmaking sure I set the new property, dateComponentsRange,and return the array of the two shipping methods.The last thing I need to do is set the shipping methodson the PKPaymentRequest like so.With these simple changes, I can build my appand check out the new shipping methods in the payment sheet.A new row has automatically been added to the payment sheetshowing the shipping methods.If I tap the rowI'll see both shipping methods that were just added,including the one that supports date ranges.I've also decided that for the festival this yearI want to send out coupon codes to all my attendeesand add the functionality to redeem themdirectly through the payment sheet in my app.To do this, there are two main changes that I need to make.Let's head back into the code.The first is when building the PKPaymentRequest.There is a new boolean, supportsCouponCode,that needs to be set to true.There also is a new optional property, couponCode,that you can set on your PKPaymentRequestto prepopulate the coupon fieldwith one of your already valid coupon codes.Next, let's jump down to my class extension that conformsto the PKPaymentAuthorization ControllerDelegateand implement the new protocol methodpaymentAuthorizationController didChangeCouponCodewhere I will be able to handle updating my summary itemsand display errors related to the coupon code entrywhen a coupon code is entered.The first thing I'm going to need is a helper functionthat updates our PKPaymentSummaryItemsif a valid coupon code is entered.I grab a reference to the first summary itemwhich is our subtotal item.From there, I create a new PKPaymentSummaryItemthat lets the user see the discount that was applied.I then create a new summary item for tax and total,and then return the array of them.Now that I have my discount application logic written,I can then write my coupon code validation logic.I first check if my coupon code that the user entered was emptyand if it is, just call our completionpassing in the unmodified payment summary items.If the entered coupon code matches a valid coupon code,then I use the just created applyDiscount functionto return the updated summary itemsinto our CouponCodeUpdate object.For your apps,you'll most likely need to be fetching valid coupon codesfrom your server at this point.Finally, if the entered coupon code was invalid,I use the new PKPaymentRequest convenience initializer,paymentCouponCodeInvalidError, and supply it a descriptionto be shown directly in the payment sheet.We also have a second convenience initializerfor expired coupon codes:paymentCouponCodeExpired ErrorWithLocalizedDescription.I then pass this error into our coupon code update initializeras well as the original SummaryItems.Just like that,I've added support for coupon codes inside my app.Let's check it out.To enter a coupon code,I just need to tap into the summary viewand enter a coupon code into the coupon code text field.If I first enter an invalid coupon code, Fest,the error message I suppliedis shown directly below the text field.Now if I enter a valid coupon code, FESTIVAL,the payment summary items are immediately updated.Then I just need to select the shipping contactas well as shipping addressand my payment request is ready to go.With these simple changes, you're now readyto test your updates to the payment sheeton a device in our Apple Pay sandbox environment.Now, back to Edward.Edward: Thanks, Russ.Russ just showed us how easy it isto implement multiple shipping methods,the new date range, and coupon code APIs.This year we've delivered some exciting new updates to Walletsuch as home key passes, identification,hiding expired passes, and multiple pass ingestion.We introduced the new JavaScript payment buttonfor Apple Pay on the web,and the new Apple Pay experience on iOS.You learned about the new shipping APIs,which include support for date rangesand read-only addresses, as well as coupon codesand how you can implement these in your own apps.For more information,check out the Apple Pay section of the Developer Portal.This includes the Apple Pay sandboxfor testing payment requests from your apps and websites.Thank you for watching.♪

♪ Bass music playing ♪♪Edward: Hi, and welcome to WWDC!I'm Edward, an engineer on the Wallet team,and later I'll be joined by my colleague, Russ.We're very excited to be here todayto talk to you about what's new in Wallet and Apple Pay.Today I'd like to talk about three main areas.First, I'd like to share some Wallet updatesand tell you about some exciting rolloutswe've had in the last year.Second, we have made a lot of exciting updates to Apple Pay.We've also added some new functionality,making payments even easier to use.Third, I want to go through some new API enhancementsthat we've made.So let's get started with some updates to Wallet.As you may have heard in the Keynote,we're bringing identity cards to Apple Wallet.Starting in the US, with a few select states,you can just scan your driver's licenseor state ID and capture a selfie.Your ID is protected by the Secure Element.The TSA is working to enable airport security checkpointsas the first place you can use your digital ID.For more information on this,check out the links associated with this session.Also new in iOS 15,we've added support for HomeKit-connected locks,so users can now tap to unlock a door with a home key pass.When it comes to adding passes,we know many of your users install them right from the web.In iOS 14, if you wanted to add four movie tickets,for example, you would add them individually.New this year,we've added multipass downloads from Safari.With a straightforward change, you can bundle passes together,making the experience smooth for your users.To do this, you'll need to do three things.First, zip the PkPass files together.Second, set the file extension to .pkpasses.And, finally, use the correct mime type.Now, all the passes in the bundle will be downloadedand processed by Wallet in a single download.And with all these passes, it can sometimes be troublesomefor you to keep track of them all.We also know that many people don't like to delete old passes,preferring instead to have them as keepsakes,but that can make Wallet kind of cluttered.So new in iOS 15,Wallet will now automatically hide your expired passes,keeping passes organized and easy to find.Let me show you an exampleof how you can take advantage of this.Here we see some JSON from an example pass.Wallet looks at three fields to determine if a passshould be automatically hidden.Number one, the pass has an expiration datethat is older than the current date.Two, the relevant date is older than one day.Or three, the pass has been voided.To ensure a great experience for your users,you should ensure these fields are set correctlyon your passes.Now let me tell you about some updates we've made to Apple Pay.Apple Pay continues to be the easiest wayto make payments on iPhone, iPad, Apple Watch, and Mac.It allows users to make payments in apps and on the web.Apple Pay is supported in iMessage and Business Chat,and also in App Clipsfor streamlined, in-the-moment experiences.Apple Pay usage around the world continues to grow.We've added support in Mexico, Israel,and South Africa this year, meaning Apple Payis now available in 55 countries and regions across the globe.We've added support for Express Transitin more locations.And, we've included support for combined credit and debit cardsin places such as Brazil.Now, I'd like to show you a few changesthat you can make to your apps and websitesto create a great payment experience.Last year we added support for more button typessuch as Rent with Apple Pay and Top Up with Apple Pay.Today we're introducing one more:Continue with Apple Pay.You should use this button when offering Apple Pay in a cartalongside other buttons.You can use Continue as a call to action.We're also introducing a new JavaScript implementationfor the Apple Pay button.This new button supports all current button types and styles.It's easy to implement, and can be customizedto match the design of your sites.Here is an example implementation.As you can see,the button size and style can be configured easily.Note that the styles are prefixed with "apple-pay".For more information on this,check out the documentation on the Apple Developer Portal.Next, I'd like to show you the big changes we've madeto Apple Pay for iPhone and iPad.For iOS 15, we're excited to make payments even betterwith a brand-new Apple Pay experience.We rebuilt the Apple Pay sheet from the ground up in SwiftUIwith an all-new design.It gives users an even clearer and smoother payment experiencewith a great new look.We also implemented several new featuresto improve conversion.For users new to Apple Pay,we simplified the flow to add a card and addressesfrom the payment sheet.Existing users will be able to add another cardwithout leaving the Apple Pay experience.We also redesigned the error handlingfor more clarity when a problem does occur.Once a user has finished adding a new payment method,they seamlessly resume their transaction.We also added a new summary viewwhich shows more detailed information,such as payment items, discounts, and subtotals.New for iOS 15,we also display your app's icon on the summary view.For payments on the web,we're now showing the Web Clip iconon the payment summary view.In Apple Pay, this was previously only visiblewhen using handoff from a Mac to complete a transaction.Now your website iconis viewable within the Apple Pay transactionto provide visual reassurance for the userthat payment is going to the right place.If you accept Apple Pay on the weband you haven't already set a Web Clip icon,we would strongly recommend you make your icon visible to users.To do this, you should provide a 2x and 3x iconat the sizes shown in your root document folder.Apple Pay will then automatically retrieveand display this icon with the payment request.Detailed information on implementing thisis available in the Human Interface Guidelines sectionof the Apple Developer site.While we're on the subject of icon sizes,I wanted to remind you of the new icon size requirementsfor your PKPasses.Since notifications in iOS 15 now display a bigger icon,you'll need to update your PKPass iconsto a minimum of 38x38 at 1x to ensure that your iconsare displayed without blurring.We're also pleased to introduce more flexibilityin the total line.This will enable you to add a dateif the payment occurs later;for example, if you take pre-ordersor to add the frequency for a recurring payment.Many of the new features we've just observed can be addedto your apps with only a few straightforward changes.So we'll now take a closer lookinto the API enhancements we're introducing in iOS 15.We're pleased to add support for shipping date ranges.Now you can present your users with relevant shippingor pickup times within Apple Pay.These can be used to set estimated shippingor delivery dates or time windows for in-store pickups.This extra information is displayedright on the main Apple Pay view.The new shipping date APIs have built-in supportfor calendars and time zones.This makes the handling of shipping datesor pick up times in your app straightforwardand the relevant information is displayed clearly to your users.Now I'll briefly show you how this works.We start by defining a normal shipping methodusing the same PKShippingMethod as before.Next, we choose a calendar.In this example, we use the user's current calendar.We use today as a reference and estimate the arrivalbetween three to seven days from this date.We then determine the start and end date for our date rangeusing the calendar.Finally, we convert the dates to the appropriate date componentsand then we add them to the shipping method.We use date components rather than simple datesso we can take advantage of the rich calendarand time zone support built into iOS.This enables use cases that would otherwise not be possible.For example, we can provide the correct time zonefor a pickup time regardless of the user's current time zone.This level of detail also allows us to showthe date and time information most appropriate to the user,such as displaying a specific pickup time.We've included a JavaScript equivalentfor Apple Pay on the web.You can see we specify the date component rangea little differently than we do in Swift.Your date components can be used in conjunctionwith any of our supported pickup types.For example, you could display a pickup time in your app.In addition to date ranges,you can now declare a read-only shipping address.You can use this to inform the userof a specific pickup location.To enable this, you must provide address detailsas an instance of PKContact.In this example,we have created a postal address as a CNMutablePostalAddressso we can set all the address components that we need.You can now add the shipping contactto payment request.Finally we declare the editing modeand specify the required shipping fields.The address fields included in the PKContactwill be presented to the user as read-only.In this example, we've provided a pick up postal address,which the user won't be able to edit.And here's the equivalent in JavaScriptfor Apple Pay on the web.You setup a shippingContact dictionary,set the shippingType, the shippingContactEditingMode,and the requiredShippingContactFields,and then you include the other fieldsfor a JavaScript payment request.For more information, check out the documentation availableon the Apple Pay section of the Developer Portal.Another great new feature for iOS 15is support for coupon codes.Now your users can enter promotional codesonce they've initiated a payment.This is intended so your usersdon't have to cancel their Apple Pay transactionif they forgot to apply a discount code.You might also consider implementing thisif you have an express purchase flow where users can check outfrom the product page or the shopping cart,but the coupon entry field is only presented at checkout.We've provided methods to update the payment request,so you can validate the discount codesor return error messages when required.Let's dive in and take a look at the code.You can make changes using the delegate methodwhich performs updates whenever the coupon codeis changed by the user.For example, you could use this to validate a codeand then update any payment totals.You also use the method to return customized errorsor update the payment summary items and shipping methods.Russ will show you an example of this in more detail shortly.We recommend prepopulating codes whenever possible,as well as displaying relevant error messagesfor invalid codes.I hope you've enjoyed these exciting API enhancementsfor iOS 15.Now that we have talked all about this in theory,I'm going to hand you over to Russ for a demoso you can see how to implement all these great new features.Russ Fenenga: Thanks, Edward. Hello, everyone.My name is Russ,and I'm a software engineer on the Wallet team.And I'm thrilled to be able to demonstrate to yousome of the amazing new features we have addedto the payment sheet in iOS 15and how you can integrate them into your apps.So let's get started!Here I have my ticket purchasing appfor the food festival I'm planning.My app has already implemented the existing protocol methodsfrom PKPaymentAuthorization ControllerDelegatein order to take advantage of the Apple Pay payment sheet.With iOS 15, the payment sheet will automatically be updatedto the new look without any additional work.I've decided that with the update to iOS 15I want my festival attendees to finally have the abilityto request their tickets in multiple ways.To do this, I'll need to add supportfor multiple shipping methods, so let's dive in!I'll head into our PaymentHandler classwhere I build the PKPaymentRequestto begin adding support for multiple PKShippingMethods.The first thing I'm going to add is a helper functionthat returns me an array of PKShippingMethodsrepresenting the different options available to my users.The first PKShippingMethod I createis a standard shipping method, letting the user knowthey can collect their tickets at the festival.New to iOS 15, I want to provide the useran estimated range it will take the ticketsto be shipped to them.To do this I create a Date and Calendar object,then define a shippingStart and shippingEnd datethree to five days from now.I'm then able to specify the date componentsthat I want to display to the user in the payment sheet.Then I build my PKShippingMethodmaking sure I set the new property, dateComponentsRange,and return the array of the two shipping methods.The last thing I need to do is set the shipping methodson the PKPaymentRequest like so.

With these simple changes, I can build my appand check out the new shipping methods in the payment sheet.A new row has automatically been added to the payment sheetshowing the shipping methods.If I tap the rowI'll see both shipping methods that were just added,including the one that supports date ranges.I've also decided that for the festival this yearI want to send out coupon codes to all my attendeesand add the functionality to redeem themdirectly through the payment sheet in my app.To do this, there are two main changes that I need to make.Let's head back into the code.The first is when building the PKPaymentRequest.There is a new boolean, supportsCouponCode,that needs to be set to true.There also is a new optional property, couponCode,that you can set on your PKPaymentRequestto prepopulate the coupon fieldwith one of your already valid coupon codes.Next, let's jump down to my class extension that conformsto the PKPaymentAuthorization ControllerDelegateand implement the new protocol methodpaymentAuthorizationController didChangeCouponCodewhere I will be able to handle updating my summary itemsand display errors related to the coupon code entrywhen a coupon code is entered.The first thing I'm going to need is a helper functionthat updates our PKPaymentSummaryItemsif a valid coupon code is entered.I grab a reference to the first summary itemwhich is our subtotal item.From there, I create a new PKPaymentSummaryItemthat lets the user see the discount that was applied.I then create a new summary item for tax and total,and then return the array of them.Now that I have my discount application logic written,I can then write my coupon code validation logic.I first check if my coupon code that the user entered was emptyand if it is, just call our completionpassing in the unmodified payment summary items.If the entered coupon code matches a valid coupon code,then I use the just created applyDiscount functionto return the updated summary itemsinto our CouponCodeUpdate object.For your apps,you'll most likely need to be fetching valid coupon codesfrom your server at this point.Finally, if the entered coupon code was invalid,I use the new PKPaymentRequest convenience initializer,paymentCouponCodeInvalidError, and supply it a descriptionto be shown directly in the payment sheet.We also have a second convenience initializerfor expired coupon codes:paymentCouponCodeExpired ErrorWithLocalizedDescription.I then pass this error into our coupon code update initializeras well as the original SummaryItems.Just like that,I've added support for coupon codes inside my app.Let's check it out.To enter a coupon code,I just need to tap into the summary viewand enter a coupon code into the coupon code text field.If I first enter an invalid coupon code, Fest,the error message I suppliedis shown directly below the text field.Now if I enter a valid coupon code, FESTIVAL,the payment summary items are immediately updated.Then I just need to select the shipping contactas well as shipping addressand my payment request is ready to go.

With these simple changes, you're now readyto test your updates to the payment sheeton a device in our Apple Pay sandbox environment.Now, back to Edward.Edward: Thanks, Russ.Russ just showed us how easy it isto implement multiple shipping methods,the new date range, and coupon code APIs.This year we've delivered some exciting new updates to Walletsuch as home key passes, identification,hiding expired passes, and multiple pass ingestion.We introduced the new JavaScript payment buttonfor Apple Pay on the web,and the new Apple Pay experience on iOS.You learned about the new shipping APIs,which include support for date rangesand read-only addresses, as well as coupon codesand how you can implement these in your own apps.For more information,check out the Apple Pay section of the Developer Portal.This includes the Apple Pay sandboxfor testing payment requests from your apps and websites.Thank you for watching.♪

## Code Samples

