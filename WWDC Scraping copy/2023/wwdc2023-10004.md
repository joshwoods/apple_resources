# Wwdc2023 10004

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Transcript

Code

Reduce network delays with L4SStreaming video, multiplayer games, and other real-time experiences depend on responsive, low latency networking. Learn how Low Latency, Low Loss, Scalable throughput (L4S) can reduce network delays and improve the overall experience in your app. We'll show you how to set up and test your app, network, and server with L4S.Chapters0:00 -Welcome1:18 -Discover the benefits of L4S5:44 -Learn how L4S works9:01 -Prepare your app11:19 -Set up your server12:31 -Configure test network and devicesResourcesTesting and Debugging L4S in Your AppHD VideoSD VideoRelated VideosWWDC22Reduce networking delays for a more responsive app

Streaming video, multiplayer games, and other real-time experiences depend on responsive, low latency networking. Learn how Low Latency, Low Loss, Scalable throughput (L4S) can reduce network delays and improve the overall experience in your app. We'll show you how to set up and test your app, network, and server with L4S.

0:00 -Welcome

1:18 -Discover the benefits of L4S

5:44 -Learn how L4S works

9:01 -Prepare your app

11:19 -Set up your server

12:31 -Configure test network and devices

Testing and Debugging L4S in Your App

HD VideoSD Video

HD Video

SD Video

Reduce networking delays for a more responsive app

Search this video…♪ ♪Shawn: Hi, I am Shawn.I am an engineer on the Internet Technologies team.Today, we are going to talk about reducing network delays in your appwith L4S.L4S stands for Low Latency,Low Loss, and Scalable throughput.It is an incredible technologythat dramatically improves the performance of appswhere network latency can impact the user experience.To name just a few benefits, it can help your appreduce content load time, improve video quality,and bring more responsive collaboration between users.Today, we'll first explore how L4S worksand how it reduces network delays.Then, we will go over how to prepare your app for L4Sand how to turn on L4S on your server.Finally, we will talk about the steps you can taketo configure an L4S network and test your app.First, let's explore the benefits of L4S and how it works.A busy network can be especially challengingfor apps that depend on features like real-time audio and video.When the network is used by many devices at once,it can often cause high latency and packet lossin these types of apps.For example, you might have experienced delaysor video stalls during a video callwhen someone else using the same network is watching a movieor downloading a video game.To show you how much L4S can help in such a difficult situation,we have made a sample appthat makes video calls between two devices.I will show you two video calls with my sample appmade at different times,one without L4S and the other with L4S turned on.For both these calls, I used the same constrained networkwith low bandwidth.In addition, there are also multiple other devicesactively using the same network at the same time.Let's see this in action.You will notice a remarkable difference in video quality between the two calls.The legacy one shows occasional video stalls and delays,especially during motion.However, with L4S, the video is smooth and responsive,without any significant delays.Now let's analyze the video calls we have just witnessedto understand what was happening.In this demo, L4S allowed our app to achievesignificant improvements across all key networking metrics.First, let's look at the distribution of round trip time of packetsduring these video calls.A shorter round trip time indicates a lowerand better latency on the network.For an interactive app like this, the tail latency is extremely important,as it shows the worst case that a user experiences.Our test network has a minimum round trip timeof 20 milliseconds.However, without L4S,packets experienced a round trip time of up to 45 milliseconds.But with L4S turned on, even the worst-case latencywas cut by 50%and reduced to less than 25 milliseconds.Next, let's look at packet loss.A lower packet loss representsa more reliable connection between devices.With the legacy one, packet loss rate reached over 40%.But with L4S, packet loss in our video call was nearly eliminated.That means much fewer frame drops or stalls due to loss of data.The improved latency and packet loss rate translated directlyinto better rendering metrics of our video call.First, let's look at the video stall percentage.A lower stall percentage means fewer freezes during a video call.Without L4S, we experienced video stallsin our app from time to time.But with L4S, video stalls were almost completely eliminated.Next, let's look at received video frame rate.A higher and more consistent received video frame ratemeans a richer and smoother video call.With L4S, received video frame ratewas above 25 frames per second for most of the time.However, the legacy one sometimes dropped to as low as 0 frame per second,which means a complete video stall.Altogether, these improvements give a much better user experienceeven in a constrained network.You can bring these same improvements to your appby adopting L4S.Now, let's take a look at how L4S works.We see such remarkable improvements,because L4S reduces queueing and packet loss.Let's first take a look at how a queue builds up in a network.When a packet is sent from your app,it is routed through different network hopsbefore reaching your server.This set of hops your packet traverses is called a network path.On a path through a network, you can only deliver data end-to-endat the rate that is supported by the slowest hop,which is called the bottleneck.For many people, this is their internet service provider connection,and the highest rate it can handle packetsdetermines the maximum throughput supported on the path.If the sender exceeds the maximum throughput,a queue will form at the bottleneck, causing delays for subsequent packets.Without L4S, the queue will continue to growuntil the queue cannot accommodate any more packets.When that happens, packets are dropped,harming both latency and throughput.L4S solves this problem through a collaborationbetween the client, the server, and the bottleneck.With L4S, a client or server sending packetsneeds to signal that they will cooperate to manage network congestion.To do this, an L4S-capable sender will use a technologycalled Explicit Congestion Notification,also known as ECN.When transmitting a packet, the sender indicates support for L4Sby using the ECN bits in the packet's IP header.When an L4S hop receives these packets,it will apply L4S queue management to them.When a queue starts to build up at the bottleneck,L4S queue management will indicate that there is congestionby setting a different ECN label on the packets.This label indicates that the network has experienced congestionbefore forwarding them to the next hop.Upon receiving these packets, the receiver counts the number of packetsmarked with the congestion label and reports the numberback to the sender.When the sender receives this number,it uses this feedback to understand the congestion on the network.The sender then adjusts its sending rateaccording to the level of congestion at the bottleneck,so that it does not exceed the maximum throughput.With an adjusted sending rate, the sender can avoidbuilding a large queue of packets at the bottleneck.This allows L4S to maximize its throughputand achieve low end-to-end latency at the same time.Now, let's explore what you need to doto enable this collaboration to deliver these benefits to your users.First, let's discuss how you can prepare your app for L4S.Using networking APIs in URLSession and Network frameworkis the best way to adopt L4S in your app.If your app uses HTTP/3 or QUIC within these frameworks,L4S support is automatically built in.You don't have to make any code changes to your app.Alternatively, if your app uses HTTP/2 or TCP,iOS 17 and macOS Sonoma have built-in L4S supportfor downloads on these protocols.These are the best ways to add L4S support to your appbecause they do not require any code changes.However, if your app uses a custom protocol,there are a few things you'll need to implementin order to support L4S in your app.RFC 9330 is a good starting pointto learn about L4S requirements.You will need to implement a few new behaviors.For example, your protocol needs to understandL4S congestion feedback from the networkand adjust its sending rate accordingly.To do that, you need to implement a scalable congestion control algorithm.Then, you need to make sure your app sends L4S trafficonly when the network lets ECN bits pass through.To do that, implement an ECN validation mechanismthat checks for any network issues that may be interfering with ECN,such as ECN bleaching.When acting as a receiver, your protocol also needs to havea relay mechanism to echo back the network's ECN feedback to the sender.If your implementation is based on Network framework,you can use the ECN property on your packet metadatato send and receive ECN flags for your custom protocol.If you are using sockets, you can use the set socket optionor send and receive message system calls to send and receive ECN flags.Now we have covered how to prepare your app for L4S,let's explore how to set up your server.If your app uses QUIC,your server's implementation of QUIC also needs to support L4Sand ECN markings.There are numerous QUIC implementations available on the server side.Ask your server provider about how to enable ECN and L4S.If they do not support sending L4S traffic yet,you can still enable ECN to receive L4S traffic on your server.Now is a great time to encourage them to fully support L4S.If your app is using TCP, you will need to add L4S supportto your server's TCP implementation.For Linux based server, follow instructions on this GitHub pageto add support to your server.You can also find more details from the articlein the related items for this video.For all other server platforms, please consult your server provider,as there may be additional configurations or changes requiredin order to support L4S.Now that we have covered how your app and server can be set up for L4S,let's explore how to set up an L4S network to test your app.First, let's review what makes a network L4S-capable.The network must not block ECN markings.ECN markings are used to communicate informationabout the network between the sender, the bottleneck, and the receiver.If your network interferes with ECN markings, L4S will not work.The documentation has steps you can follow,along with additional tools, that you can use to verifyif your network is ECN compatible.Next, the network bottleneck must support L4S queue management.This is essential to being able to see the benefits of L4S.Once you have verified that your network is ECN compatible,you just need to add L4S queue management to the bottleneck.To set up a test network that supports L4S queue management,the best way is to use Internet Sharing.In macOS Sonoma, Internet Sharing supports L4S queue management.When a device joins the network created by a Mac with Internet Sharing,the Mac itself becomes an additional network hopbetween the device and the server.If you configure the Mac to be the bottleneck on the network,it will apply L4S queue management to traffic going through it,allowing you to build a complete L4S network.To enable Internet Sharing in macOS,navigate to the Internet Sharing pane in System Settings.Click the disclosure button to choose the interface to shareand the interface to which your test device will connect.To make the Mac act as a bottleneck on this network,you need to throttle its bandwidth.Use this ifconfig command in Terminal with the interface you are sharing,as well as the interface your device will connect to.Replace the interface name in this commandwith the name of the interfaces you are using,for example, en1.Then, join the network on your test deviceand test your app to see the benefits of L4S.To reverse the bandwidth throttling on the Mac,you can either reboot or run the same ifconfig commandbut change the bandwidth to 0 instead of 10 megabits per second.In iOS 17 and macOS Sonoma,L4S will be progressively rolled out to a random set of users.To ensure your test device has L4S turned on,navigate to Developer Settings and turn on L4S.In macOS, you can enable L4Sby running this defaults write command before testing.If your network or server does not support L4S,TCP and QUIC will continue to work in the legacy mode.However, you should turn L4S onand test your application to identify any issues.Provide feedback using the Feedback Assistantif any issues arise.The documentation also provides helpful informationabout debugging and testing L4S in your app.I am so excited that apps and networks are now able to supportreduced latency and reduced packet loss with L4S.Test your app in iOS 17 and macOS Sonoma todayon networks that support L4Sas well as on networks that do not.Work with your server or CDN provider to enable support for L4Son your app's servers, if they haven't already done so.Use the Feedback Assistant to report any issues you encounterwith L4S turned on in your app.Thanks for watching.I am looking forward to building even better apps with you using L4S.♪ ♪

♪ ♪Shawn: Hi, I am Shawn.I am an engineer on the Internet Technologies team.Today, we are going to talk about reducing network delays in your appwith L4S.L4S stands for Low Latency,Low Loss, and Scalable throughput.It is an incredible technologythat dramatically improves the performance of appswhere network latency can impact the user experience.To name just a few benefits, it can help your appreduce content load time, improve video quality,and bring more responsive collaboration between users.

Today, we'll first explore how L4S worksand how it reduces network delays.Then, we will go over how to prepare your app for L4Sand how to turn on L4S on your server.Finally, we will talk about the steps you can taketo configure an L4S network and test your app.First, let's explore the benefits of L4S and how it works.

A busy network can be especially challengingfor apps that depend on features like real-time audio and video.When the network is used by many devices at once,it can often cause high latency and packet lossin these types of apps.For example, you might have experienced delaysor video stalls during a video callwhen someone else using the same network is watching a movieor downloading a video game.To show you how much L4S can help in such a difficult situation,we have made a sample appthat makes video calls between two devices.I will show you two video calls with my sample appmade at different times,one without L4S and the other with L4S turned on.For both these calls, I used the same constrained networkwith low bandwidth.In addition, there are also multiple other devicesactively using the same network at the same time.Let's see this in action.You will notice a remarkable difference in video quality between the two calls.The legacy one shows occasional video stalls and delays,especially during motion.However, with L4S, the video is smooth and responsive,without any significant delays.Now let's analyze the video calls we have just witnessedto understand what was happening.In this demo, L4S allowed our app to achievesignificant improvements across all key networking metrics.First, let's look at the distribution of round trip time of packetsduring these video calls.A shorter round trip time indicates a lowerand better latency on the network.For an interactive app like this, the tail latency is extremely important,as it shows the worst case that a user experiences.Our test network has a minimum round trip timeof 20 milliseconds.However, without L4S,packets experienced a round trip time of up to 45 milliseconds.But with L4S turned on, even the worst-case latencywas cut by 50%and reduced to less than 25 milliseconds.

Next, let's look at packet loss.A lower packet loss representsa more reliable connection between devices.With the legacy one, packet loss rate reached over 40%.But with L4S, packet loss in our video call was nearly eliminated.That means much fewer frame drops or stalls due to loss of data.The improved latency and packet loss rate translated directlyinto better rendering metrics of our video call.First, let's look at the video stall percentage.A lower stall percentage means fewer freezes during a video call.Without L4S, we experienced video stallsin our app from time to time.But with L4S, video stalls were almost completely eliminated.

Next, let's look at received video frame rate.A higher and more consistent received video frame ratemeans a richer and smoother video call.With L4S, received video frame ratewas above 25 frames per second for most of the time.However, the legacy one sometimes dropped to as low as 0 frame per second,which means a complete video stall.Altogether, these improvements give a much better user experienceeven in a constrained network.You can bring these same improvements to your appby adopting L4S.Now, let's take a look at how L4S works.

We see such remarkable improvements,because L4S reduces queueing and packet loss.Let's first take a look at how a queue builds up in a network.When a packet is sent from your app,it is routed through different network hopsbefore reaching your server.This set of hops your packet traverses is called a network path.

On a path through a network, you can only deliver data end-to-endat the rate that is supported by the slowest hop,which is called the bottleneck.For many people, this is their internet service provider connection,and the highest rate it can handle packetsdetermines the maximum throughput supported on the path.If the sender exceeds the maximum throughput,a queue will form at the bottleneck, causing delays for subsequent packets.Without L4S, the queue will continue to growuntil the queue cannot accommodate any more packets.When that happens, packets are dropped,harming both latency and throughput.L4S solves this problem through a collaborationbetween the client, the server, and the bottleneck.With L4S, a client or server sending packetsneeds to signal that they will cooperate to manage network congestion.

To do this, an L4S-capable sender will use a technologycalled Explicit Congestion Notification,also known as ECN.When transmitting a packet, the sender indicates support for L4Sby using the ECN bits in the packet's IP header.When an L4S hop receives these packets,it will apply L4S queue management to them.

When a queue starts to build up at the bottleneck,L4S queue management will indicate that there is congestionby setting a different ECN label on the packets.This label indicates that the network has experienced congestionbefore forwarding them to the next hop.Upon receiving these packets, the receiver counts the number of packetsmarked with the congestion label and reports the numberback to the sender.When the sender receives this number,it uses this feedback to understand the congestion on the network.The sender then adjusts its sending rateaccording to the level of congestion at the bottleneck,so that it does not exceed the maximum throughput.With an adjusted sending rate, the sender can avoidbuilding a large queue of packets at the bottleneck.This allows L4S to maximize its throughputand achieve low end-to-end latency at the same time.Now, let's explore what you need to doto enable this collaboration to deliver these benefits to your users.First, let's discuss how you can prepare your app for L4S.Using networking APIs in URLSession and Network frameworkis the best way to adopt L4S in your app.If your app uses HTTP/3 or QUIC within these frameworks,L4S support is automatically built in.You don't have to make any code changes to your app.Alternatively, if your app uses HTTP/2 or TCP,iOS 17 and macOS Sonoma have built-in L4S supportfor downloads on these protocols.These are the best ways to add L4S support to your appbecause they do not require any code changes.However, if your app uses a custom protocol,there are a few things you'll need to implementin order to support L4S in your app.RFC 9330 is a good starting pointto learn about L4S requirements.You will need to implement a few new behaviors.For example, your protocol needs to understandL4S congestion feedback from the networkand adjust its sending rate accordingly.To do that, you need to implement a scalable congestion control algorithm.Then, you need to make sure your app sends L4S trafficonly when the network lets ECN bits pass through.To do that, implement an ECN validation mechanismthat checks for any network issues that may be interfering with ECN,such as ECN bleaching.When acting as a receiver, your protocol also needs to havea relay mechanism to echo back the network's ECN feedback to the sender.If your implementation is based on Network framework,you can use the ECN property on your packet metadatato send and receive ECN flags for your custom protocol.If you are using sockets, you can use the set socket optionor send and receive message system calls to send and receive ECN flags.

Now we have covered how to prepare your app for L4S,let's explore how to set up your server.If your app uses QUIC,your server's implementation of QUIC also needs to support L4Sand ECN markings.There are numerous QUIC implementations available on the server side.Ask your server provider about how to enable ECN and L4S.If they do not support sending L4S traffic yet,you can still enable ECN to receive L4S traffic on your server.Now is a great time to encourage them to fully support L4S.

If your app is using TCP, you will need to add L4S supportto your server's TCP implementation.For Linux based server, follow instructions on this GitHub pageto add support to your server.You can also find more details from the articlein the related items for this video.For all other server platforms, please consult your server provider,as there may be additional configurations or changes requiredin order to support L4S.Now that we have covered how your app and server can be set up for L4S,let's explore how to set up an L4S network to test your app.First, let's review what makes a network L4S-capable.The network must not block ECN markings.ECN markings are used to communicate informationabout the network between the sender, the bottleneck, and the receiver.If your network interferes with ECN markings, L4S will not work.The documentation has steps you can follow,along with additional tools, that you can use to verifyif your network is ECN compatible.Next, the network bottleneck must support L4S queue management.This is essential to being able to see the benefits of L4S.Once you have verified that your network is ECN compatible,you just need to add L4S queue management to the bottleneck.To set up a test network that supports L4S queue management,the best way is to use Internet Sharing.

In macOS Sonoma, Internet Sharing supports L4S queue management.When a device joins the network created by a Mac with Internet Sharing,the Mac itself becomes an additional network hopbetween the device and the server.If you configure the Mac to be the bottleneck on the network,it will apply L4S queue management to traffic going through it,allowing you to build a complete L4S network.To enable Internet Sharing in macOS,navigate to the Internet Sharing pane in System Settings.Click the disclosure button to choose the interface to shareand the interface to which your test device will connect.

To make the Mac act as a bottleneck on this network,you need to throttle its bandwidth.Use this ifconfig command in Terminal with the interface you are sharing,as well as the interface your device will connect to.Replace the interface name in this commandwith the name of the interfaces you are using,for example, en1.Then, join the network on your test deviceand test your app to see the benefits of L4S.To reverse the bandwidth throttling on the Mac,you can either reboot or run the same ifconfig commandbut change the bandwidth to 0 instead of 10 megabits per second.

In iOS 17 and macOS Sonoma,L4S will be progressively rolled out to a random set of users.To ensure your test device has L4S turned on,navigate to Developer Settings and turn on L4S.In macOS, you can enable L4Sby running this defaults write command before testing.If your network or server does not support L4S,TCP and QUIC will continue to work in the legacy mode.However, you should turn L4S onand test your application to identify any issues.Provide feedback using the Feedback Assistantif any issues arise.The documentation also provides helpful informationabout debugging and testing L4S in your app.I am so excited that apps and networks are now able to supportreduced latency and reduced packet loss with L4S.

Test your app in iOS 17 and macOS Sonoma todayon networks that support L4Sas well as on networks that do not.Work with your server or CDN provider to enable support for L4Son your app's servers, if they haven't already done so.Use the Feedback Assistant to report any issues you encounterwith L4S turned on in your app.Thanks for watching.I am looking forward to building even better apps with you using L4S.♪ ♪

14:38 -Throttle Internet Sharing

15:36 -Turn on L4S

## Code Samples

```swift
sudo ifconfig en1 tbr 10Mbps
```

```swift
sudo defaults write -g network_enable_l4s -bool 
true
```

