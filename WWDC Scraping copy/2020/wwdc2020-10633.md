# Wwdc2020 10633

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Transcript

Capture and stream apps on the Mac with ReplayKitLearn how you can integrate ReplayKit into your Mac apps and games to easily share screen recordings or broadcast live audio and visuals online. We'll show you how to capture screen content, audio, and microphone input inside your Mac apps, and even broadcast your video to a live audience.

For more on getting started with this framework in your app, be sure to see “Live Screen Broadcast with ReplayKit” and "What's New with Screen Recording and Live Broadcast" from previous years.ResourcesRecording and Streaming Your macOS AppReplayKitHD VideoSD VideoRelated VideosWWDC21Discover rolling clips with ReplayKit

Learn how you can integrate ReplayKit into your Mac apps and games to easily share screen recordings or broadcast live audio and visuals online. We'll show you how to capture screen content, audio, and microphone input inside your Mac apps, and even broadcast your video to a live audience.

For more on getting started with this framework in your app, be sure to see “Live Screen Broadcast with ReplayKit” and "What's New with Screen Recording and Live Broadcast" from previous years.

Recording and Streaming Your macOS App

ReplayKit

HD VideoSD Video

HD Video

SD Video

Discover rolling clips with ReplayKit

Search this video…Hello and welcome to W.W.D.C.Hello and welcome to the ReplayKit for macOS Session. My name is JohnnyTrenh and I'm a software engineer on the ReplayKit team. Today I'm reallyexcited to talk to you about ReplayKit on the mac platform as well as somenew exciting features for all platforms. Got a lot to cover so let's get started.Replay kit is a framework that gives you the ability to record or captureyour application's screen audio and microphone content to a video that peoplecan edit save and share. ReplayKit also gives you the ability to broadcastyour application screen audio and microphone to other third party broadcastservices to be viewed all over the world. ReplayKit originally launchedfor iOS in 2015 and in 2016 ReplayKit for tvOS was introduced. This yearI'm pleased to announce ReplayKit is coming to the Mac. All the greatfeatures that are available to your iOS and tvOS applications will nowbe made available for your mac applications. You can now record captureand broadcast your mac application to everyone in the world. The main goalin bringing ReplayKit to the mac was to ensure that you have access toall the great features that we're already shipping with iOS and tvOS.Along with the same HD quality low performance impact and built in privacy safeguards.Now as you can imagine applications work quite differently on the mac whencompared to iOS or tvOS. So let's take a look at the major ReplayKitfeatures in the mac and I'll start with screen recording. Screen recordinggives you the ability to record your application screen audio and microphoneinto a video that people can then edit save or share. How does screen recordingwork under the hood. Well let's take a look. Your application will callinto RPSScreenRecorder to get the sharedRecorder singleton instance. Withthe shared instance you can start Recording at which point the Replay Kit willstart to capture the screen audio and microphone samples from your applicationand start writing those samples into a movie file. When your applicationcalls stopRecording replay kit saves the recording calls a preview andshare extension and passes that information backup through RPPreviewViewController.You then present the preview view controller which allowspeople to edit save or share that movie file. Why don't we jump in and see howwe can start in app recording in a project.So here I want to talk a little bit about our project first. I'm here onour main story board. So the main story board we have three buttons thatare going to indicate the different functionalities that we're going toexpress and build out throughout this demo. We're only going to focus onit start recording button right now that you see right here on our storyboard.So this button is already hooked up to our code via IBOutlets and throughthe storyboard. What we're going to look at now is the IBAction forwhat happens when someone presses this button. So here in our code the IBActionis right here for recordButtonTapped button tapped. Now we're gonna do twodifferent types of things with this button. Were actually going have the buttonpull double duty for us if we're actively recording. This button is goingto stop recording if we're not actively recording. This button is goingto start recording for us. So let's go ahead and take a look at what happenswhen we start recording. So here is our IBAction and we're going tolook at the method start recording. Now it's very easy. The first thingyou want to do is you want to go ahead and call RPScreenRecorder andget the sharedRecorder instance. From there we're gonna go ahead and callstartRecording. After that this entire block is going to be executed right here.So the first thing you want to do because we're gonna give back an erroris you want to see if we have an error. Now if we don't have an error thenwe're properly recording and everything is started up just fine. So herewe say that there's no error. All we're simply going to do is we're gonnago ahead and update our recordingState. Now what do we do when we updateour recordingState. Actually what we do when we update our recordingStateis we simply set the button to reflect that. Are we recording or not recording.Start or stop. And that's it. And we update our state. After that we arenow up and recording. ReplayKit is now actually capturing everything andrecording a video for you. So what happens when your user taps the button again.Well here we're going to go ahead and call stopRecording. And let's takea look at how that works. Going down to the stopRecording method.Right here once again we're going to go ahead and get the sharedRecorded instanceand then we're going to go ahead and call stopRecording. When we do thatto completionHandler block is then executed. Now this looks a little bitcomplicated but I'll walk you through it because it's actually really simple.The first thing when you do is check to see if we have an error if we don'thave an error. Let's check to see if we have a previewViewController.Now this is where it gets really interesting. But we want to do with thepreviewViewController is like we spoke about you want to display it so peoplecan edit save or share their video. So we get the previewViewController.We go ahead and save a reference to that here and then this is the important part.You want to make sure that you are a delegate of the previewViewController.And I'll talk to you about why that's important just a little bit.Then you want to go ahead and share the sheet. In this case I'm using main windowand begin sheet. You can share the sheet or show the sheet however whichway you choose using UIKit. But in this example we're gonna go aheadand use begin sheet and that's it. We're gonna go ahead and show the sheet.We do some error checking here. And if there's errors we print them.If not then after that we go ahead and set the recordingState because we'reno longer recording. So let's take a look at what happens after the userinteracts with the previewViewController. That's why we want to be partof the delegate. So I'm going to go ahead and scroll down here. And hereis our delegate previewViewController did finish.This is going to be called when the user is done using the previewViewController.They're gonna go ahead and click save or exit out of it. And that's whenyou get notified. So the reason why this is important is because we wantto keep a reference to that PreviewViewController so that we can dismiss it.And that's it. Just like that you're up and running with ReplayKit andrecording your application to a video. Now that you've seen what it lookslike in code I want to take a moment to highlight some of the differences withRPPreviewViewController. People will be able to edit and trim the recordingby tapping on the edit button in the preview view controller. Saving thevideo will be a very familiar experience for people as it follows the standardmacOS file save flow. With just two simple API calls. You're now up andrunning and recording with ReplayKit with in app screen recording youand your application don't have access to the movie file. ReplayKit handlesthe creation of the movie and people drive the sharing and saving of therecorded session. However in the past I've received a lot of requestsfrom other developers about having access to the recorded movie. I thinkwe finally have an answer for those requests. This is how screen recordingcurrently works. As you can see the movie file is created and saved withinReplayKit and your application has no access to recorded movie itself.It is only provided with a preview view controller for people to editand save the video. But what if instead of ReplayKit handling the video file.We give your application to read access to the video. You can now do thatwith our new stop API. The new stopRecordingWithURL will allow youto provide a destination URL and ReplayKit will write and savea recorded movie to that URL. You now have direct access to therecorded movies and you can incorporate them into your application. With ityou can create and manage replay videos in your application. You can evencreate a custom video editor and have it integrated right into your own app experience.These are just some of the new and exciting experiences you can createusing the newStopRecording AP but you might be thinking what if I don'twant ReplayKit to make the movie recording for me. What if I want morecontrol of my application's video and audio content. And for that you canuse In-App screen capture the next major feature we've brought to theMac for ReplayKit. With in app screen capture Replay Kit will send theaudio and video samples straight to your application's process where you'llhave complete control in how to use them. Let's go ahead and take a quicklook at how that works. You've already seen how in app screen recordingis done by interacting with the shared screen recorder instance. But insteadof calling startRecording. When startCapture is called on the sharedRecorderReplayKit will start to capture your audio visual and microphonesamples from your application. However instead of ReplayKit creating andmanaging a movie for you as we do in recording we sent all audio and visualsamples back to your application process. Let's jump back into our samplecode project and see how we get started with that capture for the Mac. OK.So we're back into our project here and once again we're taking a lookat the storyboard. Remember like we said before we're building out thisdemo so that we can cover all three of the major functionalities in ReplayKit.We've already covered the start recording button.Now we're going to go ahead and focus on the start capture button.Let's take a look at how that looks like inside the code. So here. We have IBActionthat's tied to the button from our storyboard. Just like with therecording our button is gonna pull double duty if we're actively not recordingor broadcasting or capturing. Tapping this button is gonna start capture.Now if we are actively capturing tapping this button is gonna stop capture.So let's go ahead and take a look at what happens when we hit startCapture.Here's our code for startCapture. Now it looks a little bit crazy butI'll talk to you step by step here we're gonna go ahead and call screenRecorderand get the sharedRecorder instance. From there you're gonna call startCapture.startCapture is gonna take in two different handlers. The first handleris going to be your sample handler which we see here. This block of codeis executed every time ReplayKit gives you a sample whether it be audiovideo or microphone. So this block of code is run continuously. Now thesecond handler is going to be the completiionHandler which we have here.Now the completionHandler is called only once when you start capture.This is much like the recording completion handler where it signifies toyou that capture has started and we'll give you an error if there's somethingthat happened in the process. So let's take a look at the completion handlerfirst and then we'll take a look at what we do when the samples come in.Here in the completion handler just like with recording we're going tocheck to see if we have any errors if we don't have any errors. We're goingto set the caputre state much like we did with recording. Well what dowe do in the recording capture state. Well we set the button titleour active state internally and we disable the other buttons and we set upthe camera view. Now we saw this back in the recording as well. The cameraview is going to allow you to use the camera pip to add to your application.So what happens if we do have an error. We're going to go ahead and printthe error and move forward. Now let's go ahead and look at the sample blockbecause this is actually the most interesting bit because this gets calledevery time ReplayKit gives you a sample. So what you want to do is youwant to go ahead and take a look at all the different samples and all thedifferent types that we give back. Then you want to go ahead and decidewhat you want to do with it. So in this completion block we give you backa sample. We give you back the sample type and an error. And in this blockright here the first thing we do is we take a look to see if you have any errors.If we do we go out and print them. If not we're going to run a switch statementon the type. Now I'm sure in your application you're going to be doinga lot of really really awesome things but in this application we'll keepit simple. We're gonna go ahead and go through each one of these typesand we'll process them separately. So for if it's a video type we'll goahead and say processAPPVideoSample. We'll do the same for audio and micAnd that's it. These samples are given to you from ReplayKit and thenyou can do whatever you need to do with them. Let's take a look at whatwe do in this example. Which is pretty simple for all of our process methodsall we do is print. Now again I'm sure you can do something far more interestingand I'm excited to see what you do with it. But for this example we justprint and that's it. We're getting all of these samples and we printif we get the audio we print if we get a video and then we print if we geta mic.And just like that you're up and running with capture. With in app screencapture your application now has access to all the video and audio samplesthrough ReplayKit. You can build dynamic in app experiences that includescreenshots now that you have access to the samples you can add customgaming overlays to the videos. With this raw data you can even implementa custom heads up display like this for your application. The possibilitiesreally are endless.OK so now we can record and we can capture but what happens when you'reready to take things global. That's what live broadcast is for. The finalmajor feature we've bought over to macOS for ReplayKit. With live broadcastsyou give people the ability to stream their experience and your applicationto a third party streaming service allowing viewers from all over the worldto watch live. Let's take a quick look at how live broadcast works beforewe jump into another example of how to set up a live broadcast. With in app broadcastyou will call into RPBroadcastActivityController to display a pickerfor the available third party streaming services. When people select athird party streaming service ReplayKit will setup the broadcast connectionto the streaming service and give back a RPBroadcastController toyour application. The broadcast controller is what you'll use to controlthe actual broadcast. Here's a quick overview of the three part processthat'll allow you to start live broadcasting your application. People willinitiate a broadcast and you'll present the broadcast picker. People willselect the broadcast service and you'll get back a broadcast controller.Then you'll start to broadcast using that controller.Now that we have an idea of how that works let's go ahead and take a lookat how we can do that in a project. OK so we're back live here in our storyboard.We've already covered the start recording and start capture. Now we'regoing to go ahead and focus on the start broadcast button. This is wherethings get really really cool. All right let's jump back into our swiftcode here and here we go. We're right here on the IBAction for the button tap.Once again our broadcast button is going to pull double duty for us ifwe're active. The broadcast button is going to start broadcasts. And ifwe're not active it's going to start our broadcast. Let's look at the moreinteresting bit which is starting a broadcast and you'll see how easy itis to actually get your app global and broadcasting to the world. All right.Here is our button. And we're going to go ahead and do the presentBroadcastPickerlike we covered in the slides. This is what happens when your applicationpresents a picker for the available third party broadcasts so that peoplecan choose. Let's go ahead and jump into that code right here andhere it is. Well first thing we're going to do is we're going to decide on apicker origin point. This is the origin point. That is the bottom lefthand corner of the broadcast picker. Next we're going to go ahead and goon to the RPBroadcastActivityController and we're going to callshowBroadcastPicker at our origin point from the shared window of our application.And we're going to pass in a nil for preferred extension because for nowI just want to show all the available third party streaming services. All right.When we call that this block right here is going to get executed. And thefirst thing we would do is check for errors if we don't have an error.This is what we're going to do. We're going to go ahead and set the activitycontroller that we give back from this call and we're going to keep a referenceto it. You'll see why this is important later. And then you're going toget a activity controller delegate. Now the delegate part is a really reallyimportant part. You're going to need to set yourself as the delegate oryour application as the delegate. I will explain that in just a little bit.If we have an error go ahead and print it. So now you're gonna go aheadand present this picker. People are going to go ahead and choose a broadcastthat they want to do. And then you're going to want to be notified whenthey're done. This is where the delegate comes in and why it's very very important.Let's go ahead and take a look at the delegate call. Here is theBroadcastActivityController delegate. Did finish with broadcast controller.So we definitely want to go ahead and be a delegate here. And the reason whyis when the user is done picking a third party broadcast ReplayKit willconnect your application to the broadcast extension. And we're gonna giveyou back a broadcast controller. You need the broadcast controller herebecause that broadcast controller is what you're gonna use to actuallycontrol the broadcast. So in this call we're gonna go ahead and check tosee if we have an error. We don't have an error. We're gonna go ahead andsave the broadcast controller because the broadcast controller again controlsyour broadcast. You can pause. You can stop start. All of those thingsare tied in with the broadcast controller. Then we immediately use a broadcastcontroller to call startBroadcast. Then another block is executed.This is just like your startRecording. You call this and we give you back an error.If there's an error that means something went wrong but if there isn'tyou are now broadcasting to the third party streaming service people have selected.We do is update our broadcast state like we did it the other ones whichis going to update our button title our internal state and disable theother two ReplayKit functional buttons. And that's it. You're now broadcasting.You are now sending audio and video to the users selected third party broadcasts service.Now what happens when we want to call stopBroadcast. Now this is interestingbecause when we call stopBroadcast right here. This is why we want tosave the broadcast controller because here we simply call our referencebroadcast controller and we call finishBroadcast at which point thisentire block will be executed just like with stopRecording and stopCapture.We'll give you an error if something has happened. First thing you wantto do is check the error. We don't have an error set your broadcast dateto false because we're no longer broadcasting. Turn down your camera andanything else that you need to do. And that's it. You've just started andstop a live broadcast with their application and you're ready to take your application global.I want to take a minute to go into a little bit more depth what the differencesfor in app live broadcast that were made for macOS. If you're coming from iOS.you'll notice that we no longer interact with the RPBroadcastActivityViewControllerclass. Instead for macOS that class has been replacedwith RPBroadcastActivityController. Due to macOS supporting multiplescreens and windows instead of calling loadBroadcastActivityViewControllerlike we do in iOS for macOS we call showBroadcastPicker with a CGPointand a window reference. We also take in a preferred extension identifierif your application wants to stream directly to a specific broadcast service. TheCGPoint passed in is a reference to the origin point of the passed in windowand represents the bottom left hand corner for the broadcast picker.You're now global with your application using ReplayKit live broadcast. When youstart to implement ReplayKit in your macOS applications you're goingto notice something new that's been added to your menu bar. With ReplayKiton macOS in keeping with the goal of user privacy you'll seea new menu bar item shown on the menu bar every time you start an activerecording capture or broadcast session. The menu bar icon indicates thatthere is an active ReplayKit session. It also serves as a way for peopleto stop the active ReplayKit session. You'll need to make sure that youadhere to the rpScreenRecordingDelegate method calldidStopRecordingWithPreviewViewController as this will be called when people clickon the menu bar icon to stop a session. For in app capture and live broadcast sessionsthe RPPreviewViewController passed in will be nil. With that you'renow ready to add ReplayKit to record capture and broadcast your applicationsand share them with the rest of the world. But we have one last thing wewant to talk about and that is game controllers. I'm happy to announcethat there is now ReplayKit support for the Game Controller Frameworkand iOS tvOS and macOS. The game controller framework will now havebuilt in ReplayKit functionality. Double tapping the share button on thePS4 controller or the select button on Xbox controller will start anin app recording. Double tapping again will automatically stop the in-apprecording and save it to your photos for iOS and your desktop for macOS.For applications already using ReplayKit game controllers can start andstop recording's outside your Applications control. So it's a good idea tomake sure you're using key value observing for both availability and recordingproperties on RPScreenRecorder so that you can update your state as needed.Also be sure to follow the protocol method didStopRecordingWithPreviewViewControlleron RPScreenRecorderDelegate so that you can updateyour application state as needed. I'm super excited to be announcing ReplayKitsupport for game controllers. I hope to see it in your games very soon.Wow we've covered a lot today let's go ahead and take a quick recap ofwhat we talked about. I covered in app screen recording where ReplayKitwill record your applications audio and video into a movie that peoplecan edit share and save. I covered in app screen capture where ReplayKitgives your applications audio and video samples right back to you inyour applications process. I covered in app screen broadcast where ReplayKitsends your application audio and video to a third party live streaming service.And finally I covered the new built in functionality found in GameControllers Framework.The sample code project as well as the documentation regarding ReplayKitFramework or to revisit this session please visit us at developer.apple.comWe look forward to seeing you add ReplayKit to your iOS tvOSand now macOS applications.Thank you so much for watching our session on ReplayKit for macOS andI hope you have a wonderful WWDC

Hello and welcome to W.W.D.C.

Hello and welcome to the ReplayKit for macOS Session. My name is JohnnyTrenh and I'm a software engineer on the ReplayKit team. Today I'm reallyexcited to talk to you about ReplayKit on the mac platform as well as somenew exciting features for all platforms. Got a lot to cover so let's get started.

Replay kit is a framework that gives you the ability to record or captureyour application's screen audio and microphone content to a video that peoplecan edit save and share. ReplayKit also gives you the ability to broadcastyour application screen audio and microphone to other third party broadcastservices to be viewed all over the world. ReplayKit originally launchedfor iOS in 2015 and in 2016 ReplayKit for tvOS was introduced. This yearI'm pleased to announce ReplayKit is coming to the Mac. All the greatfeatures that are available to your iOS and tvOS applications will nowbe made available for your mac applications. You can now record captureand broadcast your mac application to everyone in the world. The main goalin bringing ReplayKit to the mac was to ensure that you have access toall the great features that we're already shipping with iOS and tvOS.

Along with the same HD quality low performance impact and built in privacy safeguards.

Now as you can imagine applications work quite differently on the mac whencompared to iOS or tvOS. So let's take a look at the major ReplayKitfeatures in the mac and I'll start with screen recording. Screen recordinggives you the ability to record your application screen audio and microphoneinto a video that people can then edit save or share. How does screen recordingwork under the hood. Well let's take a look. Your application will callinto RPSScreenRecorder to get the sharedRecorder singleton instance. Withthe shared instance you can start Recording at which point the Replay Kit willstart to capture the screen audio and microphone samples from your applicationand start writing those samples into a movie file. When your applicationcalls stopRecording replay kit saves the recording calls a preview andshare extension and passes that information backup through RPPreviewViewController.You then present the preview view controller which allowspeople to edit save or share that movie file. Why don't we jump in and see howwe can start in app recording in a project.

So here I want to talk a little bit about our project first. I'm here onour main story board. So the main story board we have three buttons thatare going to indicate the different functionalities that we're going toexpress and build out throughout this demo. We're only going to focus onit start recording button right now that you see right here on our storyboard.So this button is already hooked up to our code via IBOutlets and throughthe storyboard. What we're going to look at now is the IBAction forwhat happens when someone presses this button. So here in our code the IBActionis right here for recordButtonTapped button tapped. Now we're gonna do twodifferent types of things with this button. Were actually going have the buttonpull double duty for us if we're actively recording. This button is goingto stop recording if we're not actively recording. This button is goingto start recording for us. So let's go ahead and take a look at what happenswhen we start recording. So here is our IBAction and we're going tolook at the method start recording. Now it's very easy. The first thingyou want to do is you want to go ahead and call RPScreenRecorder andget the sharedRecorder instance. From there we're gonna go ahead and callstartRecording. After that this entire block is going to be executed right here.So the first thing you want to do because we're gonna give back an erroris you want to see if we have an error. Now if we don't have an error thenwe're properly recording and everything is started up just fine. So herewe say that there's no error. All we're simply going to do is we're gonnago ahead and update our recordingState. Now what do we do when we updateour recordingState. Actually what we do when we update our recordingStateis we simply set the button to reflect that. Are we recording or not recording.Start or stop. And that's it. And we update our state. After that we arenow up and recording. ReplayKit is now actually capturing everything andrecording a video for you. So what happens when your user taps the button again.Well here we're going to go ahead and call stopRecording. And let's takea look at how that works. Going down to the stopRecording method.Right here once again we're going to go ahead and get the sharedRecorded instanceand then we're going to go ahead and call stopRecording. When we do thatto completionHandler block is then executed. Now this looks a little bitcomplicated but I'll walk you through it because it's actually really simple.The first thing when you do is check to see if we have an error if we don'thave an error. Let's check to see if we have a previewViewController.

Now this is where it gets really interesting. But we want to do with thepreviewViewController is like we spoke about you want to display it so peoplecan edit save or share their video. So we get the previewViewController.

We go ahead and save a reference to that here and then this is the important part.You want to make sure that you are a delegate of the previewViewController.And I'll talk to you about why that's important just a little bit.Then you want to go ahead and share the sheet. In this case I'm using main windowand begin sheet. You can share the sheet or show the sheet however whichway you choose using UIKit. But in this example we're gonna go aheadand use begin sheet and that's it. We're gonna go ahead and show the sheet.

We do some error checking here. And if there's errors we print them.If not then after that we go ahead and set the recordingState because we'reno longer recording. So let's take a look at what happens after the userinteracts with the previewViewController. That's why we want to be partof the delegate. So I'm going to go ahead and scroll down here. And hereis our delegate previewViewController did finish.This is going to be called when the user is done using the previewViewController.They're gonna go ahead and click save or exit out of it. And that's whenyou get notified. So the reason why this is important is because we wantto keep a reference to that PreviewViewController so that we can dismiss it.

And that's it. Just like that you're up and running with ReplayKit andrecording your application to a video. Now that you've seen what it lookslike in code I want to take a moment to highlight some of the differences withRPPreviewViewController. People will be able to edit and trim the recordingby tapping on the edit button in the preview view controller. Saving thevideo will be a very familiar experience for people as it follows the standardmacOS file save flow. With just two simple API calls. You're now up andrunning and recording with ReplayKit with in app screen recording youand your application don't have access to the movie file. ReplayKit handlesthe creation of the movie and people drive the sharing and saving of therecorded session. However in the past I've received a lot of requestsfrom other developers about having access to the recorded movie. I thinkwe finally have an answer for those requests. This is how screen recordingcurrently works. As you can see the movie file is created and saved withinReplayKit and your application has no access to recorded movie itself.

It is only provided with a preview view controller for people to editand save the video. But what if instead of ReplayKit handling the video file.

We give your application to read access to the video. You can now do thatwith our new stop API. The new stopRecordingWithURL will allow youto provide a destination URL and ReplayKit will write and savea recorded movie to that URL. You now have direct access to therecorded movies and you can incorporate them into your application. With ityou can create and manage replay videos in your application. You can evencreate a custom video editor and have it integrated right into your own app experience.

These are just some of the new and exciting experiences you can createusing the newStopRecording AP but you might be thinking what if I don'twant ReplayKit to make the movie recording for me. What if I want morecontrol of my application's video and audio content. And for that you canuse In-App screen capture the next major feature we've brought to theMac for ReplayKit. With in app screen capture Replay Kit will send theaudio and video samples straight to your application's process where you'llhave complete control in how to use them. Let's go ahead and take a quicklook at how that works. You've already seen how in app screen recordingis done by interacting with the shared screen recorder instance. But insteadof calling startRecording. When startCapture is called on the sharedRecorderReplayKit will start to capture your audio visual and microphonesamples from your application. However instead of ReplayKit creating andmanaging a movie for you as we do in recording we sent all audio and visualsamples back to your application process. Let's jump back into our samplecode project and see how we get started with that capture for the Mac. OK.So we're back into our project here and once again we're taking a lookat the storyboard. Remember like we said before we're building out thisdemo so that we can cover all three of the major functionalities in ReplayKit.We've already covered the start recording button.Now we're going to go ahead and focus on the start capture button.Let's take a look at how that looks like inside the code. So here. We have IBActionthat's tied to the button from our storyboard. Just like with therecording our button is gonna pull double duty if we're actively not recordingor broadcasting or capturing. Tapping this button is gonna start capture.

Now if we are actively capturing tapping this button is gonna stop capture.So let's go ahead and take a look at what happens when we hit startCapture.

Here's our code for startCapture. Now it looks a little bit crazy butI'll talk to you step by step here we're gonna go ahead and call screenRecorderand get the sharedRecorder instance. From there you're gonna call startCapture.

startCapture is gonna take in two different handlers. The first handleris going to be your sample handler which we see here. This block of codeis executed every time ReplayKit gives you a sample whether it be audiovideo or microphone. So this block of code is run continuously. Now thesecond handler is going to be the completiionHandler which we have here.

Now the completionHandler is called only once when you start capture.This is much like the recording completion handler where it signifies toyou that capture has started and we'll give you an error if there's somethingthat happened in the process. So let's take a look at the completion handlerfirst and then we'll take a look at what we do when the samples come in.

Here in the completion handler just like with recording we're going tocheck to see if we have any errors if we don't have any errors. We're goingto set the caputre state much like we did with recording. Well what dowe do in the recording capture state. Well we set the button titleour active state internally and we disable the other buttons and we set upthe camera view. Now we saw this back in the recording as well. The cameraview is going to allow you to use the camera pip to add to your application.

So what happens if we do have an error. We're going to go ahead and printthe error and move forward. Now let's go ahead and look at the sample blockbecause this is actually the most interesting bit because this gets calledevery time ReplayKit gives you a sample. So what you want to do is youwant to go ahead and take a look at all the different samples and all thedifferent types that we give back. Then you want to go ahead and decidewhat you want to do with it. So in this completion block we give you backa sample. We give you back the sample type and an error. And in this blockright here the first thing we do is we take a look to see if you have any errors.If we do we go out and print them. If not we're going to run a switch statementon the type. Now I'm sure in your application you're going to be doinga lot of really really awesome things but in this application we'll keepit simple. We're gonna go ahead and go through each one of these typesand we'll process them separately. So for if it's a video type we'll goahead and say processAPPVideoSample. We'll do the same for audio and micAnd that's it. These samples are given to you from ReplayKit and thenyou can do whatever you need to do with them. Let's take a look at whatwe do in this example. Which is pretty simple for all of our process methodsall we do is print. Now again I'm sure you can do something far more interestingand I'm excited to see what you do with it. But for this example we justprint and that's it. We're getting all of these samples and we printif we get the audio we print if we get a video and then we print if we geta mic.

And just like that you're up and running with capture. With in app screencapture your application now has access to all the video and audio samplesthrough ReplayKit. You can build dynamic in app experiences that includescreenshots now that you have access to the samples you can add customgaming overlays to the videos. With this raw data you can even implementa custom heads up display like this for your application. The possibilitiesreally are endless.

OK so now we can record and we can capture but what happens when you'reready to take things global. That's what live broadcast is for. The finalmajor feature we've bought over to macOS for ReplayKit. With live broadcastsyou give people the ability to stream their experience and your applicationto a third party streaming service allowing viewers from all over the worldto watch live. Let's take a quick look at how live broadcast works beforewe jump into another example of how to set up a live broadcast. With in app broadcastyou will call into RPBroadcastActivityController to display a pickerfor the available third party streaming services. When people select athird party streaming service ReplayKit will setup the broadcast connectionto the streaming service and give back a RPBroadcastController toyour application. The broadcast controller is what you'll use to controlthe actual broadcast. Here's a quick overview of the three part processthat'll allow you to start live broadcasting your application. People willinitiate a broadcast and you'll present the broadcast picker. People willselect the broadcast service and you'll get back a broadcast controller.

Then you'll start to broadcast using that controller.

Now that we have an idea of how that works let's go ahead and take a lookat how we can do that in a project. OK so we're back live here in our storyboard.We've already covered the start recording and start capture. Now we'regoing to go ahead and focus on the start broadcast button. This is wherethings get really really cool. All right let's jump back into our swiftcode here and here we go. We're right here on the IBAction for the button tap.Once again our broadcast button is going to pull double duty for us ifwe're active. The broadcast button is going to start broadcasts. And ifwe're not active it's going to start our broadcast. Let's look at the moreinteresting bit which is starting a broadcast and you'll see how easy itis to actually get your app global and broadcasting to the world. All right.Here is our button. And we're going to go ahead and do the presentBroadcastPickerlike we covered in the slides. This is what happens when your applicationpresents a picker for the available third party broadcasts so that peoplecan choose. Let's go ahead and jump into that code right here andhere it is. Well first thing we're going to do is we're going to decide on apicker origin point. This is the origin point. That is the bottom lefthand corner of the broadcast picker. Next we're going to go ahead and goon to the RPBroadcastActivityController and we're going to callshowBroadcastPicker at our origin point from the shared window of our application.And we're going to pass in a nil for preferred extension because for nowI just want to show all the available third party streaming services. All right.When we call that this block right here is going to get executed. And thefirst thing we would do is check for errors if we don't have an error.This is what we're going to do. We're going to go ahead and set the activitycontroller that we give back from this call and we're going to keep a referenceto it. You'll see why this is important later. And then you're going toget a activity controller delegate. Now the delegate part is a really reallyimportant part. You're going to need to set yourself as the delegate oryour application as the delegate. I will explain that in just a little bit.

If we have an error go ahead and print it. So now you're gonna go aheadand present this picker. People are going to go ahead and choose a broadcastthat they want to do. And then you're going to want to be notified whenthey're done. This is where the delegate comes in and why it's very very important.Let's go ahead and take a look at the delegate call. Here is theBroadcastActivityController delegate. Did finish with broadcast controller.So we definitely want to go ahead and be a delegate here. And the reason whyis when the user is done picking a third party broadcast ReplayKit willconnect your application to the broadcast extension. And we're gonna giveyou back a broadcast controller. You need the broadcast controller herebecause that broadcast controller is what you're gonna use to actuallycontrol the broadcast. So in this call we're gonna go ahead and check tosee if we have an error. We don't have an error. We're gonna go ahead andsave the broadcast controller because the broadcast controller again controlsyour broadcast. You can pause. You can stop start. All of those thingsare tied in with the broadcast controller. Then we immediately use a broadcastcontroller to call startBroadcast. Then another block is executed.This is just like your startRecording. You call this and we give you back an error.If there's an error that means something went wrong but if there isn'tyou are now broadcasting to the third party streaming service people have selected.

We do is update our broadcast state like we did it the other ones whichis going to update our button title our internal state and disable theother two ReplayKit functional buttons. And that's it. You're now broadcasting.You are now sending audio and video to the users selected third party broadcasts service.Now what happens when we want to call stopBroadcast. Now this is interestingbecause when we call stopBroadcast right here. This is why we want tosave the broadcast controller because here we simply call our referencebroadcast controller and we call finishBroadcast at which point thisentire block will be executed just like with stopRecording and stopCapture.We'll give you an error if something has happened. First thing you wantto do is check the error. We don't have an error set your broadcast dateto false because we're no longer broadcasting. Turn down your camera andanything else that you need to do. And that's it. You've just started andstop a live broadcast with their application and you're ready to take your application global.

I want to take a minute to go into a little bit more depth what the differencesfor in app live broadcast that were made for macOS. If you're coming from iOS.you'll notice that we no longer interact with the RPBroadcastActivityViewControllerclass. Instead for macOS that class has been replacedwith RPBroadcastActivityController. Due to macOS supporting multiplescreens and windows instead of calling loadBroadcastActivityViewControllerlike we do in iOS for macOS we call showBroadcastPicker with a CGPointand a window reference. We also take in a preferred extension identifierif your application wants to stream directly to a specific broadcast service. TheCGPoint passed in is a reference to the origin point of the passed in windowand represents the bottom left hand corner for the broadcast picker.You're now global with your application using ReplayKit live broadcast. When youstart to implement ReplayKit in your macOS applications you're goingto notice something new that's been added to your menu bar. With ReplayKiton macOS in keeping with the goal of user privacy you'll seea new menu bar item shown on the menu bar every time you start an activerecording capture or broadcast session. The menu bar icon indicates thatthere is an active ReplayKit session. It also serves as a way for peopleto stop the active ReplayKit session. You'll need to make sure that youadhere to the rpScreenRecordingDelegate method calldidStopRecordingWithPreviewViewController as this will be called when people clickon the menu bar icon to stop a session. For in app capture and live broadcast sessionsthe RPPreviewViewController passed in will be nil. With that you'renow ready to add ReplayKit to record capture and broadcast your applicationsand share them with the rest of the world. But we have one last thing wewant to talk about and that is game controllers. I'm happy to announcethat there is now ReplayKit support for the Game Controller Frameworkand iOS tvOS and macOS. The game controller framework will now havebuilt in ReplayKit functionality. Double tapping the share button on thePS4 controller or the select button on Xbox controller will start anin app recording. Double tapping again will automatically stop the in-apprecording and save it to your photos for iOS and your desktop for macOS.

For applications already using ReplayKit game controllers can start andstop recording's outside your Applications control. So it's a good idea tomake sure you're using key value observing for both availability and recordingproperties on RPScreenRecorder so that you can update your state as needed.

Also be sure to follow the protocol method didStopRecordingWithPreviewViewControlleron RPScreenRecorderDelegate so that you can updateyour application state as needed. I'm super excited to be announcing ReplayKitsupport for game controllers. I hope to see it in your games very soon.

Wow we've covered a lot today let's go ahead and take a quick recap ofwhat we talked about. I covered in app screen recording where ReplayKitwill record your applications audio and video into a movie that peoplecan edit share and save. I covered in app screen capture where ReplayKitgives your applications audio and video samples right back to you inyour applications process. I covered in app screen broadcast where ReplayKitsends your application audio and video to a third party live streaming service.And finally I covered the new built in functionality found in GameControllers Framework.

The sample code project as well as the documentation regarding ReplayKitFramework or to revisit this session please visit us at developer.apple.comWe look forward to seeing you add ReplayKit to your iOS tvOSand now macOS applications.

Thank you so much for watching our session on ReplayKit for macOS andI hope you have a wonderful WWDC

## Code Samples

