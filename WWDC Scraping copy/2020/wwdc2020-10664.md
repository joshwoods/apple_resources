# Wwdc2020 10664

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Transcript

Getting started with HealthKitHealthKit helps you build world-class health and fitness apps by centralizing health data from third-party apps, iPhone, Apple Watch, and external health devices. Discover how you can manage authorization and privacy around Health data, read and write data to the shared Health Store, and use HealthKit's built-in queries to fetch data and calculate statistics for that data.ResourcesAccessing Health RecordsCreating a Mobility Health AppHealthKitHD VideoSD VideoRelated VideosWWDC21Measure health with motionWWDC20Beyond counting stepsSynchronize health data with HealthKitWhat's new in CareKitWhat's new in HealthKit

HealthKit helps you build world-class health and fitness apps by centralizing health data from third-party apps, iPhone, Apple Watch, and external health devices. Discover how you can manage authorization and privacy around Health data, read and write data to the shared Health Store, and use HealthKit's built-in queries to fetch data and calculate statistics for that data.

Accessing Health Records

Creating a Mobility Health App

HealthKit

HD VideoSD Video

HD Video

SD Video

Measure health with motion

Beyond counting steps

Synchronize health data with HealthKit

What's new in CareKit

What's new in HealthKit

Search this videoâ€¦Hello and welcome to WWDC. Hi everyone. My name is Dina, and I'm aniOS engineer here at Apple.Today I'm going to introduce you to HealthKit and get you started buildingyour first health application. Our own health data makes up some of themost personal parts of who we are, whether it's tracking menstrual cyclesand fertility to get pregnant or my lab test result from my doctor's appointment...and even the workout I completed this morning on my Apple Watch. Ready access  00:00:33.706 --> 00:00:37.906 to our own health data is one of the most empowering developments of modern technology.Today there are over 18,000 applications on the App Store thatall focus on improving our health and fitness. That's mind-blowing.Like seriously, it's mind-blowing. There are applications today that help usreach our fitness goals at home by providing at-home workouts, help us track ourmenstrual cycles and fertility and even log the food that we eat to helpus reach or goal weight. There's a whole diversity of different applicationsavailable today that help us take control over our health. All of theseapplications are built on the foundation of HealthKit. HealthKit is aframework that creates a central repository of all the user's health data,allowing applications to read data from it and also contribute data toit, to help create the most seamless user experience. We can interact withour health data on multiple devices including our iPhone, Apple Watch, eveniCloud. HealthKit securely stores and synchronizes all of our health dataacross these devices so you as a developer don't have to worry about handling that.HealthKit also guards users' privacy by giving us explicit control overwhat data applications have access to. HealthKit is a framework that helpscreate a more seamless health application while also protecting our health data.So today we're going to join this healthy community of ours by buildingan application of our own with HealthKit called SmoothWalker, and justlike its name, the goal of this application is to allow us to record thewalks that we've been on and visually see the daily steps we've takenover the past week.To build SmoothWalker, we'll need to accomplish three different tasks.The first one being setting up HealthKit in our xCode project. Once we do,we'll be able to start saving data - specifically, the distances we've walked.And finally, we can read data to display our daily step count over thepast week in our application.  To set up HealthKit, we'll need to accomplishseveral different tasks:  the first one being, we'll need to enable the HealthKitcapability in our Xcode project. Once we do, we'll need to check whetheror not the platform we're running on supports HealthKit. And finally, we'llcreate an HKHealthStore, the entry point to the HealthKit API.  To enablethe HealthKit capability in your application you'll select the target thatyou want to integrate users' health data into. You'll tap "Signing & Capabilities"and hit that "+ Capability" button. You'll type in "HealthKit" and rightthen and there you'll add the HealthKit framework into your application,which will allow you to retrieve and store users' health information.  We'llnow need to check whether or not the platform we're running on supports HealthKit.It's really common for developers to have one application and have it runon multiple platforms or operating systems, so we'll need to check whetherthe platform we're running on right now supports HealthKit. You'll needto import HealthKit, and then using HKHealthStore, you'll check whetheror not health data is available. If it is, you'll continue being able tointegrate users' health data into your application. If not, then make surethat your application is still able to operate without having users' health data.Finally we'll create an HKHealthStore. An HKHealthStore is what Ilike to think of as the gateway or portal to the world of health data.It's what you'll use when you want to request access to users' health data.It's how you'll save data and even read data using queries. You only needto create one instance and reuse it across the lifecycle of your application.There's no need to create multiple instances. Here, we have our HealthStoreobject, the one that we'll be using across the entirety of our application,and if health data is available, we'll instantiate our HealthStore object.And setting up HealthKit is that easy. Enabling the HealthKit capability,checking whether or not our platform supports HealthKit and creating anHKHealthStore. That's all you need to do.  Now that we finished setting up HealthKit,let's move on to saving data - specifically, the distances we've logged.But before we do, we'll need to take a deeper look at how HealthKit organizesand structures our data. I have this little ritual of mine where rightbefore any presentation or talk, I like to do a little bit of a workoutIt helps boost up my energy but also calm my nerves. There's nothing a couplepush ups or a couple sprints can't fix. So that's what I did right beforethis presentation. I did a quick workout. So let's see all of the healthdata that was recorded during my workout. For my workout, I went for a walkfrom 2:35 to 3:00 p.m. today. I walked outside because the weather was gorgeous...partially cloudy, low humidity... great for a good hair day. I walked628 meters and I was blasting Lizzo and Rico Nasty a little bittoo loudly on Apple Music and should probably turn down the volume movingforward to preserve my hearing health. Five minutes into my walk, I alsostarted noticing some mild abdominal cramping due to the fact that my periodis going to start any day now. All of these different types of health dataare stored as Health Samples. Health Samples are all structured in a verysimilar pattern. They all have the associated type of data that they represent,the value of that type of data, the time these health events occurred andmetadata which represents any additional information we want to store aboutthese samples - like whether or not my workout was outdoors or indoors, theweather outside, the device that recorded it and even the application thatwrote it.  As all of these different types of data are stored as samples,there are some nuance differences between all of them. Right now I'm goingto focus on one type of sample called Quantity Samples. Quantity Samplesstore a numerical value and unit associated with our health data -perfect for storing the distance we walk and our headphone audio level exposure.Regardless of type, we always want to remain in control of our data andto do so, HealthKit has its authorization system, which will allow you torequest authorization for users' health data by specific data type.And to give users the most control over what data applications have accessto, read permissions and write permissions are handled separately. So youruser may or may not grant you permission to the data that you requestedfor, depending on the sensitivity of it and what they feel comfortable sharing.Any time you request authorization, the screen on the right might appearto the user. This is HealthKit's authorization sheet. It allows the userto grant or deny permission to the data that you're requesting access for.So it's important to request authorization in context so the user hasan understanding of what the screen is and why this application needs accessto their health data. You'll be required to define two keys in your application'sInfo.plist: Health Update Usage Description and Health Share Usage Description.This will give you an opportunity to briefly explain what your applicationdoes and how it interacts with the user's health data. Another importantpart of context is requesting authorization when there's good timing.Request authorization any time you intend to interact with the user's health data,whether that's saving or reading their health data.  Onboarding is also anothergreat place to request authorization because that's usually where the userhas an understanding of what your application does and how it'll use theirhealth data in the experience. As requesting authorization in contextis really important, make sure to request authorization for only the datathat you need to create the best experience for the user. If, for instance,you requested authorization for all HealthKit data types (that's well over 100by the way), then the user might be a little bit confused as to why an applicationthat's helping them perform a swimming workout is also asking them forall the times they brush their teeth. I mean you could be hitting thatreally niche group of athletes who swim while also brushing their teethbut I'd be a little bit skeptical. Finally, request authorization everytime you intend to interact with the user's health data. HealthKit is thesource of truth when it comes to user permissions, and user permissionscan change at any time outside of your application so make sure to requestauthorization so your application stays up-to-date.  To save the distanceI walked during my workout today, the first thing we'll need to do is requestwrite access to our walking distance data type using HealthKit's authorization system.Once we do, we'll need to create our walking distance sample and save thatsample using our HealthStore.  To request write access, what we'll need to dois to find the type of data that we want write access to. In this case,it's just our distanceWalkingRunning quantity type. Then we'll call therequest authorization method on our HealthStore, passing in the data thatwe want to write to and read from.  In SmoothWalker, we're only writingthe distances we've walked. We're not reading any of that data. So we'reonly going to request write access. Finally, we'll know if we successfullyrequested authorization in our completion handler. Success in this casedoes not mean that the user has granted permission to these data types.It just means that you successfully requested authorization and if it failed,you can always try again. User privacy is so important when it comes toour sensitive health data so make sure when requesting authorization toonly ask for what you need, when you need it, every time.  We finished requestingwrite access so let's move on to our final two tasks of creating our samplethat represents the distance I walk during my workout and saving that sampleusing our HealthStore.  We'll need to define the type of data that we wantto save, which is our quantity type distanceWalkingRunning - the same quantitytype we requested write access for. Then we'll need to instantiate thestart and end time of when I walked that distance. In this case it was2:35 and 3 p.m. today. All quantity samples in HealthKit are stored withan associated HKQuantity. HKQuantities represent the value and unitassociated with the sample - so from my walk today I walked a distance of628 meters. A really powerful part of HealthKit is thatit can convert between different units for you. So, for instance, if I wantedto see all the distances I walked in meters in one application but inyards in another application, then HealthKit can do all that conversionfor you on the same data set - so you don't have to do any of that manual math.We have all the pieces needed to construct our sample.  We'll pass in thetype of data we want to create, which is our distanceWalkingRunning quantitytype, our quantity of 628 meters and our start andend date 2:35 and 3 p.m. today. Finally, we'll call our save methodon our HealthStore and pass in our sample, and we'll know if we successfullysaved the sample into the database through our completion handler.  And justwith that we saved the distance I walked during my workout.  We just tooka deeper look into how Quantity Samples are structured and stored in HealthKit.But not all of our data is necessarily best represented in quantity sampleslike my workout or my abdominal cramps today. So let's take a deeper lookinto how HealthKit organizes our data in a more general way. To reiterate,we have Quantity Samples that store a numerical value and unit associatedwith our health data - perfect for storing the distance I walked and myheadphone audio level exposure. However, not all of my health data is necessarily quantitative.Some of it is more qualitative and those are stored as Category Samplesin HealthKit where the value that you can record comes from a predefinedlist and it doesn't carry a unit. So for instance when I log my mild abdominalcramping today, I had the option to log whether it was mild, moderate orsevere and, thankfully, it was just mild. Both of these types of samplesrepresent singular values but not all of our health data is necessarilyrepresented in that way in HealthKit like my workout, which summarizesmultiple values and can carry multiple units depending on the values thatit's summarizing. Like my workout today summarized the 628meters I walked, the three flights I climbed and even the105 calories that I burned. All of these different types of data aresamples in HealthKit. Samples all have an associated start and end timeof when these health events happened. As we looked at quantity samples,category samples and workouts, there are many more different types of samplesavailable that I encourage you to look into. Not all of our health datathough changes over time like samples do.  Some of our health data remainsmore static over our life - like my birthday or my blood type.  These arestored as characteristics in HealthKit. All of these different types ofobjects are unified under HKObject, where it has the associated uniqueidentifier for data so you can easily reference it, the device that recordedit and even the application that wrote it. This hierarchy represents theobjects that are stored in HealthKit. There is also a parallel hierarchyof all the types in HealthKit.For instance, the distance I walked today was stored as a quantity sampleof the quantity type distanceWalkingRunning. My mild abdominal crampswas stored in a category sample of the category type abdominalCramps.We just took a look into how HealthKit organizes and structures our data.So let's move on to our final and third task of reading data. When it comesto reading health data, you'll want to use queries. HealthKit has a widerange of queries to help you accomplish the task that you have at hand.Here are some of the many. Today, we're gonna look into three of them:HKStatisticsQuery, HKStatisticsCollectionQuery and HKSampleQuery.When it comes to using queries, the first thing you'll need to do is constructa query object. You'll need to define the type of data that you want toread as well as specify a filter that will restrict the resultsreturned from your query. This is done by defining a predicate. A predicate canvastly improve the efficiency and performance of your query by filteringout the results that it returns. Finally, you'll execute your query on ourHealthStore and get our results from our handler. The first query we'regonna look into is HKStatisticsQuery, and it is exactly what it sounds like.It's a query that performs statistics on samples, specifically quantity samples.Let's take a look at what type of statistics can be computed with anHKStatisticsQuery. For instance, I might want to know the total amountof steps I took during my workout or the total amount of calories I burned.And if I'm feeling particularly brave, I might want to know the total amountof caffeine I consumed today, which might unveil a matcha latte addiction.I think I'll hold off on that one.We can compute the sum of these different data types but it doesn't makesense to sum up all of our health data. For instance, I might want to knowmy average UV exposure for today so I know that my SPF 50 and my shadeshad me fully protected... or to know that my hit workouts were really impactingmy minimum resting heart rate... and even know my maximum body temperaturefrom when I was sick a couple weeks ago. We can also compute the averageminimum and maximum on our health data. It doesn't make sense to sum upall of our body temperatures or compute the average calories I burned duringmy workout, so the type of statistics we can compute depends on what makesthe most sense and what reveals the most insightful information about our health.This is known as the aggregation style of samples in HealthKit where thetotal steps I took and my calories burned are all cumulative while my UVexposure and my heart rate are discrete. Today I want to know the totalamount of steps I took this past week from June 15th to today. Here areall my steps for the past week. What I'll do is construct anHKStatisticsQuery specifying the type of statistics I want to compute, which is cumulative sum.I'll execute it on our HealthStore and we'll get back anHKStatistics object, which has the start date and end date of all the samplesthat make up our statistic as well as our sum of 6,902steps. It's not that much. I probably should really up my activitymoving forward. All of those samples were recorded on my Apple Watch butsometimes when I go for a walk, I like to bring my iPhone with me in case I need to makea couple of phone calls. Both my Apple Watch and my iPhone are both recording steps.If we were to sum up all of my steps over all of my devices then we would easilybe doublecounting a lot of those steps. HKStatisticsQuerycan help with the de-duplication of data. For instance on June 15th, HKStatisticsQuerywill ignore those 900 steps recorded on my iPhone since that wouldbe duplicated data but it would also add in those additional 1100steps that were recorded on my iPhone when I forgot my Apple Watch at home.So we'll construct our HKStatisticsQuery, execute it on our HealthStoreand get our updated HKStatistics object with our new sum of 8002steps. So I did better but not by that much. I'm more interested inthe patterns of my daily step count. I want to know the steps that I takeevery day for the past week. What we could do is constructHKStatisticsQueries for every day of the week. That would be seven of them. That mightbe fine for now but if I wanted to know my daily step count over the pastyear then that would be well over 300 HKStatisticsQueries to manageand that just becomes too much. HealthKit has a solution. It's calledHKStatisticsCollectionQuery, and it's a query that performs statistics onfixed time intervals that you specify. In this case, we'll specify a dailycadence of when I want the sum of my steps to be computed. I'll also needto specify an anchor date which represents when our statistics start beingcomputed and how our samples get bucketed. When I construct myHKStatisticsCollectionQuery, I'll specify my anchor of June 15th at midnight, my timeinterval of a daily cadence and the statistics I want to compute, whichis the sum. I'll execute this on my HealthStore, and we'll get back anHKStatisticsCollection object. An HKStatisticsCollection object is exactlywhat it sounds like. It's a collection of HKStatistics. So for everyday of the week, we'll get an HKStatistics object with the sum of our steps.So for Monday, June 15th, I'll get a sum of 2,222steps. Tuesday, I'm not going to lie. I was super lazy... didn'teven get out of bed so I didn't take any steps. Wednesday, I have a sumof steps of 1,100 so I'll get an HKStatistics object witha sum of 1,100, and the rest will follow suit. Here are some ofthe many charts in Health that are all powered by HKStatisticsCollectionQueries.It's incredible to see how one query can unveil so much useful and insightfulinformation about our health.  HKStatisticsCollectionQuery is really powerful.I want to touch on one of its other super powers. It can listen for updatesto the user's health data. To do so, we'll need to set its update handlerbefore executing the query.  That way our query will be running in the backgroundlistening to any new statistics or new data coming into the health database.Now our query will be running in the background indefinitely, so we'll wantto make sure to call stop when we're done collecting all the data that we need.So let's go ahead and use HKStatisticsCollectionQuery and SmoothWalkerto display our daily step count over the past week. The first thing we'llneed to do is construct our HKStatisticsCollectionQuery. Once we do,we'll execute it on our HealthStore and update our UI with theHKStatisticsCollection object we get back. Let's move on to our demo. All of the codeyou're about to see is available online through a sample Xcode projectfor you to download and to play around with. Here we have SmoothWalkerrunning in our simulator in the left-hand portion of my screen. The viewis empty right now because we haven't implemented the pieces to displayour daily step count. In the upper right-hand cornerwe also have an add data button which will allow us to add any new stepsfor today. So let's go ahead and move over into our Xcode project andimplement all the pieces we need to display our daily steps. Here I amin DailyStepCountTableViewController. This is the view controllerthat's powering our view in the simulator right now.  We have an array that'shooked up to our table view so all we need to do is read our daily stepsand populate our array with that. The first thing we'll need to do thoughis request read and write access to our step count data. We'll need torequest authorization where there's appropriate context. A great placeto do that is in our method viewWillAppear. That way when our applicationloads or we hit that step count tab, our authorization sheet will appear.So let's go ahead and do that.Here we define the type of data that we want read and write access to, whichis our stepCount data type. Then, using our HealthStore, we'll request authorization,passing in the data that we want to write to and read from. If we successfullyrequest authorization, we'll call the method calculateDailyStepCountForPastWeek.This is the method where all the magic happens. It's wherewe'll read our daily steps and update our UI. So let's go down into this method.Here I am in calculateDailyStepCountForPastWeek. We'll need to construct anHKStatisticsCollectionQuery, execute our query on our HealthStore and updateour UI with the results. The first thing we'll need to do is define allthe pieces needed to construct our query like the type of data we wantto read, which in this case is our step count data.We'll need our anchor, which is Monday at 3 a.m.Our time interval, which is a daily cadence.  There can be a lot of stepsdata in HealthKit but we're only interested in computing statistics overthe past week's worth so we'll define a predicate. That way we're only computingstatistics over the past week's worth of step samples.Here I define my date from one week ago, and I'll construct my predicate usingHKQuery's predicateForSamples. We have all the components needed to constructour query. So let's go ahead and do that. Here I have my HKStatisticsCollectionQuerypassing in the type of data I want to read: which is our stepcount data, our predicate of one week ago, the statistics we want to compute(which is our sum), our anchor of Monday and our time interval of a daily cadence.Now that we've constructed our query, we'll need to update our UI withthe results we get back. Here we have our initialResultsHandler. Whenour query is done executing, we'll get back our statisticsCollection andan error if there was any issue reading our health data. Here is where we'llupdate our UI.If there are any statistics to show on our table view, we'll call our methodupdateUIFromStatistics. This is where we'll pass in our statisticsCollectionand update our array that's backing our table view. So let's go down intothis method and implement it.Here I am in updateUIFromStatistics. It takes a statisticsCollectionobject so we'll enumerate over all of our statistics and append it intoour array that's backing our table view. Since we'll be updating our UI,we want to make sure to dispatch back to the main thread.  Here we have ourdataValues array, which is the array backing our table view and our UI.It is an array of HKStatistics. What we'll need to do is enumerate overstatistics for the past week in our statisticsCollection object.We'll define our start date of one week ago and we'll enumerate until today.Then we'll call our enumerateStatistics method on our statisticsCollection,and as we enumerate we'll append our statistics into our array backingour table view. Finally when we're done enumerating, we'll call reloadData.This will refresh our table view and update our UI. The final thing weneed to do though is execute our query so we'll go back up into ourcalculateDailyStepCountForPastWeek method and execute our query after settingour initial results handler.And with that, I'll hit run and let's see what happens.Ah. Our authorization sheet just popped up on our device. This will allow usto deny or grant permission to our step count data for SmoothWalker.  SinceI'm not particularly sensitive about steps data, I'll enable both readand write access for it. I'll hit "Turn All Categories On" and hit that "Allow" button.Ah. And our table view just updated with all of our daily steps for the pastweek. Let's go ahead and try and add some data for today. I'll add 800steps and hit that "Add" button. And as you can see, our table view didn't update.And that's because we haven't set our update handler on our query.So let's go back into Xcode and set up our update handler. That way our querywill be running in the background listening for any new health data orany new steps coming in. We'll set up our update handler in our methodcalculateDailyStepCountForPastWeek. We'll need to set up our updatehandler before we execute our query.So that's where we'll do it. Here, I have my statisticsUpdateHandler.This will get called when there's any new data that's coming into the databaseor if there's any new statistics. We'll get back any new statistics, astatisticsCollection object and an error if there's any issue reading our data.  Herewe'll update our UI, calling the same method we did in our initial results handler.Now our query is going to be running in the background indefinitely, listeningto any new steps that'll be added into the database so we'll want to makesure to call stop when we're done collecting all the data that we need.A great place to do that is in our method viewWillDisappear. That way,our query will stop when our view is no longer visible on our device.So let's go ahead and implement that.Here we're in viewWillDisappear. We'll stop our query in this method.And with that, let's hit run again and see what happens when we add somenew steps for today. So I'm going to add some data, I'll add 235steps - and our table view just updated with that new step count.And with that, we just finished displaying our daily steps in our application.Let's just take a look at what we just did. We constructed ourHKStatisticsCollectionQuery, executed it on our HealthStore and updated our UI with ourstatisticsCollection object. We just took a look at HKStatisticsQueryand HKStatisticsCollectionQuery. They are super powerful.However, you may not always want to compute statistics on the health data, and notall of our health data is quantitative. You can use HKSampleQuery toretrieve the raw health samples stored in the database. So let's go takea look at how we would do that. Here we'll define the type of data I wantto read, which is my workouts. Then I'll define a sort, which will sort allof the objects returned back from my query. In this case, I want them sortedfrom the most recent date that they finished. Finally, we'll construct oursample query, passing in the type of data we want to read, our predicate, whichis nil, our limit of 1 (since we're only interested in the most recent oneworkout) and our sort. Finally, we'll execute our query using our HealthStore.There are many other types of queries available in HealthKit to help youaccomplish the task that you have at hand. We have HKAnchoredObjectQuery,which will allow you to track changes in the user's database. There's alsoHKActivitySummaryQuery, which will allow you to display the rich activityring data from our Apple Watch. There's also HKWorkoutRouteQuerywhich will display all of the locations we've been on during our outdoor workouts.And with that we finished integrating HealthKit into SmoothWalker.We discussed a lot today. I want to go over some of the bigger takeaways.HealthKit is a framework that helps create and manage a central repositoryof the user's health data, providing a rich ecosystem for your health application.However our health data makes up some of the most sensitive data on ourdevice so make sure to request authorization for only the data that youneed. When you need it. Every time. HealthKit has a rich type system to helporganize and structure health data. We looked at quantity types, categorytypes and even workouts but there are many more that I encourage you tolook into to see what works best for your health application.HealthKit has a wide range of queries to help you efficiently and performantly read data.We looked at sample query and statistics queries today but there are manymore to help you create the next great health application. We're so excitedfor you to join our healthy community here at Apple and to see the incrediblehealth applications you'll build that will revolutionize the way userstake control over their health.I hope you have a wonderful rest of
your WWDC and let's go get healthy.

Hello and welcome to WWDC. Hi everyone. My name is Dina, and I'm aniOS engineer here at Apple.Today I'm going to introduce you to HealthKit and get you started buildingyour first health application. Our own health data makes up some of themost personal parts of who we are, whether it's tracking menstrual cyclesand fertility to get pregnant or my lab test result from my doctor's appointment...and even the workout I completed this morning on my Apple Watch. Ready access  00:00:33.706 --> 00:00:37.906 to our own health data is one of the most empowering developments of modern technology.

Today there are over 18,000 applications on the App Store thatall focus on improving our health and fitness. That's mind-blowing.Like seriously, it's mind-blowing. There are applications today that help usreach our fitness goals at home by providing at-home workouts, help us track ourmenstrual cycles and fertility and even log the food that we eat to helpus reach or goal weight. There's a whole diversity of different applicationsavailable today that help us take control over our health. All of theseapplications are built on the foundation of HealthKit. HealthKit is aframework that creates a central repository of all the user's health data,allowing applications to read data from it and also contribute data toit, to help create the most seamless user experience. We can interact withour health data on multiple devices including our iPhone, Apple Watch, eveniCloud. HealthKit securely stores and synchronizes all of our health dataacross these devices so you as a developer don't have to worry about handling that.HealthKit also guards users' privacy by giving us explicit control overwhat data applications have access to. HealthKit is a framework that helpscreate a more seamless health application while also protecting our health data.So today we're going to join this healthy community of ours by buildingan application of our own with HealthKit called SmoothWalker, and justlike its name, the goal of this application is to allow us to record thewalks that we've been on and visually see the daily steps we've takenover the past week.To build SmoothWalker, we'll need to accomplish three different tasks.The first one being setting up HealthKit in our xCode project. Once we do,we'll be able to start saving data - specifically, the distances we've walked.And finally, we can read data to display our daily step count over thepast week in our application.  To set up HealthKit, we'll need to accomplishseveral different tasks:  the first one being, we'll need to enable the HealthKitcapability in our Xcode project. Once we do, we'll need to check whetheror not the platform we're running on supports HealthKit. And finally, we'llcreate an HKHealthStore, the entry point to the HealthKit API.  To enablethe HealthKit capability in your application you'll select the target thatyou want to integrate users' health data into. You'll tap "Signing & Capabilities"and hit that "+ Capability" button. You'll type in "HealthKit" and rightthen and there you'll add the HealthKit framework into your application,which will allow you to retrieve and store users' health information.  We'llnow need to check whether or not the platform we're running on supports HealthKit.It's really common for developers to have one application and have it runon multiple platforms or operating systems, so we'll need to check whetherthe platform we're running on right now supports HealthKit. You'll needto import HealthKit, and then using HKHealthStore, you'll check whetheror not health data is available. If it is, you'll continue being able tointegrate users' health data into your application. If not, then make surethat your application is still able to operate without having users' health data.Finally we'll create an HKHealthStore. An HKHealthStore is what Ilike to think of as the gateway or portal to the world of health data.It's what you'll use when you want to request access to users' health data.It's how you'll save data and even read data using queries. You only needto create one instance and reuse it across the lifecycle of your application.There's no need to create multiple instances. Here, we have our HealthStoreobject, the one that we'll be using across the entirety of our application,and if health data is available, we'll instantiate our HealthStore object.And setting up HealthKit is that easy. Enabling the HealthKit capability,checking whether or not our platform supports HealthKit and creating anHKHealthStore. That's all you need to do.  Now that we finished setting up HealthKit,let's move on to saving data - specifically, the distances we've logged.But before we do, we'll need to take a deeper look at how HealthKit organizesand structures our data. I have this little ritual of mine where rightbefore any presentation or talk, I like to do a little bit of a workoutIt helps boost up my energy but also calm my nerves. There's nothing a couplepush ups or a couple sprints can't fix. So that's what I did right beforethis presentation. I did a quick workout. So let's see all of the healthdata that was recorded during my workout. For my workout, I went for a walkfrom 2:35 to 3:00 p.m. today. I walked outside because the weather was gorgeous...partially cloudy, low humidity... great for a good hair day. I walked628 meters and I was blasting Lizzo and Rico Nasty a little bittoo loudly on Apple Music and should probably turn down the volume movingforward to preserve my hearing health. Five minutes into my walk, I alsostarted noticing some mild abdominal cramping due to the fact that my periodis going to start any day now. All of these different types of health dataare stored as Health Samples. Health Samples are all structured in a verysimilar pattern. They all have the associated type of data that they represent,the value of that type of data, the time these health events occurred andmetadata which represents any additional information we want to store aboutthese samples - like whether or not my workout was outdoors or indoors, theweather outside, the device that recorded it and even the application thatwrote it.  As all of these different types of data are stored as samples,there are some nuance differences between all of them. Right now I'm goingto focus on one type of sample called Quantity Samples. Quantity Samplesstore a numerical value and unit associated with our health data -perfect for storing the distance we walk and our headphone audio level exposure.Regardless of type, we always want to remain in control of our data andto do so, HealthKit has its authorization system, which will allow you torequest authorization for users' health data by specific data type.And to give users the most control over what data applications have accessto, read permissions and write permissions are handled separately. So youruser may or may not grant you permission to the data that you requestedfor, depending on the sensitivity of it and what they feel comfortable sharing.Any time you request authorization, the screen on the right might appearto the user. This is HealthKit's authorization sheet. It allows the userto grant or deny permission to the data that you're requesting access for.So it's important to request authorization in context so the user hasan understanding of what the screen is and why this application needs accessto their health data. You'll be required to define two keys in your application'sInfo.plist: Health Update Usage Description and Health Share Usage Description.This will give you an opportunity to briefly explain what your applicationdoes and how it interacts with the user's health data. Another importantpart of context is requesting authorization when there's good timing.Request authorization any time you intend to interact with the user's health data,whether that's saving or reading their health data.  Onboarding is also anothergreat place to request authorization because that's usually where the userhas an understanding of what your application does and how it'll use theirhealth data in the experience. As requesting authorization in contextis really important, make sure to request authorization for only the datathat you need to create the best experience for the user. If, for instance,you requested authorization for all HealthKit data types (that's well over 100by the way), then the user might be a little bit confused as to why an applicationthat's helping them perform a swimming workout is also asking them forall the times they brush their teeth. I mean you could be hitting thatreally niche group of athletes who swim while also brushing their teethbut I'd be a little bit skeptical. Finally, request authorization everytime you intend to interact with the user's health data. HealthKit is thesource of truth when it comes to user permissions, and user permissionscan change at any time outside of your application so make sure to requestauthorization so your application stays up-to-date.  To save the distanceI walked during my workout today, the first thing we'll need to do is requestwrite access to our walking distance data type using HealthKit's authorization system.Once we do, we'll need to create our walking distance sample and save thatsample using our HealthStore.  To request write access, what we'll need to dois to find the type of data that we want write access to. In this case,it's just our distanceWalkingRunning quantity type. Then we'll call therequest authorization method on our HealthStore, passing in the data thatwe want to write to and read from.  In SmoothWalker, we're only writingthe distances we've walked. We're not reading any of that data. So we'reonly going to request write access. Finally, we'll know if we successfullyrequested authorization in our completion handler. Success in this casedoes not mean that the user has granted permission to these data types.It just means that you successfully requested authorization and if it failed,you can always try again. User privacy is so important when it comes toour sensitive health data so make sure when requesting authorization toonly ask for what you need, when you need it, every time.  We finished requestingwrite access so let's move on to our final two tasks of creating our samplethat represents the distance I walk during my workout and saving that sampleusing our HealthStore.  We'll need to define the type of data that we wantto save, which is our quantity type distanceWalkingRunning - the same quantitytype we requested write access for. Then we'll need to instantiate thestart and end time of when I walked that distance. In this case it was2:35 and 3 p.m. today. All quantity samples in HealthKit are stored withan associated HKQuantity. HKQuantities represent the value and unitassociated with the sample - so from my walk today I walked a distance of628 meters. A really powerful part of HealthKit is thatit can convert between different units for you. So, for instance, if I wantedto see all the distances I walked in meters in one application but inyards in another application, then HealthKit can do all that conversionfor you on the same data set - so you don't have to do any of that manual math.We have all the pieces needed to construct our sample.  We'll pass in thetype of data we want to create, which is our distanceWalkingRunning quantitytype, our quantity of 628 meters and our start andend date 2:35 and 3 p.m. today. Finally, we'll call our save methodon our HealthStore and pass in our sample, and we'll know if we successfullysaved the sample into the database through our completion handler.  And justwith that we saved the distance I walked during my workout.  We just tooka deeper look into how Quantity Samples are structured and stored in HealthKit.But not all of our data is necessarily best represented in quantity sampleslike my workout or my abdominal cramps today. So let's take a deeper lookinto how HealthKit organizes our data in a more general way. To reiterate,we have Quantity Samples that store a numerical value and unit associatedwith our health data - perfect for storing the distance I walked and myheadphone audio level exposure. However, not all of my health data is necessarily quantitative.Some of it is more qualitative and those are stored as Category Samplesin HealthKit where the value that you can record comes from a predefinedlist and it doesn't carry a unit. So for instance when I log my mild abdominalcramping today, I had the option to log whether it was mild, moderate orsevere and, thankfully, it was just mild. Both of these types of samplesrepresent singular values but not all of our health data is necessarilyrepresented in that way in HealthKit like my workout, which summarizesmultiple values and can carry multiple units depending on the values thatit's summarizing. Like my workout today summarized the 628meters I walked, the three flights I climbed and even the105 calories that I burned. All of these different types of data aresamples in HealthKit. Samples all have an associated start and end timeof when these health events happened. As we looked at quantity samples,category samples and workouts, there are many more different types of samplesavailable that I encourage you to look into. Not all of our health datathough changes over time like samples do.  Some of our health data remainsmore static over our life - like my birthday or my blood type.  These arestored as characteristics in HealthKit. All of these different types ofobjects are unified under HKObject, where it has the associated uniqueidentifier for data so you can easily reference it, the device that recordedit and even the application that wrote it. This hierarchy represents theobjects that are stored in HealthKit. There is also a parallel hierarchyof all the types in HealthKit.For instance, the distance I walked today was stored as a quantity sampleof the quantity type distanceWalkingRunning. My mild abdominal crampswas stored in a category sample of the category type abdominalCramps.We just took a look into how HealthKit organizes and structures our data.So let's move on to our final and third task of reading data. When it comesto reading health data, you'll want to use queries. HealthKit has a widerange of queries to help you accomplish the task that you have at hand.Here are some of the many. Today, we're gonna look into three of them:HKStatisticsQuery, HKStatisticsCollectionQuery and HKSampleQuery.When it comes to using queries, the first thing you'll need to do is constructa query object. You'll need to define the type of data that you want toread as well as specify a filter that will restrict the resultsreturned from your query. This is done by defining a predicate. A predicate canvastly improve the efficiency and performance of your query by filteringout the results that it returns. Finally, you'll execute your query on ourHealthStore and get our results from our handler. The first query we'regonna look into is HKStatisticsQuery, and it is exactly what it sounds like.It's a query that performs statistics on samples, specifically quantity samples.Let's take a look at what type of statistics can be computed with anHKStatisticsQuery. For instance, I might want to know the total amountof steps I took during my workout or the total amount of calories I burned.And if I'm feeling particularly brave, I might want to know the total amountof caffeine I consumed today, which might unveil a matcha latte addiction.I think I'll hold off on that one.We can compute the sum of these different data types but it doesn't makesense to sum up all of our health data. For instance, I might want to knowmy average UV exposure for today so I know that my SPF 50 and my shadeshad me fully protected... or to know that my hit workouts were really impactingmy minimum resting heart rate... and even know my maximum body temperaturefrom when I was sick a couple weeks ago. We can also compute the averageminimum and maximum on our health data. It doesn't make sense to sum upall of our body temperatures or compute the average calories I burned duringmy workout, so the type of statistics we can compute depends on what makesthe most sense and what reveals the most insightful information about our health.This is known as the aggregation style of samples in HealthKit where thetotal steps I took and my calories burned are all cumulative while my UVexposure and my heart rate are discrete. Today I want to know the totalamount of steps I took this past week from June 15th to today. Here areall my steps for the past week. What I'll do is construct anHKStatisticsQuery specifying the type of statistics I want to compute, which is cumulative sum.I'll execute it on our HealthStore and we'll get back anHKStatistics object, which has the start date and end date of all the samplesthat make up our statistic as well as our sum of 6,902steps. It's not that much. I probably should really up my activitymoving forward. All of those samples were recorded on my Apple Watch butsometimes when I go for a walk, I like to bring my iPhone with me in case I need to makea couple of phone calls. Both my Apple Watch and my iPhone are both recording steps.

If we were to sum up all of my steps over all of my devices then we would easilybe doublecounting a lot of those steps. HKStatisticsQuerycan help with the de-duplication of data. For instance on June 15th, HKStatisticsQuerywill ignore those 900 steps recorded on my iPhone since that wouldbe duplicated data but it would also add in those additional 1100steps that were recorded on my iPhone when I forgot my Apple Watch at home.So we'll construct our HKStatisticsQuery, execute it on our HealthStoreand get our updated HKStatistics object with our new sum of 8002steps. So I did better but not by that much. I'm more interested inthe patterns of my daily step count. I want to know the steps that I takeevery day for the past week. What we could do is constructHKStatisticsQueries for every day of the week. That would be seven of them. That mightbe fine for now but if I wanted to know my daily step count over the pastyear then that would be well over 300 HKStatisticsQueries to manageand that just becomes too much. HealthKit has a solution. It's calledHKStatisticsCollectionQuery, and it's a query that performs statistics onfixed time intervals that you specify. In this case, we'll specify a dailycadence of when I want the sum of my steps to be computed. I'll also needto specify an anchor date which represents when our statistics start beingcomputed and how our samples get bucketed. When I construct myHKStatisticsCollectionQuery, I'll specify my anchor of June 15th at midnight, my timeinterval of a daily cadence and the statistics I want to compute, whichis the sum. I'll execute this on my HealthStore, and we'll get back anHKStatisticsCollection object. An HKStatisticsCollection object is exactlywhat it sounds like. It's a collection of HKStatistics. So for everyday of the week, we'll get an HKStatistics object with the sum of our steps.So for Monday, June 15th, I'll get a sum of 2,222steps. Tuesday, I'm not going to lie. I was super lazy... didn'teven get out of bed so I didn't take any steps. Wednesday, I have a sumof steps of 1,100 so I'll get an HKStatistics object witha sum of 1,100, and the rest will follow suit. Here are some ofthe many charts in Health that are all powered by HKStatisticsCollectionQueries.It's incredible to see how one query can unveil so much useful and insightfulinformation about our health.  HKStatisticsCollectionQuery is really powerful.I want to touch on one of its other super powers. It can listen for updatesto the user's health data. To do so, we'll need to set its update handlerbefore executing the query.  That way our query will be running in the backgroundlistening to any new statistics or new data coming into the health database.Now our query will be running in the background indefinitely, so we'll wantto make sure to call stop when we're done collecting all the data that we need.So let's go ahead and use HKStatisticsCollectionQuery and SmoothWalkerto display our daily step count over the past week. The first thing we'llneed to do is construct our HKStatisticsCollectionQuery. Once we do,we'll execute it on our HealthStore and update our UI with theHKStatisticsCollection object we get back. Let's move on to our demo. All of the codeyou're about to see is available online through a sample Xcode projectfor you to download and to play around with. Here we have SmoothWalkerrunning in our simulator in the left-hand portion of my screen. The viewis empty right now because we haven't implemented the pieces to displayour daily step count. In the upper right-hand cornerwe also have an add data button which will allow us to add any new stepsfor today. So let's go ahead and move over into our Xcode project andimplement all the pieces we need to display our daily steps. Here I amin DailyStepCountTableViewController. This is the view controllerthat's powering our view in the simulator right now.  We have an array that'shooked up to our table view so all we need to do is read our daily stepsand populate our array with that. The first thing we'll need to do thoughis request read and write access to our step count data. We'll need torequest authorization where there's appropriate context. A great placeto do that is in our method viewWillAppear. That way when our applicationloads or we hit that step count tab, our authorization sheet will appear.So let's go ahead and do that.

Here we define the type of data that we want read and write access to, whichis our stepCount data type. Then, using our HealthStore, we'll request authorization,passing in the data that we want to write to and read from. If we successfullyrequest authorization, we'll call the method calculateDailyStepCountForPastWeek.This is the method where all the magic happens. It's wherewe'll read our daily steps and update our UI. So let's go down into this method.

Here I am in calculateDailyStepCountForPastWeek. We'll need to construct anHKStatisticsCollectionQuery, execute our query on our HealthStore and updateour UI with the results. The first thing we'll need to do is define allthe pieces needed to construct our query like the type of data we wantto read, which in this case is our step count data.We'll need our anchor, which is Monday at 3 a.m.

Our time interval, which is a daily cadence.  There can be a lot of stepsdata in HealthKit but we're only interested in computing statistics overthe past week's worth so we'll define a predicate. That way we're only computingstatistics over the past week's worth of step samples.

Here I define my date from one week ago, and I'll construct my predicate usingHKQuery's predicateForSamples. We have all the components needed to constructour query. So let's go ahead and do that. Here I have my HKStatisticsCollectionQuerypassing in the type of data I want to read: which is our stepcount data, our predicate of one week ago, the statistics we want to compute(which is our sum), our anchor of Monday and our time interval of a daily cadence.

Now that we've constructed our query, we'll need to update our UI withthe results we get back. Here we have our initialResultsHandler. Whenour query is done executing, we'll get back our statisticsCollection andan error if there was any issue reading our health data. Here is where we'llupdate our UI.

If there are any statistics to show on our table view, we'll call our methodupdateUIFromStatistics. This is where we'll pass in our statisticsCollectionand update our array that's backing our table view. So let's go down intothis method and implement it.

Here I am in updateUIFromStatistics. It takes a statisticsCollectionobject so we'll enumerate over all of our statistics and append it intoour array that's backing our table view. Since we'll be updating our UI,we want to make sure to dispatch back to the main thread.  Here we have ourdataValues array, which is the array backing our table view and our UI.It is an array of HKStatistics. What we'll need to do is enumerate overstatistics for the past week in our statisticsCollection object.We'll define our start date of one week ago and we'll enumerate until today.Then we'll call our enumerateStatistics method on our statisticsCollection,and as we enumerate we'll append our statistics into our array backingour table view. Finally when we're done enumerating, we'll call reloadData.This will refresh our table view and update our UI. The final thing weneed to do though is execute our query so we'll go back up into ourcalculateDailyStepCountForPastWeek method and execute our query after settingour initial results handler.

And with that, I'll hit run and let's see what happens.

Ah. Our authorization sheet just popped up on our device. This will allow usto deny or grant permission to our step count data for SmoothWalker.  SinceI'm not particularly sensitive about steps data, I'll enable both readand write access for it. I'll hit "Turn All Categories On" and hit that "Allow" button.

Ah. And our table view just updated with all of our daily steps for the pastweek. Let's go ahead and try and add some data for today. I'll add 800steps and hit that "Add" button. And as you can see, our table view didn't update.And that's because we haven't set our update handler on our query.So let's go back into Xcode and set up our update handler. That way our querywill be running in the background listening for any new health data orany new steps coming in. We'll set up our update handler in our methodcalculateDailyStepCountForPastWeek. We'll need to set up our updatehandler before we execute our query.

So that's where we'll do it. Here, I have my statisticsUpdateHandler.

This will get called when there's any new data that's coming into the databaseor if there's any new statistics. We'll get back any new statistics, astatisticsCollection object and an error if there's any issue reading our data.  Herewe'll update our UI, calling the same method we did in our initial results handler.

Now our query is going to be running in the background indefinitely, listeningto any new steps that'll be added into the database so we'll want to makesure to call stop when we're done collecting all the data that we need.A great place to do that is in our method viewWillDisappear. That way,our query will stop when our view is no longer visible on our device.So let's go ahead and implement that.

Here we're in viewWillDisappear. We'll stop our query in this method.

And with that, let's hit run again and see what happens when we add somenew steps for today. So I'm going to add some data, I'll add 235steps - and our table view just updated with that new step count.And with that, we just finished displaying our daily steps in our application.Let's just take a look at what we just did. We constructed ourHKStatisticsCollectionQuery, executed it on our HealthStore and updated our UI with ourstatisticsCollection object. We just took a look at HKStatisticsQueryand HKStatisticsCollectionQuery. They are super powerful.However, you may not always want to compute statistics on the health data, and notall of our health data is quantitative. You can use HKSampleQuery toretrieve the raw health samples stored in the database. So let's go takea look at how we would do that. Here we'll define the type of data I wantto read, which is my workouts. Then I'll define a sort, which will sort allof the objects returned back from my query. In this case, I want them sortedfrom the most recent date that they finished. Finally, we'll construct oursample query, passing in the type of data we want to read, our predicate, whichis nil, our limit of 1 (since we're only interested in the most recent oneworkout) and our sort. Finally, we'll execute our query using our HealthStore.There are many other types of queries available in HealthKit to help youaccomplish the task that you have at hand. We have HKAnchoredObjectQuery,which will allow you to track changes in the user's database. There's alsoHKActivitySummaryQuery, which will allow you to display the rich activityring data from our Apple Watch. There's also HKWorkoutRouteQuerywhich will display all of the locations we've been on during our outdoor workouts.

And with that we finished integrating HealthKit into SmoothWalker.We discussed a lot today. I want to go over some of the bigger takeaways.HealthKit is a framework that helps create and manage a central repositoryof the user's health data, providing a rich ecosystem for your health application.However our health data makes up some of the most sensitive data on ourdevice so make sure to request authorization for only the data that youneed. When you need it. Every time. HealthKit has a rich type system to helporganize and structure health data. We looked at quantity types, categorytypes and even workouts but there are many more that I encourage you tolook into to see what works best for your health application.HealthKit has a wide range of queries to help you efficiently and performantly read data.We looked at sample query and statistics queries today but there are manymore to help you create the next great health application. We're so excitedfor you to join our healthy community here at Apple and to see the incrediblehealth applications you'll build that will revolutionize the way userstake control over their health.

I hope you have a wonderful rest of
your WWDC and let's go get healthy.

## Code Samples

