# Wwdc2020 10659

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Transcript

Introducing StoreKit Testing in XcodeDiscover StoreKit Testing in Xcode — a local environment for testing your in-app purchases without needing to connect to App Store servers. We'll show you how to set up a test environment, create a StoreKit configuration file, and prepare to validate receipts locally. We'll also explain how to test a variety of in-app purchase scenarios and automate those tests with the StoreKitTest framework, and cover the latest improvements to testing in the sandbox environment.ResourcesSetting up StoreKit Testing in XcodeStoreKit TestTesting at all stages of development with Xcode and the sandboxTesting In-App Purchases in XcodeTesting In-App Purchases with sandboxHD VideoSD VideoRelated VideosWWDC23Meet StoreKit for SwiftUIWWDC22What's new in StoreKit testingWWDC20What’s new with in-app purchase

Discover StoreKit Testing in Xcode — a local environment for testing your in-app purchases without needing to connect to App Store servers. We'll show you how to set up a test environment, create a StoreKit configuration file, and prepare to validate receipts locally. We'll also explain how to test a variety of in-app purchase scenarios and automate those tests with the StoreKitTest framework, and cover the latest improvements to testing in the sandbox environment.

Setting up StoreKit Testing in Xcode

StoreKit Test

Testing at all stages of development with Xcode and the sandbox

Testing In-App Purchases in Xcode

Testing In-App Purchases with sandbox

HD VideoSD Video

HD Video

SD Video

Meet StoreKit for SwiftUI

What's new in StoreKit testing

What’s new with in-app purchase

Search this video…♪Hello, and welcome to WWDC.Dana DuBois: Hello, and welcome toIntroducing StoreKit Testing in Xcode.My name is Dana, and I'm really excited to show youall the great new features we're introducing this yearthat'll make building and testing in-app purchasesbetter than ever.But before we get into what's new,let's quickly review how developers work with StoreKitto add in-app purchases to their apps today.Currently, if I'm looking to update my app,either to begin selling content through StoreKit,or to add new content to sell,one of the very first steps I have to takeis to sign in to App Store Connect.There, I need to register my app,define my in-app purchases,and create my Sandbox accounts for testing.Only after I've taken those steps can I go back to Xcodeand start writing the code to integrate StoreKitwithin my app.As I'm building up my app,I'll be working with the Sandbox environmentto test my in-app purchasesusing one of the Sandbox accountsI set up in App Store Connect.There I won't be chargedas purchases are made during my testing.Additionally, when I hand off my app to be beta tested.the Sandbox environment will be continued to be usedby developers working with my app.Only after I verified my app works as expected,will I release my app to the app store,where the production environment is usedto back all StoreKit calls.This has worked well in the past,but we think we can do better for you, our developers.I'm excited to announce this year, with Xcode 12,we're introducing a new development and testing suitededicated to StoreKit and in-app purchases.This will allow you to start right in Xcode to buildand test your app's in-app purchases entirely locally.This is all integrated right into Xcode,so it works seamlessly with your app's development workflow.Additionally, we're introducing a brand newStoreKit test framework that will unlockthe full automation testing for your StoreKit integration.This changes the entire development lifecyclefor StoreKit.Now instead of starting in App Store Connect,you can start right in Xcode.Build out your StoreKit integrationat the same time you're building out the rest of your app.Add in unit UI and other automation tests to make surethe quality of your app's StoreKit integrationremains high,then sign in to App Store Connectand begin using the Sandbox environment.Working with Sandbox is a critical step you need to taketo make sure your app is ready to be released to your usersin the App Store. It's also the environment you need to use to test outany server-to-server functionality requiredfor your app.Additionally, we're adding a number of great enhancementsto the Sandbox environment this yearthat my colleague Chris will go into more detail later onin the session.Let's dive in and take a closer look at StoreKit testingin Xcode 12.The app I'm building, Fruta, is all about fruit smoothiesand the feature I'm working on right nowis around selling recipes for those smoothies.StoreKit is the right technology to use as those recipesare digital content I want to offer within my app.I've already configured Fruta to fetch and renderthose store products for the recipes.If I navigate to Store.swift,where I keep most of the store content within my app,you can see I have a list of product identifiersfor all the different recipes I want to sell.Further down within the fetchedProducts function,I have a SKProductsRequest callwhere I'm passing in all the product identifiersfrom those recipes.Fruta should be ready to gofor fetching and rendering those products.So let's launch it in the simulator and see what happens.As you can see, none of my recipes are showing.But this is expected,because I've not yet configured my app or in-app purchaseswithin App Store Connect, and by default,StoreKit is using the Sandbox environment.So I need to enable local testing within Xcode.To do that, I'll first need to define my in-app productsinside my project.First, I navigate up to the file menu, create a new file.There I'll type in StoreKitand select the StoreKit configuration file template.And I'll just create a new configuration fileright inside my project.And now I'll have a place to store the metadatafor all my in-app products;the recipes that my app will offer.In the bottom left-hand corner of this editor,I have the option to add StoreKit items to this file.As I select that,I'm given a choice over which type of product to add.The first option is for a consumable,which is a type of product that you can buyover and over and over again,such as lives or gems within a game.The second is for a non-consumable,which are purchased once and never expire.Lastly we have auto-renewable subscriptionswhere users are charged periodicallyfor access to services or content.I'm going to choose to create a non-consumableas that makes the most sense for purchasing digital recipes.And now I need to fill out the detailsfor the recipe I want to sell.In this case, I'm gonna choose Berry Blueas it's my favorite smoothie.The product ID is a unique identifierfor this specific product within my appand it needs to match the value that my appwill pass in to the StoreKit APIs.To make sure I get it right,I'm just gonna copy and paste it from Store.swift.Next I need to set a price.Unlike in App Store Connect,where I can choose from a price tier,here I'm given the option to enter in any decimal value.This is because for StoreKit testing in Xcodethe price is simply used for setting what value is returnedin the SKProduct that is handed back to my app.So here I have direct control over the valueand I can easily change it to make sure my app can handleany possible value returned.For now, I'm going to leave it as 99 cents.Additionally, I have the option to enable Family Sharing.This is a brand new feature we're releasing this year.For the purposes of StoreKit testing in Xcode,enabling Family Sharing will updatethe IsFamilySharable flag on the SKProduct.I'm going to leave that unset.Lastly, I need to give this producta localized name within my app.I can also set a description,but for now, I'm going to leave that blank.Now that I've set up my StoreKit configuration,I need to tell Xcode to use it instead of Sandboxwhen launching my app.Doing that's as easy as opening up the scheme editor,and under Run Options,selecting that configuration I just created.Now when I relaunch my app,StoreKit is using the local test environment.And the SKProduct returns the metadata I've configured.Earlier I skipped setting a description for Berry Blue.But I want a description to show upand Fruta is already set upto take the localized description from the SKProductand display it.StoreKit testing in Xcode is entirely interactive,meaning I can update the metadatafrom my app's products without recompiling or even relaunching.I just need to update the StoreKit configuration fileto have the description I want.And have my app re-execute the SK product requeststo pull down the updated metadata.My project already contained a StoreKit configurationthat has all the recipes I will be selling,so I'm going to quickly switch over to that fileand relaunch my app.My app is already configured to take the SKProductthat we fetched and use it to create an SK paymentand add it to the payment queue.To exercise that code,I just need to select one of the buy buttons.Right here in the simulator,I get a payment sheet a lot like what my users will see.The big difference here is that I didn't need to sign inand there is no need to authenticatesince this is just for testing purposes and I won't be charged.I simply select confirm and the payment goes through.Just like Sandbox or production,my app's payment transaction observer is updatedas the transaction goes from purchasing to purchased.I'm even given a receipt that my app can verify.Berry Blue is now unlockedand I can navigate in and see the recipe.Now let's say you had an issuewhere I needed to purchase Berry Blue all over again,possibly to fix a bugor to change the experience around purchasing.Xcode makes that really easywith the new StoreKit Transaction Manager.I see all the purchases I made in the local test environmentand I have full control over them.I'm able to delete this transaction,and reset state as if the purchase never happened.I can now buy Berry Blue againas if I'd never purchased it before.In addition to being able to delete previous purchases,I have the ability to simulate a refund.In the case of a refund,the transaction remains in the transaction managerbut is marked as refunded.The transaction also remains in the app's receipt,but is updated to contain a cancellation datefor when the refund occurred.Again, my app is informed about the refundand is able to respond immediately.If you want to make sure your app has a great experiencefor kids who need to get permissionbefore making purchases,StoreKit testing in Xcode has full support for Ask to Buy.It's as easy as going back to your StoreKit configuration fileand enabling Ask to Buy under the editor menu.Now when I go to purchase a recipe within Fruta,I see the same Ask Permission dialoguethat will be presented to any userwho has Ask to Buy turned on for their account.When I select "Ask,"the transaction appears as pending approvalwithin the transaction manager.And in code, my app's SKPayment transaction observeris informed that the transaction is now in a deferred state.I can now approve or decline it.Once I approve, the previously deferred transaction is updatedto a purchase state and my app updates right awayto show the unlocked recipe.I also have the option to enable interrupted purchases.This will allow me to simulate the casewhere a user needs to take some action on their accountbefore being able to complete a purchase.For example they may need to update detailsrelated to their account's billing information.In this case, the initial purchase will come backas failed.But once the user has taken action to resolvewhatever issue caused the interruption,a new transaction for the same product will be addedto the payment queue.I've been considering changing the business modelof my application to be subscription based.For one monthly price,users will have access to all the smoothie recipesinstead of needing to buy them one at a time.StoreKit Testing in Xcode makes it really easyto build auto-renewable subscriptions with StoreKit.I've already created a second StoreKit configuration filethat contains two different subscriptionsI want to offer in my app.First, Recipes Plus,which is configured to renew at a monthly price of $2.99.To make it even more compelling,I've set up an introductory offer of 99 centsfor the first month.I've also created a Recipes Pro option,which not only unlocks all the recipes in my app,but gives subscribers access to advanced nutrition factsfor each smoothie.The two subscriptions are containedin the same subscription group,enabling my app to offer upgrade optionsbetween Recipes Plus and Recipes Pro.I've already built Fruta to work with these subscriptions,so to try out that business model,I just need to switch StoreKit configurationsand relaunch my app.Here my app is displaying detailsabout both the subscription offers,including the introductory offer on Recipes Plus.I want to make sure my app correctly handleswhen my subscription auto-renews,but I don't want to wait a full month to test it out.With StoreKit testing in Xcode,I have the power to speed up time.In the editor menu of my subscription configuration,I select Time Rate, and I can set one second to be one day.This will change it so we only have to wait secondsfor that renewal to occur instead of an entire month.Now that I've purchased that subscription,all the recipes are unlocked.And I won't have to wait very longfor the Recipe auto-renewing subscriptionto automatically renew.Earlier as I was working with the transaction managerto delete and refund purchases,my app immediately updated to revoke access to those recipes.This was made possible in iOS14thanks to a new API we added on SKPayment transaction Observer:didRevokeEntitlementsForProduct Identifiers.To learn more about this API and all of the other new featureswe've added to StoreKit this year,I highly suggest you check outWhat's New with In-App Purchases.To enable you to authenticatethe purchased content in your app,the App Store provides a digitally signed receipt.The receipt is the trusted record of purchasesmade by the user in your app.It's stored on the deviceand updated automatically by the system.It is signed so you know that it came from the App Storeand was meant for your app on that device.If you want to learn more on how to verify the receipt,I recommend checking out Best Practicesand What's New with In-App Purchases from 2018.But I do want to highlight some key differencesyou need to keep in mind when working with the receiptsgenerated by the local Xcode StoreKit test environment.First, they are signed with a different private keythan what is used for the receiptsgenerated in the Sandbox or production environments.That means you need to usea different certificate when validating.We provide a convenient way to exportthat StoreKit Test Certificate into your projectvia the editor menu of your StoreKit configuration file.Lastly, the StoreKit Test Certificateis not part of a certificate chain.To accommodate for those differences,you should make use of the debug macrowithin your client-side validation code.Here you can see where my code is choosingbetween the StoreKit test certificateand the Apple, Inc. Root Certificate,based on that macro.Additionally, if I use open SSLfor my client-side receipt validation,I would pass in the PKCS7 no chain argument,but only when building for debug.StoreKit Testing in Xcode 12 work greaton all of the OS betas that we just released,both when building and running in the simulatoras well as on real devices.I walked you through setting upyour project StoreKit configuration,enabling the local test environment,using the transaction manager to delete and refundprevious purchases,and making sure your app has a great experiencefor deferred or interrupted purchases,and purchases that renew automatically.But as critical is it is for you to be able to buildand test your store kit integration manually,it's just as important for you to build automationthat continuously tests your in-app purchases,which is why we're introducing a brand new StoreKitTest Frameworkthat enables you in codeto control the full local test environment.All the controls that you had manually are exposedinside your tests.StoreKitTest works with XCTestfor extending unit and UI test coverageto your in-app purchases.Additionally, with StoreKitTest you have the ability to disableall the sheets and dialogs that would normally appear.So your tests can run to completionwithout waiting for user interaction.Lastly, you have the ability to triggerthe renewal of the subscription right awayso your test can validate if your app's subscription featurescontinue to work across renewals.StoreKitTest can be used to cover a wide range of casesincluding your app's handling of bothsuccessful and failed purchases,interrupted and deferred purchases,transactions that initiate outsidethe running of your app,as well as all sorts of cases related to subscriptions.Let's go back in Xcode and run through an example.In Fruta, I've already built out a series of unit testscovering cases related to in-app purchases.The first one is a basic test casethat ensures my App correctly unlocksthe Berry Banana smoothie recipewhen successfully purchased by a user.The very first thing it does is createsa new Store KitTest session initializedwith the non-consumable StoreKit configuration file.It's important to remember to include the configuration filein the test targetsso that's referenceable by SK Test session.Next I'm disabling all dialogs on my sessionso that my test can run to completionwithout user interaction.After that, I'm clearing all previous transactionsso I know that I'm starting from a clear state.Finally, my test buys the recipe and confirmsthat it's available.Test succeeded, so I know I'm good to go.At this point, I can begin the processof getting my app in in-app purchasesready to be available in the App Store.The critical next step is to sign in to App Store Connect,set up everything the App Store needsto support my in-app purchasesand test that configuration using the Sandbox environment.To tell you all about all the great enhancementsand features we're bringing to Sandbox,I'm gonna hand it off to Chris.Chris Markiewicz: Thanks, Dana.Hi, I'm Chris, a program manager for the App Store.We saw how StoreKit Testing in Xcode enables youto perform early testing and debuggingof in-app purchases in a local test environment.There are some key differences between StoreKit Testing in Xcodeand testing in the Sandbox environment.First, you set up in-app purchases in App Store Connect.This is the same product information your app useswhen it's available on the App Store,and you'll create a Sandbox Apple IDto sign into your test device.In Sandbox, app receipts are signed by the App Store.Sandbox also supports server-side receipt validationand App Store server notifications.In iOS 12, we added a Sandbox account sectionin app store settings for signing into a Sandbox account,an account which you set up in App Store Connect.In iOS14, it's easier to test your in-app purchasesand subscriptions in Sandbox.A new Manage option leads youinto the new Sandbox manage subscriptions pagewhere you can view and test your subscriptionsin Sandbox.Tapping into our Fruta app,we see all subscriptions within the subscription group.You may have used this page on productionas a subscriber for selecting a different subscriptionto upgrade, downgrade, or cancel.Now this page is available to you as a developerto test your subscription tiers in the Sandbox environment.We added the ability to reset introductory offer eligibilityfor a subscription.With this, you can use the same Sandbox test accountto test free trials or introductory offers.You no longer need to set up a new Sandbox Apple IDeach time you want to retest an introductory offer.Here's an example of subscription lifecycle.With this new functionality in Sandbox,you can test common subscription changeswhich happen outside of your app,including customer actions such as a downgrade, an upgrade,or a cancellation.You can test server logicfor subscriber status change notification typessuch as DID_CHANGE_RENEWAL_STATUSand DID_RENEW, a new notification type coming later this yearin production which you'll also receive in Sandbox.To learn more about server notification types,please refer to the session What's New with In-App Purchase.Coming soon to App Store Connect,Sandbox accounts will be able to testinterrupted purchases on a device.To use this, select a row for a Sandbox Apple ID.Selecting Cindy's account,check the box to enable interrupted purchases,then Save.Now Cindy can test interrupted purchases in Sandboxon an iOS device.A scenario would be needing to agreeto updated terms and conditions before completing the purchase.Purchases on a device will continue to be interruptedfor an individual Sandbox accountuntil you return to App Store Connectand disable interrupted purchases for each tester.Let's review the new iOS 14 subscription and in-app purchasetesting functionality in Sandbox.On a device you can now view and manage subscriptions.You can also test upgrades, downgrades, cancellations,and reset introductory offer eligibility.Soon you'll be able to test on a devicehow your app responds to an interrupted purchase.Lastly, in App Store Connect, users with the developer rolewill be able to create and manage Sandbox tester accounts.Testing in the Sandbox environment is a great wayto improve your app's handling of in-app purchasesbefore releasing into production.For a recap, here's Dana.Thanks, Chris.There's a clear path for building and releasinghigh-quality apps that use StoreKit.Start in Xcode 12and use the interactive local test environmentto build out your StoreKit integration.Use the StoreKitTest framework to build tests and automationto ensure the quality of your app's subscriptionand in-app purchase functionality.Sign into App Store Connect,set up everything the App Store needsto support your in-app purchases,and test that configuration using the Sandbox environment.Additionally use Sandbox to testall server-to-server functionalityrequired for your app.Take advantage of TestFlight to get beta testing coverageof both your app and its subscriptionor in-app purchase functionalityand then make your app live on the App Store.Thanks again, and we look forward to seeingthe great apps
you're going to release.

♪Hello, and welcome to WWDC.Dana DuBois: Hello, and welcome toIntroducing StoreKit Testing in Xcode.My name is Dana, and I'm really excited to show youall the great new features we're introducing this yearthat'll make building and testing in-app purchasesbetter than ever.But before we get into what's new,let's quickly review how developers work with StoreKitto add in-app purchases to their apps today.Currently, if I'm looking to update my app,either to begin selling content through StoreKit,or to add new content to sell,one of the very first steps I have to takeis to sign in to App Store Connect.There, I need to register my app,define my in-app purchases,and create my Sandbox accounts for testing.Only after I've taken those steps can I go back to Xcodeand start writing the code to integrate StoreKitwithin my app.

As I'm building up my app,I'll be working with the Sandbox environmentto test my in-app purchasesusing one of the Sandbox accountsI set up in App Store Connect.There I won't be chargedas purchases are made during my testing.Additionally, when I hand off my app to be beta tested.the Sandbox environment will be continued to be usedby developers working with my app.Only after I verified my app works as expected,will I release my app to the app store,where the production environment is usedto back all StoreKit calls.This has worked well in the past,but we think we can do better for you, our developers.I'm excited to announce this year, with Xcode 12,we're introducing a new development and testing suitededicated to StoreKit and in-app purchases.This will allow you to start right in Xcode to buildand test your app's in-app purchases entirely locally.This is all integrated right into Xcode,so it works seamlessly with your app's development workflow.Additionally, we're introducing a brand newStoreKit test framework that will unlockthe full automation testing for your StoreKit integration.This changes the entire development lifecyclefor StoreKit.Now instead of starting in App Store Connect,you can start right in Xcode.Build out your StoreKit integrationat the same time you're building out the rest of your app.

Add in unit UI and other automation tests to make surethe quality of your app's StoreKit integrationremains high,then sign in to App Store Connectand begin using the Sandbox environment.Working with Sandbox is a critical step you need to taketo make sure your app is ready to be released to your usersin the App Store. It's also the environment you need to use to test outany server-to-server functionality requiredfor your app.Additionally, we're adding a number of great enhancementsto the Sandbox environment this yearthat my colleague Chris will go into more detail later onin the session.

Let's dive in and take a closer look at StoreKit testingin Xcode 12.The app I'm building, Fruta, is all about fruit smoothiesand the feature I'm working on right nowis around selling recipes for those smoothies.StoreKit is the right technology to use as those recipesare digital content I want to offer within my app.I've already configured Fruta to fetch and renderthose store products for the recipes.If I navigate to Store.swift,where I keep most of the store content within my app,you can see I have a list of product identifiersfor all the different recipes I want to sell.Further down within the fetchedProducts function,I have a SKProductsRequest callwhere I'm passing in all the product identifiersfrom those recipes.Fruta should be ready to gofor fetching and rendering those products.So let's launch it in the simulator and see what happens.

As you can see, none of my recipes are showing.But this is expected,because I've not yet configured my app or in-app purchaseswithin App Store Connect, and by default,StoreKit is using the Sandbox environment.So I need to enable local testing within Xcode.To do that, I'll first need to define my in-app productsinside my project.First, I navigate up to the file menu, create a new file.

There I'll type in StoreKitand select the StoreKit configuration file template.And I'll just create a new configuration fileright inside my project.And now I'll have a place to store the metadatafor all my in-app products;the recipes that my app will offer.In the bottom left-hand corner of this editor,I have the option to add StoreKit items to this file.As I select that,I'm given a choice over which type of product to add.The first option is for a consumable,which is a type of product that you can buyover and over and over again,such as lives or gems within a game.The second is for a non-consumable,which are purchased once and never expire.Lastly we have auto-renewable subscriptionswhere users are charged periodicallyfor access to services or content.I'm going to choose to create a non-consumableas that makes the most sense for purchasing digital recipes.And now I need to fill out the detailsfor the recipe I want to sell.In this case, I'm gonna choose Berry Blueas it's my favorite smoothie.The product ID is a unique identifierfor this specific product within my appand it needs to match the value that my appwill pass in to the StoreKit APIs.To make sure I get it right,I'm just gonna copy and paste it from Store.swift.

Next I need to set a price.Unlike in App Store Connect,where I can choose from a price tier,here I'm given the option to enter in any decimal value.This is because for StoreKit testing in Xcodethe price is simply used for setting what value is returnedin the SKProduct that is handed back to my app.So here I have direct control over the valueand I can easily change it to make sure my app can handleany possible value returned.For now, I'm going to leave it as 99 cents.Additionally, I have the option to enable Family Sharing.This is a brand new feature we're releasing this year.For the purposes of StoreKit testing in Xcode,enabling Family Sharing will updatethe IsFamilySharable flag on the SKProduct.I'm going to leave that unset.Lastly, I need to give this producta localized name within my app.

I can also set a description,but for now, I'm going to leave that blank.Now that I've set up my StoreKit configuration,I need to tell Xcode to use it instead of Sandboxwhen launching my app.Doing that's as easy as opening up the scheme editor,and under Run Options,selecting that configuration I just created.Now when I relaunch my app,StoreKit is using the local test environment.And the SKProduct returns the metadata I've configured.Earlier I skipped setting a description for Berry Blue.But I want a description to show upand Fruta is already set upto take the localized description from the SKProductand display it.StoreKit testing in Xcode is entirely interactive,meaning I can update the metadatafrom my app's products without recompiling or even relaunching.I just need to update the StoreKit configuration fileto have the description I want.

And have my app re-execute the SK product requeststo pull down the updated metadata.

My project already contained a StoreKit configurationthat has all the recipes I will be selling,so I'm going to quickly switch over to that fileand relaunch my app.

My app is already configured to take the SKProductthat we fetched and use it to create an SK paymentand add it to the payment queue.To exercise that code,I just need to select one of the buy buttons.

Right here in the simulator,I get a payment sheet a lot like what my users will see.The big difference here is that I didn't need to sign inand there is no need to authenticatesince this is just for testing purposes and I won't be charged.I simply select confirm and the payment goes through.Just like Sandbox or production,my app's payment transaction observer is updatedas the transaction goes from purchasing to purchased.I'm even given a receipt that my app can verify.Berry Blue is now unlockedand I can navigate in and see the recipe.Now let's say you had an issuewhere I needed to purchase Berry Blue all over again,possibly to fix a bugor to change the experience around purchasing.Xcode makes that really easywith the new StoreKit Transaction Manager.

I see all the purchases I made in the local test environmentand I have full control over them.I'm able to delete this transaction,and reset state as if the purchase never happened.

I can now buy Berry Blue againas if I'd never purchased it before.

In addition to being able to delete previous purchases,I have the ability to simulate a refund.In the case of a refund,the transaction remains in the transaction managerbut is marked as refunded.

The transaction also remains in the app's receipt,but is updated to contain a cancellation datefor when the refund occurred.Again, my app is informed about the refundand is able to respond immediately.If you want to make sure your app has a great experiencefor kids who need to get permissionbefore making purchases,StoreKit testing in Xcode has full support for Ask to Buy.It's as easy as going back to your StoreKit configuration fileand enabling Ask to Buy under the editor menu.

Now when I go to purchase a recipe within Fruta,I see the same Ask Permission dialoguethat will be presented to any userwho has Ask to Buy turned on for their account.

When I select "Ask,"the transaction appears as pending approvalwithin the transaction manager.And in code, my app's SKPayment transaction observeris informed that the transaction is now in a deferred state.

I can now approve or decline it.Once I approve, the previously deferred transaction is updatedto a purchase state and my app updates right awayto show the unlocked recipe.I also have the option to enable interrupted purchases.This will allow me to simulate the casewhere a user needs to take some action on their accountbefore being able to complete a purchase.For example they may need to update detailsrelated to their account's billing information.In this case, the initial purchase will come backas failed.But once the user has taken action to resolvewhatever issue caused the interruption,a new transaction for the same product will be addedto the payment queue.

I've been considering changing the business modelof my application to be subscription based.For one monthly price,users will have access to all the smoothie recipesinstead of needing to buy them one at a time.StoreKit Testing in Xcode makes it really easyto build auto-renewable subscriptions with StoreKit.I've already created a second StoreKit configuration filethat contains two different subscriptionsI want to offer in my app.First, Recipes Plus,which is configured to renew at a monthly price of $2.99.

To make it even more compelling,I've set up an introductory offer of 99 centsfor the first month.I've also created a Recipes Pro option,which not only unlocks all the recipes in my app,but gives subscribers access to advanced nutrition factsfor each smoothie.The two subscriptions are containedin the same subscription group,enabling my app to offer upgrade optionsbetween Recipes Plus and Recipes Pro.I've already built Fruta to work with these subscriptions,so to try out that business model,I just need to switch StoreKit configurationsand relaunch my app.

Here my app is displaying detailsabout both the subscription offers,including the introductory offer on Recipes Plus.I want to make sure my app correctly handleswhen my subscription auto-renews,but I don't want to wait a full month to test it out.With StoreKit testing in Xcode,I have the power to speed up time.In the editor menu of my subscription configuration,I select Time Rate, and I can set one second to be one day.This will change it so we only have to wait secondsfor that renewal to occur instead of an entire month.

Now that I've purchased that subscription,all the recipes are unlocked.And I won't have to wait very longfor the Recipe auto-renewing subscriptionto automatically renew.

Earlier as I was working with the transaction managerto delete and refund purchases,my app immediately updated to revoke access to those recipes.This was made possible in iOS14thanks to a new API we added on SKPayment transaction Observer:didRevokeEntitlementsForProduct Identifiers.To learn more about this API and all of the other new featureswe've added to StoreKit this year,I highly suggest you check outWhat's New with In-App Purchases.To enable you to authenticatethe purchased content in your app,the App Store provides a digitally signed receipt.The receipt is the trusted record of purchasesmade by the user in your app.It's stored on the deviceand updated automatically by the system.It is signed so you know that it came from the App Storeand was meant for your app on that device.If you want to learn more on how to verify the receipt,I recommend checking out Best Practicesand What's New with In-App Purchases from 2018.But I do want to highlight some key differencesyou need to keep in mind when working with the receiptsgenerated by the local Xcode StoreKit test environment.First, they are signed with a different private keythan what is used for the receiptsgenerated in the Sandbox or production environments.That means you need to usea different certificate when validating.We provide a convenient way to exportthat StoreKit Test Certificate into your projectvia the editor menu of your StoreKit configuration file.Lastly, the StoreKit Test Certificateis not part of a certificate chain.To accommodate for those differences,you should make use of the debug macrowithin your client-side validation code.Here you can see where my code is choosingbetween the StoreKit test certificateand the Apple, Inc. Root Certificate,based on that macro.Additionally, if I use open SSLfor my client-side receipt validation,I would pass in the PKCS7 no chain argument,but only when building for debug.StoreKit Testing in Xcode 12 work greaton all of the OS betas that we just released,both when building and running in the simulatoras well as on real devices.I walked you through setting upyour project StoreKit configuration,enabling the local test environment,using the transaction manager to delete and refundprevious purchases,and making sure your app has a great experiencefor deferred or interrupted purchases,and purchases that renew automatically.But as critical is it is for you to be able to buildand test your store kit integration manually,it's just as important for you to build automationthat continuously tests your in-app purchases,which is why we're introducing a brand new StoreKitTest Frameworkthat enables you in codeto control the full local test environment.All the controls that you had manually are exposedinside your tests.StoreKitTest works with XCTestfor extending unit and UI test coverageto your in-app purchases.Additionally, with StoreKitTest you have the ability to disableall the sheets and dialogs that would normally appear.So your tests can run to completionwithout waiting for user interaction.Lastly, you have the ability to triggerthe renewal of the subscription right awayso your test can validate if your app's subscription featurescontinue to work across renewals.

StoreKitTest can be used to cover a wide range of casesincluding your app's handling of bothsuccessful and failed purchases,interrupted and deferred purchases,transactions that initiate outsidethe running of your app,as well as all sorts of cases related to subscriptions.Let's go back in Xcode and run through an example.In Fruta, I've already built out a series of unit testscovering cases related to in-app purchases.The first one is a basic test casethat ensures my App correctly unlocksthe Berry Banana smoothie recipewhen successfully purchased by a user.The very first thing it does is createsa new Store KitTest session initializedwith the non-consumable StoreKit configuration file.It's important to remember to include the configuration filein the test targetsso that's referenceable by SK Test session.Next I'm disabling all dialogs on my sessionso that my test can run to completionwithout user interaction.After that, I'm clearing all previous transactionsso I know that I'm starting from a clear state.Finally, my test buys the recipe and confirmsthat it's available.

Test succeeded, so I know I'm good to go.At this point, I can begin the processof getting my app in in-app purchasesready to be available in the App Store.The critical next step is to sign in to App Store Connect,set up everything the App Store needsto support my in-app purchasesand test that configuration using the Sandbox environment.To tell you all about all the great enhancementsand features we're bringing to Sandbox,I'm gonna hand it off to Chris.Chris Markiewicz: Thanks, Dana.Hi, I'm Chris, a program manager for the App Store.We saw how StoreKit Testing in Xcode enables youto perform early testing and debuggingof in-app purchases in a local test environment.There are some key differences between StoreKit Testing in Xcodeand testing in the Sandbox environment.First, you set up in-app purchases in App Store Connect.This is the same product information your app useswhen it's available on the App Store,and you'll create a Sandbox Apple IDto sign into your test device.In Sandbox, app receipts are signed by the App Store.Sandbox also supports server-side receipt validationand App Store server notifications.In iOS 12, we added a Sandbox account sectionin app store settings for signing into a Sandbox account,an account which you set up in App Store Connect.In iOS14, it's easier to test your in-app purchasesand subscriptions in Sandbox.A new Manage option leads youinto the new Sandbox manage subscriptions pagewhere you can view and test your subscriptionsin Sandbox.Tapping into our Fruta app,we see all subscriptions within the subscription group.You may have used this page on productionas a subscriber for selecting a different subscriptionto upgrade, downgrade, or cancel.Now this page is available to you as a developerto test your subscription tiers in the Sandbox environment.We added the ability to reset introductory offer eligibilityfor a subscription.With this, you can use the same Sandbox test accountto test free trials or introductory offers.You no longer need to set up a new Sandbox Apple IDeach time you want to retest an introductory offer.

Here's an example of subscription lifecycle.With this new functionality in Sandbox,you can test common subscription changeswhich happen outside of your app,including customer actions such as a downgrade, an upgrade,or a cancellation.You can test server logicfor subscriber status change notification typessuch as DID_CHANGE_RENEWAL_STATUSand DID_RENEW, a new notification type coming later this yearin production which you'll also receive in Sandbox.To learn more about server notification types,please refer to the session What's New with In-App Purchase.Coming soon to App Store Connect,Sandbox accounts will be able to testinterrupted purchases on a device.To use this, select a row for a Sandbox Apple ID.Selecting Cindy's account,check the box to enable interrupted purchases,then Save.Now Cindy can test interrupted purchases in Sandboxon an iOS device.A scenario would be needing to agreeto updated terms and conditions before completing the purchase.Purchases on a device will continue to be interruptedfor an individual Sandbox accountuntil you return to App Store Connectand disable interrupted purchases for each tester.Let's review the new iOS 14 subscription and in-app purchasetesting functionality in Sandbox.On a device you can now view and manage subscriptions.You can also test upgrades, downgrades, cancellations,and reset introductory offer eligibility.Soon you'll be able to test on a devicehow your app responds to an interrupted purchase.Lastly, in App Store Connect, users with the developer rolewill be able to create and manage Sandbox tester accounts.Testing in the Sandbox environment is a great wayto improve your app's handling of in-app purchasesbefore releasing into production.For a recap, here's Dana.Thanks, Chris.There's a clear path for building and releasinghigh-quality apps that use StoreKit.Start in Xcode 12and use the interactive local test environmentto build out your StoreKit integration.

Use the StoreKitTest framework to build tests and automationto ensure the quality of your app's subscriptionand in-app purchase functionality.Sign into App Store Connect,set up everything the App Store needsto support your in-app purchases,and test that configuration using the Sandbox environment.Additionally use Sandbox to testall server-to-server functionalityrequired for your app.Take advantage of TestFlight to get beta testing coverageof both your app and its subscriptionor in-app purchase functionalityand then make your app live on the App Store.Thanks again, and we look forward to seeingthe great apps
you're going to release.

## Code Samples

