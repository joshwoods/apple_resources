# Wwdc2022 10095

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Transcript

Code

Enhance collaboration experiences with MessagesDiscover how you can help improve communication and collaboration in your app with Collaboration in Messages. Learn how to tie a document to Messages conversations for simple sharing and discussion. Explore how you can keep everyone in the conversation up to date on the latest activity in the document. And find out how you can add customizable UI in your app to manage collaboration details and connect documents to Messages conversations and FaceTime calls. 

To learn more about the SharedWithYou framework, we recommend watching "Add Shared with You to your app.” For more information on adding collaboration APIs to apps that have custom collaboration infrastructure, check out "Integrate your custom collaboration app with Messages.”

(Note: API will be available in an upcoming beta.)ResourcesHD VideoSD VideoRelated VideosWWDC22Add Shared with You to your appIntegrate your custom collaboration app with MessagesMeet TransferableWhat's new in AppKitWhat's new in SwiftUIWWDC21What's new in CloudKit

Discover how you can help improve communication and collaboration in your app with Collaboration in Messages. Learn how to tie a document to Messages conversations for simple sharing and discussion. Explore how you can keep everyone in the conversation up to date on the latest activity in the document. And find out how you can add customizable UI in your app to manage collaboration details and connect documents to Messages conversations and FaceTime calls. 

To learn more about the SharedWithYou framework, we recommend watching "Add Shared with You to your app.” For more information on adding collaboration APIs to apps that have custom collaboration infrastructure, check out "Integrate your custom collaboration app with Messages.”

(Note: API will be available in an upcoming beta.)

HD VideoSD Video

HD Video

SD Video

Add Shared with You to your app

Integrate your custom collaboration app with Messages

Meet Transferable

What's new in AppKit

What's new in SwiftUI

What's new in CloudKit

Search this video…♪ Mellow instrumental hip-hop music ♪♪Miranda Zhou: Hi, my name is Mirandaand I'm an engineer on the Sharing team.Elana Stettin: I'm Elana and I'm an engineeron the Messages team.Miranda: In this video, Elana and I will be diving intohow to enhance collaboration with Messages in your app.I'll start with an introduction of what the feature is.You'll learn how to prepare to adopt this feature,and how to tie Messages into the processto start a collaboration.Elana will explain how to add collaborationwith Messages UI to your app,and finally she will discuss how to keep up to datewhen the collaboration is updated.First, let me introduce collaboration with Messages!In iOS 16 and macOS Ventura, we've added a new and easy wayto improve communication between people who are collaborating.Collaborators are able to tie a document to conversationsby sharing via Messages.Collaboration activity is surfaced in Messagesconversations and in ongoing FaceTime calls.A customizable Collaboration popoveris also provided to your app to manage detailsof the collaboration and connect to the Messages conversation.This builds on technologies that you are already using,such as the share sheet and drag and drop.Next, I'll go over the types of collaboration infrastructureswe support, and how to tie each of thoseto Messages collaboration.We support three types of collaboration infrastructures:CloudKit, iCloud Drive, and whatever customcollaboration infrastructure you may be using today!In this video, I'll mainly focuson the CloudKit and iCloud Drive cases.If you are using a custom infrastructure,watch the "Integrate your custom collaboration app with Messages"video for more details.If you use CloudKit-based collaboration,we've provided a new API to create an objectthat the system can recognize for collaboration.This is based off the macOS Sierra APIto start or manage a share with NSSharingService.Once you have the collaboration object,identify where in the app you are showing UIto start or manage the share.You need to update to the new APIto enhance your collaboration with Messages,as we will deprecate the existing AppKit API.The new collaboration object API uses NSItemProvider.NSItemProvider is used by system servicesto transport your app's data to other processes on the system.The provider requires either the CKSharefor the collaboration item, or a preparation handlerto create a CKShare when collaboration starts.Your app's CKContainer is also required.And finally, provide a CKAllowedSharingOptions objectrepresenting the access and permissions optionsfor the collaboration.The values of the options are the same as theNSCloudKitSharingServiceOptions which were previously requestedfrom NSCloudSharingServiceDelegatemethods.Here's a brief overview of what it looks like to createa CloudKit collaboration object.If the collaboration is being started and you pass ina preparation handler, you need to bothcreate the share and save it to the server in the handler.If it's already started, just pass in the associated share.The CKAllowedSharingOptions instance being registeredis using a static standard propertywhich returns the default set of allowed options.CloudKit adopters can use that or create a custom instanceof the class for a restricted set of allowed options.For those of you who might be interested in adopting CloudKit,CloudKit lets you use iCloud as your app's databasewithout writing your own server code.You will also get a built-in method of sharing partsof that data with other iCloud users.For more details, watch the "What's new in CloudKit" video.If you're using iCloud Drive,your object for collaboration is simply your file URL --we'll do all the work to recognize it!Once you have that, identify the entry pointsto start or manage collaboration in your appand prepare to replace them with the new and improved versions.For custom collaboration infrastructures,your collaboration object is called SWCollaborationMetadata,wrapped in new NSItemProvider API.Watch the "Integrate your custom collaboration app with Messages"video for details on how to use this APIto update your collaboration UI.Now you're ready to go.Next, initiating a collaboration.There are two different ways: through the share sheetin its new collaboration mode, and through drag and dropto Messages, either from your appor from the Files app on iOS and Finder on macOS.The new share sheet collaboration modecan be identified by an indicator in the header,which also provides a choice between collaborationand sending a copy.In order to have collaboration in the share sheet,give the share sheet the collaboration objectyou prepared earlier.On macOS, this collaboration indicatoris shown in a beautiful new share popover!The share popover also includes a title and imagein the header, plus a row of conversation suggestions,and all the transports we offered already.For more details about this,watch the WWDC22 "What's new in AppKit" video.On iOS and Mac Catalyst, show the share sheet usingthe UIActivityViewController class.On macOS, show the share popover using NSSharingServicePicker.Pass the collaboration object to UIActivityViewControlleras an activity item to present it with collaboration enabled.And similarly, initialize NSSharingServicePickerwith the collaboration object to show itwith collaboration enabled.CloudKit adopters will need to take an extra stepto provide a title and image for the headers.On iOS, use existing API such as UIActivityItemsConfigurationor UIActivityItemSource to providean LPLinkMetadata object with a title and imageProvider.Create your configuration with your collaboration object,then set the metadata provider to returnyour LPLinkMetadata object for the item being shared.Finally, initialize UIActivityViewControllerwith that configuration.On macOS, we have a new API calledNSPreviewRepresenting ActivityItemfor providing the header metadata.Refer to theNSPreviewRepresenting ActivityItem documentationfor more details.To use NSPreviewRepresenting ActivityItem,first choose your title, image, and icon.The image represents the item being shared,while the icon represents the source of the itembeing shared -- for example, an app icon.Create an NSPreviewRepresenting ActivityItemwith your collaboration object, title, image, and icon,and initialize NSSharingServicePickerwith that preview item.On an exciting note, the new SwiftUI ShareLink APIfor the share sheet will also support collaboration mode!To adopt, the item you are sharing must be representedby Transferable, a new protocol for sharing and data transfer.CloudKit adopters provide the share, container,and options through a CKShareTransferRepresentationreturned by your Transferable item.For more details, watch the "Meet Transferable"and WWDC22 "What's new in SwiftUI" videos.Here's an example of how a CloudKit adopter like Noteswould create a transferable object to share with ShareLink.The note provides a CKShareTransferRepresentation,which is constructed either as its existing valuewith an existing CKShare, CKContainer,and CKAllowedSharingOptions value,or as its prepareShare value with a CKContainer,CKAllowedSharingOptions value, and a preparation handlerto create and save a CKShare for the collaboration object.For iCloud Drive adopters, your file URLis the Transferable object which you share through ShareLink.If you have a custom collaboration infrastructure,watch the "Integrate your custom collaboration app with Messages"video for how to return an SWCollaborationMetadata objectfrom your transferable object.Once you have your Transferable object,pass it to the ShareLink initializeras the item to share.At the same time, pass in a previewwith a title and image to fill in the share sheet header.One notable featureof the share sheet collaboration mode headeris the summary of the access and permissions options.Tapping this summary brings up a view where collaboratorschoose what access and permissions optionsto use when collaborating.For CloudKit adopters, this view showsthe set of options registered in the collaboration object.iCloud Drive adoptersshow the standard set of iCloud Drive options.If you have a custom infrastructure,watch the "Integrate your custom collaboration app with Messages"video for how to specify your custom optionsand have them show up in this view.There's one more way to start a collaboration,and that's through drag and drop.A collaborator can simply drag your document into Messagesand get the new collaboration-enabled rich linkfor the document in Messages.This rich link provides functionalityboth for collaboration and sending a copy,and for selecting collaboration options.To adopt, provide your collaboration objectthrough ShareLink on iOS 16 and macOS Ventura.And that's how you prepare for and initiate collaborationswith Messages.Next, I'll hand it over to Elana,who will talk about taking your app's collaboration experienceto the next level.Elana: Thanks, Miranda!Now that you know how to get started,I'll talk about how to further integrateour collaboration UI into your app.We've added these new featuresto amplify the collaboration experience.The collaboration button is placed in your app's navigationand will show the group photoof the associated messages group.There is also an active participant countto the right of the button that will show when othersare present in the document.When you tap the collaboration button,the new collaboration popover appears.The customizable popovershows the overview of the collaboration.It also allows users to initiate communicationwith other participants with just one tap.This provides them the ability to work together in real timevia Messages and FaceTime.These UI elements are all powered by a single classin the SharedWithYou framework: SWCollaborationView.This view represents the button view in the navigation.All you need to do is initializethe SWCollaborationView and we will take careof the popover layout and presentation for you.To show custom content, you'll provide a viewwhich will be added to the popover.Now, I'll go over the code to create the SWCollaborationView.Initialize the SWCollaborationViewwith an itemProvider.The itemProvider containsthe CKShare for CloudKit-based apps,the fileURL for iCloud Drive-based apps,or the SW Collaboration metadatafor custom collaboration infrastructures.Set the activeParticipantCount propertyon the collaboration view to show the numberof active participants on the document.Then set the contentView propertyon the collaborationView to provide the popoverwith custom content.The ContentView is what makes the popovercompletely customizable.This is where you'll add your own content to give usersa unique view of what is going on in the collaboration.For example, in Pages, the ContentView containsthe Current Participants listand the Participant Cursors toggle.Now, let's look at the "manage" button.For CloudKit and iCloud Drive adopters,this manage button will bring up the manage UI,where you can add and remove participantsor change the share settings.I'll talk more about this shortly.Customize the provided button title by settingthe manageButtonTitle property on the collaboration view.If you do not set this property,the title will default to "Manage Share."If your app uses a custom collaboration infrastructure,include your own manage button in the contentView.One will not be provided for you.On Mac, make sure the button has a transparent backgroundto adhere to Apple design recommendations.Finally, create a UIBarButtonItem on iOSas shown here, using the collaborationViewas the custom view.On Mac, initialize an NSToolbarItemusing a UIBarButtonItem.Then, add the bar button item or toolbar itemto the ViewController's navigationItem.As I mentioned earlier,CloudKit and iCloud Drive adopters are providedwith a button in the collaboration popover.This enables you to manage the share in the same wayyou've always been able to.Changes in the provided manage UI are observableby adhering to the same delegate protocolsalready used to observe changes:UICloudSharing ControllerDelegateand NSCloudSharing ServiceDelegate.Now you have an understanding of how to integratethe new collaboration UI into your app.Next, I'll go over how to observe and handleupdates to collaborations.It is critical to know when a share starts or stops.For CloudKit adopters, we've added a new protocolcalled CKSystemSharing UIObserverto notify you of just that.With this protocol, you get callbacks correspondingto when your CKShare is saved or removedwithout needing the CloudKit Sharing UI.I'll take you through some code now.Initialize an observer using the CKContainer.On the observer, define a closure to be executedwhen the CKShare is saved and assign itto the systemSharingUI DidSaveShareBlock.In the closure, if the Share was saved correctly,you'll get a success result --indicating the share was started --and an associated CKShare to work with.If the save was unsuccessful,you receive a failure result and the associated error.Here is the implementation of the closurefor when the document owner stops sharing.In the success case,the CKShare has successfully been deleted.In the failure case, you will also get the associated error.Starting and stopping sharesare not the only changes you may care about.Some changes, you might even want to bubble up to users.We've added API to enable you to post noticessummarizing updates to a collaboration,right at the top of the relevant Messages thread.Collaborators are shown what the update wasand who made the change.To post a notice, retrieve the SWCollaborationHighlight,which is a collaboration-specifictype of highlight in Shared with You.Use it to create an SWCollaborationHighlight event.Learn more about SWHighlights and other SharedWithYou APIsin the "Add Shared with You to your app" video.Watch this video before beginning your workto adopt notices.I'll talk through posting different noticesusing a CloudKit app as an example.If your app uses a custom collaboration infrastructure,view the "Integrate your custom collaboration appwith Messages" video for detailed instructions.To represent a notice, we've introduced a protocolcalled SWHighlightEvent.Highlight events are initialized with SWHighlightsretrieved from the SWHighlightCenter API.The supported event types include a change eventfor content updates or comments;a mention event when a user is mentioned in a collaboration;a persistence event when content is moved, renamed, or deleted;and a membership eventwhen a participant is added or removed from a document.Here's an example showing how to post a change eventwhen a collaboration has been edited.Using the highlight center API,retrieve a collaboration highlight using the CKShare URL.Remember, this CKShare is one you defined duringthe collaboration initiation, so your app should havethis available when a content change is made.Next, create a HighlightChangeEvent instance.The initializer takes a highlight,and a trigger enum value.In this case, we set the trigger type to edit.Lastly, post the notice for that eventto the highlightCenter.The rest of the events follow a similar formatwith the sole exception being the mentionEvent,as it requires more informationto indicate which user was mentioned.You are able to post this type of eventonly if your app supports user mentions.Create the mentionEvent by passing in the retrievedhighlight and the handle of the mentioned CKShare participant.This notice will only be shown to the mentioned user.Use the persistence event type when content is moved,renamed, or deleted.Here, the renamed trigger type is used to signifythe document name has been changed.Finally, here is a membershipEvent.For a membershipEvent, use the addedCollaboratoror removedCollaborator trigger type instead.With mentionevents, notices are posted to showhow the document membership has changed.However, we've also made it possible to keep collaboratorson your shared documents in syncwhen the Messages group membership changes.For CloudKit and iCloud Drive, this is simple:we do the work for you.When someone new is added to the Messages groupwith a collaboration, the document owneris prompted via a notice to add them to the share.The same goes for when someone is removed.For apps with custom collaboration infrastructures,there's a little more work to be done.You will need to adopt theSWCollaborationActionHandler API,which you can learn more about in "Integrate your customcollaboration app with Messages."Now you know how to get started with collaboration in Messagesand integrate it into your app, whether you're using CloudKit,iCloud Drive, or your own collaboration infrastructure.Prepare your app to initiate collaborations by adoptingthe new share sheet and drag and drop APIs.Integrate the new collaboration UIto provide a customized overviewof what is happening in the shared document.Once you have that set up,go even further and adopt notices to display changesto the collaboration from within the Messages thread.Miranda and I can't wait to see how your app takes advantageof these new collaboration features in Messages!Both: Thank you for watching!♪

♪ Mellow instrumental hip-hop music ♪♪Miranda Zhou: Hi, my name is Mirandaand I'm an engineer on the Sharing team.Elana Stettin: I'm Elana and I'm an engineeron the Messages team.Miranda: In this video, Elana and I will be diving intohow to enhance collaboration with Messages in your app.I'll start with an introduction of what the feature is.You'll learn how to prepare to adopt this feature,and how to tie Messages into the processto start a collaboration.Elana will explain how to add collaborationwith Messages UI to your app,and finally she will discuss how to keep up to datewhen the collaboration is updated.First, let me introduce collaboration with Messages!In iOS 16 and macOS Ventura, we've added a new and easy wayto improve communication between people who are collaborating.Collaborators are able to tie a document to conversationsby sharing via Messages.Collaboration activity is surfaced in Messagesconversations and in ongoing FaceTime calls.A customizable Collaboration popoveris also provided to your app to manage detailsof the collaboration and connect to the Messages conversation.This builds on technologies that you are already using,such as the share sheet and drag and drop.Next, I'll go over the types of collaboration infrastructureswe support, and how to tie each of thoseto Messages collaboration.We support three types of collaboration infrastructures:CloudKit, iCloud Drive, and whatever customcollaboration infrastructure you may be using today!In this video, I'll mainly focuson the CloudKit and iCloud Drive cases.If you are using a custom infrastructure,watch the "Integrate your custom collaboration app with Messages"video for more details.If you use CloudKit-based collaboration,we've provided a new API to create an objectthat the system can recognize for collaboration.This is based off the macOS Sierra APIto start or manage a share with NSSharingService.Once you have the collaboration object,identify where in the app you are showing UIto start or manage the share.You need to update to the new APIto enhance your collaboration with Messages,as we will deprecate the existing AppKit API.The new collaboration object API uses NSItemProvider.NSItemProvider is used by system servicesto transport your app's data to other processes on the system.The provider requires either the CKSharefor the collaboration item, or a preparation handlerto create a CKShare when collaboration starts.Your app's CKContainer is also required.And finally, provide a CKAllowedSharingOptions objectrepresenting the access and permissions optionsfor the collaboration.The values of the options are the same as theNSCloudKitSharingServiceOptions which were previously requestedfrom NSCloudSharingServiceDelegatemethods.Here's a brief overview of what it looks like to createa CloudKit collaboration object.If the collaboration is being started and you pass ina preparation handler, you need to bothcreate the share and save it to the server in the handler.If it's already started, just pass in the associated share.The CKAllowedSharingOptions instance being registeredis using a static standard propertywhich returns the default set of allowed options.CloudKit adopters can use that or create a custom instanceof the class for a restricted set of allowed options.

For those of you who might be interested in adopting CloudKit,CloudKit lets you use iCloud as your app's databasewithout writing your own server code.You will also get a built-in method of sharing partsof that data with other iCloud users.For more details, watch the "What's new in CloudKit" video.If you're using iCloud Drive,your object for collaboration is simply your file URL --we'll do all the work to recognize it!Once you have that, identify the entry pointsto start or manage collaboration in your appand prepare to replace them with the new and improved versions.For custom collaboration infrastructures,your collaboration object is called SWCollaborationMetadata,wrapped in new NSItemProvider API.Watch the "Integrate your custom collaboration app with Messages"video for details on how to use this APIto update your collaboration UI.Now you're ready to go.Next, initiating a collaboration.There are two different ways: through the share sheetin its new collaboration mode, and through drag and dropto Messages, either from your appor from the Files app on iOS and Finder on macOS.The new share sheet collaboration modecan be identified by an indicator in the header,which also provides a choice between collaborationand sending a copy.In order to have collaboration in the share sheet,give the share sheet the collaboration objectyou prepared earlier.On macOS, this collaboration indicatoris shown in a beautiful new share popover!The share popover also includes a title and imagein the header, plus a row of conversation suggestions,and all the transports we offered already.For more details about this,watch the WWDC22 "What's new in AppKit" video.On iOS and Mac Catalyst, show the share sheet usingthe UIActivityViewController class.On macOS, show the share popover using NSSharingServicePicker.Pass the collaboration object to UIActivityViewControlleras an activity item to present it with collaboration enabled.And similarly, initialize NSSharingServicePickerwith the collaboration object to show itwith collaboration enabled.CloudKit adopters will need to take an extra stepto provide a title and image for the headers.On iOS, use existing API such as UIActivityItemsConfigurationor UIActivityItemSource to providean LPLinkMetadata object with a title and imageProvider.Create your configuration with your collaboration object,then set the metadata provider to returnyour LPLinkMetadata object for the item being shared.Finally, initialize UIActivityViewControllerwith that configuration.On macOS, we have a new API calledNSPreviewRepresenting ActivityItemfor providing the header metadata.Refer to theNSPreviewRepresenting ActivityItem documentationfor more details.To use NSPreviewRepresenting ActivityItem,first choose your title, image, and icon.The image represents the item being shared,while the icon represents the source of the itembeing shared -- for example, an app icon.Create an NSPreviewRepresenting ActivityItemwith your collaboration object, title, image, and icon,and initialize NSSharingServicePickerwith that preview item.On an exciting note, the new SwiftUI ShareLink APIfor the share sheet will also support collaboration mode!To adopt, the item you are sharing must be representedby Transferable, a new protocol for sharing and data transfer.CloudKit adopters provide the share, container,and options through a CKShareTransferRepresentationreturned by your Transferable item.For more details, watch the "Meet Transferable"and WWDC22 "What's new in SwiftUI" videos.Here's an example of how a CloudKit adopter like Noteswould create a transferable object to share with ShareLink.The note provides a CKShareTransferRepresentation,which is constructed either as its existing valuewith an existing CKShare, CKContainer,and CKAllowedSharingOptions value,or as its prepareShare value with a CKContainer,CKAllowedSharingOptions value, and a preparation handlerto create and save a CKShare for the collaboration object.For iCloud Drive adopters, your file URLis the Transferable object which you share through ShareLink.If you have a custom collaboration infrastructure,watch the "Integrate your custom collaboration app with Messages"video for how to return an SWCollaborationMetadata objectfrom your transferable object.Once you have your Transferable object,pass it to the ShareLink initializeras the item to share.At the same time, pass in a previewwith a title and image to fill in the share sheet header.One notable featureof the share sheet collaboration mode headeris the summary of the access and permissions options.Tapping this summary brings up a view where collaboratorschoose what access and permissions optionsto use when collaborating.For CloudKit adopters, this view showsthe set of options registered in the collaboration object.iCloud Drive adoptersshow the standard set of iCloud Drive options.If you have a custom infrastructure,watch the "Integrate your custom collaboration app with Messages"video for how to specify your custom optionsand have them show up in this view.There's one more way to start a collaboration,and that's through drag and drop.A collaborator can simply drag your document into Messagesand get the new collaboration-enabled rich linkfor the document in Messages.This rich link provides functionalityboth for collaboration and sending a copy,and for selecting collaboration options.To adopt, provide your collaboration objectthrough ShareLink on iOS 16 and macOS Ventura.And that's how you prepare for and initiate collaborationswith Messages.Next, I'll hand it over to Elana,who will talk about taking your app's collaboration experienceto the next level.Elana: Thanks, Miranda!Now that you know how to get started,I'll talk about how to further integrateour collaboration UI into your app.We've added these new featuresto amplify the collaboration experience.The collaboration button is placed in your app's navigationand will show the group photoof the associated messages group.There is also an active participant countto the right of the button that will show when othersare present in the document.When you tap the collaboration button,the new collaboration popover appears.The customizable popovershows the overview of the collaboration.It also allows users to initiate communicationwith other participants with just one tap.This provides them the ability to work together in real timevia Messages and FaceTime.

These UI elements are all powered by a single classin the SharedWithYou framework: SWCollaborationView.This view represents the button view in the navigation.All you need to do is initializethe SWCollaborationView and we will take careof the popover layout and presentation for you.To show custom content, you'll provide a viewwhich will be added to the popover.Now, I'll go over the code to create the SWCollaborationView.Initialize the SWCollaborationViewwith an itemProvider.The itemProvider containsthe CKShare for CloudKit-based apps,the fileURL for iCloud Drive-based apps,or the SW Collaboration metadatafor custom collaboration infrastructures.

Set the activeParticipantCount propertyon the collaboration view to show the numberof active participants on the document.Then set the contentView propertyon the collaborationView to provide the popoverwith custom content.The ContentView is what makes the popovercompletely customizable.This is where you'll add your own content to give usersa unique view of what is going on in the collaboration.For example, in Pages, the ContentView containsthe Current Participants listand the Participant Cursors toggle.Now, let's look at the "manage" button.For CloudKit and iCloud Drive adopters,this manage button will bring up the manage UI,where you can add and remove participantsor change the share settings.I'll talk more about this shortly.Customize the provided button title by settingthe manageButtonTitle property on the collaboration view.If you do not set this property,the title will default to "Manage Share."If your app uses a custom collaboration infrastructure,include your own manage button in the contentView.One will not be provided for you.On Mac, make sure the button has a transparent backgroundto adhere to Apple design recommendations.Finally, create a UIBarButtonItem on iOSas shown here, using the collaborationViewas the custom view.On Mac, initialize an NSToolbarItemusing a UIBarButtonItem.Then, add the bar button item or toolbar itemto the ViewController's navigationItem.As I mentioned earlier,CloudKit and iCloud Drive adopters are providedwith a button in the collaboration popover.This enables you to manage the share in the same wayyou've always been able to.Changes in the provided manage UI are observableby adhering to the same delegate protocolsalready used to observe changes:UICloudSharing ControllerDelegateand NSCloudSharing ServiceDelegate.Now you have an understanding of how to integratethe new collaboration UI into your app.Next, I'll go over how to observe and handleupdates to collaborations.It is critical to know when a share starts or stops.For CloudKit adopters, we've added a new protocolcalled CKSystemSharing UIObserverto notify you of just that.With this protocol, you get callbacks correspondingto when your CKShare is saved or removedwithout needing the CloudKit Sharing UI.I'll take you through some code now.Initialize an observer using the CKContainer.On the observer, define a closure to be executedwhen the CKShare is saved and assign itto the systemSharingUI DidSaveShareBlock.In the closure, if the Share was saved correctly,you'll get a success result --indicating the share was started --and an associated CKShare to work with.If the save was unsuccessful,you receive a failure result and the associated error.Here is the implementation of the closurefor when the document owner stops sharing.In the success case,the CKShare has successfully been deleted.In the failure case, you will also get the associated error.Starting and stopping sharesare not the only changes you may care about.Some changes, you might even want to bubble up to users.We've added API to enable you to post noticessummarizing updates to a collaboration,right at the top of the relevant Messages thread.Collaborators are shown what the update wasand who made the change.To post a notice, retrieve the SWCollaborationHighlight,which is a collaboration-specifictype of highlight in Shared with You.Use it to create an SWCollaborationHighlight event.Learn more about SWHighlights and other SharedWithYou APIsin the "Add Shared with You to your app" video.Watch this video before beginning your workto adopt notices.I'll talk through posting different noticesusing a CloudKit app as an example.If your app uses a custom collaboration infrastructure,view the "Integrate your custom collaboration appwith Messages" video for detailed instructions.To represent a notice, we've introduced a protocolcalled SWHighlightEvent.Highlight events are initialized with SWHighlightsretrieved from the SWHighlightCenter API.The supported event types include a change eventfor content updates or comments;a mention event when a user is mentioned in a collaboration;a persistence event when content is moved, renamed, or deleted;and a membership eventwhen a participant is added or removed from a document.Here's an example showing how to post a change eventwhen a collaboration has been edited.Using the highlight center API,retrieve a collaboration highlight using the CKShare URL.Remember, this CKShare is one you defined duringthe collaboration initiation, so your app should havethis available when a content change is made.Next, create a HighlightChangeEvent instance.The initializer takes a highlight,and a trigger enum value.In this case, we set the trigger type to edit.Lastly, post the notice for that eventto the highlightCenter.The rest of the events follow a similar formatwith the sole exception being the mentionEvent,as it requires more informationto indicate which user was mentioned.You are able to post this type of eventonly if your app supports user mentions.Create the mentionEvent by passing in the retrievedhighlight and the handle of the mentioned CKShare participant.This notice will only be shown to the mentioned user.Use the persistence event type when content is moved,renamed, or deleted.Here, the renamed trigger type is used to signifythe document name has been changed.Finally, here is a membershipEvent.For a membershipEvent, use the addedCollaboratoror removedCollaborator trigger type instead.With mentionevents, notices are posted to showhow the document membership has changed.However, we've also made it possible to keep collaboratorson your shared documents in syncwhen the Messages group membership changes.For CloudKit and iCloud Drive, this is simple:we do the work for you.When someone new is added to the Messages groupwith a collaboration, the document owneris prompted via a notice to add them to the share.The same goes for when someone is removed.

For apps with custom collaboration infrastructures,there's a little more work to be done.You will need to adopt theSWCollaborationActionHandler API,which you can learn more about in "Integrate your customcollaboration app with Messages."Now you know how to get started with collaboration in Messagesand integrate it into your app, whether you're using CloudKit,iCloud Drive, or your own collaboration infrastructure.Prepare your app to initiate collaborations by adoptingthe new share sheet and drag and drop APIs.Integrate the new collaboration UIto provide a customized overviewof what is happening in the shared document.Once you have that set up,go even further and adopt notices to display changesto the collaboration from within the Messages thread.Miranda and I can't wait to see how your app takes advantageof these new collaboration features in Messages!Both: Thank you for watching!♪

4:08 -Create a CloudKit collaboration item provider

7:35 -Set up Share Sheet on iOS and Mac Catalyst

7:47 -Set up Share Popover on macOS

8:22 -Provide metadata for CloudKit collaboration in Share Sheet (iOS, Mac Catalyst)

9:03 -Provide metadata for CloudKit collaboration in Share Popover (macOS)

10:21 -Create Transferable object for CloudKit collaboration with ShareLink

11:34 -Adopt ShareLink in SwiftUI

14:58 -Initialize the collaborationView

18:11 -Observe when CKShare is saved with CKSystemSharingUIObserver

18:47 -Observe when CKShare is removed with CKSystemSharingUIObserver

20:44 -Posting notice for edit SWHighlightChangeEvent

21:30 -Post an SWHighlightMentionEvent Notice

21:58 -Post an SWHighlightPersistenceEvent Notice

22:11 -Post an SWHighlightMembershipEvent Notice

## Code Samples

```swift
// CloudKit collaboration object



// Starting collaboration


let
 itemProvider 
=
 
NSItemProvider
()
itemProvider.registerCKShare(container: container, 
                             allowedSharingOptions: 
CKAllowedSharingOptions
.standard, 
                             preparationHandler: {
    
// Create your share and save to server, or throw error

    
return
 savedShare
})


// Inviting to existing collaboration


let
 itemProvider 
=
 
NSItemProvider
()
itemProvider.registerCKShare(share, 
                             container: container, 
                             allowedSharingOptions: 
CKAllowedSharingOptions
.standard)
```

```swift
// Setting up Share Sheet - iOS and Mac Catalyst



let
 activityViewController 
=
 
UIActivityViewController
(activityItems: [collaborationObject], applicationActivities: 
nil
)

presentingViewController.present(activityViewController, animated: 
true
)
```

```swift
// Setting up Share Popover - macOS



let
 sharingServicePicker 
=
 
NSSharingServicePicker
(items: [collaborationObject])

sharingServicePicker.show(relativeTo: view.bounds, of: view, preferredEdge: .minY)
```

```swift
// Providing CloudKit metadata - iOS



let
 configuration 
=
 
UIActivityItemsConfiguration
(itemProviders: [collaborationItemProvider])
configuration.perItemMetadataProvider 
=
 { (
_
, key) 
in

    
switch
 key {
    
case
 .linkPresentationMetadata:
        
// Create LPLinkMetadata with title and imageProvider

        
return
 metadata
    
default
:
        
return
 
nil

    }
}


let
 activityViewController 
=
 
UIActivityViewController
(activityItemsConfiguration: configuration)
```

```swift
// Providing CloudKit metadata - macOS



let
 title 
=
 “
Shared
 
Item
”

let
 image 
=
 
NSImage
(contentsOfFile: “
Shared_Item_Preview_Image
.png”)

let
 icon 
=
 
NSImage
(contentsOfFile: “
App_Icon
.png”) 
// Shared item source



let
 previewRepresentingItem 
=
 
NSPreviewRepresentingActivityItem
(item: collaborationItemProvider, 
                                                                title: title, 
                                                                image: image, 
                                                                icon: icon)


let
 picker 
=
 
NSSharingServicePicker
(items: [previewRepresentingItem])
```

```swift
// SwiftUI CloudKit Transferable



struct
 
Note
: 
Transferable
 {
    
// Properties of the note e.g. name, preview image, content, ID, …

    
var
 share: 
CKShare
?
    
func
 
saveCKShareToServer
() 
async
 
throws
 -> 
CKShare
 { 
…
 }

    
static
 
var
 transferRepresentation: 
some
 
TransferRepresentation
 {
        
CKShareTransferRepresentation
 { note 
in

            
if
 
let
 share 
=
 note.share {
                
return
 .existing(share, container: container, options: options)
            } 
else
 {
                
return
 .prepareShare(container: container, options: options) {
                    
return
 
try
 
await
 note.saveCKShareToServer()
                }
            }
        }
    }
}
```

```swift
// SwiftUI ShareLink adoption



struct
 
ContentView
: 
View
 {
    
@State
 
let
 item 
=
 
ShareItem
()

    
var
 body: 
some
 
View
 {
        
ShareLink
(item: item, preview: 
SharePreview
(item.title, image: item.previewImage))
    }
}
```

```swift
// Collaboration View



let
 collaborationView 
=
 
SWCollaborationView
(itemProvider: itemProvider)

collaborationView.activeParticipantCount 
=
 myModel.activePeople.count

collaborationView.contentView 
=
 
MyView
(model: myModel)

collaborationView.manageButtonTitle 
=
 
"Custom Manage Button"
```

```swift
// Observing CKShare Changes



let
 observer 
=
 
CKSystemSharingUIObserver
(container: container)

observer.systemSharingUIDidSaveShareBlock 
=
 { 
_
, result 
in

    
switch
 result {
    
case
 .success(
let
 share):
        
// Handle successfully starting share

    
case
 .failure(
let
 error):
        
// Handle error

    }
}
```

```swift
// Observing CKShare Changes


observer.systemSharingUIDidStopSharingBlock 
=
 { 
_
, result 
in

    
switch
 result {
    
case
 .success(
let
 share):
        
// Handle successfully starting share

    
case
 .failure(
let
 error):
        
// Handle error

    }
}
```

```swift
// Post an SWHighlightChangeEvent Notice



let
 highlightCenter: 
SWHighlightCenter
 
=
 
self
.highlightCenter


let
 highlight 
=
 
try
 highlightCenter.collaborationHighlight(forURL: ckShareURL, error: 
&
error)


let
 editEvent 
=
 
SWHighlightChangeEvent
(highlight: highlight, trigger: .edit)

highlightCenter.postNotice(for: editEvent)
```

```swift
// Post an SWHighlightMentionEvent Notice



let
 highlightCenter: 
SWHighlightCenter
 
=
 
self
.highlightCenter


let
 highlight 
=
 
try
 highlightCenter.collaborationHighlight(forURL: ckShareURL, error: 
&
error)


let
 mentionEvent 
=
 
SWHighlightMentionEvent
(highlight: highlight, 
           mentionedPersonCloudKitShareHandle: ckShareParticipantHandle)

highlightCenter.postNotice(for: mentionEvent)
```

```swift
// Post an SWHighlightPersistenceEvent Notice



let
 highlightCenter: 
SWHighlightCenter
 
=
 
self
.highlightCenter


let
 highlight 
=
 
try
 highlightCenter.collaborationHighlight(forURL: ckShareURL, error: 
&
error)


let
 renamedEvent 
=
 
SWHighlightPersistenceEvent
(highlight: highlight, trigger: .renamed)

highlightCenter.postNotice(for: renamedEvent)
```

```swift
// Post an SWHighlightMembershipEvent Notice



let
 highlightCenter: 
SWHighlightCenter
 
=
 
self
.highlightCenter


let
 highlight 
=
 
try
 highlightCenter.collaborationHighlight(forURL: ckShareURL, error: 
&
error)


let
 membershipEvent 
=
 
SWHighlightMembershipEvent
(highlight: highlight, 
                                           trigger: .addedCollaborator)

highlightCenter.postNotice(for: membershipEvent)
```

