WEBVTT

00:00:11.010 --> 00:00:11.540
Good morning.

00:00:11.540 --> 00:00:15.080
Welcome to Advanced Troubleshooting
for System Administrators.

00:00:15.080 --> 00:00:17.550
My name is Nicole Jacque,
and I work with the

00:00:17.550 --> 00:00:19.960
AppleCare Enterprise Support Engineering
Group.

00:00:19.960 --> 00:00:22.980
And if you haven't noticed,
the title and the

00:00:23.040 --> 00:00:27.030
description for this session,
they're pretty broad.

00:00:27.060 --> 00:00:31.520
As much as I'd like to,
there's really not a way to cover

00:00:31.520 --> 00:00:37.710
troubleshooting the entire OS X and
OS X Server systems in one session.

00:00:38.040 --> 00:00:41.690
There's not a magic silver bullet
that I can tell you that you can

00:00:41.690 --> 00:00:45.370
go back and fix every problem
that you're ever going to have.

00:00:45.380 --> 00:00:48.660
There's not a magical key combination
or hidden checkbox that says,

00:00:48.760 --> 00:00:49.810
make things work.

00:00:49.810 --> 00:00:51.100
Sorry.

00:00:51.100 --> 00:00:52.230
Okay.

00:00:52.230 --> 00:00:54.930
Feature request.

00:00:57.900 --> 00:01:02.040
So what we're going to do today
is we're going to focus on some

00:01:02.040 --> 00:01:05.090
areas of troubleshooting that

00:01:05.170 --> 00:01:09.970
My group sees very commonly
from our enterprise customers,

00:01:10.080 --> 00:01:15.620
and we're going to talk about the
tools that you can use to troubleshoot

00:01:15.650 --> 00:01:21.080
these parts of the operating system
and these issues so that you can

00:01:21.300 --> 00:01:28.580
either fix these problems yourself,
or you can talk more effectively

00:01:28.580 --> 00:01:28.580
to us so we can fix them.

00:01:28.770 --> 00:01:33.340
And even though I said that
there's no magic command,

00:01:33.340 --> 00:01:35.810
no silver bullet,
there's one thing that we're

00:01:35.810 --> 00:01:38.400
going to be talking about
throughout the entire session,

00:01:38.400 --> 00:01:42.240
you're going to see it keep coming up,
and that is DNS.

00:01:43.840 --> 00:01:50.500
You need to have DNS running, working,
and you need to have forward and

00:01:50.500 --> 00:01:55.820
reverse records for all your servers,
and the relevant service records for

00:01:55.820 --> 00:02:00.690
any Active Directory domain controllers
that you might have in your environment.

00:02:01.830 --> 00:02:05.200
So the areas that we
are going to talk about,

00:02:05.430 --> 00:02:10.150
we're going to talk a little bit
just about logging in general,

00:02:10.150 --> 00:02:12.520
just to make sure we're
all on the same page.

00:02:12.580 --> 00:02:16.410
Then we're going to move on to
Directory Services Troubleshooting.

00:02:16.650 --> 00:02:20.300
So the areas that we
are going to talk about,

00:02:20.300 --> 00:02:25.050
we're going to talk a little bit
just about logging in general,

00:02:25.050 --> 00:02:27.440
just to make sure we're
all on the same page.

00:02:27.440 --> 00:02:31.320
Then we're going to move on to
Directory Services Troubleshooting.

00:02:46.630 --> 00:02:49.600
So this is going to be an opportunity
for you to get your questions in,

00:02:49.600 --> 00:02:51.400
it just will not be in this room.

00:02:51.400 --> 00:02:58.350
So we're going to start just by
talking very briefly about logging.

00:03:00.350 --> 00:03:03.300
So you're all, since you're advanced
system administrators,

00:03:03.420 --> 00:03:06.460
you all probably know where the logs are.

00:03:06.460 --> 00:03:11.270
Var log is where most of your
standard Unix type utilities

00:03:11.270 --> 00:03:14.050
and processes put their logs.

00:03:14.150 --> 00:03:18.750
That's where your system log is,
that's where your console stuff goes,

00:03:18.750 --> 00:03:21.760
that's where the secure log is.

00:03:22.730 --> 00:03:28.740
Library logs is where a lot of
OS X specific processes put their logs.

00:03:28.870 --> 00:03:31.650
And then if you have some
user specific logging,

00:03:31.890 --> 00:03:35.600
that will usually go in the
user's library logs directory

00:03:35.600 --> 00:03:37.280
in their home directory.

00:03:38.270 --> 00:03:42.360
Now,
every process can handle its own logging.

00:03:42.380 --> 00:03:45.810
It can put a log file in any
one of these directories,

00:03:45.920 --> 00:03:49.400
and it can log at any level
of verbosity that it wants to.

00:03:49.410 --> 00:03:53.810
They may have totally separate
ways for configuring logging

00:03:53.860 --> 00:03:56.760
to be turned on and off,
or at different levels of logging.

00:03:58.530 --> 00:04:02.930
But one thing that a lot of processes
have in common is that they use the

00:04:02.930 --> 00:04:05.550
syslog system to do their logging.

00:04:05.610 --> 00:04:08.040
And you can actually configure this.

00:04:08.120 --> 00:04:13.900
So the configuration file
is in the /etc/ directory,

00:04:13.940 --> 00:04:15.950
syslog.conf,
and it looks something like this.

00:04:16.850 --> 00:04:18.940
But let's break that down a little bit.

00:04:19.050 --> 00:04:23.930
You'll see a lot of these pairs
of something dot something.

00:04:24.510 --> 00:04:27.240
And so the first part of
that is called the facility,

00:04:27.440 --> 00:04:31.900
and that's just a fancy name for the
part of the OS that's doing the logging.

00:04:31.900 --> 00:04:38.860
The second part of that is the level
of logging that you want to do.

00:04:41.060 --> 00:04:42.860
You have a lot of different
levels of logging,

00:04:42.860 --> 00:04:50.790
all the way from none up through debug,
and in this progression,

00:04:50.870 --> 00:04:55.970
the lower you go down on this chart,
the more logging that you get.

00:04:57.550 --> 00:05:03.220
You can string these pairs along,
put them together with semicolons,

00:05:04.300 --> 00:05:07.920
And then, at the end of the line,
you specify where you would

00:05:07.920 --> 00:05:09.540
like the logging to go.

00:05:09.540 --> 00:05:16.020
So, in this default syslog configuration,
you'll see what goes into the system log.

00:05:16.120 --> 00:05:19.620
You can feel free to change that,
make more information

00:05:19.650 --> 00:05:22.300
go into the system log,
or possibly less.

00:05:22.300 --> 00:05:28.870
Or,
you can make your own totally new log,

00:05:29.050 --> 00:05:30.020
and log whatever you want to it.

00:05:31.540 --> 00:05:34.730
You can also use asterisks for wildcards.

00:05:34.860 --> 00:05:39.830
So in this case,
kern.asterisk is going to log every

00:05:39.830 --> 00:05:43.210
single level for the Kernel facility.

00:05:44.590 --> 00:05:47.570
Even more useful,
you can use the asterisk as

00:05:47.570 --> 00:05:49.780
a wildcard for the facility.

00:05:49.910 --> 00:05:54.560
So asterisk.debug is going
to log messages at the debug

00:05:54.770 --> 00:05:57.380
level for every facility.

00:05:57.380 --> 00:06:02.460
This can be really useful if
you have a problem in the OS,

00:06:02.460 --> 00:06:05.530
and you're really not
sure where the problem is.

00:06:05.530 --> 00:06:08.630
You just want to get as much information
out of the system as you can.

00:06:09.630 --> 00:06:15.320
So you can set asterisk.debug logging,
and hopefully whatever process it is

00:06:15.380 --> 00:06:19.560
that's having the problem logs to syslog,
and you'll get some information

00:06:19.560 --> 00:06:21.420
about it in your system log.

00:06:22.720 --> 00:06:27.010
So this is basically just to
get us all on the same page at

00:06:27.010 --> 00:06:29.350
various points in the presentation.

00:06:29.400 --> 00:06:30.520
I'm going to refer back to this.

00:06:30.520 --> 00:06:33.490
I'm going to tell you you're
going to want to configure syslog.

00:06:33.590 --> 00:06:36.160
This is what I'm talking about.

00:06:36.570 --> 00:06:41.130
And now it's time to move
on to Directory Services.

00:06:41.170 --> 00:06:44.720
So like I said,
we're going to talk very widely

00:06:44.720 --> 00:06:48.390
about Directory Services,
client, server.

00:06:48.550 --> 00:06:51.400
And one thing,
just to give me sort of an idea,

00:06:51.400 --> 00:06:57.390
how many people in the
audience use Open Directory?

00:06:57.530 --> 00:06:58.900
Okay, quite a few.

00:06:59.150 --> 00:07:02.500
How many people use Active Directory?

00:07:04.290 --> 00:07:06.230
How many people use something else?

00:07:06.240 --> 00:07:09.910
OK.

00:07:09.970 --> 00:07:13.040
Just out of even more curiosity,
how many people use more than

00:07:13.040 --> 00:07:15.270
one directory system at a time?

00:07:16.400 --> 00:07:20.160
Okay, good to know.

00:07:20.200 --> 00:07:24.600
So the very first thing that I get
asked when people start trying

00:07:24.600 --> 00:07:27.590
to troubleshoot something with
directory services is they'll say,

00:07:27.590 --> 00:07:31.240
"You know, I was somewhere,
I was in Work Group Manager or something,

00:07:31.430 --> 00:07:35.190
and I got this error message,
and it was something

00:07:35.190 --> 00:07:38.350
like negative 14.002.

00:07:38.440 --> 00:07:40.780
So what is that?"

00:07:41.730 --> 00:07:44.360
Well, you can actually look up
all those error codes.

00:07:44.390 --> 00:07:47.040
They're in the MAN page
for Directory Service.

00:07:47.100 --> 00:07:49.840
That has a very brief
description of them.

00:07:49.930 --> 00:07:53.510
There's a little bit more
information in the open directory

00:07:53.510 --> 00:07:55.730
reference on the developer site.

00:07:57.930 --> 00:08:01.280
So you can actually,
any time you get these errors,

00:08:01.280 --> 00:08:02.390
look that up.

00:08:02.490 --> 00:08:04.550
It might give you some more information.

00:08:04.550 --> 00:08:07.880
And we'll be talking a little bit
more about some of these errors

00:08:07.880 --> 00:08:10.060
throughout the presentation.

00:08:11.730 --> 00:08:15.050
So the other basic information
about directory services

00:08:15.060 --> 00:08:19.100
that you need to know is,
well, where do all the files live?

00:08:19.190 --> 00:08:23.160
So library preferences directory
service is where the majority

00:08:23.160 --> 00:08:25.780
of the configuration files
for directory service go.

00:08:25.780 --> 00:08:30.240
This is where if you
configure directory access,

00:08:30.390 --> 00:08:33.570
all those settings are stored here.

00:08:35.220 --> 00:08:40.090
If you are using open directory,
you're using a password server,

00:08:40.090 --> 00:08:43.870
and so there's some additional
config files that are kept

00:08:43.870 --> 00:08:45.600
in var db auth server.

00:08:45.700 --> 00:08:49.090
If you're using Kerberos,
which could mean you're using open

00:08:49.090 --> 00:08:52.790
directory or active directory,
or something else,

00:08:52.790 --> 00:08:55.510
just some other Kerberos server.

00:08:55.730 --> 00:09:00.420
Then you have an edu.mit.kerberos file,
which is your basic

00:09:00.980 --> 00:09:02.940
configuration for Kerberos.

00:09:03.170 --> 00:09:08.510
And if you're a server,
you may also have a keytab file in Etsy,

00:09:08.660 --> 00:09:10.470
krb5.keytab.

00:09:10.470 --> 00:09:14.450
That's where your
service principals live.

00:09:14.780 --> 00:09:17.380
So these are files that you
can go and look at if you're

00:09:17.550 --> 00:09:19.480
curious as to how they're stored.

00:09:19.670 --> 00:09:24.100
A few of the files have a few options
in them that aren't exposed to the GUI,

00:09:24.270 --> 00:09:27.230
so you can look at and
change things there.

00:09:27.550 --> 00:09:33.190
Another reason people want
to know where these are,

00:09:33.190 --> 00:09:33.190
though, is just that at some point,

00:09:33.780 --> 00:09:37.000
They need to start fresh
with directory services.

00:09:37.060 --> 00:09:40.160
And so if you remove these files,

00:09:40.350 --> 00:09:44.250
This is what you need to get
back to a clean slate as far as

00:09:44.260 --> 00:09:47.170
directory services is concerned.

00:09:47.310 --> 00:09:50.410
Once you remove the files,
you either need to reboot the system,

00:09:50.410 --> 00:09:52.640
or you can just restart
directory services,

00:09:52.840 --> 00:09:56.680
and to do that,
sudo killall directory service.

00:09:57.370 --> 00:10:00.120
Launch D actually takes
care of restarting it,

00:10:00.180 --> 00:10:04.530
so basically you just need
to kill directory services.

00:10:10.210 --> 00:10:13.080
The next thing people want
to do is get some information

00:10:13.090 --> 00:10:14.330
out of Directory Service.

00:10:14.450 --> 00:10:18.090
By default, it doesn't really log a
whole lot of information.

00:10:18.090 --> 00:10:25.070
But you can actually turn on debug
logging with the USR1 flag sent using

00:10:25.080 --> 00:10:27.600
the killall command to Directory Service.

00:10:27.600 --> 00:10:30.600
This is essentially an on/off switch.

00:10:30.780 --> 00:10:32.880
Doing it once turns it on.

00:10:32.880 --> 00:10:34.980
Doing it again turns it off.

00:10:34.980 --> 00:10:37.980
If you restart, it will be back off.

00:10:38.100 --> 00:10:42.460
If you want the debug logging to
start automatically at startup,

00:10:42.460 --> 00:10:46.000
you need to create a file
in the Library Preferences

00:10:46.000 --> 00:10:51.100
Directory Service folder
called .dslogapi at start.

00:10:51.100 --> 00:10:54.830
You can use touch to do it,
or whatever method you like.

00:10:55.100 --> 00:11:00.100
And the log file is going to go
to Library Logs Directory Service,

00:11:00.100 --> 00:11:04.430
and it's going to be called
directoryservice.debug.log.

00:11:06.040 --> 00:11:10.320
So, great, you turn on debugging,
and you're going to get

00:11:10.320 --> 00:11:13.480
something that looks like this.

00:11:13.820 --> 00:11:19.660
Which is really exciting,
and everybody looks at it and says,

00:11:19.660 --> 00:11:23.550
oh yeah, that totally solves my problem.

00:11:23.580 --> 00:11:27.300
So we're going to actually break
this down a little bit more for you.

00:11:28.410 --> 00:11:32.950
Basically, what Directory Services spends
most of its time doing is it gets

00:11:32.950 --> 00:11:35.040
questions and it answers them.

00:11:35.170 --> 00:11:40.990
So those are the two main things
you're going to find in the debug log.

00:11:41.180 --> 00:11:45.100
So for a query, you'll see a timestamp.

00:11:45.370 --> 00:11:50.760
You'll see the client or the process
that called Directory Service,

00:11:50.770 --> 00:11:54.060
and you'll see that client's process ID.

00:11:54.410 --> 00:11:58.540
You'll see the actual call
that's made to directory service,

00:11:58.620 --> 00:12:00.860
the plugin that's being called.

00:12:00.970 --> 00:12:03.660
In this case, it's LDAPv3,
but it could be the

00:12:03.700 --> 00:12:08.630
Active Directory plugin,
the NetInfo plugin, whatever plugin.

00:12:09.100 --> 00:12:11.740
And then you'll see the query itself.

00:12:11.740 --> 00:12:18.640
In this case, it's querying for
John Smith with an exact match,

00:12:18.640 --> 00:12:21.400
and it has to be a user record.

00:12:22.830 --> 00:12:28.070
So, directory service gets the query,
and it answers.

00:12:28.530 --> 00:12:31.980
You'll get most of the
same information here,

00:12:32.040 --> 00:12:34.420
except that instead of seeing the query,
you'll see whether or

00:12:34.420 --> 00:12:35.660
not it found any results.

00:12:35.690 --> 00:12:38.280
So you'll either get
number of found records,

00:12:38.280 --> 00:12:41.290
zero,
or you'll get number of found records,

00:12:41.290 --> 00:12:43.600
however many records it found.

00:12:44.320 --> 00:12:49.050
Now, the different plugins for
Directory Service can choose to log

00:12:49.320 --> 00:12:52.510
even more information than that.

00:12:52.870 --> 00:12:57.940
One really good example is
the Active Directory plugin,

00:12:57.940 --> 00:13:01.030
which actually does an
awful lot of logging,

00:13:01.030 --> 00:13:03.980
especially during the process
of binding to Active Directory.

00:13:03.980 --> 00:13:06.480
And it's actually pretty human readable.

00:13:06.480 --> 00:13:08.870
So in this case,
you can see that it's trying

00:13:08.870 --> 00:13:12.230
to talk to some servers,
and the servers aren't responding,

00:13:12.230 --> 00:13:14.870
they're missing some of
their service records,

00:13:14.870 --> 00:13:17.230
and so it's picking different servers.

00:13:18.500 --> 00:13:22.190
And here it's telling you that
the network isn't reachable.

00:13:22.190 --> 00:13:25.030
So it will tell you a lot of information.

00:13:25.040 --> 00:13:28.480
If you are having a problem with
the Active Directory plugin,

00:13:28.540 --> 00:13:32.680
particularly with binding,
this is the first place to go.

00:13:32.680 --> 00:13:35.630
If you escalate a case,
either through the bug reporter,

00:13:35.650 --> 00:13:38.220
through the developer channel,
or to AppleCare,

00:13:38.220 --> 00:13:42.000
this is probably going to be the first
thing we're going to ask you for.

00:13:45.320 --> 00:13:49.410
So now that we've looked at that,
you've configured your

00:13:49.410 --> 00:13:54.460
directory services,
and you want to know, are they working?

00:13:54.560 --> 00:13:58.440
So a really easy way to see
if they're working is just to

00:13:58.490 --> 00:14:00.960
try and resolve a username.

00:14:01.310 --> 00:14:06.240
So you can use the ID command for this,
and you can see in this case,

00:14:06.240 --> 00:14:07.750
DogCow exists.

00:14:08.480 --> 00:14:13.100
Unfortunately,
it looks like CyberDog does not.

00:14:13.100 --> 00:14:16.590
I think we have one CyberDog fan here.

00:14:17.150 --> 00:14:19.540
Any other CyberDog fans?

00:14:19.580 --> 00:14:22.280
All right, give a hand for CyberDog.

00:14:22.710 --> 00:14:28.020
So another way that you might
find that you have no connectivity

00:14:28.020 --> 00:14:30.440
to your directory service,
you're not able to look up users,

00:14:30.440 --> 00:14:34.290
is you might go into
something like Worker Manager,

00:14:34.290 --> 00:14:38.280
and instead of showing you a nice list
of your users and groups and such,

00:14:38.280 --> 00:14:41.970
it gives you a nasty looking error,
which usually has an error

00:14:41.970 --> 00:14:45.990
number something in the
low negative 14,000 range,

00:14:45.990 --> 00:14:49.700
like a 14002, 14008, and so on.

00:14:51.430 --> 00:14:55.020
So the first thing that you might
need to troubleshoot is why am

00:14:55.020 --> 00:14:59.740
I not talking to the server?

00:15:02.020 --> 00:15:04.500
You need to know what server
you're talking to first.

00:15:04.590 --> 00:15:06.950
So if you're using Open Directory,

00:15:07.170 --> 00:15:11.330
You may have an Open Directory Master and
maybe a bunch of replicas.

00:15:11.330 --> 00:15:16.600
So you can find out what servers
Directory Service knows about by looking

00:15:16.600 --> 00:15:20.550
at the DSLDAPv3pluginconfig.plist file.

00:15:20.550 --> 00:15:22.100
I know that's a mouthful.

00:15:22.100 --> 00:15:26.100
That's in your Library Preferences
Directory Service folder.

00:15:26.530 --> 00:15:31.090
And you'll see a list of
all the replicas in there.

00:15:31.780 --> 00:15:38.800
Similarly, for Active Directory,
you'll see a list for every domain.

00:15:38.830 --> 00:15:41.610
You will have at least
three different lists.

00:15:41.730 --> 00:15:46.460
One list of LDAP servers,
one list of Kerberos servers,

00:15:46.460 --> 00:15:47.970
and one list of Kpassword servers.

00:15:47.990 --> 00:15:50.260
They may all be the same
servers in those lists,

00:15:50.260 --> 00:15:52.900
but you'll have essentially
three different lists.

00:15:53.960 --> 00:15:58.900
You may also have Global Catalog
server lists in this file,

00:15:58.920 --> 00:16:01.060
and this is the
Active Directory.plist file,

00:16:01.060 --> 00:16:03.960
again in Library Preferences
Directory Service.

00:16:05.960 --> 00:16:09.900
So once you've figured out what
servers you're talking about,

00:16:10.900 --> 00:16:13.790
The very first thing that
I would like all of you to

00:16:13.790 --> 00:16:16.230
do before you go any further,
is

00:16:18.640 --> 00:16:38.180
Check your DNS.

00:16:38.180 --> 00:16:38.180
You do not know how many cases we get.

00:16:38.180 --> 00:16:38.180
I would say probably 90-some
percent of the cases that we see,

00:16:38.180 --> 00:16:38.180
especially with the
Active Directory plugin,

00:16:38.180 --> 00:16:38.180
there's a DNS problem.

00:16:38.180 --> 00:16:38.180
So before you go any farther,
check your DNS.

00:16:39.950 --> 00:16:43.150
The next thing that you might want
to do is make sure that you can even

00:16:43.270 --> 00:16:47.580
get a connection between where your
client is and where the server is.

00:16:47.670 --> 00:16:52.240
So for that,
you can just do a telnet on port 389,

00:16:52.310 --> 00:16:56.480
because that's the standard LDAP port,
and see if you can get connected.

00:16:56.540 --> 00:16:58.900
So if you get something like this--

00:16:59.750 --> 00:17:02.200
The port is open, you can reach it.

00:17:02.200 --> 00:17:05.540
If you're not able to get that,
that means something

00:17:05.540 --> 00:17:10.440
like the server's down,
the firewall is between

00:17:10.440 --> 00:17:12.620
you and your server,

00:17:13.220 --> 00:17:15.650
The network is down
between you and the server?

00:17:15.770 --> 00:17:20.530
You have some sort of connectivity
issue to look at before you can

00:17:20.690 --> 00:17:25.050
get directory services working
with that particular server.

00:17:26.460 --> 00:17:30.280
But assuming that you are
able to successfully get

00:17:30.280 --> 00:17:32.350
a telnet connection here,

00:17:32.900 --> 00:17:35.130
You could try doing an LDAP query.

00:17:35.170 --> 00:17:36.400
You can use LDAP search.

00:17:36.400 --> 00:17:38.860
We're going to talk more
about LDAP search later.

00:17:38.900 --> 00:17:40.900
But you can just do a basic query.

00:17:40.900 --> 00:17:45.220
What's important here though is
that when you do LDAP search,

00:17:45.330 --> 00:17:48.560
to make it a good test,
use the same information that

00:17:48.560 --> 00:17:50.640
you used in directory access.

00:17:50.650 --> 00:17:53.120
So use the same host name.

00:17:53.120 --> 00:17:55.160
If you're using host
names in directory access,

00:17:55.160 --> 00:17:59.280
don't put the IP number here because
maybe you didn't fix your DNS.

00:17:59.280 --> 00:18:04.300
And use the same search base that you
find configured in directory access

00:18:04.480 --> 00:18:09.690
because a lot of times that can simply be
the case of the search base is messed up.

00:18:12.620 --> 00:18:15.760
So once you've got
directory service working,

00:18:15.760 --> 00:18:19.470
it's happy, it's resolving users,
the next thing you can do is look in a

00:18:19.470 --> 00:18:21.450
little bit more detail at those users.

00:18:21.670 --> 00:18:23.660
So you're all familiar
with WorkRoute Manager,

00:18:23.660 --> 00:18:25.220
I would hope.

00:18:25.270 --> 00:18:30.090
But from the command line,
there's a utility called DSCL.

00:18:30.380 --> 00:18:35.390
Now, one thing we're not going
to talk about is LookupD.

00:18:35.450 --> 00:18:38.700
If you were all in the
open directory session,

00:18:38.700 --> 00:18:42.930
you might have heard NetInfo
and LookupD are going away.

00:18:43.000 --> 00:18:45.010
Don't be too sad.

00:18:45.280 --> 00:18:50.900
So if you have not been using
DSCL and you've been using LookupD,

00:18:50.920 --> 00:18:54.060
now would be a really good
time to start using DSCL.

00:18:54.490 --> 00:18:57.400
Check out,
it's got a really good man page.

00:18:57.440 --> 00:19:01.950
And there's also information in the
command line administration manual.

00:19:03.400 --> 00:19:06.690
But if you're more of a GUI person,
there's the Inspector Mode in

00:19:06.700 --> 00:19:07.640
WorkRoute Manager.

00:19:07.640 --> 00:19:10.460
You can turn that on through preferences.

00:19:15.600 --> 00:19:23.660
What happens if you have,
this is a problem that we've

00:19:23.660 --> 00:19:23.660
been seeing quite a bit recently.

00:19:24.050 --> 00:19:27.740
You're looking,
you're using Active Directory,

00:19:27.860 --> 00:19:29.980
you're looking at
Active Directory users and groups,

00:19:30.160 --> 00:19:33.490
and you know you just configured
a home directory for them,

00:19:33.500 --> 00:19:35.380
and you've put them in
some specific groups.

00:19:35.380 --> 00:19:40.670
And the classic symptom of this
is that you go to the client,

00:19:40.710 --> 00:19:45.060
they try and log in,
they don't get their home directory,

00:19:45.060 --> 00:19:48.290
maybe they aren't showing up
as members of certain groups,

00:19:48.290 --> 00:19:51.620
not getting their managed
client based on certain groups.

00:19:53.330 --> 00:19:55.770
And yet you look in
Active Directory Users and Computers,

00:19:55.770 --> 00:19:57.080
it's there.

00:19:57.230 --> 00:20:01.060
And you look in DSCL or
Inspector Mode and Worker Manager,

00:20:01.060 --> 00:20:02.920
and you're not seeing it.

00:20:04.130 --> 00:20:08.270
Well, the important thing to
remember is that LDAP,

00:20:08.610 --> 00:20:12.410
just like any other server,
has credentials that you

00:20:12.640 --> 00:20:16.210
need to use to access it,
and it gives you different rights

00:20:16.210 --> 00:20:18.340
based on the credentials that you use.

00:20:18.340 --> 00:20:21.660
So the question is,
what credentials is Directory Service?

00:20:24.070 --> 00:20:27.220
So that's going to depend
based on what plug-in you're

00:20:27.220 --> 00:20:28.310
using and how you're using it.

00:20:28.310 --> 00:20:35.640
If you're using the LDAP plug-in,
by default, anonymous access.

00:20:36.260 --> 00:20:41.200
Now, if you're using a third party,
something other than open directory,

00:20:41.450 --> 00:20:48.530
you very likely may have had to
specify a particular user account in

00:20:48.530 --> 00:20:54.040
the security tab because your admin
didn't want to allow anonymous access.

00:20:54.040 --> 00:20:56.770
So, you may have that.

00:20:57.700 --> 00:21:02.310
If you're using the authenticated
binding feature of Open Directory,

00:21:02.310 --> 00:21:05.370
then that actually creates a
computer account in Open Directory,

00:21:05.570 --> 00:21:08.500
and it authenticates as that account.

00:21:08.600 --> 00:21:11.770
And if you're using the
Active Directory plugin,

00:21:12.920 --> 00:21:19.490
That again is going to create a computer
account in Active Directory and use that.

00:21:21.130 --> 00:21:27.850
So this is a direction that OS X is
moving more and more towards,

00:21:27.850 --> 00:21:31.890
you know, away from anonymous binding
into more secure methods.

00:21:31.970 --> 00:21:36.560
So this is something that you're
going to start seeing more coming in,

00:21:36.750 --> 00:21:37.820
for example, Leopard.

00:21:38.030 --> 00:21:42.340
But right now,
this is primarily something that you

00:21:42.340 --> 00:21:46.020
Active Directory users are going to see.

00:21:47.400 --> 00:21:48.400
How do you tell?

00:21:48.400 --> 00:21:49.900
Is this really a permissions issue?

00:21:49.900 --> 00:21:53.720
And if it is, what am I actually seeing?

00:21:53.720 --> 00:21:56.480
And how,
if I'm not the person who has admin

00:21:56.480 --> 00:22:00.350
access to my Active Directory,
how do I explain this to my

00:22:00.350 --> 00:22:04.160
Active Directory admin so
that they can fix it for me?

00:22:04.160 --> 00:22:11.060
So we can use our old friend LDAP search,
and we can authenticate using a username,

00:22:11.060 --> 00:22:14.200
such as, for example,
an admin username or just

00:22:14.260 --> 00:22:16.610
your regular account username.

00:22:16.730 --> 00:22:19.580
And normally you would
specify this in the regular

00:22:19.580 --> 00:22:21.970
distinguished name LDAP syntax.

00:22:22.070 --> 00:22:25.820
Well, that can be kind of tedious,
especially in Active Directory where

00:22:25.820 --> 00:22:28.810
maybe they've gone kind of
crazy with the nested OUs and

00:22:28.810 --> 00:22:31.260
you're down about five levels.

00:22:31.270 --> 00:22:34.220
So you can actually use a
little bit shorter syntax and

00:22:34.470 --> 00:22:38.270
just say username @domain.

00:22:41.320 --> 00:22:44.470
So once you do that,
you'll get a listing of what

00:22:44.530 --> 00:22:46.960
you can see as the admin user.

00:22:46.960 --> 00:22:50.290
So that's great,
but now what you need to do is,

00:22:50.340 --> 00:22:53.200
what are you seeing as
the computer account?

00:22:53.310 --> 00:22:56.200
Well, if you're going to connect
as the computer account,

00:22:56.240 --> 00:22:58.200
you need to know the username,
which is pretty easy,

00:22:58.200 --> 00:23:00.200
that's the computer name.

00:23:00.200 --> 00:23:04.200
But how do you get the
computer account's password?

00:23:04.200 --> 00:23:06.280
So it turns out,

00:23:07.150 --> 00:23:14.800
that in the Active Directory PList file,
you'll find a key called

00:23:14.800 --> 00:23:14.800
AD Computer Password.

00:23:15.130 --> 00:23:16.720
And you'll see this data section.

00:23:16.790 --> 00:23:20.540
It looks kind of weird.

00:23:20.540 --> 00:23:23.630
Maybe it's the password,
but you try using that, and no,

00:23:23.630 --> 00:23:25.450
it's not the password.

00:23:26.850 --> 00:23:30.800
Well, it turns out that that's
actually base 64 encoded.

00:23:30.800 --> 00:23:34.800
So you can get that by
using the OpenSSL utility,

00:23:34.800 --> 00:23:40.540
decode it, and you'll get the actual
password that you could then plug

00:23:40.540 --> 00:23:42.840
in to an LDAP search command.

00:23:43.370 --> 00:23:45.870
One thing to remember here,

00:23:46.300 --> 00:23:51.270
is just remember you have to specify
the computer account name here.

00:23:51.270 --> 00:23:53.870
And unfortunately,
Active Directory will only

00:23:53.870 --> 00:23:56.590
allow distinguished name
syntax for computer accounts.

00:23:56.700 --> 00:24:02.320
So you will actually have to use
the CN equals and so on syntax here.

00:24:02.450 --> 00:24:07.700
By the way, this is also a good way
of troubleshooting cases

00:24:07.820 --> 00:24:12.370
where you have a machine,
it's been working with Active Directory,

00:24:12.370 --> 00:24:12.370
suddenly it's not.

00:24:13.510 --> 00:24:19.720
And one thing that might have happened
is it's possible that somehow the

00:24:19.720 --> 00:24:23.740
password in Active Directory has been
changed for the computer account.

00:24:23.900 --> 00:24:27.240
Either by some other computer
that says it's that computer,

00:24:27.250 --> 00:24:30.920
or for example as we're going to
talk about on the server side,

00:24:30.920 --> 00:24:31.510
by Samba.

00:24:31.700 --> 00:24:34.190
So you can use this technique to
just test and make sure that you

00:24:34.200 --> 00:24:39.720
have a valid computer name and
password for your computer account.

00:24:40.940 --> 00:24:45.780
So once you've got connectivity
to your directory server,

00:24:45.780 --> 00:24:50.140
you've got lookups of users and
groups and everything working,

00:24:50.140 --> 00:24:52.870
the next thing that everybody
wants to be able to do is

00:24:52.870 --> 00:24:54.390
actually authenticate users.

00:24:54.400 --> 00:24:59.860
So Apple provides a utility called DIRT,
which just stands for Directory Tool,

00:24:59.860 --> 00:25:05.980
and you can use this to test standard
authentication and NTLM authentication.

00:25:07.040 --> 00:25:13.690
So you need to supply -m
and then the plugin/node.

00:25:13.810 --> 00:25:20.420
So keep in mind if there is a space
in the name of the plugin or the node,

00:25:20.420 --> 00:25:25.370
such as Active Directory or All Domains,
remember to use the quotes.

00:25:25.660 --> 00:25:28.500
Then you need to supply the
username and the password,

00:25:28.550 --> 00:25:31.430
and in the case of if you want
to test NTLM authentication,

00:25:31.800 --> 00:25:34.510
it's -ANT.

00:25:34.690 --> 00:25:39.100
I also want to point out that
there is a man page for DIRT.

00:25:39.250 --> 00:25:42.600
It does say in it though that you
can actually omit the password

00:25:42.600 --> 00:25:44.260
and it will prompt you for it.

00:25:44.310 --> 00:25:46.260
That actually is not the case.

00:25:46.390 --> 00:25:49.300
A bug is filed.

00:25:50.820 --> 00:25:53.860
So if you want to test
Kerberos authentication,

00:25:53.860 --> 00:25:58.100
on the other hand,
we have the standard Kerberos utilities.

00:25:58.170 --> 00:26:01.900
KINIT lets you test getting a
ticket or just get a ticket.

00:26:01.900 --> 00:26:06.200
KLIST lists any tickets
that you might already have.

00:26:06.200 --> 00:26:10.990
KPASSWORD lets you change your
password over the Kerberos protocol.

00:26:11.260 --> 00:26:15.290
These are great,
but some of you are more GUI inclined,

00:26:15.290 --> 00:26:18.790
or maybe your users
are more GUI inclined.

00:26:19.070 --> 00:26:21.570
So there's actually a nice
little GUI utility that's often

00:26:21.570 --> 00:26:25.600
overlooked because it is in
System Library Core Services.

00:26:25.670 --> 00:26:27.430
It's called Kerberos.app.

00:26:27.430 --> 00:26:29.500
And for some reason,
people don't go there to look

00:26:29.500 --> 00:26:30.990
for applications very often.

00:26:31.020 --> 00:26:35.990
So this may be a good option for you.

00:26:39.260 --> 00:26:42.700
If authentication isn't working,
there's some config files that

00:26:42.700 --> 00:26:45.350
you may want to take a look at.

00:26:45.350 --> 00:26:49.030
And so if you're using
Open Directory and password server,

00:26:49.060 --> 00:26:51.980
you're going to look
in var db authserver,

00:26:51.980 --> 00:26:54.460
and you're going to have
authserver replicas,

00:26:54.540 --> 00:26:55.990
.local and .remote.

00:26:56.050 --> 00:26:59.990
And if we take a look
at one of these files,

00:27:01.050 --> 00:27:03.000
It's pretty interesting, doesn't it?

00:27:03.000 --> 00:27:05.440
A lot of As.

00:27:05.440 --> 00:27:09.410
So, turns out that that's not
just a bunch of gibberish.

00:27:09.520 --> 00:27:13.030
That is actually Base64 encoded again.

00:27:13.310 --> 00:27:19.290
So if you look at the very
first part of that data section,

00:27:19.570 --> 00:27:25.760
that is actually the IP number
of your password server,

00:27:25.760 --> 00:27:25.760
or at least it ought to be.

00:27:25.940 --> 00:27:30.430
So you can actually decode this,
again with the OpenSSL command,

00:27:30.440 --> 00:27:33.640
and check and see whether or
not that's actually the case.

00:27:33.730 --> 00:27:37.240
If it's not the case,
you can delete this file,

00:27:37.370 --> 00:27:40.330
it'll get regenerated,
but you may find that it

00:27:40.390 --> 00:27:42.640
still has the wrong IP number.

00:27:42.800 --> 00:27:48.100
And that is because you probably have an
out-of-date config record on your server,

00:27:48.100 --> 00:27:51.270
and we'll talk about how and
where to change that when we

00:27:51.380 --> 00:27:53.570
talk about Open Directory Server.

00:27:54.520 --> 00:27:57.530
For Kerberos,
you have the edu.mit.kerberos

00:27:57.690 --> 00:28:00.260
file in library preferences.

00:28:00.260 --> 00:28:04.500
What's important here,
you should have a default realm.

00:28:04.520 --> 00:28:07.620
It's really important,
especially if you're mixing open

00:28:07.620 --> 00:28:09.460
directory and active directory.

00:28:09.460 --> 00:28:13.240
The default realm is going to need
to be the active directory realm.

00:28:13.700 --> 00:28:17.600
Otherwise, if you have multiple realms,
make sure that that realm is

00:28:17.600 --> 00:28:23.170
actually the domain or the realm
that you want to be using primarily.

00:28:24.030 --> 00:28:27.850
Then,
you should also have a Realm section for

00:28:27.930 --> 00:28:30.070
every Kerberos Realm that you're using.

00:28:30.380 --> 00:28:34.100
If you're using Active Directory,
you may have lots of these,

00:28:34.140 --> 00:28:36.900
because you'll have one for
every domain in your forest.

00:28:36.900 --> 00:28:41.110
If you're using Open Directory,
you'll generally just have the one.

00:28:44.570 --> 00:28:49.500
So, if you've done all this,
it's still not working,

00:28:49.500 --> 00:28:51.870
you're looking to take it
to the next step to try and

00:28:51.900 --> 00:28:56.510
figure out what's going on,
you can always go to a TCP dump and

00:28:56.510 --> 00:28:57.650
see what's happening on the wire.

00:28:57.660 --> 00:29:00.670
So, there's lots of stuff
going on on the wire,

00:29:00.670 --> 00:29:04.760
so really all you need to look at
are what's going on for Kerberos,

00:29:04.790 --> 00:29:09.300
which is port 88, LDAP,
which is port 389,

00:29:09.300 --> 00:29:12.140
or if you're doing it over SSL,
it'll be port 636.

00:29:13.960 --> 00:29:18.700
If you're using DNS, which is port 53,
and if you're using Active Directory,

00:29:18.700 --> 00:29:23.850
the Active Directory global catalog,
which is port 3268.

00:29:24.340 --> 00:29:27.050
There's a little bit of
information on how to use

00:29:27.160 --> 00:29:29.240
TCP dump on our developer site.

00:29:29.430 --> 00:29:35.200
It's developer article QA 1176,
Getting a Packet Trace.

00:29:35.200 --> 00:29:38.720
So check that out.

00:29:39.900 --> 00:29:43.220
We're now going to move away
from talking about some just

00:29:43.220 --> 00:29:47.070
general directory service stuff,
and we're going to talk

00:29:47.070 --> 00:29:48.800
about login troubleshooting.

00:29:48.800 --> 00:29:51.740
Because there's a bunch of stuff
in login troubleshooting that's not

00:29:51.820 --> 00:29:53.800
strictly speaking directory services.

00:29:53.800 --> 00:29:56.790
It is stuff like getting
the home directory mounted,

00:29:57.150 --> 00:30:00.800
managed client,
portable home directory syncing.

00:30:00.800 --> 00:30:05.970
And so we're going to talk
about that in this section.

00:30:06.690 --> 00:30:11.360
So the first thing we're going
to talk about is just getting

00:30:11.360 --> 00:30:13.150
that home directory mounted.

00:30:13.150 --> 00:30:15.940
And how many people in here have had
a problem getting home directories

00:30:15.940 --> 00:30:19.270
mounted before with their clients?

00:30:19.630 --> 00:30:22.030
Yeah, pretty popular problem.

00:30:22.120 --> 00:30:25.360
So, just take a guess.

00:30:25.370 --> 00:30:28.870
What do you think the first thing
that I'm going to have you do?

00:30:32.130 --> 00:30:32.980
You're all brilliant.

00:30:33.040 --> 00:30:39.530
So yeah, check your DNS,
because your home directories are

00:30:39.530 --> 00:30:42.820
going to be trying to mount your home,
or your client is going to

00:30:42.820 --> 00:30:46.140
be trying to mount your home
directories based on the DNS record,

00:30:46.140 --> 00:30:51.840
and that's going to require both a
forward record and a reverse record.

00:30:55.810 --> 00:31:05.200
So that's the first thing you want to do.

00:31:05.210 --> 00:31:05.210
But since you're all advanced
system administrators,

00:31:05.210 --> 00:31:05.210
I know that's what you'll go and do.

00:31:05.210 --> 00:31:05.210
And so the next thing you're going
to want to look at is just...

00:31:05.560 --> 00:31:07.930
Can you actually manually,
like doing connect to

00:31:07.930 --> 00:31:10.080
server on the client,
actually connect to that

00:31:10.080 --> 00:31:11.570
user's home directory?

00:31:11.640 --> 00:31:15.160
It's a really simple thing,
but that will catch a lot

00:31:15.160 --> 00:31:19.220
of stupid mistakes that
I know never actually happen,

00:31:19.220 --> 00:31:26.630
but things like the service is
not running on the file server,

00:31:26.910 --> 00:31:28.660
or permissions being
changed on the file server,

00:31:28.660 --> 00:31:28.660
things like that.

00:31:29.550 --> 00:31:31.720
Next,
what you want to do is actually check

00:31:31.720 --> 00:31:34.830
the user record and the mount records,
if there are any.

00:31:35.080 --> 00:31:38.580
So in this case,
we're talking more about open directory.

00:31:38.710 --> 00:31:42.720
And you want to check that home
directory and NFS home directory

00:31:42.990 --> 00:31:48.900
have the right domain name,
and that they match the mount record.

00:31:49.520 --> 00:31:54.050
So what that should look like is you
should have a home directory attribute,

00:31:54.050 --> 00:31:58.090
which should be sort of
an XML sort of string.

00:31:58.140 --> 00:32:05.180
And that should have, in the URL,
the DNS name of your server.

00:32:06.180 --> 00:32:10.320
should have the same DNS name
in your NFS home directory.

00:32:10.550 --> 00:32:14.100
If you have multiple
DNS names for a server,

00:32:14.100 --> 00:32:17.410
don't go using one in one
place and one in the other.

00:32:17.600 --> 00:32:19.100
Make sure they're both the same.

00:32:19.170 --> 00:32:23.640
It's also important that you don't have,
for example, the DNS name in one of these

00:32:23.640 --> 00:32:26.400
and the IP number in the other,
because it won't be

00:32:26.440 --> 00:32:27.850
able to match them up.

00:32:28.270 --> 00:32:32.670
So then these need to match
the actual mount record.

00:32:32.720 --> 00:32:35.920
So again,
you'll have the DNS name in a couple

00:32:35.920 --> 00:32:38.880
of places in the mount record.

00:32:39.200 --> 00:32:42.980
So if you check all of that,
everything looks good.

00:32:42.980 --> 00:32:45.720
The next thing you need
to do is troubleshoot

00:32:45.860 --> 00:32:50.930
everybody's favorite process:
Auto Mount.

00:32:51.840 --> 00:32:56.730
So one thing you can do is
actually run AutoMount manually.

00:32:56.820 --> 00:33:04.930
So you can supply -m AutoMount servers,
-mnt private var AutoMount network

00:33:04.930 --> 00:33:09.210
servers to give it the correct paths
to match up with where the home

00:33:09.210 --> 00:33:10.640
directories are going to get mounted.

00:33:11.010 --> 00:33:15.820
And then you use the -d flag to
actually get debug information.

00:33:16.590 --> 00:33:19.690
Another thing you can do is
if you go back to the syslog

00:33:19.690 --> 00:33:24.760
things we were doing before,
if you set asterisk.debug,

00:33:24.820 --> 00:33:27.000
automount logs to syslog.

00:33:27.090 --> 00:33:31.180
So you'll actually get a whole lot
of debug information in the system

00:33:31.180 --> 00:33:33.530
log or if you choose some other log.

00:33:34.130 --> 00:33:38.170
Another thing you can do is you can
actually look at what options are being

00:33:38.250 --> 00:33:41.940
passed to Automount when it starts up.

00:33:41.990 --> 00:33:46.550
And it may be the case that changing
those options may be helpful.

00:33:46.870 --> 00:33:52.220
There's a KBase article 303841,
Resolving Login Issues with

00:33:52.220 --> 00:33:53.850
the Active Directory Plugin.

00:33:54.070 --> 00:34:00.080
Despite the name, this actually can apply
to Open Directory as well.

00:34:00.510 --> 00:34:05.340
So what this will help you do is
change a couple of options in there

00:34:05.730 --> 00:34:08.910
that may be causing your issue.

00:34:11.600 --> 00:35:09.000
[Transcript missing]

00:35:09.520 --> 00:35:14.440
But if you look in these network folders,
you'll find the hierarchy.

00:35:14.440 --> 00:35:18.890
You'll have network, servers,
server name, SharePoint.

00:35:19.070 --> 00:35:23.000
And then, in the case where
something has gone wrong,

00:35:23.130 --> 00:35:27.390
you'll find maybe a few
user home directories.

00:35:27.540 --> 00:35:32.110
And they're not on the server.

00:35:32.110 --> 00:35:32.110
They're on the local client.

00:35:32.800 --> 00:35:35.210
That's probably not a good thing.

00:35:35.250 --> 00:35:40.220
And you probably, if that's the case,
want to save the user's files

00:35:40.220 --> 00:35:41.800
rather than just delete them.

00:35:41.800 --> 00:35:43.360
Just an idea.

00:35:43.360 --> 00:35:47.920
But then you want to move or
delete these files out of there,

00:35:47.980 --> 00:35:51.940
because if you get files in
the place where the links

00:35:51.940 --> 00:35:55.860
are supposed to be created,
from that point on,

00:35:55.940 --> 00:35:58.470
Automount is never going to
be able to create the link.

00:35:58.520 --> 00:36:01.440
So your home directories will
never work after that point.

00:36:02.400 --> 00:36:07.550
So look for what we call bogus
directories in any of these locations.

00:36:10.530 --> 00:36:16.980
And if you were in the network
file systems discussion,

00:36:16.980 --> 00:36:20.500
AutoFS is going to take over
all of the duties of the

00:36:20.510 --> 00:36:23.090
automount process for Leopard.

00:36:23.220 --> 00:36:26.410
This will actually give us a bunch
of new functionality and so on.

00:36:26.590 --> 00:36:30.850
So look for some exciting
things in Leopard.

00:36:33.560 --> 00:36:37.680
So, you get past all of that,
think your home directories

00:36:37.680 --> 00:36:39.960
are working good,
and...

00:36:40.600 --> 00:36:44.340
The users, you know,
they're getting past the login window,

00:36:44.340 --> 00:36:47.100
but they get the lovely,
soothing blue screen,

00:36:47.100 --> 00:36:49.300
and that's as far as they go.

00:36:50.020 --> 00:36:53.800
Or you start loading the desktop
and it never quite finishes.

00:36:53.800 --> 00:36:58.670
So what you want to do is SSH in,
because you don't have control

00:36:58.800 --> 00:37:02.170
of the machine from the GUI,
and try top.

00:37:02.230 --> 00:37:05.240
See what processes are
using a lot of CPU.

00:37:05.320 --> 00:37:09.000
See if they have the hung flag.

00:37:09.170 --> 00:37:13.290
See if you see processes running
that shouldn't be running.

00:37:14.060 --> 00:37:17.940
Another thing that can cause this kind
of a symptom is just bad preferences

00:37:17.940 --> 00:37:19.500
in the user's home directory.

00:37:19.630 --> 00:37:23.520
So move aside their
library preferences folder,

00:37:23.550 --> 00:37:25.230
have them try and log in again.

00:37:25.300 --> 00:37:29.520
If that solves your problem,
it's probably bad preferences,

00:37:29.540 --> 00:37:35.440
and you can actually use the PLUtil
with the lint option to check for

00:37:35.550 --> 00:37:41.680
corrupt plist type preferences.

00:37:43.450 --> 00:37:47.150
If you think your problem is actually
something with managed client,

00:37:47.160 --> 00:37:49.960
for example,
your mobile accounts don't seem

00:37:49.960 --> 00:37:53.120
to be getting created right,
or you're not getting the correct

00:37:53.190 --> 00:37:57.680
managed client preferences enforced,
you can actually use some utilities

00:37:57.680 --> 00:38:00.140
that we give you to help debug this.

00:38:00.910 --> 00:38:03.640
So MCX Cacher is one,
and that's kind of hidden away

00:38:03.640 --> 00:38:09.340
in System Library Core Services,
MCXD.app, Contents, Resources,

00:38:09.340 --> 00:38:10.630
MCX Cacher.

00:38:11.590 --> 00:38:15.250
And in all the little commands here,
I did not put that full

00:38:15.340 --> 00:38:18.380
path on all of them,
but because that's not going

00:38:18.380 --> 00:38:21.380
to be in your normal path,
you will want to include,

00:38:21.380 --> 00:38:23.050
you'll have to include all
of that for it to work.

00:38:23.900 --> 00:38:27.680
I just didn't want to do it because
it kind of took up the entire slide.

00:38:28.350 --> 00:38:33.220
So if you want to test
creating a mobile account,

00:38:33.220 --> 00:38:39.040
you can do mcxcacher-U username,
and then you can supply to the -h

00:38:39.040 --> 00:38:43.300
option if you'd like a location where
you want the home directory to be.

00:38:43.340 --> 00:38:47.280
So if you're going to have a home
directory in a non-standard location,

00:38:47.280 --> 00:38:49.670
this would be how you could specify it.

00:38:50.520 --> 00:38:55.970
Also with MCX Cacher,
you can use the -f option,

00:38:55.970 --> 00:38:58.560
which essentially just will
make your client unmanaged.

00:38:59.270 --> 00:39:03.440
And you can also force a refresh
of the cache at the next login

00:39:03.780 --> 00:39:10.200
from the client side by using the
"-d" option to dirty the cache.

00:39:10.840 --> 00:39:17.200
Another way of doing this is also to
delete any MCX cache objects that you

00:39:17.200 --> 00:39:20.000
might find in the LocalNetInfo database.

00:39:20.150 --> 00:39:25.230
You can also look at these cache objects
just to see what MCX settings they have

00:39:25.230 --> 00:39:28.410
in them and see if they look correct,
or maybe they're just

00:39:28.470 --> 00:39:29.840
totally out of date.

00:39:31.070 --> 00:39:37.150
So, if this doesn't do it for you though,
you can actually get a bunch of

00:39:37.150 --> 00:39:42.500
information from the MCXD process
by setting the debug output

00:39:42.500 --> 00:39:44.440
option using the defaults command.

00:39:44.440 --> 00:39:51.440
So you want to say defaults write
library preferences com.apple.mcxdebug,

00:39:51.440 --> 00:39:56.230
debug output, and then choose a level
of logging from 0,

00:39:56.230 --> 00:40:00.100
which is none, to 3,
which is the most verbose.

00:40:01.000 --> 00:40:05.490
All of this information is
going to go to your system log.

00:40:07.020 --> 00:40:11.770
The next thing, and this is something
that was new in Tiger,

00:40:11.880 --> 00:40:14.240
is if you're doing
portable home directories.

00:40:14.350 --> 00:40:16.470
So this is where you have
the local home directory,

00:40:16.680 --> 00:40:19.100
the network home directory,
and you're syncing

00:40:19.110 --> 00:40:20.780
between the two of them.

00:40:21.040 --> 00:40:26.490
So sometimes the sync
database can just be corrupt.

00:40:26.570 --> 00:40:30.630
So in the case where either
things are not syncing or things

00:40:30.630 --> 00:40:35.140
seem to be syncing incorrectly,
you may just want to reset that database.

00:40:35.140 --> 00:40:39.940
So if you are syncing the library
folder of the user's home directory,

00:40:40.090 --> 00:40:41.670
you can actually do this really easily.

00:40:41.770 --> 00:40:45.380
Just hold down
Option Shift when you log in.

00:40:46.060 --> 00:40:48.990
If you're not doing that,
then you're going to want to move

00:40:48.990 --> 00:40:53.640
aside the library mirrors folder
in the user's home directory.

00:40:53.750 --> 00:40:57.370
One thing to be aware of though,
is that this also holds the

00:40:57.370 --> 00:40:59.720
sync databases for .mac.

00:40:59.720 --> 00:41:03.020
So you will be resetting
that as well here.

00:41:04.350 --> 00:41:09.110
And then, like MCXD, you can actually get
debugging out of Mirror Agent,

00:41:09.280 --> 00:41:12.680
which is the process that handles
the syncing of the network home

00:41:12.680 --> 00:41:14.300
directory and the local home directory.

00:41:14.300 --> 00:41:19.300
And so again, that's a defaults command
to com.apple.mirroragent.

00:41:19.300 --> 00:41:23.680
This has a slightly different
range of logging options,

00:41:23.740 --> 00:41:24.790
0 to 4.

00:41:24.800 --> 00:41:27.680
4, though, is really, really verbose.

00:41:27.720 --> 00:41:33.220
I would say 3 is probably where
you're going to want to start.

00:41:34.190 --> 00:41:38.220
Logs for this will actually go
into the user's home directory

00:41:38.300 --> 00:41:42.290
in library logs mirroragent.log.

00:41:45.210 --> 00:41:49.330
So now that we've talked about
the client side of things,

00:41:49.410 --> 00:41:53.990
we're going to switch gears and talk
about the server side of things.

00:41:55.340 --> 00:41:59.430
So, Open Directory,
really just three servers all

00:41:59.430 --> 00:42:02.200
tied and integrated together.

00:42:02.380 --> 00:42:05.680
First, you've got an LDAP server,
and that's basically SLAPD,

00:42:05.680 --> 00:42:08.380
which is your standard
Open LDAP LDAP server.

00:42:08.380 --> 00:42:13.730
Then you've got the password server,
which is basically Apple's mechanism

00:42:13.730 --> 00:42:19.080
for dealing with all different types
of passwords except for Kerberos.

00:42:20.020 --> 00:42:25.400
And then to deal with Kerberos,
we have your standard MIT KDC.

00:42:28.030 --> 00:42:34.690
The problems that you have with
Open Directory Server pretty

00:42:34.790 --> 00:42:38.680
much all come down to one thing.

00:42:38.860 --> 00:42:41.400
And what do you think it might be?

00:42:46.490 --> 00:42:49.240
You guys are catching on real fast.

00:42:49.240 --> 00:42:56.440
So, the very first thing is
you want to check your DNS.

00:42:56.510 --> 00:43:01.630
And the thing to be aware of is
that even if DNS is working now,

00:43:01.970 --> 00:43:05.000
Was DNS working when
you set up your server?

00:43:05.000 --> 00:43:07.890
Or at some other point when you
made some other major change?

00:43:07.900 --> 00:43:12.440
And so DNS is so important
that we've actually made some

00:43:12.440 --> 00:43:15.900
changes in 10.4.6 for this.

00:43:15.900 --> 00:43:18.480
But the important thing here
is after you've checked to

00:43:18.550 --> 00:43:22.900
make sure your DNS forward and
reverse records are correct,

00:43:22.900 --> 00:43:26.820
check the output of
hostname on the server.

00:43:26.900 --> 00:43:27.900
Make sure it's correct.

00:43:27.900 --> 00:43:32.320
Make sure it's your DNS hostname,
and not, for example,

00:43:32.320 --> 00:43:38.890
your Bonjour hostname, or localhost,
or some out-of-date DNS name.

00:43:39.230 --> 00:43:41.730
If it's not correct,
you're going to want to

00:43:41.780 --> 00:43:47.410
fix that with scutil,
and it's the set hostname command.

00:43:49.160 --> 00:43:54.100
And like I said, as of 10.4.6,
we've made some changes.

00:43:54.120 --> 00:44:00.590
And so we've made the server a little bit
smarter about resolving its host name.

00:44:00.800 --> 00:44:04.650
We also have made some changes
so that if it appears that there

00:44:04.650 --> 00:44:09.010
is a problem with your host name,
we will start putting log messages

00:44:09.010 --> 00:44:12.540
in your system logs saying,
"You got a mismatch.

00:44:12.540 --> 00:44:14.560
Can you please fix it?"

00:44:17.570 --> 00:44:21.490
It is the FQDN,
the Fully Qualified Domain Name.

00:44:21.500 --> 00:44:26.490
So there's a KBase article that
details all of these changes.

00:44:26.580 --> 00:44:32.710
It's KBase Article 303.697,
Mac OS X Server 10.4.6,

00:44:32.710 --> 00:44:36.500
Changes in Server Host Name Discovery.

00:44:39.290 --> 00:44:43.640
So, now let's look at each part
of the server individually.

00:44:43.640 --> 00:44:50.540
For SLAPD, you've got your standard
OpenLDAP config file in /etc/openldap.

00:44:50.540 --> 00:44:54.710
You've got your logs
in /var/log/slapd.log.

00:44:54.710 --> 00:44:59.160
And you've got the actual
database and transaction logs in

00:44:59.160 --> 00:45:02.170
/var/db/openldap/openldapdata.

00:45:02.710 --> 00:45:06.550
One thing that you should be aware
of is in addition to just the

00:45:06.550 --> 00:45:11.290
database for OpenLDAP in here,
you also have all the transaction

00:45:11.290 --> 00:45:14.600
logs that are used by the
Berkeley database back end,

00:45:14.860 --> 00:45:19.870
which is what we use
for our SLAPD database.

00:45:20.080 --> 00:45:24.980
These transaction logs,
they're all 10 megs each.

00:45:25.010 --> 00:45:30.600
And if you're making a lot of changes,
you may get quite an accumulation

00:45:30.850 --> 00:45:32.500
of these transaction logs.

00:45:32.650 --> 00:45:35.200
And you may not actually
need all of them.

00:45:35.280 --> 00:45:40.510
So if you're looking for,
where has all my space gone?

00:45:40.790 --> 00:45:45.600
You can actually use the
dbarchive command to get a list

00:45:45.750 --> 00:45:48.100
of which ones are not needed.

00:45:48.100 --> 00:45:51.700
And you can actually,
if you supply the -d option to it,

00:45:51.740 --> 00:45:57.970
it will take care of deleting and
removing those transaction logs for you.

00:46:00.360 --> 00:46:06.820
So digging deeper with slapd,
we have the slapconfig command.

00:46:07.020 --> 00:46:11.940
This is actually what's used to
set up your open directory server.

00:46:11.940 --> 00:46:19.620
The enable slapd log option will
turn on logging to the slapd log.

00:46:19.990 --> 00:46:24.850
The BackupDB option is actually
the command line equivalent of the

00:46:24.950 --> 00:46:29.500
archive of the Open Directory server
that you see in Server Admin.

00:46:29.590 --> 00:46:32.500
So if you're looking for a way to script,

00:46:32.650 --> 00:46:38.100
A backup of the open directory databases,
this is what you want to look at.

00:46:39.500 --> 00:46:42.840
Then you also have some
standard LDAP utilities.

00:46:42.850 --> 00:46:46.550
SlapCat basically will just
export everything in the

00:46:46.560 --> 00:46:48.620
LDAP server out to an LDF.

00:46:48.930 --> 00:46:51.330
SlapAdd just lets you add some records.

00:46:51.410 --> 00:46:53.870
And LDAP Search we've
already talked about,

00:46:53.980 --> 00:46:58.790
that's just a way for you to
directly query the LDAP server.

00:47:00.720 --> 00:47:05.130
So if you need even more troubleshooting,
because slapd is maybe

00:47:05.520 --> 00:47:08.550
hanging or dying on you,
and you want to see what

00:47:08.550 --> 00:47:13.840
it is that's causing that,
you can actually run slapd in debug mode.

00:47:14.080 --> 00:47:19.140
So what you want to do is stop slapd
and restart it with the -d flag.

00:47:19.200 --> 00:47:25.730
Problem is, if you try and just do that,
launchd is going to be very vigilant

00:47:25.800 --> 00:47:28.900
and just restart it for you before
you can turn it on with debugging.

00:47:28.900 --> 00:47:34.890
So before you try to turn
it on with the -d flag,

00:47:35.010 --> 00:47:40.000
you're actually going to want to unload
it using launch control from launchd,

00:47:40.100 --> 00:47:42.900
so that launchd isn't sitting
there trying to restart it on you.

00:47:42.900 --> 00:47:44.600
started on you.

00:47:44.940 --> 00:47:49.110
When you're all done troubleshooting,
you can have LaunchD load it

00:47:49.110 --> 00:47:55.800
back into its Watched list just
by changing the Unload to Load.

00:47:56.500 --> 00:48:00.130
So again, you can use the -d option.

00:48:00.200 --> 00:48:03.400
There's a lot of different
levels of debugging.

00:48:03.410 --> 00:48:05.880
Unfortunately,
they're rather complicated,

00:48:05.910 --> 00:48:09.500
and I couldn't fit them all in the slide.

00:48:09.500 --> 00:48:12.160
So check the slapdman page.

00:48:12.250 --> 00:48:17.000
It gives you a very nice,
detailed explanation of what they are.

00:48:18.580 --> 00:48:20.760
Moving on to Password Server.

00:48:20.890 --> 00:48:26.490
The database is stored in
var/db/authserver/authserver/main.

00:48:26.920 --> 00:48:31.430
There's a config file in
librarypreferences.com.apple.passwords

00:48:31.530 --> 00:48:34.130
erverplist,
and then there's also the var db

00:48:34.130 --> 00:48:38.670
authserverreplicas file that we were
talking about that are the same as

00:48:38.720 --> 00:48:41.130
what you would see on the client.

00:48:41.980 --> 00:48:44.740
The biggest issue that we
see with password server,

00:48:44.740 --> 00:48:48.660
because there's really not a whole
lot that you can change or configure

00:48:48.660 --> 00:48:52.110
specifically just with password server,
you don't really interact very

00:48:52.160 --> 00:48:54.080
directly with password server.

00:48:54.080 --> 00:49:00.220
The number one issue we see is, surprise,
surprise, a DNS issue.

00:49:00.220 --> 00:49:06.850
And what happens is, at some point,
DNS has not been working quite right.

00:49:07.540 --> 00:49:12.520
And so in your
com.apple.passwordserver.plist,

00:49:12.520 --> 00:49:17.690
you have, in the SASSL realm,
the wrong host name.

00:49:17.700 --> 00:49:20.930
Maybe you have localhost.

00:49:21.160 --> 00:49:26.770
And usually where this happens is if
you have a master and multiple replicas,

00:49:26.770 --> 00:49:32.610
and you'll get some of the replicas have
the wrong-- this should actually be the

00:49:32.610 --> 00:49:35.300
DNS name of your open directory master.

00:49:35.390 --> 00:49:38.860
So all the replicas should have
the same master listed there.

00:49:38.920 --> 00:49:41.740
And some of them,
instead of having the DNS name,

00:49:41.740 --> 00:49:44.660
have something like localhost.

00:49:44.760 --> 00:49:47.780
So this is something that
you would want to fix.

00:49:49.430 --> 00:49:51.630
There's a few other utilities
that you can use that

00:49:51.680 --> 00:49:53.300
interact with password server.

00:49:53.310 --> 00:49:57.960
MKPathDB, very powerful,
lets you look at all the

00:49:57.960 --> 00:50:02.530
slots in password server,
see all the password server users.

00:50:02.630 --> 00:50:06.450
Can help you figure out, for example,
if you have users that

00:50:06.450 --> 00:50:10.040
aren't authenticating,
and especially if you've

00:50:10.040 --> 00:50:13.020
maybe just done a big import,
did they actually get a

00:50:13.020 --> 00:50:14.260
password set for them at all?

00:50:14.260 --> 00:50:17.010
Are they in password server at all?

00:50:37.000 --> 00:50:37.000
So you can look and see if there's
a list of them in mCapacityB.

00:50:37.000 --> 00:50:37.000
You can also do things like
set passwords from there.

00:50:37.000 --> 00:50:37.000
This is the tool that you would use if
you somehow lost your DER admin password.

00:50:37.870 --> 00:50:42.880
But in general, MKPastDB, Nest,
which lets you set some configuration

00:50:42.960 --> 00:50:46.040
options for password server,
and PWPolicy,

00:50:46.360 --> 00:50:50.020
which lets you set password server
policy options from the command line,

00:50:50.020 --> 00:50:53.830
are things that generally
you don't need to use.

00:50:53.840 --> 00:50:57.820
And if you're going to
try something with them,

00:50:57.820 --> 00:51:01.810
you can either maybe
magically fix your server,

00:51:01.890 --> 00:51:04.950
or completely break your server.

00:51:05.550 --> 00:51:08.870
So before you do anything,
especially with something

00:51:08.870 --> 00:51:12.260
like MKPastDB or Nest,
I highly recommend you back

00:51:12.260 --> 00:51:14.030
up your open directory.

00:51:17.900 --> 00:51:22.870
And then finally, the Kerberos Server has
its own separate database,

00:51:23.020 --> 00:51:26.700
var db krb5 kdc.

00:51:26.700 --> 00:51:29.900
Even though it's the same
users and the same password,

00:51:29.920 --> 00:51:31.660
it's two separate databases.

00:51:31.660 --> 00:51:35.300
So one thing to be aware of is
you can actually have passwords

00:51:35.300 --> 00:51:37.300
that somehow get out of sync.

00:51:37.300 --> 00:51:40.400
So you can have the case where
Kerberos authentication works

00:51:40.400 --> 00:51:46.400
or doesn't work versus regular
authentication works or doesn't work.

00:51:46.400 --> 00:51:50.000
If that's the case,
you need to go back and reset

00:51:50.000 --> 00:51:54.320
the password in whichever
one has the wrong password.

00:51:54.440 --> 00:51:57.620
You have some standard
Kerberos utilities,

00:51:57.620 --> 00:52:00.220
KAdmin, KAdmin.local, KT List.

00:52:00.530 --> 00:52:04.650
These are what you could use to,
for example, reset the Kerberos password.

00:52:04.660 --> 00:52:08.680
But in general, you don't really need
to use these very much.

00:52:08.870 --> 00:52:15.550
SSO Util you can use to set up
Kerberos single sign-on for services.

00:52:17.400 --> 00:52:22.340
And last but not least,
there are some configuration records

00:52:22.340 --> 00:52:27.190
in Open Directory that are used by
clients to set up their config records,

00:52:27.280 --> 00:52:31.540
particularly for things
like password server,

00:52:32.410 --> 00:52:36.280
It stores the IP number
of the password server.

00:52:36.330 --> 00:52:38.860
Now,
if this case where you have the wrong

00:52:38.860 --> 00:52:44.000
IP number showing up on the clients
in their password server config file,

00:52:44.120 --> 00:52:47.780
this is where you want to
come to check to fix it.

00:52:47.950 --> 00:52:51.900
If you move servers around,
change IP numbers and so on,

00:52:51.910 --> 00:52:55.260
you probably are going to want
to double check here to make sure

00:52:55.260 --> 00:52:57.410
that this has gotten updated.

00:52:59.820 --> 00:53:04.840
Same thing,
the edu.mit.kirberos file is also

00:53:04.840 --> 00:53:08.790
generated for Open Directory clients
from a config record,

00:53:08.840 --> 00:53:12.620
and that stores things like the

00:53:12.770 --> 00:53:15.800
Host names of all of
your Kerberos servers,

00:53:15.870 --> 00:53:18.660
so basically all of your
masters and replicas.

00:53:18.660 --> 00:53:20.590
So you're going to want to,
if you've been making

00:53:20.590 --> 00:53:23.280
a lot of changes there,
check and make sure you've

00:53:23.310 --> 00:53:25.050
got the right names here.

00:53:26.650 --> 00:53:32.520
So, now that we've talked lots and
lots about directory services,

00:53:32.590 --> 00:53:34.600
it's time to talk about something else.

00:53:34.600 --> 00:53:39.600
And this is probably the next most
common area that we get questions about,

00:53:39.600 --> 00:53:42.590
which is file services.

00:53:43.730 --> 00:53:46.770
So we're primarily going to
talk about AFP and SMB here.

00:53:47.380 --> 00:53:49.610
And for AFP,

00:53:50.770 --> 00:53:54.920
On the server side, there's just,
there's not a whole lot of logging.

00:53:55.090 --> 00:53:58.200
On the client side though,
you can get quite a bit of detail.

00:53:58.370 --> 00:54:07.120
And you can use the defaults command to
set a debug level and the syslog logging

00:54:07.220 --> 00:54:12.090
with the com.apple.appleshareclientcore,
which is basically just your Apple file

00:54:12.680 --> 00:54:16.330
service client on your OS X clients.

00:54:18.300 --> 00:54:23.400
Keep in mind, the debug level can be
set from zero to eight.

00:54:23.780 --> 00:54:25.450
Pick an appropriate level.

00:54:25.530 --> 00:54:29.390
8 is going to be awfully verbose,
so you probably do not want to

00:54:29.460 --> 00:54:31.760
start at the highest level here.

00:54:32.080 --> 00:54:37.080
Also keep in mind that
you need to change syslog,

00:54:37.080 --> 00:54:41.980
do asterisk.debug logging,
in order to get this to

00:54:42.010 --> 00:54:46.720
go to your system log,
and you need to either

00:54:46.720 --> 00:54:52.220
restart syslog by hopping it,
or restarting your system

00:54:52.400 --> 00:54:54.740
before the logging will start.

00:54:56.780 --> 00:55:04.060
On the SMB side, in Server Admin,
it will let you set low, medium, high.

00:55:04.080 --> 00:55:09.930
And these basically correspond
to the Samba logging levels of 0,

00:55:09.930 --> 00:55:11.680
1, and 2.

00:55:12.220 --> 00:55:15.400
That's great,
but Samba actually allows for you

00:55:15.400 --> 00:55:18.740
to log levels all the way up to 10.

00:55:19.260 --> 00:55:24.420
So you can actually go into the smb.conf
file in the Etsy directory and set

00:55:24.500 --> 00:55:27.190
that to whatever level you would like.

00:55:31.110 --> 00:55:36.230
If you want to figure out where
your actual shares are configured,

00:55:36.370 --> 00:55:42.520
they're really stored in NetInfo
in the config SharePoint's record.

00:55:42.520 --> 00:55:47.720
Samba also keeps a copy of
these in the smb.conf file,

00:55:47.720 --> 00:55:51.030
so this is something that you
may want to look at to make sure

00:55:51.030 --> 00:55:54.290
that the two are not out of sync.

00:55:54.500 --> 00:55:57.340
In Leopard,
the share points will probably be

00:55:57.340 --> 00:56:02.520
stored in a flat file on the local
system because net info is going away.

00:56:02.660 --> 00:56:07.550
You can use the sharing
command to list SharePoints,

00:56:07.680 --> 00:56:11.400
configure SharePoints,
and so on from the command line.

00:56:11.480 --> 00:56:16.670
And then, for just basic configuration,
all of the settings for AFP are

00:56:16.700 --> 00:56:22.310
stored in library preferences
com.apple.applefileserver.plist.

00:56:22.860 --> 00:56:24.900
Generally, you don't need to make
any changes in here,

00:56:24.900 --> 00:56:28.490
but there are a few options
that are not exposed in the GUI.

00:56:28.570 --> 00:56:33.010
An example of this is you can
set the number of threads that

00:56:33.010 --> 00:56:35.530
are used by the file server.

00:56:35.610 --> 00:56:39.430
This can be a great thing to
increase the number of threads

00:56:39.430 --> 00:56:41.860
to make your performance better.

00:56:42.020 --> 00:56:43.980
But in general,

00:56:44.380 --> 00:56:48.890
If you see an option in there and
you're not really sure what it does,

00:56:48.890 --> 00:56:51.850
you probably don't want to change it.

00:56:53.870 --> 00:56:58.250
If you see an option in there and
you're not really sure what it does,

00:56:58.380 --> 00:57:01.360
you probably don't want to change it.

00:57:12.290 --> 00:57:17.620
So one big problem that we see
with file services is we get a lot

00:57:17.620 --> 00:57:20.900
of questions about authentication.

00:57:21.160 --> 00:57:23.350
And I'm going to give you one guess.

00:57:23.560 --> 00:57:28.150
What do you think the big thing
that you need to check for--

00:57:28.160 --> 00:57:30.690
I almost gave it away there.

00:57:30.750 --> 00:57:32.920
What is the big thing
that you need to check?

00:57:33.960 --> 00:57:36.890
.

00:57:37.900 --> 00:57:42.400
Good guesses, but again, it's DNS.

00:57:42.400 --> 00:57:47.400
This is particularly important
if you're doing Kerberos.

00:57:47.400 --> 00:57:52.050
So let's look at, first of all, AFP,
two authentication types,

00:57:52.110 --> 00:57:53.990
standard and Kerberos.

00:57:54.040 --> 00:57:57.900
Generally, there's not really any
reason to change this.

00:57:57.900 --> 00:58:01.340
You can change it in the
pulldown in Server Admin,

00:58:01.340 --> 00:58:05.030
but you know,
if you want to use both or just Kerberos,

00:58:05.120 --> 00:58:06.300
you can set it.

00:58:06.300 --> 00:58:10.550
One reason why you may want to change
this is if you're in the situation where

00:58:10.550 --> 00:58:16.120
you are using Active Directory and you
have users in a large number of groups,

00:58:16.240 --> 00:58:21.120
Active Directory stores that group
information in the Kerberos file,

00:58:21.120 --> 00:58:24.610
which is sort of a
non-standard Kerberos ticket.

00:58:24.930 --> 00:58:29.790
And the ticket just gets too
large for the AFP server.

00:58:29.800 --> 00:58:33.560
So Kerberos authentication fails.

00:58:33.560 --> 00:58:38.170
So you could actually use this to
disable Kerberos authentication so that

00:58:38.170 --> 00:58:40.920
your clients can at least authenticate.

00:58:41.040 --> 00:58:47.390
Kerberos won't be working,
but at the very least,

00:58:47.390 --> 00:58:47.390
your clients are authenticating
and getting to their files.

00:58:49.500 --> 00:58:52.820
SMB is a little bit more complicated
because of course we've got

00:58:52.820 --> 00:58:54.660
more authentication methods.

00:58:54.660 --> 00:58:57.100
We've got the old land
man authentication,

00:58:57.100 --> 00:58:58.500
which hopefully nobody's using.

00:58:58.500 --> 00:59:02.500
We've got NTLM v1 and v2.

00:59:02.680 --> 00:59:04.400
And finally we've got Kerberos.

00:59:04.510 --> 00:59:08.570
So again, this is something where
you need to remember,

00:59:08.570 --> 00:59:12.530
you should test the different
authentication methods separately.

00:59:12.530 --> 00:59:16.570
So to test NTLM authentication,
you can use the dirt

00:59:16.570 --> 00:59:18.500
command to test Kerberos.

00:59:19.530 --> 00:59:23.090
You can use the K in it
to try to get a ticket.

00:59:24.420 --> 00:59:29.470
But it's important that your Samba
config file is configured correctly

00:59:29.640 --> 00:59:31.020
for authentication to work.

00:59:31.180 --> 00:59:34.370
So the four options
that are most important:

00:59:34.520 --> 00:59:38.300
Security, Realm, Workgroup,
and Use Spanago.

00:59:38.450 --> 00:59:42.710
For security,
if you are using Active Directory and

00:59:42.710 --> 00:59:49.300
you're going to use SMB file services,
make sure security is set to ADS.

00:59:49.300 --> 00:59:53.300
Sometimes people will have
it set to user or domain.

00:59:53.300 --> 00:59:56.170
If you have it set to domain,

00:59:57.250 --> 01:00:00.140
That, by default,
will cause Samba to try to

01:00:00.140 --> 01:00:04.100
change the password periodically,
which is fine,

01:00:04.170 --> 01:00:09.190
except it kind of forgets to tell the
Active Directory plugin it's done that.

01:00:09.330 --> 01:00:11.100
And so, yeah, oops.

01:00:11.310 --> 01:00:14.860
Suddenly,
your whole server can't authenticate.

01:00:14.990 --> 01:00:16.940
So usually you want to avoid that.

01:00:17.070 --> 01:00:19.980
Now,
if you're not using Active Directory,

01:00:19.980 --> 01:00:22.870
you can use the user
or the domain option.

01:00:23.080 --> 01:00:25.350
If you're using Active Directory,
make sure that you have the

01:00:25.390 --> 01:00:27.020
correct Kerberos Realm here.

01:00:27.020 --> 01:00:28.700
It should be in all caps.

01:00:28.840 --> 01:00:31.960
And that your workgroup reflects
your NetBIOS name of the domain,

01:00:32.190 --> 01:00:34.130
not the DNS name.

01:00:34.290 --> 01:00:35.460
And use Spanago.

01:00:35.610 --> 01:00:41.490
You pretty much always want that
set to "YES" in order to have

01:00:42.290 --> 01:00:48.210
Your client and your server work out what
authentication method they want to use.

01:00:48.250 --> 01:00:54.640
If you're using Active Directory,
use the dsconfigad-enablesso command.

01:00:55.040 --> 01:00:57.510
That will set up all of
your service principles.

01:00:57.730 --> 01:01:00.590
It will also edit your
smb.conf file for you.

01:01:00.620 --> 01:01:06.640
And just one last thing that can be
a troubleshooting tip is if you're

01:01:06.650 --> 01:01:12.320
having problems authenticating with
Samba and the Active Directory plugin,

01:01:12.320 --> 01:01:16.320
you might have a corrupt
vardb-samba-secrets.tdb file.

01:01:16.320 --> 01:01:19.740
you need to unbind, delete it,
and rebind.

01:01:22.920 --> 01:01:26.040
If you're having problems with
users not getting access to files

01:01:26.040 --> 01:01:29.030
that they should have access to,
remember ACLs need to be

01:01:29.030 --> 01:01:30.640
enabled at the volume level.

01:01:30.640 --> 01:01:32.800
If you're going to look at
them from the command line,

01:01:32.840 --> 01:01:37.740
you need to use the "-le" options with
"ls". And make use of the effective

01:01:37.870 --> 01:01:43.790
permissions inspector in Worker Manager,
because ACLs can be pretty complex.

01:01:47.210 --> 01:01:52.150
Finally,
if you have issues with group membership,

01:01:52.240 --> 01:01:56.100
where users in a group are not
getting access to something

01:01:56.450 --> 01:02:00.380
based on their group membership,
the authoritative way of telling

01:02:00.770 --> 01:02:05.000
whether or not a user is in the group
is to use the DS Edit Group with

01:02:05.060 --> 01:02:06.900
the Check Member option.

01:02:07.030 --> 01:02:13.010
This basically will just respond to you,
"Yes, the user is in that group," or "No,

01:02:13.010 --> 01:02:13.010
they are not."

01:02:13.920 --> 01:02:18.580
Also keep in mind that with TIGER,
although we get you over the

01:02:18.580 --> 01:02:22.110
typical UNIX 16 group limit,

01:02:23.020 --> 01:02:29.610
Samba is still limited to 16 groups,
except...

01:02:30.770 --> 01:02:33.530
You heard the little announcement
that there's a universal

01:02:33.530 --> 01:02:35.330
version of OS X Server?

01:02:35.400 --> 01:02:39.670
The universal version has this fixed,
so Samba will now be able

01:02:39.760 --> 01:02:42.280
to use more than 16 groups.

01:02:46.450 --> 01:02:51.000
I take it some people had that issue.

01:02:51.000 --> 01:02:53.630
Just two last things that
you should be aware of.

01:02:53.760 --> 01:02:58.010
If you're having weird refresh issues
with the finder on your clients,

01:02:58.210 --> 01:03:01.980
look for corrupt.ds store
files or .ds store files that

01:03:01.980 --> 01:03:04.000
have the wrong permissions.

01:03:04.000 --> 01:03:06.310
And if you have issues
with resource forks,

01:03:06.320 --> 01:03:09.450
because you have
Mac clients and PC clients,

01:03:09.450 --> 01:03:12.740
and so you get the data and
resource forks separated,

01:03:12.740 --> 01:03:16.150
you can rejoin them with
System Library Core Services fix

01:03:16.160 --> 01:03:18.200
up resource forks.

01:03:18.840 --> 01:03:22.370
And last but not least,
if you still are having other

01:03:22.370 --> 01:03:26.570
weird issues with file services,
you can use the TCP dump command to

01:03:26.570 --> 01:03:28.680
look at what's going on in the wire.

01:03:28.680 --> 01:03:32.620
You can use FS usage to look at
what's going on in the file system.

01:03:32.630 --> 01:03:36.240
And LSOF will tell you what
files are open and in use,

01:03:36.240 --> 01:03:37.670
and by whom.

01:03:38.900 --> 01:03:43.200
So, if you have any questions,
here's the contact information.