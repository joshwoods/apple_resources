# Wwdc2025 257

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Summary

Transcript

Code

Optimize home electricity usage with EnergyKitLearn how to support EnergyKit in your app so people can optimize electricity usage at home. This can help people run appliances or charge EVs during times when electricity is cleaner and cheaper. Get details about onboarding, generating a charging schedule, and providing energy usage insights back to people through electricity usage feedback.Chapters0:00 -Introduction2:08 -Onboard EnergyKit3:28 -Generate a charging schedule7:35 -Insights14:58 -Next stepsResourcesApple 2030Optimizing home electricity usageHD VideoSD VideoRelated VideosWWDC25Explore concurrency in SwiftUIFinish tasks in the background

Learn how to support EnergyKit in your app so people can optimize electricity usage at home. This can help people run appliances or charge EVs during times when electricity is cleaner and cheaper. Get details about onboarding, generating a charging schedule, and providing energy usage insights back to people through electricity usage feedback.

0:00 -Introduction

2:08 -Onboard EnergyKit

3:28 -Generate a charging schedule

7:35 -Insights

14:58 -Next steps

Apple 2030

Optimizing home electricity usage

HD VideoSD Video

HD Video

SD Video

Explore concurrency in SwiftUI

Finish tasks in the background

Search this video…Hello, I’m Dakshil and I’m excited to introduce to you EnergyKit.The electricity powering your home comes from different sources throughout the day.These can include renewable energy, like solar and wind,or fossil fuels, like coal and natural gas.We started this journey by launching Grid Forecast, a feature in the Home app.It allows people in the contiguous U.S. to see times of day when electricityfrom relatively cleaner sources is available on the grid.We also made the Energy category within the Home app more personal and actionableby integrating people’s home electricity usagedirectly into the experience.EnergyKit drives these features,and we are excited to make this framework available to youfor residential applications.EnergyKit allows you to integrate insights about people’s local electricity gridinto your app,helping them reduce or shift electricity usageand potentially save money.For example, if you are an electric vehicle manufactureror a smart thermostat manufacturer,then EnergyKit can help you choose when to use electricity,prioritizing cleaner and potentially less expensive times.For instance, EnergyKit can help an electric vehicle manufacturershift charging schedules to times when the grid is cleanerand potentially less expensive.In this talk, we will guide you through how to integrate EnergyKit into your app.You will learn how to fetch electricity guidance,and adjust the charging schedules of electric vehicles managed by your app.Plus, we’ll show you how to create an amazing user experienceusing EnergyKit insights.Let’s get started with how to onboard people to EnergyKit.Integrating EnergyKit into your appfirst requires people to opt in to a Clean Energy Charging experience,and make a selection for each locationwhere they want to charge using cleaner electricity.In our sample app, we have a list of charging locationswhich represent where you charge an electric vehicle.We added a toggle to allow people to opt into a Clean Energy Charging experience for their electric vehiclewhen charging at this location.An EnergyVenue is a physical site where devices controlled by your appconsume electricity from the grid, and where the owner has established a Homevia the Home app or the EnergyKit onboarding flow.When they enable Clean Energy Charging, we retrieve a list of EnergyVenuesnear that location.If they select a venue, you should persist a mapping ofthe selected venue to the charging locationuntil they opt out.It is recommended that you storethe unique identifier for the venue locally.For each launch of your app,you should check that the selected venue exists.You can retrieve the selected venueby using the venue identifier that you saved earlier.Now that you have identified that the person wants to useClean Energy Charging and has selected an EnergyVenue,the next step is to generate a Clean Energy Charging Schedule.To generate a Clean Energy Charging schedule,you require a forecast that will help guide the schedule.We call this forecast Electricity Guidance.This guidance is generated by using a combination of the Home location,Grid information about the location, such as carbon emissions,or whether renewables are generating,and Utility account information, if available.There are two types of guidance actions available:Reduce and Shift.The “Reduce” guidance action is used for devices, such as smart thermostats,which are designed to reduce electricity usage.The “Shift” guidance action is used for devices,such as electric vehicles,which can shift their electricity usage from one time to another time,but use the same amount of electricity.Let's take a look at an example.The illustration shows electricity guidance for an EnergyVenue.Guidance values are from 0 to 1 as represented by the Y axis,where lower values indicate periods where electricity is cleanerand potentially less expensive if rate plan information is available.In our example, a person has onboarded their utility account in the Home app,and is on a time of use rate plan where electricity is more expensivebetween the hours of 4 to 9pm.The car is plugged in at around 6:30pm.Your charging preferences might know that they unplugged their carat around 9am or have a charging deadline of 9am.This gives us a charging window from 6:30pm to 9am the next day.If guidance is not applied to the charging schedule,the car may begin charging immediately at 6:30pm,which is not the most favorable from a cleanliness and cost perspective.Instead, we can select hours such that we can optimize the charging scheduleto charge the vehicle during cleaner and potentially less expensive times.Let’s take a look at how we can fetch this Electricity Guidanceat a selected EnergyVenue.We start by adding a method called streamGuidanceto our EnergyVenueManager.As we get updates, we will store it in the guidance variable.We need to create a query to retrieve the guidance for our use case.For an electric vehicle,the suggested action type would be to shift electricity usage.We are now ready to retrieve guidance for the EnergyVenue.ElectricityGuidance has a sharedService helperthat should be used to retrieve guidance.You get back an AsyncSequence,which is updated as EnergyKit receives updated Guidance.For more information, check out the video"Demystify concurrency in SwiftUI".If you do not need to continuously listen for updates,you can break out of the loop after the first fetch.You can call streamGuidance from a Task.If your app requires updates while in the background,you should call this from a Background Task handler.If your app has an interactive charging widget,you can also utilize that widget to keep guidance up to datewhile the app is not running.For more information, check out the video, “Finish tasks in the background”.You can now iterate over the guidance valuesin order to determine better times to charge.EnergyKit Insights help provide electricity informationin a format that is easy to present to people.You can use the provided insights to inform peoplehow much of the electricity used for charging their vehiclewas during cleaner times, which can help reduce carbon emissionsof their home electricity usage.The vehicle’s electricity usage is categorized by grid cleanlinessand is reported in one of three categories:clean, reduce and avoid.You can also inform them about the electricity usedduring relatively less expensive times.The vehicle’s electricity usage is categorized byelectricity rate plan when available and is reported in one of five categories:super off peak, off peak, partial peak, on peak, and critical peak.Rate plan is also known as the rate tariff.The next question is: How do these insights work?Insights are influenced by a combination of factors.The algorithm you use to shift or reduce electricity based on the provided guidancedetermines whether the device under controlconsumes electricity during cleaner or less expensive times.The state of the electricity grid where your device consumed electricityis determined by various factors such as electricity demand,renewable generators that are online, grid emissions, etc.If the person has onboarded their utility account in the Home appand they are on a time-of-use rate plan,the electricity usage can be attributed to the various time-of-use periodsto get back the relative cost of using electricity.And the most important piece,how and when your device consumed electricity.This is determined by the behavior of your device,interaction by people, and how your app applied guidance to the device.For an EV manufacturer, this would be the charging session behaviorfor the vehicle.In order to generate insights about your vehicle's chargingwith respect to the cleanliness and relative cost of electricity used,it is required that your app submits feedback to EnergyKit.We call this feedback LoadEvents.You should periodically create events as your vehicle chargesand changes occur to its state of charge during the charging session.When a charging session begins,create an event which represents the state of the vehicleat the start of the session.As the vehicle charges, create events periodically.We recommend one event every 15 minuteswhen the vehicle is charging at a steady rate.If a significant event such as pausing the session,a change in the charging schedule due to a new guidance set being applied,or a rapid change in power consumption occurs,create events for the same.At the end of a session, close the session with an eventthat represents the final state of the vehicle.For EnergyKit to generate insights for the created events,you need to submit them to EnergyKit.You may submit events as they occur or in batches periodically,or even in a batch at the end of the charging session.We recommend batch submitting events for performance.Do not submit events between charging sessions.Let’s take a look at how to create and submit these events.For a charging session,the most important pieces of information are:the state of charge of the battery,the power being consumed at a given instance,the cumulative energy consumed since the start of a charging session.When the vehicle starts charging,we consider that to be the start of the session.This event represents the initial state of the vehicleat the start of the charging session.The guidance state indicates whether the session startedbecause the charging schedule was following the electricity guidancerepresented by the guidance token.This token is unique to the phone that retrieved the guidancewhich was in effect, and is to be used to create events on that phone.As charging progresses, the session is marked as active.Once the charging session has ended, the session is closed with an end event.This event represents the final state of the vehicleat the end of the charging session.In our sample app, we create LoadEvents and cache themuntil we are ready to submit as a batch.These batched events are submitted to the EnergyVenueat which the vehicle was charging.The events you submit are stored in accordance to Apple’s privacy policieswith storage in Core Data on device and backed up with end-to-end encryptionto CloudKit.This data is also shared with all people that already share the HomeKit Homeassociated to the EnergyVenue for which the events are submitted.We now finally have all the information needed to generate insights.To retrieve insights, we first create a querywhere we specify that we are interested in insights for cleanlinessand relative cost if available.In our sample app, we are interested in displayinga summary of electricity consumption for a previous day.Once we have created the query, we can fetch insights for our vehicleat a venue where it was charging previously.We get back an AsyncStreamand since we are interested in the insight for a particular day,we can filter the stream as per our requirement.The retrieved insight can now be used to create a summary.Your app is now integrated with EnergyKit.In this talk,we went over the building blocks of interacting with EnergyKit.For onboarding, we looked at how people would interact with your appto select an EnergyVenue.We then went over how to use the selected EnergyVenueand to fetch electricity guidance,and use that to generate a charging schedule.After generating a charging schedule, as your vehicle charges,we went over the importance of submitting LoadEvents as feedback to EnergyKitto drive insight generation.Finally, we looked at how you can request insightsbased on the guidance retrieved and the feedback submitted by your appto build your user experience.You can download the sample app that accompanies this talkand also access the documentation for EnergyKit at developer.apple.com.At Apple, we are committed to protecting the environmentand you can learn more about this at apple.com/2030We are excited to see what amazing apps you build using EnergyKit.

Hello, I’m Dakshil and I’m excited to introduce to you EnergyKit.

The electricity powering your home comes from different sources throughout the day.These can include renewable energy, like solar and wind,or fossil fuels, like coal and natural gas.We started this journey by launching Grid Forecast, a feature in the Home app.It allows people in the contiguous U.S. to see times of day when electricityfrom relatively cleaner sources is available on the grid.

We also made the Energy category within the Home app more personal and actionableby integrating people’s home electricity usagedirectly into the experience.EnergyKit drives these features,and we are excited to make this framework available to youfor residential applications.

EnergyKit allows you to integrate insights about people’s local electricity gridinto your app,helping them reduce or shift electricity usageand potentially save money.For example, if you are an electric vehicle manufactureror a smart thermostat manufacturer,then EnergyKit can help you choose when to use electricity,prioritizing cleaner and potentially less expensive times.For instance, EnergyKit can help an electric vehicle manufacturershift charging schedules to times when the grid is cleanerand potentially less expensive.In this talk, we will guide you through how to integrate EnergyKit into your app.

You will learn how to fetch electricity guidance,and adjust the charging schedules of electric vehicles managed by your app.

Plus, we’ll show you how to create an amazing user experienceusing EnergyKit insights.

Let’s get started with how to onboard people to EnergyKit.

Integrating EnergyKit into your appfirst requires people to opt in to a Clean Energy Charging experience,and make a selection for each locationwhere they want to charge using cleaner electricity.In our sample app, we have a list of charging locationswhich represent where you charge an electric vehicle.We added a toggle to allow people to opt into a Clean Energy Charging experience for their electric vehiclewhen charging at this location.

An EnergyVenue is a physical site where devices controlled by your appconsume electricity from the grid, and where the owner has established a Homevia the Home app or the EnergyKit onboarding flow.When they enable Clean Energy Charging, we retrieve a list of EnergyVenuesnear that location.If they select a venue, you should persist a mapping ofthe selected venue to the charging locationuntil they opt out.

It is recommended that you storethe unique identifier for the venue locally.

For each launch of your app,you should check that the selected venue exists.You can retrieve the selected venueby using the venue identifier that you saved earlier.

Now that you have identified that the person wants to useClean Energy Charging and has selected an EnergyVenue,the next step is to generate a Clean Energy Charging Schedule.To generate a Clean Energy Charging schedule,you require a forecast that will help guide the schedule.

We call this forecast Electricity Guidance.This guidance is generated by using a combination of the Home location,Grid information about the location, such as carbon emissions,or whether renewables are generating,and Utility account information, if available.

There are two types of guidance actions available:Reduce and Shift.The “Reduce” guidance action is used for devices, such as smart thermostats,which are designed to reduce electricity usage.

The “Shift” guidance action is used for devices,such as electric vehicles,which can shift their electricity usage from one time to another time,but use the same amount of electricity.Let's take a look at an example.

The illustration shows electricity guidance for an EnergyVenue.

Guidance values are from 0 to 1 as represented by the Y axis,where lower values indicate periods where electricity is cleanerand potentially less expensive if rate plan information is available.In our example, a person has onboarded their utility account in the Home app,and is on a time of use rate plan where electricity is more expensivebetween the hours of 4 to 9pm.

The car is plugged in at around 6:30pm.

Your charging preferences might know that they unplugged their carat around 9am or have a charging deadline of 9am.

This gives us a charging window from 6:30pm to 9am the next day.

If guidance is not applied to the charging schedule,the car may begin charging immediately at 6:30pm,which is not the most favorable from a cleanliness and cost perspective.

Instead, we can select hours such that we can optimize the charging scheduleto charge the vehicle during cleaner and potentially less expensive times.

Let’s take a look at how we can fetch this Electricity Guidanceat a selected EnergyVenue.

We start by adding a method called streamGuidanceto our EnergyVenueManager.

As we get updates, we will store it in the guidance variable.

We need to create a query to retrieve the guidance for our use case.

For an electric vehicle,the suggested action type would be to shift electricity usage.

We are now ready to retrieve guidance for the EnergyVenue.

ElectricityGuidance has a sharedService helperthat should be used to retrieve guidance.You get back an AsyncSequence,which is updated as EnergyKit receives updated Guidance.

For more information, check out the video"Demystify concurrency in SwiftUI".

If you do not need to continuously listen for updates,you can break out of the loop after the first fetch.You can call streamGuidance from a Task.If your app requires updates while in the background,you should call this from a Background Task handler.If your app has an interactive charging widget,you can also utilize that widget to keep guidance up to datewhile the app is not running.For more information, check out the video, “Finish tasks in the background”.

You can now iterate over the guidance valuesin order to determine better times to charge.

EnergyKit Insights help provide electricity informationin a format that is easy to present to people.

You can use the provided insights to inform peoplehow much of the electricity used for charging their vehiclewas during cleaner times, which can help reduce carbon emissionsof their home electricity usage.The vehicle’s electricity usage is categorized by grid cleanlinessand is reported in one of three categories:clean, reduce and avoid.You can also inform them about the electricity usedduring relatively less expensive times.The vehicle’s electricity usage is categorized byelectricity rate plan when available and is reported in one of five categories:super off peak, off peak, partial peak, on peak, and critical peak.

Rate plan is also known as the rate tariff.The next question is: How do these insights work?Insights are influenced by a combination of factors.The algorithm you use to shift or reduce electricity based on the provided guidancedetermines whether the device under controlconsumes electricity during cleaner or less expensive times.

The state of the electricity grid where your device consumed electricityis determined by various factors such as electricity demand,renewable generators that are online, grid emissions, etc.If the person has onboarded their utility account in the Home appand they are on a time-of-use rate plan,the electricity usage can be attributed to the various time-of-use periodsto get back the relative cost of using electricity.

And the most important piece,how and when your device consumed electricity.This is determined by the behavior of your device,interaction by people, and how your app applied guidance to the device.

For an EV manufacturer, this would be the charging session behaviorfor the vehicle.In order to generate insights about your vehicle's chargingwith respect to the cleanliness and relative cost of electricity used,it is required that your app submits feedback to EnergyKit.We call this feedback LoadEvents.You should periodically create events as your vehicle chargesand changes occur to its state of charge during the charging session.When a charging session begins,create an event which represents the state of the vehicleat the start of the session.As the vehicle charges, create events periodically.We recommend one event every 15 minuteswhen the vehicle is charging at a steady rate.If a significant event such as pausing the session,a change in the charging schedule due to a new guidance set being applied,or a rapid change in power consumption occurs,create events for the same.At the end of a session, close the session with an eventthat represents the final state of the vehicle.For EnergyKit to generate insights for the created events,you need to submit them to EnergyKit.You may submit events as they occur or in batches periodically,or even in a batch at the end of the charging session.

We recommend batch submitting events for performance.Do not submit events between charging sessions.Let’s take a look at how to create and submit these events.For a charging session,the most important pieces of information are:the state of charge of the battery,the power being consumed at a given instance,the cumulative energy consumed since the start of a charging session.When the vehicle starts charging,we consider that to be the start of the session.

This event represents the initial state of the vehicleat the start of the charging session.The guidance state indicates whether the session startedbecause the charging schedule was following the electricity guidancerepresented by the guidance token.

This token is unique to the phone that retrieved the guidancewhich was in effect, and is to be used to create events on that phone.As charging progresses, the session is marked as active.Once the charging session has ended, the session is closed with an end event.This event represents the final state of the vehicleat the end of the charging session.In our sample app, we create LoadEvents and cache themuntil we are ready to submit as a batch.These batched events are submitted to the EnergyVenueat which the vehicle was charging.The events you submit are stored in accordance to Apple’s privacy policieswith storage in Core Data on device and backed up with end-to-end encryptionto CloudKit.This data is also shared with all people that already share the HomeKit Homeassociated to the EnergyVenue for which the events are submitted.We now finally have all the information needed to generate insights.To retrieve insights, we first create a querywhere we specify that we are interested in insights for cleanlinessand relative cost if available.In our sample app, we are interested in displayinga summary of electricity consumption for a previous day.Once we have created the query, we can fetch insights for our vehicleat a venue where it was charging previously.We get back an AsyncStreamand since we are interested in the insight for a particular day,we can filter the stream as per our requirement.The retrieved insight can now be used to create a summary.Your app is now integrated with EnergyKit.In this talk,we went over the building blocks of interacting with EnergyKit.

For onboarding, we looked at how people would interact with your appto select an EnergyVenue.We then went over how to use the selected EnergyVenueand to fetch electricity guidance,and use that to generate a charging schedule.

After generating a charging schedule, as your vehicle charges,we went over the importance of submitting LoadEvents as feedback to EnergyKitto drive insight generation.Finally, we looked at how you can request insightsbased on the guidance retrieved and the feedback submitted by your appto build your user experience.

You can download the sample app that accompanies this talkand also access the documentation for EnergyKit at developer.apple.com.

At Apple, we are committed to protecting the environmentand you can learn more about this at apple.com/2030We are excited to see what amazing apps you build using EnergyKit.

3:13 -Retrive an EnergyVenue

6:03 -Fetch Electricity Guidance at a selected EnergyVenue

7:00 -Start monitoring Electricity Guidance

11:30 -Update charging measurements

11:50 -Start a session

12:25 -Update a session

12:31 -End a session

12:43 -Create a load event

12:50 -Submit events

13:25 -Create an insight query

13:43 -Request insights

0:00 -IntroductionThe EnergyKit framework enables you to integrate local electricity grid insights into your apps, so people can reduce usage, save money, and prioritize cleaner energy sources when using devices such as smart thermostats, or charging electric vehicles.2:08 -Onboard EnergyKitTo onboard EnergyKit, users opt-in to clean energy charging for a specific location. Your app retrieves the location (known as an energy venue) and stores its identifier.3:28 -Generate a charging scheduleEnergyKit provides electricity guidance, based on the location, grid info, and utility data, to create a clean energy charging schedule. It can suggest "reduce" actions (for devices like smart thermostats) or "shift" actions (for uses like electric vehicle charging). Electricity guidance prioritizes cleaner, cheaper off-peak hours, optimizing cost and environmental impact.7:35 -InsightsEnergyKit insights help simplify the presentation of electricity information for users, and can categorize electricity usage based on grid cleanliness. 

For electric vehicle manufacturers to generate insights, apps provide feedback to EnergyKit in the form of load events which track progress during the charging session. By batching and submitting these events, EnergyKit can accurately analyze the charging data.14:58 -Next stepsAdopt EnergyKit in your apps that manage electricity usage. For more details, see the sample code that accompanies this session.

0:00 -Introduction

The EnergyKit framework enables you to integrate local electricity grid insights into your apps, so people can reduce usage, save money, and prioritize cleaner energy sources when using devices such as smart thermostats, or charging electric vehicles.

The EnergyKit framework enables you to integrate local electricity grid insights into your apps, so people can reduce usage, save money, and prioritize cleaner energy sources when using devices such as smart thermostats, or charging electric vehicles.

2:08 -Onboard EnergyKit

To onboard EnergyKit, users opt-in to clean energy charging for a specific location. Your app retrieves the location (known as an energy venue) and stores its identifier.

To onboard EnergyKit, users opt-in to clean energy charging for a specific location. Your app retrieves the location (known as an energy venue) and stores its identifier.

3:28 -Generate a charging schedule

EnergyKit provides electricity guidance, based on the location, grid info, and utility data, to create a clean energy charging schedule. It can suggest "reduce" actions (for devices like smart thermostats) or "shift" actions (for uses like electric vehicle charging). Electricity guidance prioritizes cleaner, cheaper off-peak hours, optimizing cost and environmental impact.

EnergyKit provides electricity guidance, based on the location, grid info, and utility data, to create a clean energy charging schedule. It can suggest "reduce" actions (for devices like smart thermostats) or "shift" actions (for uses like electric vehicle charging). Electricity guidance prioritizes cleaner, cheaper off-peak hours, optimizing cost and environmental impact.

7:35 -Insights

EnergyKit insights help simplify the presentation of electricity information for users, and can categorize electricity usage based on grid cleanliness. 

For electric vehicle manufacturers to generate insights, apps provide feedback to EnergyKit in the form of load events which track progress during the charging session. By batching and submitting these events, EnergyKit can accurately analyze the charging data.

EnergyKit insights help simplify the presentation of electricity information for users, and can categorize electricity usage based on grid cleanliness. 

For electric vehicle manufacturers to generate insights, apps provide feedback to EnergyKit in the form of load events which track progress during the charging session. By batching and submitting these events, EnergyKit can accurately analyze the charging data.

14:58 -Next steps

Adopt EnergyKit in your apps that manage electricity usage. For more details, see the sample code that accompanies this session.

Adopt EnergyKit in your apps that manage electricity usage. For more details, see the sample code that accompanies this session.

## Code Samples

```swift
// Retrieve an EnergyVenue



import
 EnergyKit

import
 Foundation


@Observable
 
final
 
class
 
EnergyVenueManager
  {

    
let
 venue: 
EnergyVenue


    
init?
(
venueID
: 
UUID
) 
async
 {
        
guard
 
let
 energyVenue 
=
 
await
 
EnergyVenue
.venue(for: venueID) 
else
 {
            
return
 
nil

        }
        venue 
=
 energyVenue
    }
}
```

```swift
// Fetch ElectricityGuidance



import
 EnergyKit

import
 Foundation


@Observable
 
final
 
class
 
EnergyVenueManager
  {
    
// The current active guidance.

    
var
 guidance: 
ElectricityGuidance
?

    
fileprivate
 
func
 
streamGuidance
(
        
venueID
: 
UUID
,
        
update
: (
_
 guidance: 
ElectricityGuidance
) -> 
Void

    ) 
async
 
throws
 {
        
let
 query 
=
 
ElectricityGuidance
.
Query
(suggestedAction: .shift)
        
for
 
try
 
await
 currentGuidance 
in
 
ElectricityGuidance
.sharedService.guidance(
            using: query,
            at: venueID
        ) {
            update(currentGuidance)
          	
break

        }
    }
}
```

```swift
// Fetch ElectricityGuidance



import
 EnergyKit

import
 Foundation


@Observable
 
final
 
class
 
EnergyVenueManager
  {
    
// The task used to stream guidance.

    
private
 
var
 streamGuidanceTask: 
Task
<(), 
Error
>?

    
///Start streaming guidance and store the value in the observed property 'guidance'.

    
func
 
startGuidanceMonitoring
() {
       streamGuidanceTask
?
.cancel()
        streamGuidanceTask 
=
 
Task
.detached { [
weak
 
self
] 
in

            
if
 
let
 venueID 
=
 
self
?
.venue.id {
                
try?
 
await
 
self
?
.streamGuidance(venueID: venueID) { guidance 
in

                    
self
?
.guidance 
=
 guidance
                    
if
 
Task
.isCancelled {
                        
return

                    }
                }
            }
        }
    }
}
```

```swift
// Update charging measurements



import
 EnergyKit


// A controller that handles an electric vehicle


@Observable
 
class
 
ElectricVehicleController
 {
    
fileprivate
 
func
 
chargingMeasurement
() -> 
ElectricVehicleLoadEvent
.
ElectricalMeasurement
 {
        
let
 stateOfCharge 
=
 
Int
(configuration.state.stateOfCharge.rounded(.down))
        
let
 power 
=
 
Measurement
<
UnitPower
>(
            value: configuration.properties.chargingPower 
*
 
1000000
,
            unit: .milliwatts
        )
        
let
 energy 
=
 
Measurement
<
UnitEnergy
>(
            value: configuration.state.cummulativeEnergy 
*
 
1000000
,
            unit: .
EnergyKit
.milliwattHours
        )
        
return
 
ElectricVehicleLoadEvent
.
ElectricalMeasurement
(
            stateOfCharge: stateOfCharge,
            direction: .imported,
            power: power,
            energy: energy
        )
    }
}
```

```swift
// Start a session



import
 EnergyKit


// A controller that handles an electric vehicle


@Observable
 
class
 
ElectricVehicleController
 {
    
// The session

    
var
 session: 
ElectricVehicleLoadEvent
.
Session
?

    
// The current guidance stored at the EV

    
var
 currentGuidance: 
ElectricityGuidance


    
// Whether the EV is following guidance

    
var
 isFollowingGuidance: 
Bool
 
=
 
true


    
fileprivate
 
func
 
beginSession
() {
        session 
=
 
ElectricVehicleLoadEvent
.
Session
(
            id: 
UUID
(),
            state: .begin,
            guidanceState: .
init
(
                wasFollowingGuidance: isFollowingGuidance,
                guidanceToken: currentGuidance.guidanceToken
            )
        )
    }
}
```

```swift
// Update a session



import
 EnergyKit


// A controller that handles an electric vehicle


@Observable
 
class
 
ElectricVehicleController
 {
    
fileprivate
 
func
 
updateSession
() {
        
if
 
let
 session {
            
self
.session 
=
 
ElectricVehicleLoadEvent
.
Session
(
                id: session.id,
                state: .active,
                guidanceState: .
init
(
                    wasFollowingGuidance:
                    isFollowingGuidance,
                    guidanceToken:
                    currentGuidance.guidanceToken
                )
            )
        }
    }
}
```

```swift
// End a session



import
 EnergyKit


// A controller that handles an electric vehicle.


@Observable
 
class
 
ElectricVehicleController
 {
    
fileprivate
 
func
 
endSession
() {
        
if
 
let
 session {
            
self
.session 
=
 
ElectricVehicleLoadEvent
.
Session
(
                id: session.id,
                state: .end,
                guidanceState: .
init
(
                    wasFollowingGuidance:
                    isFollowingGuidance,
                    guidanceToken:
                    currentGuidance.guidanceToken
                )
            )
        }
    }
}
```

```swift
// Create a ElectricVehicleLoadEvent



@Observable
 
class
 
ElectricVehicleController
 {
    
fileprivate
 
func
 
createLoadEvent
(
        
sessionState
: 
ElectricVehicleLoadEvent
.
Session
.
State

    ) {
        
switch
 sessionState {
        
case
 .begin:
            beginSession()
        
case
 .active:
            updateSession()
        
case
 .end:
            endSession()
        
@unknown
 
default
:
            
fatalError
()
        }
        
if
 
let
 session {
            
let
 event 
=
 
ElectricVehicleLoadEvent
(
                timestamp: configuration.state.timestamp,
                measurement: chargingMeasurement(),
                session: session,
                deviceID: configuration.properties.vehicleID
            )
           events.append(event)
        }
    }
}
```

```swift
// Submit events



import
 EnergyKit


// A controller that handles an electric vehicle


@Observable
 
class
 
ElectricVehicleController
 {
    
// EnergyVenue

    
// The venue at which the EV uses energy

    
var
 currentVenue: 
EnergyVenue


    
// Electric EV Events

    
// The list of generated EV load events

    
var
 events 
=
 [
ElectricVehicleLoadEvent
]()
    
    
func
 
submitEvents
() 
async
 
throws
 {
        
try
 
await
 currentVenue.submitEvents(events)
    }
}
```

```swift
// Create an insight query



import
 EnergyKit


@Observable
 
final
 
class
 
EnergyVenueManager
  {
    
func
 
createInsightsQuery
(
on
 
date
: 
Date
) -> 
ElectricityInsightQuery
 {
        
return
 
ElectricityInsightQuery
(
            options: .cleanliness.union(.tariff),
            range: 
self
.dayInterval(date: date),
            granularity: .daily,
            flowDirection: .imported
        )
    }
}
```

```swift
// Request an insights



import
 EnergyKit


@Observable
 
final
 
class
 
EnergyVenueManager
  {
    
func
 
generateInsights
(
for
 
vehicleIdentifier
: 
String
, 
on
 
date
: 
Date
) 
async
 
throws
 ->     
ElectricityInsightRecord
<
Measurement
<
UnitEnergy
>>? {
        
let
 query 
=
 createInsightsQuery(on: date)
        
return
 
try
 
await
 
ElectricityInsightService
.shared.energyInsights(
            forDeviceID: vehicleIdentifier,
            using: query,
            atVenue: 
self
.venue.id
        ).first { record 
in

            
return
 record.range.start 
==
 query.range.start
        }
    }
}
```

