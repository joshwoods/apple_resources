# Wwdc2024 10204

## Transcript

More Videos

Streaming is available in most browsers,and in the Developer app.

About

Transcript

Build a great Lock Screen camera capture experienceFind out how the LockedCameraCapture API can help you bring your capture application's most useful information directly to the Lock Screen. Examine the API's features and functionality, learn how to get started creating a capture extension, and find out how that extension behaves when the device is locked.Chapters0:00 -Introduction1:39 -Great capture experiences3:33 -Lifecycle of a capture extension4:49 -Running on a locked device10:48 -Capturing from the Lock Screen18:31 -Working with captures in your appResourcesCreating a camera experience for the Lock ScreenCreating controls to perform actions across the systemForum: Photos & CameraHuman Interface Guidelines: ControlsHD VideoSD VideoRelated VideosWWDC24Extend your app’s controls across the system

Find out how the LockedCameraCapture API can help you bring your capture application's most useful information directly to the Lock Screen. Examine the API's features and functionality, learn how to get started creating a capture extension, and find out how that extension behaves when the device is locked.

0:00 -Introduction

1:39 -Great capture experiences

3:33 -Lifecycle of a capture extension

4:49 -Running on a locked device

10:48 -Capturing from the Lock Screen

18:31 -Working with captures in your app

Creating a camera experience for the Lock Screen

Creating controls to perform actions across the system

Forum: Photos & Camera

Human Interface Guidelines: Controls

HD VideoSD Video

HD Video

SD Video

Extend your app’s controls across the system

Search this video…Hi there, I’m Adam and I’m an engineer on the iOS System Experience team.Today, I am excited to show you how to build a great camera capture experiencefor the Lock Screen.I love how easy it is to capture a great moment with my iPhone.When I take my iPhone out of my pocket, without even needing to unlock it,I can launch into the camera from the Action button,Control Center, or the Lock Screen.Before you know it, I’ve snapped a great photo,like this photo I took today at Apple Park.New in iOS 18, your camera experience can be made availableto people right from their Lock Screen on both iPhone and iPad.This type of capture experience is enabledby a new framework we’re introducing in iOS 18:LockedCameraCapture framework.The LockedCameraCapture framework contains the building blocksto build a great camera capture experiencethat will run from the Lock Screen.One major component introduced by LockedCameraCaptureso we can build this capture experienceis a new extension type, the Locked Camera Capture Extension.In this session, we’ll talk about what makes a great camera capture experiencethen we’ll take you through the lifecycle of a capture extension,Then we’ll talk about some important considerationsfor running on a locked device.After that we’ll take a deeper dive intohow you can capture great photos and videos from the Lock Screen.And finally, we’ll look at how you can incorporate contentcaptured from the Lock Screen back into your application.Let's start with a discussion of what makes a great capture experience.The Camera app on iOS providesa great capture experience on iPhone or iPad.I can quickly and easily access my camera from my Lock Screeneven when my device is locked by pressing on the Camera control.Pressing that control takes me directly to a viewfinder to start capturing photos.I can press the volume up button to capture a photoor press and hold it to start recording a video.Once I’ve taken a photo or video, I can tap the image well to view it.My device still remains locked,and Camera maintains my privacy by only showing photos and videosI’ve captured while I had the camera presented.If I want deeper interactions with my content,my phone will request that I unlock my deviceand then allow me to continue.To enable this type of experience for your app,you can create a new type of app extension,the Locked Camera Capture Extension.An app extension is a separate target that gets embedded in your application.It lets you extend custom functionality and content beyond your app,making it available to peoplewhile they’re interacting with other apps or the system.This new type of app extension runs from the Lock Screenso you can build a capture experience that allows people to get quick and easy accessto snap a photo or record a video usingthe same familiar UI from your application,even when their device is locked.Let's take a look at the lifecycle of this new extension.The first step of the lifecycle is launching the extension.This extension can be launched from a control in control center.From a control assigned to the action button.Or from a control on the Lock Screen.Once the extension is launched,someone can then start to capture great photo and video contentwhich will use the same familiar UI from your app.Capture extension can either directly add photoand video assets to a person’s Photo library,or the extension can store any data it needs to represent a captureto a provided directory on the file system.After capturing some content,someone might want to do something more in depth with it,such as sharing it to a social network or applying a filter requiring image assets,to give it a styled look.For these types of interactions,the extension can request to open its parent application,which will authenticate a person using the device.This enables the ability to doa seamless transition from extension to app,bringing someone right to where the extension left off.Lastly, whether by transitioning to the applicationor if someone swiped up to return to the Lock Screen,the capture extension will be dismissed.When this happens, the system moves the captured contentto a location that the parent application can access.When the app has runtime,it can incorporate the content capturedwhile in the extension into its other content.We’ll talk more in depth about this process later on in this video.Now that we know more about the lifecycle of a capture extension,lets cover some important considerations for running on a locked device.People around the world rely on iOS everydayto provide them a high degree of privacy.When my device is locked, I can rest assured that my contacts, emails,photos, videos and much more are secure behind the Lock Screen,requiring me to unlock my device to access them.We’ve built LockedCameraCapture frameworkwith an intentional focus on security and privacy,remaining conscious of protecting the contents of people's devices.Since this new extension type runs from the Lock Screen,a persons device may be locked while they are capturing photos or videoin your capture experience.To ensure the privacy and security of a persons device,we’ve enforced a few restrictions for this new experience.Your extension should provide the same capture experienceas in your application,and is expected to provide people with a camera viewfinderas soon as possible after launch.If your extension is not showing a camera viewfinder at launch,your extension will be terminated by the system.We think capturing a photo or video with the hardware buttons of the phoneis a great way to give people the quickest point and shoot experience possible.Therefore, your extension must use AVCaptureEventInteractionto handle events from the system hardware buttons.Since your experience will be accessible while the device is locked,your capture extension will be restricted from using any network resourcesit cannot read from or write to any shared group container for your application,or other extensions,and cannot access any shared preferences for your application.Rest assured you can still share an important statebetween your extension and application,we’ll go over how in a little while.First, let's take a look at how persisting data for capturesworks when in the extension.We recommend using PhotoKit to save photo and video assetscaptured from your extension.With PhotoKit, your extension can add captured photos and videosto someone's photo library,even when the device is locked.PhotoKit is designed to protect the private photos and videosin the photo library when the device is locked.When reading the photo library on a locked device,only photos and videos written during the current capture sessionwill be available to be read.If your device is unlocked and your extensionhas the proper permissions for the photo library,you will be able to read all photos and videosthat someone has given you access to,not just those captured during the current capture session.PhotoKit also has great supportfor granular levels of photo library access,such as write only access and limited library support,allowing someone to select a set of photos to allow access to.Your extension inherits Photos permissions from your app,so your extension should be preparedto handle any level of permissions for photo library access.If your extension needs additional permissions for Photos,you can transition into your application to request them.We’ll cover how to do that a bit later in this video.For more information on working with PhotoKit,you can check out these videos from previous WWDCs.Some capture experiences might need to save other datathat PhotoKit does not support.LockedCameraCapture framework also supportssaving any data you might need for captures taken in your extension.Let’s take a look at how this works.These boxes represent the file system storage of photosand videos captured for your extension on the left,and your application on the right.On launch, your extension will be provided a content path via the session object.In this example, as a person captures content,your extension can write data to a provided session content directory.You may also use PhotoKit to ingest captured photos and videos,adding them directly to the photo library.You might be tempted to store additional data anywhere elsein the extension container.However, this is not recommended.At any time, someone can dismiss your extension.Once your extension is dismissed,the provided session content directory is migrated to your application’s containerand the extension’s container is erased to ensure securityand to preserve the privacy of the device owner.You will not be able to access the contentsof any prior sessions from within the extension.Persist any data you wish to preserve past the given sessionin the provided session content directory.In the case of an unexpected termination, the system will still copy the contentsof this directory, allowing you to attempt recovery of the data.If someone launches your extension again,it receives a new session objectcontaining a new session content directory to write files to.Once again, the extension writes into the session content directory,and when someone dismisses the extension, the content is once again movedinto the application’s container as a separate session content directory.When your application has runtime, it can retrieve the captured contentsand handle them appropriately,such as integrating them to sit alongside other captured content in your app.Once your application is done handlingthe contents of a single session directory,it can call to invalidate that directory,letting the system know that directory is safeto erase from the file system.To reiterate: Someone can dismiss your extension at any time,and when that happens, only contents in the session content directorywill be copied to your application’s container.You will not be able to access the container contentsfrom a previous launch of the extension on the next launch of the extension,as data in the extension’s container will be erased.While we have mainly focused on behaviors for running while the device is locked,your extension will run from the Lock Screenregardless of the device’s locked state.For both locked and unlocked cases the behaviors and restrictionswill remain the same.Now that we’ve discussed the caveats of running on a locked device,let's talk about building our experienceto capture content right from the Lock Screen.My colleague, Jon, and I have recently been workingon an update to our app, ClownTownthat lets Clowns add a profile for themselves,so they can connect with other Clowns in the area.I think adding the ability to take a photo for their profilewould be a great feature.I’ll use my updates to the ClownTown appas an example as we go through building our capture extensionand the rest of the capture experience.To help you get started, Xcode provides a convenient templatefor the Locked Camera Capture Extension.This template includes everything you need to build and run right away,including a camera viewfinder and shutter button.In my example here, I define my extension,which conforms to LockedCameraCaptureExtension.Then from within that struct,an extension scene is implemented for the body,and the scene returns my custom view content.Your UI for this extension should be focusedon bringing people to a camera viewfinder to capture photos and videos.Your extension should also provide the same consistent capture experiencepeople will get in your application,using the same familiar UI elements.Your extension will inherit permissions for Camera and Photos accessfrom your application.Your extension should be prepared to handle any level of permissionsfor both Camera or Photos.If your app cannot use the Camera due to permissions not having been granted,the system will request an unlock of a person's deviceand after a successful authentication,launch your app instead of your extension to handle that case.The initializer for the LockedCameraCaptureUISceneprovides a single parameter,an instance of LockedCameraCaptureSession.Let's take a look at what this session object provides.This session object serves a few important purposes.The capture session provides a sessionContentURL.This is a path to a directory in your extension’s containerwhich you can use to persist any and all datafor someone’s captured photos and videos,and any other related data you wish to preserve.You can also persist captured photos and videosdirectly to PhotoKit from your capture extension.You can write content to the photo library even if the device is locked,however when the device is locked,only photos and videos written during the current capture sessionwill be available to be read.When unlocked, your extension can read all of the photos it has permissions to read,including those outside of the current capture session.If you are finished using the data you’ve writtento the directory sessionContentURL,for example, if you have saved the contents to PhotoKit,you can call invalidateSessionContent to erase the contents of that directory.You can continue to write to the directory after calling this function,but any content written there prior to the invalidate call will be erased.The session also provides a function to request an open of your application.You should only call this functionin reaction to a person interacting with your UI,such as when someone taps a button to share a photo via the share sheet.Since sharing content requires network access,and you cannot fulfill that request in the capture extension,you can call openApplication,which will prompt for an unlock of the device,and if successfully unlocked, then will open your application.We’ll take a closer look athow to use this function later in this video.When we discussed the lifecycle of your extension earlier,I mentioned that your extension is launched from a control in Control Center,from a control set to the action button, or a control on the Lock Screen.To allow someone to launch your capture experience,you will need to create a custom control.This control will be part of another extension,a widget extension which you can build with WidgetKit.For this control to specifically launch your capture experience,you will need to implement a new typeof system intent being introduced in iOS 18,the CameraCaptureIntent.Depending on conditions such as whether the device is at the Lock or Home Screen,the system will determine whether to launch your capture extensionor your application with your CameraCaptureIntent.When your app or extension is launched with this intent,that is your cue to bring someone directly to your capture experience on launch.To allow this intent to launch your extension or your application,you must include your CameraCaptureIntent in all three targets:your widget extension, allowing the intent to be used by your control,your extension, and your application.The Camera capture intent defines an app context.This context is shared between your application and extension,and can be written to from either.You should use this context to store user preferencesor any settings you want to share between your capture experiencein your extension,and the capture experience in your application.For example, you might store datato represent app purchases made by a person in your applicationso they can also be used in your capture extension.To update the app context, call the updateAppContext functionpassing in the new app context you wish to persist.It's very important to note, the app context has a limited size.If a context is too large, it will not be persisted,which may impact the behavior of your capture experience,so be conscious of how much you write to the app context.Here you can see my implementation of a CameraCaptureIntent.You’ll notice I’ve defined my own type for the app context, ClownTownContext.Here's what that context looks like.A clown may not always be ready to capture a great clown portraitsince they’re not always in their makeup,so we have a button to automatically add some clown makeup for anyone,so they’re ready to snap the perfect clown profile photo anytime.Here, I’ve defined a single bool to represent that settingfor whether we are adding clown makeup and a clown nose or not.I’ve implemented the perform function for my intent,which you can see here.Notice how I’m reading the context and using itto set up my interface stateso my capture experience will always reflect the latest statein which a person used the app: with added clown makeup or not.Here is a code snippet of my button code in my capture experience,which shows how I am handling the button pressto turn on and off that clown makeup setting.When the action is triggered, I call to update the app contextwith this setting so it can be read from both my app and my extension.And finally, here is my control widget for ClownTown,which will be incorporated into my widget extension.You can see here I am passing an instance of my ClownTownCaptureIntentto the control as its action to perform.To summarize, you will add a widget extension to your appand define your control.Along with that, you will also implement a camera capture intentto provide to your control,as well as including it in your app and extension targets.For more information on how to build a Controlto launch your capture experience,you can check out my colleague Cliff’s video,"Creating your own Controls",and for more information on working with AppIntents,you can watch,"Bring your app’s core features to users with App Intents."One final requirement for your capture experienceis that your extension and applicationshould both include privacy usage descriptions for the Camera.This is a signal to the system that you intend to use the camerafor capturing photos and videoand allows the system to display that descriptionto explain why your capture experience wishes to use the camera.Now that we’ve built a control to launch our capture experience,let's talk about how we work with captured content in our app.While running your capture experience at the Lock Screen,someone might want to perform an action that requires privileges beyondwhat is available in the capture extension.For example, someone may wish to post their captured photos to a social network,which would require network access,or they may wish to use a feature that requires resourcesfrom your application's shared group container.To handle these types of interactions,your extension can call the openApplication functionon LockedCameraCaptureSession, which we briefly covered earlier.This function takes a single parameter of an NSUserActivity.As a convenience, LockedCameraCapture also exposesa new NSUserActivity type, NSUserActivityType LockedCameraCapture.This new user activity type is intended to be used with the openApplication function,as a signal indicating to your applicationthat it was launched from your capture extension.Calling the openApplication functionwill prompt someone to unlock their device if needed,and open your application which will receive a callto handle continuation of the NSUserActivity.This allows your application to bring a personright where they left off in your UI with a seamless transition.For my ClownTown capture extension,I want to open the app when someone wants to update the profile photo,which will use the network to send it to a server.Here, when the user taps the appropriate button,I call to open the application with an NSUserActivitywith our new type for LockedCameraCapture,and I pass some context in the userInfo to indicate that I want my applicationto continue the "update profile photo" flow.With the userInfo as well as the user activity type,my application has enough context to perform a transitionthat is seamless from my extension.From within your application, you can use the LockedCameraCaptureManagerto work with the content that has been capturedfrom your capture extension.LockedCameraCaptureManager exposes a shared instance for youto use across your application as needed.The manager exposes a sessionContentURLs property,which provides an array of URLs,each pointing to a directory of content captured in your capture extension.The manager also exposes an AsyncSequence of sessionContentUpdates.This sequence begins with the URLsrepresenting the current session content directories,and continues with any added or removed session content directories.This can be used to asynchronously process the captured contents from your extension.In some cases, when transitioning from the extension to the application,the most recently captured session content directorymay become available shortly after your application launch.It is recommended to use this async sequenceto ensure you can process the session contentsas soon as they are available.Lastly, the manager exposes an invalidate function.This function is meant to be calledafter the session contents at the given URL have been handled,and you no longer need that session content.Calling this function will deletethe session contents from the URL provided,so it is important to make sure you only call thisonce you are completely done working with those session contents.You should note that when you invalidate the session content at a given URL,this will also result in a session content updatefor the removal of that session content directory.In my ClownTown app,I can use the sessionContentUpdates propertyto process the initial existing captured content,await new session contents,and process them in my application as they are received.LockedCameraCapture provides all of the components you needto build a great capture experienceand make it easily accessible at someone’s Lock Screen.You can transition into your app to complete key workflowsthat need additional access,while preserving the privacy and securitythat people expect when capturing photos and videos from the Lock Screen.We can’t wait to see what you’ll build with it.Thanks for watching.

Hi there, I’m Adam and I’m an engineer on the iOS System Experience team.Today, I am excited to show you how to build a great camera capture experiencefor the Lock Screen.I love how easy it is to capture a great moment with my iPhone.When I take my iPhone out of my pocket, without even needing to unlock it,I can launch into the camera from the Action button,Control Center, or the Lock Screen.Before you know it, I’ve snapped a great photo,like this photo I took today at Apple Park.

New in iOS 18, your camera experience can be made availableto people right from their Lock Screen on both iPhone and iPad.This type of capture experience is enabledby a new framework we’re introducing in iOS 18:LockedCameraCapture framework.The LockedCameraCapture framework contains the building blocksto build a great camera capture experiencethat will run from the Lock Screen.One major component introduced by LockedCameraCaptureso we can build this capture experienceis a new extension type, the Locked Camera Capture Extension.

In this session, we’ll talk about what makes a great camera capture experiencethen we’ll take you through the lifecycle of a capture extension,Then we’ll talk about some important considerationsfor running on a locked device.

After that we’ll take a deeper dive intohow you can capture great photos and videos from the Lock Screen.And finally, we’ll look at how you can incorporate contentcaptured from the Lock Screen back into your application.

Let's start with a discussion of what makes a great capture experience.The Camera app on iOS providesa great capture experience on iPhone or iPad.I can quickly and easily access my camera from my Lock Screeneven when my device is locked by pressing on the Camera control.

Pressing that control takes me directly to a viewfinder to start capturing photos.

I can press the volume up button to capture a photoor press and hold it to start recording a video.

Once I’ve taken a photo or video, I can tap the image well to view it.

My device still remains locked,and Camera maintains my privacy by only showing photos and videosI’ve captured while I had the camera presented.If I want deeper interactions with my content,my phone will request that I unlock my deviceand then allow me to continue.

To enable this type of experience for your app,you can create a new type of app extension,the Locked Camera Capture Extension.

An app extension is a separate target that gets embedded in your application.It lets you extend custom functionality and content beyond your app,making it available to peoplewhile they’re interacting with other apps or the system.

This new type of app extension runs from the Lock Screenso you can build a capture experience that allows people to get quick and easy accessto snap a photo or record a video usingthe same familiar UI from your application,even when their device is locked.

Let's take a look at the lifecycle of this new extension.The first step of the lifecycle is launching the extension.

This extension can be launched from a control in control center.From a control assigned to the action button.Or from a control on the Lock Screen.

Once the extension is launched,someone can then start to capture great photo and video contentwhich will use the same familiar UI from your app.

Capture extension can either directly add photoand video assets to a person’s Photo library,or the extension can store any data it needs to represent a captureto a provided directory on the file system.

After capturing some content,someone might want to do something more in depth with it,such as sharing it to a social network or applying a filter requiring image assets,to give it a styled look.

For these types of interactions,the extension can request to open its parent application,which will authenticate a person using the device.

This enables the ability to doa seamless transition from extension to app,bringing someone right to where the extension left off.Lastly, whether by transitioning to the applicationor if someone swiped up to return to the Lock Screen,the capture extension will be dismissed.When this happens, the system moves the captured contentto a location that the parent application can access.When the app has runtime,it can incorporate the content capturedwhile in the extension into its other content.

We’ll talk more in depth about this process later on in this video.Now that we know more about the lifecycle of a capture extension,lets cover some important considerations for running on a locked device.People around the world rely on iOS everydayto provide them a high degree of privacy.

When my device is locked, I can rest assured that my contacts, emails,photos, videos and much more are secure behind the Lock Screen,requiring me to unlock my device to access them.We’ve built LockedCameraCapture frameworkwith an intentional focus on security and privacy,remaining conscious of protecting the contents of people's devices.Since this new extension type runs from the Lock Screen,a persons device may be locked while they are capturing photos or videoin your capture experience.To ensure the privacy and security of a persons device,we’ve enforced a few restrictions for this new experience.Your extension should provide the same capture experienceas in your application,and is expected to provide people with a camera viewfinderas soon as possible after launch.If your extension is not showing a camera viewfinder at launch,your extension will be terminated by the system.

We think capturing a photo or video with the hardware buttons of the phoneis a great way to give people the quickest point and shoot experience possible.Therefore, your extension must use AVCaptureEventInteractionto handle events from the system hardware buttons.

Since your experience will be accessible while the device is locked,your capture extension will be restricted from using any network resourcesit cannot read from or write to any shared group container for your application,or other extensions,and cannot access any shared preferences for your application.

Rest assured you can still share an important statebetween your extension and application,we’ll go over how in a little while.First, let's take a look at how persisting data for capturesworks when in the extension.

We recommend using PhotoKit to save photo and video assetscaptured from your extension.

With PhotoKit, your extension can add captured photos and videosto someone's photo library,even when the device is locked.

PhotoKit is designed to protect the private photos and videosin the photo library when the device is locked.When reading the photo library on a locked device,only photos and videos written during the current capture sessionwill be available to be read.If your device is unlocked and your extensionhas the proper permissions for the photo library,you will be able to read all photos and videosthat someone has given you access to,not just those captured during the current capture session.PhotoKit also has great supportfor granular levels of photo library access,such as write only access and limited library support,allowing someone to select a set of photos to allow access to.

Your extension inherits Photos permissions from your app,so your extension should be preparedto handle any level of permissions for photo library access.If your extension needs additional permissions for Photos,you can transition into your application to request them.We’ll cover how to do that a bit later in this video.For more information on working with PhotoKit,you can check out these videos from previous WWDCs.Some capture experiences might need to save other datathat PhotoKit does not support.LockedCameraCapture framework also supportssaving any data you might need for captures taken in your extension.Let’s take a look at how this works.

These boxes represent the file system storage of photosand videos captured for your extension on the left,and your application on the right.

On launch, your extension will be provided a content path via the session object.In this example, as a person captures content,your extension can write data to a provided session content directory.

You may also use PhotoKit to ingest captured photos and videos,adding them directly to the photo library.

You might be tempted to store additional data anywhere elsein the extension container.However, this is not recommended.At any time, someone can dismiss your extension.

Once your extension is dismissed,the provided session content directory is migrated to your application’s containerand the extension’s container is erased to ensure securityand to preserve the privacy of the device owner.

You will not be able to access the contentsof any prior sessions from within the extension.Persist any data you wish to preserve past the given sessionin the provided session content directory.In the case of an unexpected termination, the system will still copy the contentsof this directory, allowing you to attempt recovery of the data.If someone launches your extension again,it receives a new session objectcontaining a new session content directory to write files to.Once again, the extension writes into the session content directory,and when someone dismisses the extension, the content is once again movedinto the application’s container as a separate session content directory.

When your application has runtime, it can retrieve the captured contentsand handle them appropriately,such as integrating them to sit alongside other captured content in your app.Once your application is done handlingthe contents of a single session directory,it can call to invalidate that directory,letting the system know that directory is safeto erase from the file system.

To reiterate: Someone can dismiss your extension at any time,and when that happens, only contents in the session content directorywill be copied to your application’s container.You will not be able to access the container contentsfrom a previous launch of the extension on the next launch of the extension,as data in the extension’s container will be erased.While we have mainly focused on behaviors for running while the device is locked,your extension will run from the Lock Screenregardless of the device’s locked state.

For both locked and unlocked cases the behaviors and restrictionswill remain the same.Now that we’ve discussed the caveats of running on a locked device,let's talk about building our experienceto capture content right from the Lock Screen.My colleague, Jon, and I have recently been workingon an update to our app, ClownTownthat lets Clowns add a profile for themselves,so they can connect with other Clowns in the area.I think adding the ability to take a photo for their profilewould be a great feature.

I’ll use my updates to the ClownTown appas an example as we go through building our capture extensionand the rest of the capture experience.To help you get started, Xcode provides a convenient templatefor the Locked Camera Capture Extension.

This template includes everything you need to build and run right away,including a camera viewfinder and shutter button.

In my example here, I define my extension,which conforms to LockedCameraCaptureExtension.

Then from within that struct,an extension scene is implemented for the body,and the scene returns my custom view content.Your UI for this extension should be focusedon bringing people to a camera viewfinder to capture photos and videos.Your extension should also provide the same consistent capture experiencepeople will get in your application,using the same familiar UI elements.

Your extension will inherit permissions for Camera and Photos accessfrom your application.Your extension should be prepared to handle any level of permissionsfor both Camera or Photos.If your app cannot use the Camera due to permissions not having been granted,the system will request an unlock of a person's deviceand after a successful authentication,launch your app instead of your extension to handle that case.The initializer for the LockedCameraCaptureUISceneprovides a single parameter,an instance of LockedCameraCaptureSession.Let's take a look at what this session object provides.

This session object serves a few important purposes.

The capture session provides a sessionContentURL.

This is a path to a directory in your extension’s containerwhich you can use to persist any and all datafor someone’s captured photos and videos,and any other related data you wish to preserve.You can also persist captured photos and videosdirectly to PhotoKit from your capture extension.You can write content to the photo library even if the device is locked,however when the device is locked,only photos and videos written during the current capture sessionwill be available to be read.

When unlocked, your extension can read all of the photos it has permissions to read,including those outside of the current capture session.If you are finished using the data you’ve writtento the directory sessionContentURL,for example, if you have saved the contents to PhotoKit,you can call invalidateSessionContent to erase the contents of that directory.You can continue to write to the directory after calling this function,but any content written there prior to the invalidate call will be erased.

The session also provides a function to request an open of your application.You should only call this functionin reaction to a person interacting with your UI,such as when someone taps a button to share a photo via the share sheet.Since sharing content requires network access,and you cannot fulfill that request in the capture extension,you can call openApplication,which will prompt for an unlock of the device,and if successfully unlocked, then will open your application.We’ll take a closer look athow to use this function later in this video.When we discussed the lifecycle of your extension earlier,I mentioned that your extension is launched from a control in Control Center,from a control set to the action button, or a control on the Lock Screen.To allow someone to launch your capture experience,you will need to create a custom control.This control will be part of another extension,a widget extension which you can build with WidgetKit.

For this control to specifically launch your capture experience,you will need to implement a new typeof system intent being introduced in iOS 18,the CameraCaptureIntent.Depending on conditions such as whether the device is at the Lock or Home Screen,the system will determine whether to launch your capture extensionor your application with your CameraCaptureIntent.When your app or extension is launched with this intent,that is your cue to bring someone directly to your capture experience on launch.To allow this intent to launch your extension or your application,you must include your CameraCaptureIntent in all three targets:your widget extension, allowing the intent to be used by your control,your extension, and your application.

The Camera capture intent defines an app context.This context is shared between your application and extension,and can be written to from either.

You should use this context to store user preferencesor any settings you want to share between your capture experiencein your extension,and the capture experience in your application.For example, you might store datato represent app purchases made by a person in your applicationso they can also be used in your capture extension.To update the app context, call the updateAppContext functionpassing in the new app context you wish to persist.It's very important to note, the app context has a limited size.If a context is too large, it will not be persisted,which may impact the behavior of your capture experience,so be conscious of how much you write to the app context.

Here you can see my implementation of a CameraCaptureIntent.

You’ll notice I’ve defined my own type for the app context, ClownTownContext.

Here's what that context looks like.A clown may not always be ready to capture a great clown portraitsince they’re not always in their makeup,so we have a button to automatically add some clown makeup for anyone,so they’re ready to snap the perfect clown profile photo anytime.Here, I’ve defined a single bool to represent that settingfor whether we are adding clown makeup and a clown nose or not.

I’ve implemented the perform function for my intent,which you can see here.

Notice how I’m reading the context and using itto set up my interface stateso my capture experience will always reflect the latest statein which a person used the app: with added clown makeup or not.

Here is a code snippet of my button code in my capture experience,which shows how I am handling the button pressto turn on and off that clown makeup setting.When the action is triggered, I call to update the app contextwith this setting so it can be read from both my app and my extension.And finally, here is my control widget for ClownTown,which will be incorporated into my widget extension.You can see here I am passing an instance of my ClownTownCaptureIntentto the control as its action to perform.

To summarize, you will add a widget extension to your appand define your control.Along with that, you will also implement a camera capture intentto provide to your control,as well as including it in your app and extension targets.For more information on how to build a Controlto launch your capture experience,you can check out my colleague Cliff’s video,"Creating your own Controls",and for more information on working with AppIntents,you can watch,"Bring your app’s core features to users with App Intents."One final requirement for your capture experienceis that your extension and applicationshould both include privacy usage descriptions for the Camera.This is a signal to the system that you intend to use the camerafor capturing photos and videoand allows the system to display that descriptionto explain why your capture experience wishes to use the camera.Now that we’ve built a control to launch our capture experience,let's talk about how we work with captured content in our app.

While running your capture experience at the Lock Screen,someone might want to perform an action that requires privileges beyondwhat is available in the capture extension.For example, someone may wish to post their captured photos to a social network,which would require network access,or they may wish to use a feature that requires resourcesfrom your application's shared group container.To handle these types of interactions,your extension can call the openApplication functionon LockedCameraCaptureSession, which we briefly covered earlier.

This function takes a single parameter of an NSUserActivity.

As a convenience, LockedCameraCapture also exposesa new NSUserActivity type, NSUserActivityType LockedCameraCapture.This new user activity type is intended to be used with the openApplication function,as a signal indicating to your applicationthat it was launched from your capture extension.Calling the openApplication functionwill prompt someone to unlock their device if needed,and open your application which will receive a callto handle continuation of the NSUserActivity.This allows your application to bring a personright where they left off in your UI with a seamless transition.

For my ClownTown capture extension,I want to open the app when someone wants to update the profile photo,which will use the network to send it to a server.Here, when the user taps the appropriate button,I call to open the application with an NSUserActivitywith our new type for LockedCameraCapture,and I pass some context in the userInfo to indicate that I want my applicationto continue the "update profile photo" flow.With the userInfo as well as the user activity type,my application has enough context to perform a transitionthat is seamless from my extension.

From within your application, you can use the LockedCameraCaptureManagerto work with the content that has been capturedfrom your capture extension.LockedCameraCaptureManager exposes a shared instance for youto use across your application as needed.

The manager exposes a sessionContentURLs property,which provides an array of URLs,each pointing to a directory of content captured in your capture extension.The manager also exposes an AsyncSequence of sessionContentUpdates.This sequence begins with the URLsrepresenting the current session content directories,and continues with any added or removed session content directories.This can be used to asynchronously process the captured contents from your extension.

In some cases, when transitioning from the extension to the application,the most recently captured session content directorymay become available shortly after your application launch.

It is recommended to use this async sequenceto ensure you can process the session contentsas soon as they are available.

Lastly, the manager exposes an invalidate function.This function is meant to be calledafter the session contents at the given URL have been handled,and you no longer need that session content.Calling this function will deletethe session contents from the URL provided,so it is important to make sure you only call thisonce you are completely done working with those session contents.

You should note that when you invalidate the session content at a given URL,this will also result in a session content updatefor the removal of that session content directory.In my ClownTown app,I can use the sessionContentUpdates propertyto process the initial existing captured content,await new session contents,and process them in my application as they are received.

LockedCameraCapture provides all of the components you needto build a great capture experienceand make it easily accessible at someone’s Lock Screen.You can transition into your app to complete key workflowsthat need additional access,while preserving the privacy and securitythat people expect when capturing photos and videos from the Lock Screen.

We can’t wait to see what you’ll build with it.Thanks for watching.

## Code Samples

